<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>otcD04b01-VTPMArchitecture</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="generator" content="pdftohtml 0.36"/>
<meta name="author" content="schnitzer"/>
<meta name="date" content="2009-05-29T14:12:21+00:00"/>
<style type="text/css">
<!--
.xflip {
    -moz-transform: scaleX(-1);
    -webkit-transform: scaleX(-1);
    -o-transform: scaleX(-1);
    transform: scaleX(-1);
    filter: fliph;
}
.yflip {
    -moz-transform: scaleY(-1);
    -webkit-transform: scaleY(-1);
    -o-transform: scaleY(-1);
    transform: scaleY(-1);
    filter: flipv;
}
.xyflip {
    -moz-transform: scaleX(-1) scaleY(-1);
    -webkit-transform: scaleX(-1) scaleY(-1);
    -o-transform: scaleX(-1) scaleY(-1);
    transform: scaleX(-1) scaleY(-1);
    filter: fliph + flipv;
}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<!-- Page 1 -->
<a name="1"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft10{font-size:27px;font-family:IHILJB+BitstreamVeraSans;color:#000000;}
	.ft11{font-size:16px;font-family:IHILJB+BitstreamVeraSans;color:#000000;}
	.ft12{font-size:16px;font-family:IHILJD+BitstreamVeraSans;color:#000000;}
	.ft13{font-size:17px;font-family:IHILJD+BitstreamVeraSans;color:#000000;}
	.ft14{font-size:10px;font-family:IHILJD+BitstreamVeraSans;color:#000000;}
	.ft15{font-size:16px;line-height:19px;font-family:IHILJD+BitstreamVeraSans;color:#000000;}
	.ft16{font-size:16px;line-height:19px;font-family:IHILJB+BitstreamVeraSans;color:#000000;}
-->
</style>
<div id="page1-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42001.png" alt="background image"/>
<p style="position:absolute;top:224px;left:255px;white-space:nowrap" class="ft10"><b>D04.7 VTPM Architecture</b></p>
<p style="position:absolute;top:283px;left:91px;white-space:nowrap" class="ft11"><b>Project&#160;number</b></p>
<p style="position:absolute;top:283px;left:425px;white-space:nowrap" class="ft12">IST-027635</p>
<p style="position:absolute;top:308px;left:91px;white-space:nowrap" class="ft11"><b>Project&#160;acronym</b></p>
<p style="position:absolute;top:308px;left:425px;white-space:nowrap" class="ft12">Open_TC</p>
<p style="position:absolute;top:334px;left:91px;white-space:nowrap" class="ft11"><b>Project&#160;title</b></p>
<p style="position:absolute;top:334px;left:425px;white-space:nowrap" class="ft12">Open Trusted Computing</p>
<p style="position:absolute;top:366px;left:91px;white-space:nowrap" class="ft11"><b>Deliverable&#160;type</b></p>
<p style="position:absolute;top:356px;left:425px;white-space:nowrap" class="ft15">Report&#160;<br/>(see&#160;p&#160;87/88&#160;Annex&#160;1&#160;-&#160;Nature)</p>
<p style="position:absolute;top:415px;left:91px;white-space:nowrap" class="ft11"><b>Deliverable&#160;reference&#160;number</b></p>
<p style="position:absolute;top:415px;left:425px;white-space:nowrap" class="ft12">IST-027635&#160;/ D04.7&#160;FINAL|1.0_Update</p>
<p style="position:absolute;top:441px;left:91px;white-space:nowrap" class="ft11"><b>Deliverable&#160;title</b></p>
<p style="position:absolute;top:441px;left:425px;white-space:nowrap" class="ft12">TPM&#160;Virtualisation&#160;Architecture&#160;document</p>
<p style="position:absolute;top:466px;left:91px;white-space:nowrap" class="ft11"><b>WP&#160;contributing&#160;to&#160;the&#160;deliverable</b></p>
<p style="position:absolute;top:466px;left:425px;white-space:nowrap" class="ft12">WP04/WP05</p>
<p style="position:absolute;top:492px;left:91px;white-space:nowrap" class="ft11"><b>Due&#160;date</b></p>
<p style="position:absolute;top:492px;left:425px;white-space:nowrap" class="ft12">April&#160;2009&#160;(M42)</p>
<p style="position:absolute;top:517px;left:91px;white-space:nowrap" class="ft11"><b>Actual&#160;submission&#160;date</b></p>
<p style="position:absolute;top:517px;left:425px;white-space:nowrap" class="ft12">29&#160;May&#160;2009</p>
<p style="position:absolute;top:560px;left:91px;white-space:nowrap" class="ft11"><b>Responsible&#160;Organisation</b></p>
<p style="position:absolute;top:560px;left:424px;white-space:nowrap" class="ft12">HPLB</p>
<p style="position:absolute;top:631px;left:91px;white-space:nowrap" class="ft11"><b>Authors</b></p>
<p style="position:absolute;top:582px;left:424px;white-space:nowrap" class="ft15">HPLB&#160;(David&#160;Plaquin,&#160;Serdar&#160;Cabuk,&#160;Chris<br/>Dalton, Dirk&#160;Kuhlmann,&#160;Philipp&#160;Grete)<br/>TUD&#160;(Carsten&#160;Weinhold,&#160;Alexander&#160;B</p>
<p style="position:absolute;top:621px;left:728px;white-space:nowrap" class="ft13">ö</p>
<p style="position:absolute;top:622px;left:738px;white-space:nowrap" class="ft12">ttcher)</p>
<p style="position:absolute;top:641px;left:424px;white-space:nowrap" class="ft15">CUCL&#160;(Derek&#160;Murray,&#160;Theodore&#160;Hong)<br/>RUB&#160;(Marcel&#160;Winandy)</p>
<p style="position:absolute;top:699px;left:91px;white-space:nowrap" class="ft11"><b>Abstract</b></p>
<p style="position:absolute;top:699px;left:424px;white-space:nowrap" class="ft15">The&#160;report&#160;includes a&#160;state-of-the-art review<br/>and&#160;describes&#160;the current&#160;state&#160;of&#160;virtual<br/>TPM&#160;implementations,&#160;compares&#160;ownership<br/>and lifecycle&#160;models,&#160;discusses&#160;trusted<br/>virtual&#160;platforms,&#160;property&#160;based&#160;attestation,<br/>and outlines the OpenTC&#160;virtual&#160;TPM&#160;design.<br/>As&#160;an&#160;UPDATE&#160;of&#160;D04.7&#160;it is based&#160;on&#160;the<br/>original&#160;document&#160;submitted&#160;in&#160;August&#160;2008,<br/>and expanded&#160;by&#160;chapter&#160;“Implementation<br/>details”.&#160;</p>
<p style="position:absolute;top:914px;left:91px;white-space:nowrap" class="ft11"><b>Keywords</b></p>
<p style="position:absolute;top:914px;left:424px;white-space:nowrap" class="ft12">Trusted Computing,&#160;Virtualization,&#160;TPM</p>
<p style="position:absolute;top:957px;left:92px;white-space:nowrap" class="ft11"><b>Dissemination&#160;level</b></p>
<p style="position:absolute;top:957px;left:423px;white-space:nowrap" class="ft12">Public</p>
<p style="position:absolute;top:983px;left:92px;white-space:nowrap" class="ft11"><b>Revision</b></p>
<p style="position:absolute;top:983px;left:423px;white-space:nowrap" class="ft12">FINAL&#160;| 1.0&#160;_Update</p>
<p style="position:absolute;top:1034px;left:90px;white-space:nowrap" class="ft11"><b>Instrument</b></p>
<p style="position:absolute;top:1034px;left:271px;white-space:nowrap" class="ft12">IP</p>
<p style="position:absolute;top:1025px;left:452px;white-space:nowrap" class="ft16"><b>Start&#160;date&#160;of the<br/>project</b></p>
<p style="position:absolute;top:1034px;left:632px;white-space:nowrap" class="ft12">1</p>
<p style="position:absolute;top:1034px;left:643px;white-space:nowrap" class="ft14">st</p>
<p style="position:absolute;top:1034px;left:652px;white-space:nowrap" class="ft12">&#160;November&#160;2005</p>
<p style="position:absolute;top:1063px;left:90px;white-space:nowrap" class="ft11"><b>Thematic&#160;Priority</b></p>
<p style="position:absolute;top:1063px;left:271px;white-space:nowrap" class="ft12">IST</p>
<p style="position:absolute;top:1063px;left:452px;white-space:nowrap" class="ft11"><b>Duration</b></p>
<p style="position:absolute;top:1063px;left:632px;white-space:nowrap" class="ft12">42 months</p>
</div>
<!-- Page 2 -->
<a name="2"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft27{font-size:15px;font-family:IHILJD+BitstreamVeraSans;color:#000000;}
	.ft28{font-size:24px;font-family:IHILJB+BitstreamVeraSans;color:#000000;}
-->
</style>
<div id="page2-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42002.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft27">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft27">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:169px;left:85px;white-space:nowrap" class="ft28"><b>Table of&#160;Contents</b></p>
<p style="position:absolute;top:206px;left:85px;white-space:nowrap" class="ft25">1&#160;&#160;Introduction...............................................................................................................4<br/>2&#160;&#160;Motivation..................................................................................................................6</p>
<p style="position:absolute;top:244px;left:94px;white-space:nowrap" class="ft25">2.1&#160;Background&#160;and&#160;State of&#160;the&#160;Art............................................................................7<br/>2.2&#160;Types of Virtual&#160;TPMs.............................................................................................9</p>
<p style="position:absolute;top:283px;left:85px;white-space:nowrap" class="ft22">3&#160;&#160;Review&#160;of current&#160;architectures...............................................................................10</p>
<p style="position:absolute;top:302px;left:94px;white-space:nowrap" class="ft25">3.1&#160;Virtual&#160;TPMs&#160;on&#160;Xen.............................................................................................10<br/>3.2&#160;Virtual&#160;TPMs&#160;on&#160;L4&#160;...............................................................................................10<br/>3.3&#160;Current Limitations&#160;..............................................................................................11</p>
<p style="position:absolute;top:360px;left:85px;white-space:nowrap" class="ft22">4&#160;&#160;Ownership&#160;Model&#160;of&#160;the Hardware&#160;TPM...................................................................13</p>
<p style="position:absolute;top:379px;left:94px;white-space:nowrap" class="ft25">4.1&#160;TPM Owner ..........................................................................................................13<br/>4.2&#160;Software&#160;as&#160;TPM Owner .......................................................................................13<br/>4.3&#160;Virtual&#160;TPMs&#160;and the&#160;Basic&#160;Management&#160;and&#160;Security&#160;Interface.........................15</p>
<p style="position:absolute;top:436px;left:85px;white-space:nowrap" class="ft22">5&#160;&#160;vTPM&#160;Lifecycle.........................................................................................................16</p>
<p style="position:absolute;top:456px;left:94px;white-space:nowrap" class="ft25">5.1&#160;Virtual&#160;TPM manufacturing&#160;..................................................................................16<br/>5.2&#160;Virtual&#160;TPM Instantiation......................................................................................18<br/>5.3&#160;Binding&#160;Virtual&#160;TPMs to&#160;VMs.................................................................................21</p>
<p style="position:absolute;top:513px;left:85px;white-space:nowrap" class="ft22">6&#160;&#160;vTPMs&#160;and&#160;Trusted Virtual&#160;Platforms.......................................................................24</p>
<p style="position:absolute;top:532px;left:94px;white-space:nowrap" class="ft25">6.1&#160;Definitions............................................................................................................24<br/>6.2&#160;Generalization&#160;of&#160;binding property.......................................................................25<br/>6.3&#160;Bootstrapping&#160;a Virtual&#160;Platform&#160;with&#160;a&#160;VTPM......................................................27</p>
<p style="position:absolute;top:590px;left:85px;white-space:nowrap" class="ft22">7&#160;&#160;Enhancing&#160;vTPM&#160;Functionalities...............................................................................28</p>
<p style="position:absolute;top:609px;left:94px;white-space:nowrap" class="ft25">7.1&#160;Property-Based Attestation..................................................................................28<br/>7.2&#160;Enhanced vTPM&#160;Architecture................................................................................29<br/>7.3&#160;Realizing&#160;Property-Based&#160;Functionality with&#160;vTPM...............................................31</p>
<p style="position:absolute;top:667px;left:85px;white-space:nowrap" class="ft22">8&#160;&#160;Design......................................................................................................................34</p>
<p style="position:absolute;top:686px;left:94px;white-space:nowrap" class="ft25">8.1&#160;Implementation for Xen........................................................................................34<br/>8.2&#160;Implementation for L4/Fiasco&#160;and&#160;L4Env.............................................................36</p>
<p style="position:absolute;top:724px;left:85px;white-space:nowrap" class="ft25">9&#160;&#160;Summary.................................................................................................................38<br/>1&#160;0&#160;Abbreviations.........................................................................................................39<br/>1&#160;1&#160;Implementation&#160;details..........................................................................................40</p>
<p style="position:absolute;top:782px;left:94px;white-space:nowrap" class="ft25">11.&#160;1Software&#160;components&#160;and their description.......................................................40<br/>11.&#160;2Packaging and&#160;software&#160;distribution..................................................................46</p>
<p style="position:absolute;top:820px;left:85px;white-space:nowrap" class="ft22">1&#160;2&#160;References.............................................................................................................47</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft27">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft27">2/48</p>
</div>
<!-- Page 3 -->
<a name="3"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page3-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42003.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft37">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft37">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:169px;left:85px;white-space:nowrap" class="ft38"><b>List&#160;of&#160;figures</b></p>
<p style="position:absolute;top:206px;left:85px;white-space:nowrap" class="ft35">Figure&#160;1:&#160;VTPM&#160;State&#160;Structure.....................................................................................19<br/>Figure&#160;2:&#160;Virtual Platform&#160;Layout..................................................................................24<br/>Figure&#160;3:&#160;Virtual Platform&#160;Services...............................................................................25<br/>Figure&#160;4:&#160;Logical&#160;architecture&#160;of&#160;property&#160;based&#160;attestation enhanced&#160;vTPM..............29<br/>Figure&#160;5: Matrix of&#160;vPCRs&#160;for a&#160;vTPM&#160;instance..............................................................30<br/>Figure&#160;6:&#160;VTPM&#160;Architecture&#160;on&#160;Xen.............................................................................34<br/>Figure&#160;7:&#160;VTPM&#160;Implementation&#160;on&#160;L4..........................................................................36</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft37">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft37">3/48</p>
</div>
<!-- Page 4 -->
<a name="4"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft49{font-size:15px;font-family:IHIMON+BitstreamVeraSerif;color:#000000;}
	.ft410{font-size:18px;font-family:IHILJB+BitstreamVeraSans;color:#000000;}
	.ft411{font-size:16px;font-family:IHIMPO+BitstreamVeraSans;color:#000000;}
	.ft412{font-size:16px;line-height:28px;font-family:IHILJD+BitstreamVeraSans;color:#000000;}
-->
</style>
<div id="page4-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42004.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft47">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft47">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:172px;left:85px;white-space:nowrap" class="ft49"><b>1&#160;</b></p>
<p style="position:absolute;top:169px;left:117px;white-space:nowrap" class="ft410"><b>Introduction</b></p>
<p style="position:absolute;top:199px;left:85px;white-space:nowrap" class="ft412">Numerous&#160;core concepts of&#160;Trusted&#160;Computing&#160;(TC)&#160;as&#160;defined by&#160;the&#160;Trusted<br/>Computing&#160;Group (TCG)&#160;were originally&#160;conceived&#160;to support&#160;traditional&#160;computing<br/>platforms.&#160;For example,&#160;it&#160;was&#160;typically&#160;taken for&#160;granted&#160;that&#160;only&#160;a&#160;single&#160;operating<br/>system&#160;would&#160;be&#160;running&#160;on&#160;each&#160;physical&#160;platforms.&#160;It&#160;was also&#160;assumed&#160;that&#160;only&#160;a<br/>single&#160;Trusted&#160;Platform&#160;Module&#160;(TPM)&#160;would&#160;be present&#160;on a&#160;physical&#160;platform,&#160;and<br/>that&#160;this would&#160;suffice&#160;to extend&#160;trust&#160;properties&#160;from&#160;this&#160;element to&#160;all other<br/>hardware&#160;and&#160;software&#160;components.&#160;Another&#160;general&#160;assumption&#160;was that&#160;the TPM<br/>would&#160;typically&#160;be&#160;implemented&#160;in&#160;hardware.<br/>Under&#160;these&#160;assumptions,&#160;it&#160;is&#160;conceptually&#160;straightforward&#160;to&#160;create&#160;a&#160;</p>
<p style="position:absolute;top:362px;left:680px;white-space:nowrap" class="ft411"><i>chain of&#160;trust</i></p>
<p style="position:absolute;top:381px;left:85px;white-space:nowrap" class="ft45">on TC enabled&#160;computing&#160;platforms.&#160;This&#160;chain&#160;consists&#160;of software&#160;components&#160;with<br/>known trust&#160;properties&#160;that&#160;are&#160;executed in&#160;a defined&#160;sequence. Trust&#160;properties&#160;are<br/>represented&#160;as the cryptographic&#160;digests of&#160;all&#160;binaries,&#160;scripts&#160;and&#160;configuration&#160;files<br/>used to initialize&#160;the system.&#160;During&#160;system&#160;initialization,&#160;these digests&#160;are&#160;logged into<br/>dedicated,&#160;protected&#160;registers&#160;of the TPM.&#160;The&#160;set of register values&#160;represents&#160;the<br/>system&#160;state at the&#160;end of the initialization&#160;process.&#160;By requesting&#160;the&#160;values&#160;of&#160;the<br/>register&#160;set, remote&#160;peers&#160;can&#160;validate&#160;whether the actual,&#160;measured&#160;configuration&#160;of<br/>the system&#160;in question&#160;corresponds&#160;to&#160;a&#160;setup&#160;that&#160;is known&#160;to&#160;be&#160;trustworthy.<br/>These&#160;mechanisms&#160;are&#160;well&#160;suited&#160;to support&#160;static&#160;configurations,&#160;that&#160;is,&#160;platforms<br/>that&#160;provide&#160;limited&#160;and&#160;well-defined&#160;functionality for specific&#160;purposes.&#160;Multi-purpose<br/>platforms&#160;such&#160;as&#160;client&#160;PCs or&#160;data&#160;center&#160;servers,&#160;however,&#160;require&#160;a&#160;high&#160;level&#160;of<br/>flexibility.&#160;We&#160;often&#160;want&#160;to lock&#160;down&#160;and&#160;protect a&#160;specific&#160;subset&#160;of&#160;components<br/>while simultaneously&#160;maintaining&#160;the&#160;option&#160;of&#160;running&#160;the remaining&#160;system&#160;in an<br/>unconstrained,&#160;freely&#160;configurable&#160;mode.&#160;To&#160;reconcile requirements&#160;of flexibility&#160;with<br/>those&#160;of&#160;policy constrained&#160;execution, OpenTC exploits&#160;techniques&#160;of&#160;operating<br/>system&#160;virtualization.&#160;These&#160;techniques&#160;allow to&#160;concurrently&#160;host&#160;multiple&#160;execution<br/>environments&#160;– so-called&#160;virtual&#160;machines or&#160;VMs&#160;–&#160;while&#160;subjecting&#160;each&#160;of&#160;them&#160;to a<br/>different&#160;security policy.&#160;In&#160;order&#160;to&#160;support&#160;remote&#160;attestation not&#160;only&#160;for&#160;the<br/>hardware&#160;platform,&#160;but&#160;also&#160;for&#160;each&#160;virtual&#160;machine&#160;hosted&#160;by&#160;it, however,&#160;this<br/>approach&#160;essentially&#160;requires&#160;the&#160;equivalent&#160;of a&#160;dedicated 'virtual'&#160;TPM for&#160;each&#160;VM<br/>instance.&#160;<br/>Virtualization&#160;of&#160;TPM&#160;functionality&#160;poses a number&#160;of challenges.&#160;Virtualized&#160;TPM<br/>instances&#160;become part&#160;of the&#160;Trusted&#160;Computing&#160;Base&#160;of the hardware&#160;platform.&#160;They<br/>have&#160;to be&#160;included&#160;the&#160;system's&#160;integrity&#160;verification&#160;and&#160;bound&#160;to&#160;its integrity state,<br/>that&#160;is,&#160;the&#160;hardware&#160;TPM&#160;and&#160;its values.&#160;Registers&#160;and&#160;keys of virtual&#160;TPMs must&#160;be<br/>isolated&#160;and protected from&#160;hosted VMs&#160;to guarantee&#160;the trustworthiness&#160;of&#160;the<br/>attestation information.&#160;Further&#160;considerations&#160;are&#160;necessary&#160;with&#160;regard&#160;to&#160;the&#160;life<br/>cycle of virtual&#160;TPMs,&#160;their&#160;keys&#160;and&#160;certificates.&#160;Yet another set of&#160;questions concerns<br/>properties&#160;that are&#160;required&#160;to support&#160;migration&#160;of&#160;virtual&#160;machines&#160;between different<br/>physical&#160;hosts.<br/>This&#160;report&#160;documents&#160;the status&#160;of OpenTC's&#160;investigation&#160;on virtual&#160;TPMs&#160;as of&#160;June<br/>2008.&#160;Chapter&#160;2&#160;motivates&#160;the need&#160;for&#160;vTPMs&#160;and&#160;sketches&#160;some&#160;implementation<br/>alternatives.&#160;Chapter&#160;3&#160;discusses&#160;the current&#160;state&#160;of&#160;vTPM&#160;components&#160;developed&#160;for<br/>the&#160;Xen&#160;and&#160;L4 hypervisor&#160;layers.&#160;Chapter&#160;4&#160;compares&#160;the traditional&#160;model&#160;of TPM<br/>ownership&#160;with&#160;models&#160;required&#160;by or&#160;possible&#160;through&#160;virtual&#160;TPMs.&#160;In&#160;chapter&#160;5,&#160;we<br/>contrast&#160;the life-cycle model&#160;of&#160;TPM hardware&#160;with&#160;that&#160;of&#160;virtual&#160;TPMs.&#160;Chapter&#160;6<br/>introduces&#160;the&#160;concept of Trusted&#160;Virtual&#160;Platforms.&#160;In chapter&#160;7,&#160;we&#160;outline&#160;how the<br/>flexibility of virtual&#160;TPMs&#160;can&#160;be&#160;improved&#160;for&#160;better supporting&#160;virtual&#160;platforms.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft47">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft47">4/48</p>
</div>
<!-- Page 5 -->
<a name="5"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page5-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42005.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft57">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft57">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft55">Chapter&#160;8 describes&#160;the&#160;actual&#160;vTPM&#160;design&#160;for&#160;Xen&#160;and&#160;L4,&#160;and chapter&#160;9 gives&#160;a<br/>summary&#160;of&#160;this&#160;report.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft57">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft57">5/48</p>
</div>
<!-- Page 6 -->
<a name="6"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page6-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42006.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft67">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft67">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:172px;left:85px;white-space:nowrap" class="ft69"><b>2&#160;</b></p>
<p style="position:absolute;top:169px;left:117px;white-space:nowrap" class="ft610"><b>Motivation</b></p>
<p style="position:absolute;top:199px;left:85px;white-space:nowrap" class="ft65">Operating&#160;system&#160;virtualization&#160;creates&#160;a&#160;number&#160;of challenges&#160;for the original<br/>concept&#160;of Trusted&#160;Computing&#160;as defined&#160;by&#160;the&#160;TCG.&#160;A&#160;first&#160;problem&#160;arises&#160;with<br/>regard&#160;to&#160;the chain of trust.&#160;The trustworthiness&#160;of each component&#160;in&#160;this chain<br/>depends&#160;on&#160;its&#160;own&#160;integrity&#160;as well&#160;as on&#160;that&#160;of&#160;all its predecessors.&#160;This&#160;assumes&#160;a<br/>linear sequence&#160;of&#160;executed&#160;trusted components.&#160;In&#160;a virtualized&#160;scenario,&#160;however,<br/>the structure&#160;of&#160;dependencies&#160;between&#160;system&#160;components&#160;becomes more&#160;complex,<br/>as&#160;multiple&#160;virtual&#160;machines&#160;are&#160;hosted&#160;simultaneously&#160;by&#160;a single virtualization&#160;layer.<br/>Furthermore,&#160;virtual&#160;machines&#160;are&#160;created&#160;and&#160;destroyed&#160;dynamically&#160;on&#160;demand.<br/>This&#160;results in&#160;a tree-like,&#160;dynamic&#160;structure&#160;of&#160;trust dependencies.&#160;<br/>A closely related problem concerns the&#160;limited&#160;capacity&#160;of&#160;the&#160;hardware&#160;TPM&#160;on&#160;the<br/>physical&#160;platform.&#160;A&#160;v1.2&#160;compliant&#160;TPM provides&#160;24&#160;dedicated&#160;registers&#160;for&#160;logging<br/>and tracking&#160;the&#160;platform&#160;state. This&#160;was&#160;deemed&#160;sufficient&#160;to&#160;support&#160;a single<br/>operating&#160;system,&#160;however,&#160;it can&#160;not&#160;cater&#160;for a multitude of&#160;(virtual)&#160;machines&#160;that<br/>can&#160;be created&#160;and&#160;destroyed&#160;during&#160;a&#160;single&#160;boot&#160;cycle of the hardware&#160;platform.&#160;<br/>Remote&#160;attestation&#160;should&#160;not&#160;only be&#160;supported&#160;for&#160;the hardware&#160;platform&#160;and&#160;the<br/>hypervisor&#160;layer,&#160;but&#160;ultimately&#160;for&#160;each&#160;hosted&#160;VM. To&#160;achieve this,&#160;we&#160;essentially<br/>need&#160;a&#160;dedicated&#160;'virtual'&#160;TPM&#160;for&#160;each&#160;VM instance.&#160;In theory,&#160;a&#160;physical&#160;TPM&#160;could<br/>be extended&#160;to&#160;directly support&#160;multiple&#160;concurrent&#160;VMs&#160;by&#160;multiplexing&#160;requests of<br/>several&#160;VMs&#160;while keeping track of their&#160;respective&#160;contexts.&#160;The&#160;set of additional<br/>functions&#160;and commands&#160;necessary&#160;have&#160;been specified&#160;by&#160;Goldman&#160;and&#160;Berger[1].<br/>The authors&#160;also&#160;describe&#160;functions&#160;supporting&#160;the migration&#160;of&#160;such&#160;contexts<br/>between different physical&#160;TPMs.&#160;This would&#160;effectively allow&#160;to&#160;relocate virtual TPM<br/>instances&#160;between&#160;different&#160;hosts.&#160;However,&#160;these&#160;suggestions&#160;have&#160;not&#160;yet been<br/>embraced&#160;by&#160;the&#160;TCG, and&#160;there&#160;exists&#160;no&#160;hardware&#160;TPM&#160;chip&#160;implementing&#160;the<br/>additional&#160;functionality&#160;and&#160;commands.&#160;In&#160;the remainder&#160;of&#160;this&#160;document,&#160;the<br/>expression&#160;“virtual&#160;TPM”&#160;refers&#160;only to&#160;TPM&#160;functionality&#160;that is realized&#160;as software&#160;or<br/>service.&#160;<br/>We&#160;briefly recapitulate&#160;the&#160;fundamental&#160;features&#160;that&#160;apply&#160;to&#160;hardware&#160;based&#160;TPMs<br/>as&#160;well as&#160;their virtualized&#160;counterparts&#160;here. A TPM has&#160;two&#160;main&#160;key pairs.&#160;The<br/>Endorsement&#160;Key (EK)&#160;represents the TPM’s&#160;identity,&#160;while the Storage&#160;Root&#160;Key&#160;(SRK)<br/>is used&#160;to&#160;encrypt&#160;other&#160;keys&#160;generated&#160;by&#160;the TPM&#160;(the encrypted blobs<br/>corresponding&#160;to&#160;these keys are stored&#160;outside&#160;the&#160;TPM). The&#160;TPM supports&#160;trusted or<br/>authenticated&#160;boot&#160;by&#160;allowing&#160;to&#160;record&#160;“measurements”&#160;of&#160;the hardware<br/>configuration&#160;and&#160;software&#160;stack executed&#160;during&#160;the&#160;boot process.&#160;These<br/>measurements&#160;(typically,&#160;the SHA-1 hash&#160;of executed binaries,&#160;scripts,&#160;or<br/>configuration&#160;files&#160;used)&#160;are&#160;stored&#160;in specific&#160;TPM&#160;registers&#160;called&#160;Platform<br/>Configuration&#160;Registers&#160;(PCRs).&#160;Adding&#160;a hash&#160;</p>
<p style="position:absolute;top:917px;left:473px;white-space:nowrap" class="ft611"><i>(m)</i></p>
<p style="position:absolute;top:917px;left:502px;white-space:nowrap" class="ft62">&#160;to a PCR is called&#160;</p>
<p style="position:absolute;top:917px;left:655px;white-space:nowrap" class="ft611"><i>extension.</i></p>
<p style="position:absolute;top:917px;left:741px;white-space:nowrap" class="ft62">&#160;It</p>
<p style="position:absolute;top:936px;left:85px;white-space:nowrap" class="ft62">requires to&#160;use the&#160;function&#160;</p>
<p style="position:absolute;top:936px;left:320px;white-space:nowrap" class="ft611"><i>TPM_Extend(i,&#160;m)</i></p>
<p style="position:absolute;top:936px;left:464px;white-space:nowrap" class="ft62">, which concatenates&#160;</p>
<p style="position:absolute;top:936px;left:644px;white-space:nowrap" class="ft611"><i>m</i></p>
<p style="position:absolute;top:936px;left:660px;white-space:nowrap" class="ft62">&#160;to the current</p>
<p style="position:absolute;top:956px;left:85px;white-space:nowrap" class="ft62">value of the&#160;</p>
<p style="position:absolute;top:956px;left:189px;white-space:nowrap" class="ft611"><i>i</i></p>
<p style="position:absolute;top:956px;left:193px;white-space:nowrap" class="ft62">-th PCR by computing&#160;a&#160;cumulative&#160;hash.&#160;</p>
<p style="position:absolute;top:984px;left:85px;white-space:nowrap" class="ft65">Based&#160;on these&#160;PCR&#160;values,&#160;the TPM&#160;provides&#160;a sealing&#160;functionality&#160;that&#160;binds<br/>encrypted&#160;data to&#160;the&#160;recorded&#160;configuration,&#160;and&#160;attestation,&#160;which reports&#160;the<br/>system&#160;state as&#160;recorded&#160;by the&#160;TPM&#160;to&#160;a&#160;(remote)&#160;party.&#160;For&#160;attestation,&#160;the function</p>
<p style="position:absolute;top:1041px;left:85px;white-space:nowrap" class="ft611"><i>TPM_Quote&#160;</i></p>
<p style="position:absolute;top:1041px;left:183px;white-space:nowrap" class="ft62">is&#160;employed,&#160;which presents&#160;the recorded&#160;PCR&#160;values&#160;signed&#160;by an</p>
<p style="position:absolute;top:1061px;left:85px;white-space:nowrap" class="ft611"><i>Attestation&#160;Identity Key (AIK)</i></p>
<p style="position:absolute;top:1061px;left:326px;white-space:nowrap" class="ft62">&#160;of the&#160;TPM.&#160;The AIK&#160;plays&#160;the role of&#160;a pseudonym&#160;of the</p>
<p style="position:absolute;top:1080px;left:85px;white-space:nowrap" class="ft65">TPM’s&#160;identity EK&#160;for privacy&#160;reasons.&#160;In&#160;order&#160;to enable&#160;other&#160;parties&#160;to verify&#160;the<br/>key's&#160;authenticity and its binding&#160;to a specific&#160;TPM,&#160;the AIK&#160;must&#160;be&#160;certified&#160;by&#160;a<br/>trusted third party&#160;called Privacy-CA.&#160;</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft67">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft67">6/48</p>
</div>
<!-- Page 7 -->
<a name="7"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page7-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42007.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft77">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft77">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft71"><b>2.1&#160;Background&#160;and&#160;State&#160;of&#160;the&#160;Art</b></p>
<p style="position:absolute;top:179px;left:85px;white-space:nowrap" class="ft75">Software&#160;implementations&#160;of&#160;the&#160;Trusted&#160;Platform&#160;Module&#160;(TPM)&#160;can&#160;be&#160;classified&#160;as<br/>software&#160;TPMs and&#160;virtual&#160;TPMs.&#160;</p>
<p style="position:absolute;top:198px;left:358px;white-space:nowrap" class="ft711"><i>Software&#160;TPMs&#160;</i></p>
<p style="position:absolute;top:198px;left:484px;white-space:nowrap" class="ft72">(or&#160;</p>
<p style="position:absolute;top:198px;left:513px;white-space:nowrap" class="ft711"><i>TPM emulators</i></p>
<p style="position:absolute;top:198px;left:636px;white-space:nowrap" class="ft72">) replicate&#160;TPM</p>
<p style="position:absolute;top:218px;left:85px;white-space:nowrap" class="ft75">functionality&#160;in&#160;platforms&#160;where&#160;no&#160;hardware&#160;TPM is available.&#160;Since no&#160;hardware<br/>support&#160;is provided,&#160;TPM emulators&#160;do&#160;not&#160;offer&#160;the level&#160;of security as&#160;required&#160;by&#160;the<br/>Trusted&#160;Computing&#160;Group&#160;(TCG)[2], and are&#160;therefore&#160;often&#160;used&#160;for&#160;testing&#160;purposes<br/>only.&#160;</p>
<p style="position:absolute;top:275px;left:131px;white-space:nowrap" class="ft711"><i>Virtual&#160;TPMs&#160;</i></p>
<p style="position:absolute;top:275px;left:238px;white-space:nowrap" class="ft72">utilize TPM&#160;emulators&#160;in&#160;ways&#160;to&#160;virtualize&#160;the&#160;underlying&#160;hardware</p>
<p style="position:absolute;top:294px;left:85px;white-space:nowrap" class="ft75">TPM.&#160;In particular,&#160;virtual&#160;TPMs&#160;are “anchored”&#160;to&#160;the&#160;hardware&#160;TPM in addition&#160;to<br/>using&#160;TPM emulators&#160;to&#160;provide&#160;the&#160;necessary&#160;TPM&#160;functionality.&#160;The level&#160;of<br/>involvement&#160;by&#160;the&#160;hardware&#160;TPM&#160;depends&#160;on&#160;the level&#160;of performance&#160;and&#160;security<br/>requirements.&#160;<br/>In [3],&#160;two&#160;types&#160;of virtual&#160;TPMs&#160;have&#160;been defined&#160;that observe&#160;a&#160;different&#160;mix&#160;of<br/>security&#160;and&#160;performance&#160;requirements.&#160;A&#160;</p>
<p style="position:absolute;top:399px;left:442px;white-space:nowrap" class="ft711"><i>software-based&#160;virtual&#160;TPM utilizes</i></p>
<p style="position:absolute;top:399px;left:730px;white-space:nowrap" class="ft72">&#160;the</p>
<p style="position:absolute;top:419px;left:85px;white-space:nowrap" class="ft75">hardware&#160;TPM&#160;for&#160;persistent&#160;storage&#160;only.&#160;In&#160;this&#160;setting,&#160;virtual&#160;TPM&#160;keys&#160;are loaded<br/>to&#160;the&#160;memory&#160;once&#160;such&#160;a&#160;virtual&#160;TPM&#160;is&#160;initialized.&#160;A&#160;</p>
<p style="position:absolute;top:438px;left:540px;white-space:nowrap" class="ft711"><i>hardware-based&#160;virtual TPM</i></p>
<p style="position:absolute;top:457px;left:85px;white-space:nowrap" class="ft711"><i>utilizes</i></p>
<p style="position:absolute;top:457px;left:143px;white-space:nowrap" class="ft72">&#160;the&#160;hardware&#160;TPM&#160;to permanently&#160;store&#160;the&#160;keys&#160;of virtual&#160;TPMs (i.e.&#160;virtual</p>
<p style="position:absolute;top:476px;left:85px;white-space:nowrap" class="ft75">TPM&#160;keys never leave the hardware&#160;TPM&#160;in&#160;clear-text).&#160;The former&#160;approach&#160;yields<br/>better&#160;performance&#160;as&#160;it&#160;does&#160;not&#160;use the&#160;underlying&#160;TPM&#160;once the&#160;keys are&#160;loaded.<br/>However,&#160;a system&#160;compromise&#160;can&#160;potentially&#160;reveal&#160;vTPM&#160;keys&#160;to malicious&#160;parties.<br/>The latter&#160;approach&#160;provides&#160;key protection&#160;at&#160;the&#160;expense&#160;of limited&#160;performance.&#160;<br/>Virtual&#160;TPM&#160;design&#160;elements&#160;comprise&#160;a&#160;TPM emulator&#160;and&#160;mechanisms&#160;that bind<br/>virtual&#160;TPMs to&#160;the&#160;underlying&#160;hardware&#160;TPM.&#160;The&#160;generalized&#160;TPM&#160;virtualization<br/>(GVTPM) design by&#160;Intel [3]&#160;mimics&#160;the&#160;hardware&#160;TPM design&#160;by replicating&#160;its<br/>components&#160;in software.&#160;GVTPM&#160;uses&#160;the&#160;underlying&#160;trusted virtual&#160;machine&#160;monitor<br/>(VMM)&#160;to isolate&#160;the processing&#160;units of&#160;each&#160;virtual&#160;TPM&#160;assigned&#160;to&#160;each&#160;virtual<br/>machine&#160;(VM).&#160;Further,&#160;hardware&#160;TPM-assisted&#160;protected storage&#160;is used&#160;to protect<br/>the&#160;virtual&#160;TPM non-volatile&#160;memory&#160;(NVRAM)&#160;and&#160;keys. In&#160;particular,&#160;the&#160;NVRAM can<br/>be&#160;restored&#160;and&#160;the&#160;keys&#160;can be&#160;used&#160;by a&#160;virtual&#160;TPM if&#160;and only&#160;if the platform,&#160;the<br/>GVTPM&#160;environment&#160;and&#160;the&#160;virtual TPM&#160;emulator&#160;are in the expected state.&#160;Between<br/>the two&#160;designs&#160;proposed&#160;in [3],&#160;the software-based&#160;prototype&#160;uses&#160;the&#160;hardware&#160;TPM<br/>only&#160;to restore&#160;the&#160;TPM&#160;state and&#160;load&#160;its keys&#160;into&#160;the memory.&#160;The&#160;hardware-based<br/>prototype extensively uses&#160;the hardware&#160;TPM&#160;for&#160;key&#160;storage&#160;at the&#160;expense&#160;of lower<br/>performance.&#160;A&#160;central&#160;management&#160;utility&#160;called the&#160;GVTPM&#160;manager&#160;and&#160;a&#160;virtual<br/>certificate&#160;authority&#160;manage&#160;the complete&#160;life-cycle of the&#160;virtual&#160;TPMs&#160;(e.g.&#160;creation,<br/>termination),&#160;the binding&#160;between&#160;virtual&#160;TPMs&#160;and&#160;VMs,&#160;and&#160;virtual&#160;TPM&#160;keys.<br/>The GVTPM&#160;design&#160;in [3]&#160;lacks mechanisms&#160;for&#160;virtual&#160;TPM&#160;migration&#160;which&#160;can be&#160;of<br/>importance,&#160;for&#160;example,&#160;in&#160;a data&#160;center where&#160;VMs&#160;can be&#160;migrated&#160;frequently&#160;in-<br/>line with&#160;customer&#160;requirements.&#160;A functional&#160;requirement&#160;for&#160;a&#160;migration&#160;service&#160;is to<br/>migrate&#160;the virtual&#160;TPM instance&#160;along&#160;with&#160;its VM&#160;counterpart.&#160;The&#160;main&#160;challenges&#160;in<br/>doing&#160;so&#160;are&#160;(1)&#160;preserving&#160;the&#160;association&#160;between&#160;the VM and&#160;the&#160;virtual TPM and<br/>(2)&#160;transferring&#160;the virtual&#160;TPM&#160;state&#160;(e.g.&#160;NVRAM&#160;contents,&#160;keys,&#160;authorisation<br/>sessions)&#160;in&#160;a&#160;confidential&#160;and&#160;integrity-preserving&#160;way.&#160;<br/>The virtual&#160;TPM&#160;design&#160;provided&#160;by IBM&#160;in [1]&#160;observes&#160;these&#160;requirements&#160;in&#160;addition<br/>to the&#160;life-cycle&#160;and&#160;key management&#160;requirements&#160;described&#160;above.&#160;The main&#160;design<br/>element&#160;there is&#160;the&#160;virtual TPM&#160;manager&#160;that&#160;orchestrates&#160;various virtual TPM<br/>instances&#160;that&#160;run&#160;in the privileged&#160;domain (e.g.&#160;management&#160;VM) on&#160;a&#160;virtualized<br/>platform.&#160;This&#160;entity&#160;manages&#160;the life-cycle&#160;of&#160;&#160;these instances&#160;and keeps&#160;record&#160;of<br/>their VM&#160;associations&#160;and&#160;key hierarchies.&#160;Each&#160;virtual&#160;TPM&#160;instance&#160;is&#160;anchored&#160;to the<br/>underlying&#160;platform&#160;using&#160;two sets of integrity measurements:&#160;A&#160;(read-only)&#160;lower&#160;set</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft77">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft77">7/48</p>
</div>
<!-- Page 8 -->
<a name="8"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page8-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42008.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft87">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft87">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft85">of PCRs&#160;that&#160;mirrors&#160;the&#160;underlying&#160;hardware&#160;TPM&#160;measurements,&#160;and&#160;a&#160;(read/extend)<br/>higher&#160;set of PCRs&#160;for&#160;further&#160;measurements&#160;regarding&#160;the corresponding&#160;VM. The<br/>authors&#160;also&#160;present&#160;various&#160;alternatives&#160;for&#160;virtual&#160;TPM&#160;certificates&#160;that&#160;can be&#160;used<br/>to&#160;vouch&#160;for&#160;the underlying&#160;platform&#160;configuration&#160;in&#160;addition&#160;to&#160;the&#160;corresponding&#160;VM<br/>configuration.<br/>In [4],&#160;secure&#160;virtual&#160;TPM&#160;migration&#160;is enabled&#160;via&#160;a communication&#160;protocol&#160;between<br/>source&#160;and destination&#160;virtual&#160;TPM managers&#160;that&#160;transmit&#160;sensitive&#160;virtual&#160;TPM<br/>information&#160;(i.e. the virtual&#160;TPM&#160;state)&#160;in&#160;encrypted&#160;form.&#160;The protocol&#160;guarantees&#160;the<br/>uniqueness&#160;and integrity of the&#160;migrated&#160;virtual&#160;TPM&#160;by making&#160;use&#160;of a nonce&#160;and a<br/>digest,&#160;respectively.&#160;However,&#160;difficulties&#160;arise&#160;with virtual&#160;TPM&#160;certificates&#160;as<br/>migration&#160;breaks&#160;the&#160;link between the&#160;migrated instance&#160;and the underlying&#160;platform.<br/>Another&#160;shortcoming&#160;of&#160;the&#160;architecture&#160;is&#160;that&#160;the virtual&#160;TPM&#160;instances&#160;all run&#160;in&#160;the<br/>same&#160;privileged&#160;domain.&#160;An alternative&#160;setting,&#160;in&#160;which&#160;each instance&#160;resides&#160;in a<br/>separate&#160;compartment&#160;(as&#160;in [5]&#160;and&#160;[6]),&#160;can potentially&#160;provide&#160;better&#160;separation&#160;of<br/>resources&#160;compared&#160;to&#160;this approach.<br/>In [4],&#160;secure&#160;migration&#160;is coordinated&#160;by peer virtual&#160;TPM managers&#160;that&#160;reside in<br/>“service&#160;domains”&#160;of&#160;the source&#160;and&#160;target&#160;platforms.&#160;Similar&#160;to&#160;[1],&#160;the locked and<br/>encrypted&#160;virtual TPM&#160;state&#160;that&#160;includes&#160;virtual&#160;TPM&#160;authorisation&#160;data, VM&#160;certificate<br/>store&#160;and&#160;security policies&#160;is&#160;transmitted&#160;to the&#160;target&#160;platform&#160;alongside&#160;the migrated<br/>VM. &#160;This way the strong&#160;binding&#160;between&#160;the virtual&#160;TPM&#160;and&#160;the VM&#160;is preserved.<br/>The design&#160;also&#160;employs&#160;virtual&#160;TPM&#160;capabilities&#160;such&#160;as virtual&#160;attestation&#160;identity<br/>keys&#160;(AIKs)&#160;that&#160;provide&#160;a&#160;strong&#160;VM&#160;identity&#160;coupled with&#160;a weak&#160;identity&#160;(i.e. a&#160;vAIK<br/>label),&#160;which is&#160;useful&#160;in identifying&#160;the&#160;VM&#160;in security policies.&#160;During&#160;migration&#160;the<br/>VM&#160;identity is implicitly migrated&#160;with the virtual&#160;TPM&#160;state.<br/>In&#160;all&#160;previous&#160;designs&#160;virtual&#160;TPM&#160;instances&#160;reside&#160;on&#160;the&#160;same&#160;privileged&#160;domain<br/>along&#160;with&#160;the&#160;management&#160;entity.&#160;An&#160;alternative&#160;is&#160;to&#160;disaggregate&#160;these&#160;instances<br/>onto&#160;separate&#160;domains&#160;for&#160;better&#160;resource separation.&#160;In [6],&#160;the virtual&#160;TPM&#160;instances<br/>are&#160;coordinated&#160;using&#160;a management&#160;VM&#160;as&#160;before.&#160;However,&#160;each virtual&#160;TPM<br/>instance&#160;resides&#160;in a&#160;separate&#160;small&#160;compartment&#160;and&#160;the&#160;binding&#160;between&#160;these<br/>instances&#160;and&#160;VMs is&#160;orchestrated&#160;by the&#160;management&#160;VM.&#160;This central&#160;authority&#160;also<br/>provides&#160;a&#160;signed&#160;secure&#160;audit&#160;for&#160;the&#160;VM-virtual&#160;TPM&#160;pair.&#160;This audit&#160;includes the<br/>integrity&#160;measurements&#160;of the VM&#160;and&#160;virtual&#160;TPM&#160;images,&#160;plus&#160;the underlying<br/>platform&#160;configuration.&#160;This&#160;information&#160;is&#160;then used to&#160;obtain a&#160;certificate from&#160;a<br/>Trust Authority&#160;that&#160;can vouch&#160;for&#160;the&#160;(virtual)&#160;platform&#160;integrity.&#160;Migration is again&#160;an<br/>open problem&#160;problem&#160;as&#160;it&#160;invalidates&#160;the&#160;signed&#160;digests.&#160;Another&#160;solution&#160;is<br/>presented&#160;in [5],&#160;in&#160;which&#160;each&#160;virtual&#160;TPM&#160;instance&#160;runs&#160;on&#160;a&#160;MiniOS&#160;domain.<br/>As for&#160;implementation,&#160;a Xen-based&#160;virtual&#160;TPM&#160;prototype&#160;has&#160;been&#160;introduced that<br/>enables&#160;VMs&#160;to&#160;gain&#160;access to&#160;virtual&#160;TPM&#160;instances of their&#160;own&#160;[7][8]. The&#160;design&#160;is<br/>based&#160;on&#160;the&#160;Intel [3]&#160;and&#160;IBM&#160;[1]&#160;virtual&#160;TPM&#160;designs.&#160;In&#160;particular,&#160;a&#160;centralised<br/>virtual&#160;TPM&#160;manager&#160;sits&#160;in the&#160;management&#160;domain&#160;(i.e.&#160;Dom0) of the&#160;Xen&#160;platform.<br/>This&#160;entity coordinates&#160;the&#160;life-cycle&#160;of the&#160;virtual&#160;TPM instances&#160;and&#160;their&#160;associations<br/>with&#160;the&#160;VMs.&#160;All virtual&#160;TPM&#160;instances&#160;reside&#160;in&#160;Dom0.&#160;The&#160;communication&#160;between<br/>the instances&#160;and&#160;the&#160;VMs&#160;are&#160;enabled&#160;using the&#160;Xen&#160;split&#160;driver&#160;model [7][8]. This<br/>prototype&#160;is still&#160;in&#160;the development&#160;phase&#160;and&#160;does&#160;not&#160;provide&#160;mechanisms&#160;to<br/>anchor&#160;virtual&#160;TPMs to&#160;the&#160;underlying&#160;hardware&#160;TPM.&#160;Therefore,&#160;Xen virtual&#160;TPMs are<br/>closer&#160;to TPM emulators that&#160;true virtual TPMs.&#160;</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft87">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft87">8/48</p>
</div>
<!-- Page 9 -->
<a name="9"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft913{font-size:14px;font-family:IHIOAJ+OpenSymbol;color:#000000;}
-->
</style>
<div id="page9-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42009.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft97">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft97">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft91"><b>2.2&#160;Types&#160;of&#160;Virtual&#160;TPMs</b></p>
<p style="position:absolute;top:179px;left:85px;white-space:nowrap" class="ft95">Summarizing&#160;the&#160;discussion&#160;in the previous&#160;section,&#160;there&#160;are&#160;three&#160;principle&#160;ways&#160;to<br/>implement virtual TPMs:</p>
<p style="position:absolute;top:230px;left:112px;white-space:nowrap" class="ft913">●</p>
<p style="position:absolute;top:227px;left:139px;white-space:nowrap" class="ft91"><b>Providing&#160;vTPM Functionality&#160;as&#160;Shared&#160;Service:</b></p>
<p style="position:absolute;top:227px;left:592px;white-space:nowrap" class="ft92">&#160;This&#160;model&#160;corresponds</p>
<p style="position:absolute;top:246px;left:139px;white-space:nowrap" class="ft95">to&#160;the&#160;current&#160;implementation&#160;in&#160;Xen&#160;[7]&#160;described&#160;in the&#160;next section.&#160;All<br/>Virtual&#160;TPM&#160;instances&#160;are&#160;implemented&#160;by one dedicated&#160;vTPM&#160;service&#160;(the<br/>vTPM_manager&#160;daemon)&#160;hosted in Xen domain0.&#160;The&#160;service&#160;directs TPM<br/>requests&#160;to&#160;the right&#160;vTPM&#160;instance&#160;in a&#160;multi-threaded&#160;manner.&#160;The states&#160;and<br/>secret data&#160;of&#160;all&#160;virtual&#160;TPM&#160;reside in the memory&#160;space of the central&#160;vTPM<br/>service,&#160;which is&#160;responsible&#160;for&#160;protecting&#160;the&#160;secret&#160;data. The&#160;vTPM&#160;service&#160;is<br/>also responsible&#160;for&#160;forwarding&#160;the&#160;reply&#160;to&#160;the&#160;right&#160;caller.&#160;In&#160;this&#160;model,<br/>compromising&#160;the&#160;vTPM&#160;service&#160;could&#160;result&#160;in&#160;compromised&#160;vTPMs&#160;and/or&#160;the<br/>binding&#160;between&#160;a vTPM&#160;and&#160;its corresponding&#160;VM&#160;to&#160;be broken.</p>
<p style="position:absolute;top:431px;left:112px;white-space:nowrap" class="ft913">●</p>
<p style="position:absolute;top:428px;left:139px;white-space:nowrap" class="ft91"><b>In-Guest&#160;Implementation&#160;of&#160;vTPMs:&#160;</b></p>
<p style="position:absolute;top:428px;left:474px;white-space:nowrap" class="ft92">This approach&#160;uses&#160;the kernel&#160;of&#160;the</p>
<p style="position:absolute;top:447px;left:139px;white-space:nowrap" class="ft95">virtual&#160;machine&#160;as the&#160;execution environment for the&#160;vTPM&#160;to provide&#160;vTPM<br/>functionality&#160;to&#160;applications&#160;running&#160;in&#160;a&#160;virtualized&#160;guest&#160;operating&#160;system.<br/>With&#160;regard&#160;to&#160;separating&#160;states and secrets&#160;of&#160;multiple concurrent&#160;vTPM<br/>instances&#160;from&#160;each&#160;other,&#160;it&#160;provides&#160;a better&#160;isolation&#160;than&#160;a&#160;central&#160;service<br/>(the&#160;level of isolation&#160;is similar&#160;to&#160;that&#160;of&#160;different&#160;VMs).&#160;However,&#160;it&#160;is<br/>impossible&#160;to&#160;protect&#160;vTPM&#160;secrets&#160;from&#160;the kernel&#160;itself.&#160;It is also hard to<br/>protect&#160;it from&#160;users&#160;with&#160;root&#160;privileges.&#160;An in-guest-implementation&#160;would<br/>have&#160;to guarantee&#160;that&#160;even&#160;administrators&#160;can&#160;not access&#160;vTPM&#160;secrets.&#160;This<br/>requirement&#160;that can only&#160;be met by hardened&#160;operating&#160;systems.&#160;but&#160;even<br/>with&#160;a&#160;hardened guest&#160;OS, there&#160;remains&#160;a&#160;conceptual&#160;difficulty&#160;with&#160;this<br/>approach.&#160;Trusted&#160;Computing&#160;as defined&#160;by the TCG&#160;assumes&#160;software&#160;to&#160;be<br/>measured&#160;</p>
<p style="position:absolute;top:658px;left:227px;white-space:nowrap" class="ft911"><i>before</i></p>
<p style="position:absolute;top:658px;left:281px;white-space:nowrap" class="ft92">&#160;it&#160;is executed. An in-guest&#160;implementation,&#160;on the&#160;other&#160;hand,</p>
<p style="position:absolute;top:677px;left:139px;white-space:nowrap" class="ft95">depends on the kernel&#160;and vTPM&#160;service&#160;being executed before&#160;the&#160;first value<br/>can&#160;be logged&#160;into&#160;a vTPM&#160;register.&#160;</p>
<p style="position:absolute;top:728px;left:112px;white-space:nowrap" class="ft913">●</p>
<p style="position:absolute;top:725px;left:139px;white-space:nowrap" class="ft91"><b>Disaggregated&#160;vTPMs</b></p>
<p style="position:absolute;top:725px;left:342px;white-space:nowrap" class="ft92">:&#160;This&#160;model assumes&#160;each virtual TPM to run&#160;in&#160;its</p>
<p style="position:absolute;top:744px;left:139px;white-space:nowrap" class="ft95">own,&#160;dedicated&#160;virtual&#160;machine.&#160;While a&#160;full-blown&#160;operating&#160;system&#160;could&#160;be<br/>used to host the&#160;vTPM,&#160;it&#160;is&#160;preferable&#160;to&#160;implement&#160;it&#160;as&#160;a hypervisor&#160;thread&#160;or<br/>task that&#160;runs&#160;directly&#160;on&#160;top of the&#160;virtual&#160;machine&#160;monitor&#160;(VMM).&#160;On L4, this<br/>would&#160;be&#160;implemented&#160;as&#160;a&#160;microkernel&#160;task.&#160;For&#160;Xen,&#160;a&#160;miniOS&#160;based<br/>implementation&#160;can&#160;be&#160;used&#160;[5].&#160;In both&#160;cases,&#160;the vTPM&#160;security&#160;interface<br/>should&#160;be&#160;minimal&#160;and&#160;prevent&#160;attacks on&#160;secrets&#160;and&#160;sensitive internal&#160;states<br/>(for&#160;details see&#160;Section&#160;5.2).&#160;For&#160;generating&#160;and&#160;protecting&#160;individual<br/>cryptographic&#160;keys,&#160;vTPM&#160;instances&#160;may&#160;implement&#160;different&#160;strategies.&#160;For<br/>instance,&#160;keys can&#160;be generated&#160;as software&#160;keys in&#160;the vTPM&#160;and&#160;protected&#160;by<br/>software&#160;mechanisms.&#160;Alternatively,&#160;the vTPM&#160;could&#160;delegate&#160;the&#160;key<br/>generation&#160;and&#160;protection&#160;to&#160;a&#160;physical&#160;security&#160;module,&#160;e.g.,&#160;the&#160;hardware<br/>TPM.</p>
<p style="position:absolute;top:983px;left:85px;white-space:nowrap" class="ft95">Disaggregation&#160;provides&#160;better&#160;isolation&#160;between vTPM&#160;instances&#160;than a&#160;centralized<br/>service.&#160;The&#160;vTPM&#160;is&#160;protected&#160;from&#160;its corresponding&#160;virtual&#160;machine,&#160;and<br/>compromised&#160;or&#160;malfunctioning&#160;vTPM&#160;does not have&#160;an&#160;impact&#160;on&#160;other&#160;vTPM<br/>instances.&#160;&#160;Our&#160;working&#160;hypothesis&#160;is that&#160;the disaggregated&#160;model&#160;combines&#160;the<br/>advantages of&#160;the&#160;service and&#160;in&#160;guest&#160;model&#160;while&#160;avoiding&#160;their&#160;drawbacks.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft97">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft97">9/48</p>
</div>
<!-- Page 10 -->
<a name="10"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft1014{font-size:16px;font-family:CourierNewPSMT;color:#000000;}
	.ft1015{font-size:15px;font-family:IHILJB+BitstreamVeraSans;color:#000000;}
-->
</style>
<div id="page10-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42010.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft107">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft107">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:172px;left:85px;white-space:nowrap" class="ft109"><b>3&#160;</b></p>
<p style="position:absolute;top:169px;left:117px;white-space:nowrap" class="ft1010"><b>Review of&#160;current architectures</b></p>
<p style="position:absolute;top:217px;left:85px;white-space:nowrap" class="ft101"><b>3.1&#160;Virtual&#160;TPMs&#160;on Xen</b></p>
<p style="position:absolute;top:245px;left:85px;white-space:nowrap" class="ft105">Virtual&#160;TPM&#160;support&#160;on&#160;Xen&#160;has been&#160;described&#160;by Berger&#160;et al.[1]. In&#160;their<br/>architecture,&#160;the&#160;virtual&#160;TPM&#160;consists&#160;of&#160;a&#160;vTPM&#160;root&#160;service which&#160;can&#160;spawn and<br/>manage&#160;new vTPM&#160;child&#160;instances.&#160;<br/>As with&#160;all other&#160;physical&#160;devices&#160;under&#160;Xen,&#160;TPM&#160;device&#160;access is provided&#160;to guests<br/>domains&#160;(VMs)&#160;through&#160;a&#160;split front&#160;end&#160;/ back&#160;end&#160;device driver&#160;pair.&#160;In&#160;the&#160;guest<br/>domain,&#160;the front&#160;end&#160;driver&#160;appears as&#160;the standard&#160;Linux&#160;</p>
<p style="position:absolute;top:350px;left:582px;white-space:nowrap" class="ft1011"><i>/dev/tpm0</i></p>
<p style="position:absolute;top:350px;left:667px;white-space:nowrap" class="ft102">&#160;device.&#160;The</p>
<p style="position:absolute;top:369px;left:85px;white-space:nowrap" class="ft105">corresponding&#160;back end&#160;driver&#160;is part&#160;of&#160;Xen&#160;domain0,&#160;a privileged&#160;virtual&#160;domain&#160;that<br/>controls&#160;all hardware&#160;devices, and&#160;appears&#160;as&#160;a&#160;device&#160;named&#160;</p>
<p style="position:absolute;top:394px;left:608px;white-space:nowrap" class="ft1014">/dev/vtpm</p>
<p style="position:absolute;top:389px;left:697px;white-space:nowrap" class="ft102">. The front</p>
<p style="position:absolute;top:409px;left:85px;white-space:nowrap" class="ft102">end&#160;and&#160;back end&#160;of&#160;the driver&#160;interact&#160;through&#160;Xen’s&#160;standard&#160;</p>
<p style="position:absolute;top:409px;left:615px;white-space:nowrap" class="ft1011"><i>xenbus</i></p>
<p style="position:absolute;top:409px;left:675px;white-space:nowrap" class="ft102">&#160;device</p>
<p style="position:absolute;top:428px;left:85px;white-space:nowrap" class="ft105">communication&#160;bus.&#160;<br/>The vTPM&#160;root&#160;instance&#160;is&#160;implemented&#160;as&#160;a&#160;user&#160;space&#160;process&#160;in&#160;Xen&#160;domain0.&#160;It<br/>multiplexes&#160;access to&#160;the&#160;hardware&#160;TPM,&#160;implementing&#160;the standard&#160;TPM&#160;1.2<br/>command&#160;set&#160;plus&#160;a small&#160;number&#160;of extended&#160;commands&#160;to manage&#160;new&#160;vTPM&#160;child<br/>instances&#160;and&#160;to&#160;migrate&#160;vTPMs&#160;and&#160;their keys.&#160;<br/>The&#160;values&#160;of&#160;the low-order&#160;PCRs&#160;(0-8)&#160;are&#160;mapped&#160;through&#160;directly from the&#160;hardware<br/>TPM&#160;to&#160;all&#160;of&#160;the virtual&#160;TPM&#160;instances.&#160;They&#160;are&#160;read-only in the corresponding&#160;guest<br/>domains.&#160;The&#160;high-order&#160;PCRs&#160;(9-15)&#160;of&#160;a&#160;vTPM&#160;are available&#160;for&#160;the corresponding<br/>guest&#160;domain&#160;to record&#160;integrity&#160;measurements.&#160;This&#160;arrangement&#160;permits&#160;remote<br/>attestors&#160;access&#160;to&#160;PCR&#160;register&#160;values&#160;in&#160;the&#160;underlying&#160;hardware&#160;TPM&#160;in order&#160;to<br/>verify&#160;the&#160;integrity&#160;of the&#160;hypervisor&#160;and&#160;the&#160;vTPM&#160;itself as&#160;well&#160;as&#160;the&#160;integrity&#160;of the<br/>guest&#160;virtual&#160;machine.&#160;<br/>Anderson&#160;et&#160;al. [5] realize the implementation&#160;of vTPM&#160;instances&#160;as isolated&#160;domains<br/>instead&#160;of running&#160;all&#160;vTPMs&#160;in&#160;one&#160;privileged&#160;VM.&#160;Except&#160;for&#160;the&#160;implementation,&#160;they<br/>provide&#160;no&#160;new aspects&#160;of the&#160;vTPM,&#160;but&#160;refer&#160;to [1].&#160;<br/>GvTPM&#160;[3]&#160;is&#160;an&#160;architectural&#160;framework&#160;that&#160;supports&#160;various&#160;TPM&#160;models&#160;and<br/>different&#160;security profiles&#160;for&#160;each&#160;VM&#160;under the Xen&#160;hypervisor&#160;[9].&#160;The&#160;authors<br/>discuss&#160;both&#160;a software-based&#160;and&#160;hardware-based&#160;vTPM&#160;model.&#160;The former<br/>generates&#160;and&#160;uses&#160;cryptographic&#160;keys&#160;entirely in software,&#160;whereas the latter&#160;uses<br/>the keys&#160;of the physical&#160;TPM.&#160;GvTPM&#160;is&#160;not limited&#160;to TPM&#160;functionality&#160;and may&#160;be<br/>generalized&#160;to any&#160;security&#160;co-processor.&#160;</p>
<p style="position:absolute;top:894px;left:85px;white-space:nowrap" class="ft101"><b>3.2&#160;Virtual&#160;TPMs&#160;on L4&#160;</b></p>
<p style="position:absolute;top:941px;left:85px;white-space:nowrap" class="ft1015"><b>3.2.1&#160;TPM&#160;Drivers&#160;</b></p>
<p style="position:absolute;top:967px;left:85px;white-space:nowrap" class="ft105">Basic&#160;TPM&#160;access&#160;on&#160;L4&#160;is provided&#160;by&#160;the STPM&#160;service that&#160;has&#160;been&#160;developed&#160;by<br/>TUD.&#160;In&#160;essence,&#160;STPM&#160;is&#160;a&#160;TPM&#160;driver&#160;with&#160;a&#160;generic&#160;interface&#160;that&#160;abstracts&#160;all&#160;I/O to<br/>the&#160;TPM&#160;of the underlying&#160;platform&#160;hardware.&#160;It supports&#160;a&#160;variety&#160;of older&#160;version<br/>1.1b&#160;TPMs as&#160;well as&#160;all version 1.2 TPMs&#160;that&#160;are compatible&#160;to the TPM&#160;PC&#160;Client<br/>Interface&#160;Specification&#160;[10].&#160;The&#160;interface&#160;offered&#160;to&#160;the&#160;clients is similar&#160;to&#160;a Linux<br/>character&#160;device,&#160;hence&#160;expects a&#160;raw TPM&#160;command&#160;blob&#160;as&#160;input.&#160;This also&#160;applies<br/>to&#160;TPM&#160;responses,&#160;which&#160;are&#160;relayed to&#160;the&#160;client&#160;as&#160;an&#160;uninterpreted&#160;byte&#160;array.<br/>Although STPM can&#160;support&#160;multiple&#160;clients,&#160;it&#160;does virtualize&#160;a&#160;hardware&#160;TPM&#160;(i.e.,&#160;all</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft107">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft107">10/48</p>
</div>
<!-- Page 11 -->
<a name="11"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page11-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42011.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft117">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft117">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft115">clients&#160;must&#160;cooperate&#160;in&#160;order&#160;to&#160;safely&#160;share&#160;the physical&#160;TPM).&#160;Nevertheless,&#160;the<br/>STPM&#160;service&#160;is the basis&#160;for&#160;TPM&#160;access&#160;on&#160;L4&#160;on&#160;which&#160;higher-level&#160;software&#160;layers<br/>built&#160;upon.&#160;</p>
<p style="position:absolute;top:236px;left:85px;white-space:nowrap" class="ft1115"><b>3.2.2&#160;Minimalist TPM Multiplexer&#160;”Lyon”&#160;</b></p>
<p style="position:absolute;top:262px;left:85px;white-space:nowrap" class="ft115">The TCG&#160;specified the&#160;Trusted&#160;Software&#160;Stack&#160;(TSS)&#160;&#160;as&#160;a&#160;convenient&#160;standard&#160;API&#160;for<br/>accessing&#160;TPM&#160;functionality.&#160;The TSS multiplexes&#160;the limited&#160;resources&#160;of the<br/>underlying&#160;TPM so as&#160;to allow concurrent&#160;access&#160;by multiple&#160;applications.&#160;Examples<br/>for&#160;such a TSS&#160;are&#160;</p>
<p style="position:absolute;top:320px;left:241px;white-space:nowrap" class="ft1111"><i>TrouSerS&#160;[11]&#160;</i></p>
<p style="position:absolute;top:320px;left:361px;white-space:nowrap" class="ft112">and Infineon’s&#160;</p>
<p style="position:absolute;top:320px;left:483px;white-space:nowrap" class="ft1111"><i>IFX-TSS [12]</i></p>
<p style="position:absolute;top:320px;left:585px;white-space:nowrap" class="ft112">.&#160;However,&#160;these&#160;TSS</p>
<p style="position:absolute;top:339px;left:85px;white-space:nowrap" class="ft115">implementations&#160;are&#160;quite&#160;complex,&#160;supporting&#160;hundreds&#160;of&#160;API&#160;functions&#160;that&#160;have<br/>not been ported&#160;to&#160;run&#160;directly&#160;on&#160;the L4&#160;platform.&#160;Instead,&#160;we&#160;decided&#160;to&#160;implement&#160;a<br/>TPM&#160;multiplexer&#160;service called&#160;</p>
<p style="position:absolute;top:377px;left:343px;white-space:nowrap" class="ft1111"><i>Lyon</i></p>
<p style="position:absolute;top:377px;left:382px;white-space:nowrap" class="ft112">&#160;that&#160;provides&#160;just the&#160;most&#160;basic&#160;functionality&#160;as</p>
<p style="position:absolute;top:397px;left:85px;white-space:nowrap" class="ft112">detailed&#160;in the&#160;following:&#160;</p>
<p style="position:absolute;top:428px;left:112px;white-space:nowrap" class="ft1113">●</p>
<p style="position:absolute;top:425px;left:139px;white-space:nowrap" class="ft112">Sealed&#160;storage&#160;similar&#160;to&#160;</p>
<p style="position:absolute;top:425px;left:351px;white-space:nowrap" class="ft1111"><i>TPM_Seal()&#160;</i></p>
<p style="position:absolute;top:425px;left:447px;white-space:nowrap" class="ft112">and&#160;</p>
<p style="position:absolute;top:425px;left:483px;white-space:nowrap" class="ft1111"><i>TPM_Unseal()&#160;</i></p>
<p style="position:absolute;top:456px;left:112px;white-space:nowrap" class="ft1113">●</p>
<p style="position:absolute;top:453px;left:139px;white-space:nowrap" class="ft112">Attestation&#160;of the&#160;platform&#160;state&#160;based&#160;on&#160;</p>
<p style="position:absolute;top:453px;left:493px;white-space:nowrap" class="ft1111"><i>TPM_Quote()&#160;</i></p>
<p style="position:absolute;top:484px;left:112px;white-space:nowrap" class="ft1113">●</p>
<p style="position:absolute;top:481px;left:139px;white-space:nowrap" class="ft112">A&#160;</p>
<p style="position:absolute;top:481px;left:156px;white-space:nowrap" class="ft1111"><i>TPM_Extend()</i></p>
<p style="position:absolute;top:486px;left:269px;white-space:nowrap" class="ft1114">-</p>
<p style="position:absolute;top:481px;left:279px;white-space:nowrap" class="ft112">like function&#160;that allows&#160;to&#160;report&#160;measurements.&#160;</p>
<p style="position:absolute;top:510px;left:85px;white-space:nowrap" class="ft115">This&#160;API&#160;was&#160;found&#160;sufficient&#160;for providing&#160;the&#160;essential&#160;set of&#160;Trusted&#160;Computing<br/>related&#160;functions&#160;required&#160;by&#160;most&#160;applications.&#160;In&#160;particular,&#160;it&#160;supports&#160;to&#160;build<br/>simple&#160;and lightweight&#160;applications&#160;on&#160;top without unduly&#160;burdening&#160;the&#160;underlying</p>
<p style="position:absolute;top:568px;left:85px;white-space:nowrap" class="ft1111"><i>Lyon</i></p>
<p style="position:absolute;top:568px;left:125px;white-space:nowrap" class="ft112">&#160;service&#160;with&#160;unnecessary&#160;Trusted&#160;Computing&#160;functionality.&#160;Importantly,&#160;the</p>
<p style="position:absolute;top:587px;left:85px;white-space:nowrap" class="ft115">interface&#160;is powerful&#160;enough&#160;to enable&#160;richer&#160;APIs&#160;on&#160;top&#160;of&#160;it,&#160;including&#160;a&#160;software-<br/>implemented&#160;virtual&#160;TPM&#160;that&#160;could&#160;be used&#160;by&#160;legacy&#160;software.<br/>The OpenTC&#160;Basic&#160;Management&#160;and&#160;Security Interface&#160;(BMSI) was designed&#160;with<br/>similar complexity considerations&#160;in&#160;mind.&#160;We&#160;could&#160;therefore&#160;reuse&#160;Lyon&#160;as a back-<br/>end&#160;for&#160;the&#160;L4 implementation&#160;of&#160;the BMSI.&#160;</p>
<p style="position:absolute;top:719px;left:85px;white-space:nowrap" class="ft111"><b>3.3&#160;Current&#160;Limitations&#160;</b></p>
<p style="position:absolute;top:747px;left:85px;white-space:nowrap" class="ft115">The approach&#160;of&#160;mapping&#160;the lower&#160;PCRs&#160;of the hardware&#160;TPM&#160;to&#160;the virtual&#160;PCRs&#160;of<br/>the vTPM&#160;[1]&#160;is limited with&#160;regard&#160;to&#160;support&#160;migrating&#160;a VM&#160;and its corresponding<br/>vTPM.&#160;Migration&#160;is currently&#160;only possible&#160;between platforms&#160;that&#160;are&#160;exactly identical<br/>with&#160;regard&#160;to&#160;their hardware&#160;and&#160;hypervisor.&#160;Migrating&#160;to a platform&#160;with&#160;different<br/>hardware&#160;or&#160;hypervisor&#160;would&#160;render&#160;data&#160;sealed&#160;to the vTPM&#160;inaccessible:&#160;although<br/>the new target&#160;platform&#160;might provide&#160;identical security&#160;properties&#160;as the&#160;original&#160;one,<br/>the integrity&#160;metrics&#160;would differ.&#160;This is a&#160;quite&#160;severe&#160;limitation&#160;for migrating&#160;virtual<br/>platforms.<br/>The approach&#160;described&#160;in&#160;[1]&#160;also&#160;lacks&#160;differentiated&#160;strategies for key&#160;generation<br/>and&#160;usage.&#160;Some&#160;IT&#160;environments&#160;demand&#160;cryptographic&#160;keys to be&#160;generated&#160;and<br/>protected&#160;by&#160;the hardware&#160;TPM while some&#160;VMs&#160;would&#160;benefit&#160;from&#160;the&#160;performance<br/>improvement&#160;of&#160;using&#160;software&#160;protected keys.&#160;Some&#160;VMs might&#160;be migratable&#160;while<br/>others must&#160;not&#160;be&#160;migrated.&#160;For instance,&#160;GVTPM&#160;[3]&#160;realizes&#160;flexible&#160;key types&#160;with<br/>different&#160;vTPM&#160;models.&#160;However,&#160;the decision&#160;on&#160;which&#160;model&#160;to use&#160;when&#160;the&#160;vTPM<br/>instance&#160;is created&#160;and&#160;assigned&#160;to&#160;a&#160;VM has to be&#160;taken at&#160;instantiation&#160;time.&#160;This<br/>decision&#160;can&#160;not&#160;be&#160;changed&#160;later,&#160;for example,&#160;when&#160;the&#160;policy&#160;of&#160;the IT environment<br/>changes.&#160;<br/>Finally,&#160;by emulating&#160;the functionality&#160;and&#160;behavior&#160;of&#160;the&#160;real&#160;TPM,&#160;a virtual&#160;TPM also<br/>inherits&#160;limitations&#160;of the hardware&#160;TPM&#160;itself,&#160;for&#160;instance,&#160;sealing&#160;and&#160;attestation&#160;to</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft117">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft117">11/48</p>
</div>
<!-- Page 12 -->
<a name="12"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page12-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42012.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft127">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft127">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft125">hash&#160;values&#160;of&#160;binary&#160;program&#160;files (binary&#160;attestation&#160;and&#160;sealing).&#160;One&#160; consequence<br/>of this&#160;is,&#160;for instance, that&#160;the&#160;VM&#160;can&#160;not access&#160;cryptographic&#160;keys&#160;and&#160;the data<br/>protected&#160;by&#160;those keys of&#160;the (v)TPM&#160;anymore&#160;after&#160;performing&#160;an&#160;authorized&#160;update<br/>of&#160;software&#160;since the integrity&#160;measurement&#160;values&#160;have&#160;changed.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft127">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft127">12/48</p>
</div>
<!-- Page 13 -->
<a name="13"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page13-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42013.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft137">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft137">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:172px;left:85px;white-space:nowrap" class="ft139"><b>4&#160;</b></p>
<p style="position:absolute;top:169px;left:117px;white-space:nowrap" class="ft1310"><b>Ownership&#160;Model of the Hardware TPM</b></p>
<p style="position:absolute;top:217px;left:85px;white-space:nowrap" class="ft131"><b>4.1&#160;TPM&#160;Owner&#160;</b></p>
<p style="position:absolute;top:245px;left:85px;white-space:nowrap" class="ft135">The cryptographic&#160;operations&#160;implemented&#160;in&#160;TPMs&#160;are&#160;based&#160;on a hierarchy&#160;of<br/>cryptographic&#160;keys.&#160;These keys&#160;are&#160;used&#160;to&#160;encrypt&#160;user&#160;data&#160;and&#160;to&#160;issue&#160;various<br/>types of signatures&#160;such as&#160;quotes&#160;for&#160;remote&#160;attestation.&#160;The&#160;key hierarchy&#160;in&#160;a TPM<br/>can&#160;be exchanged&#160;by the&#160;user&#160;by creating&#160;a new&#160;tree&#160;of keys protected&#160;by&#160;the&#160;so-<br/>called&#160;storage&#160;root&#160;key&#160;(SRK) at&#160;its&#160;root. Creating&#160;a new&#160;key&#160;hierarchy is&#160;part&#160;of taking<br/>ownership&#160;of&#160;the&#160;TPM.&#160;As there&#160;can&#160;be&#160;only one (randomly&#160;generated)&#160;SRK&#160;associated<br/>with&#160;a&#160;TPM,&#160;creating&#160;a&#160;new SRK&#160;invalidates&#160;the&#160;previous&#160;hierarchy,&#160;that&#160;is,&#160;all&#160;keys&#160;that<br/>were bound&#160;to&#160;this TPM before.&#160;<br/>Taking&#160;ownership&#160;of a&#160;TPM&#160;can therefore&#160;lead&#160;to&#160;denial of service if&#160;initiated&#160;by an<br/>unauthorized&#160;user.&#160;To&#160;prevent&#160;this, the concept&#160;of&#160;a TPM&#160;owner&#160;as defined&#160;by&#160;the&#160;TCG<br/>requires&#160;privileged TPM&#160;operations&#160;such as&#160;</p>
<p style="position:absolute;top:446px;left:446px;white-space:nowrap" class="ft1311"><i>TPM_TakeOwnership()</i></p>
<p style="position:absolute;top:446px;left:629px;white-space:nowrap" class="ft132">&#160;to&#160;be&#160;authorized&#160;by</p>
<p style="position:absolute;top:465px;left:85px;white-space:nowrap" class="ft135">means&#160;of&#160;a secret&#160;owner&#160;authorization&#160;value.&#160;After&#160;ownership&#160;has&#160;been taken,&#160;owner<br/>authorization&#160;is also&#160;required&#160;during&#160;normal&#160;use&#160;of the TPM&#160;for&#160;certain&#160;other<br/>operations.&#160;For&#160;example,&#160;it&#160;is not&#160;only required&#160;to create attestation&#160;identity&#160;keys<br/>(AIKs)&#160;and&#160;to&#160;set&#160;valid&#160;migration&#160;targets for&#160;migratable&#160;keys,&#160;but&#160;also&#160;for&#160;commands<br/>such&#160;as&#160;</p>
<p style="position:absolute;top:542px;left:153px;white-space:nowrap" class="ft1311"><i>TPM_CreateCounter()</i></p>
<p style="position:absolute;top:542px;left:329px;white-space:nowrap" class="ft132">&#160;or&#160;</p>
<p style="position:absolute;top:542px;left:357px;white-space:nowrap" class="ft1311"><i>TPM_NV_DefineSpace()</i></p>
<p style="position:absolute;top:542px;left:548px;white-space:nowrap" class="ft132">.&#160;</p>
<p style="position:absolute;top:570px;left:85px;white-space:nowrap" class="ft135">One&#160;major&#160;requirement&#160;for TPM virtualization is that the integrity&#160;and/or&#160;confidentiality<br/>of the internal&#160;state&#160;of&#160;a&#160;virtual&#160;TPM&#160;(vTPM)&#160;must&#160;be&#160;maintained.&#160;In the case&#160;of a<br/>purely software&#160;implemented vTPM,&#160;this includes the endorsement&#160;key (EK), the SRK,<br/>and&#160;other non-volatile&#160;internal&#160;state&#160;such&#160;as monotonic&#160;counter values.&#160;The<br/>virtualization&#160;layer&#160;can provide&#160;the&#160;required&#160;secure&#160;persistent&#160;storage&#160;for&#160;this data&#160;by<br/>sealing it&#160;to the&#160;execution environment&#160;of&#160;the vTPM&#160;software&#160;implementation. This<br/>means&#160;that&#160;the vTPM&#160;state will&#160;be&#160;encrypted&#160;with a&#160;storage&#160;key generated&#160;and<br/>protected&#160;by&#160;the physical&#160;TPM.&#160;<br/>Migration&#160;a vTPM&#160;instance&#160;might&#160;therefore&#160;require&#160;the owner&#160;of the&#160;physical&#160;source<br/>TPM&#160;to&#160;authorize&#160;a&#160;specific&#160;physical&#160;destination&#160;TPM&#160;for&#160;the&#160;key used&#160;to protect&#160;the<br/>storage&#160;of the virtual&#160;TPM.&#160;Creating&#160;a&#160;new&#160;vTPM&#160;instance&#160;might&#160;also&#160;include creating&#160;a<br/>new&#160;counter&#160;in the&#160;physical&#160;TPM&#160;of the source&#160;platform&#160;in&#160;order&#160;to&#160;prevent&#160;replay<br/>attacks,&#160;which also requires&#160;owner authorization<br/>For&#160;vTPM migration,&#160;users&#160;of a vTPM&#160;&#160;therefore&#160;rely on&#160;the&#160;cooperation&#160;of&#160;the&#160;owner&#160;of<br/>the physical&#160;TPMs&#160;residing&#160;on the&#160;source&#160;and&#160;target&#160;platforms..&#160;However,&#160; owners of<br/>physical&#160;TPMs&#160;and&#160;those of vTPM&#160;instances&#160;bound&#160;to&#160;them&#160;might&#160;not be&#160;the&#160;same<br/>person.&#160;For&#160;example,&#160;the administrator&#160;in&#160;a&#160;data&#160;center&#160;might&#160;be the owner&#160;of the<br/>physical&#160;TPM&#160;built into&#160;a server,&#160;whereas&#160;VMs&#160;and&#160;vTPM&#160;instances&#160;hosted&#160;on this<br/>server&#160;might&#160;be owned&#160;by&#160;customers.&#160;Some&#160;of these&#160;customers&#160;may not&#160;want&#160;to&#160;trust<br/>the administrator&#160;with respect&#160;to&#160;vTPM integrity;&#160;for&#160;instance,&#160;if&#160;a&#160;target platform&#160;for&#160;a<br/>migratable&#160;key&#160;needs to&#160;be&#160;authorized&#160;or if&#160;a customer&#160;defined&#160;security policy&#160;forbids<br/>to&#160;make&#160;a specific&#160;remote&#160;machine&#160;a valid&#160;migration&#160;target.&#160;We discuss&#160;how&#160;to<br/>accommodate&#160;for&#160;this&#160;requirement&#160;in&#160;the following&#160;section.&#160;</p>
<p style="position:absolute;top:1057px;left:85px;white-space:nowrap" class="ft131"><b>4.2&#160;Software&#160;as&#160;TPM Owner&#160;</b></p>
<p style="position:absolute;top:1085px;left:85px;white-space:nowrap" class="ft135">Ideally,&#160;the owner of&#160;the&#160;physical&#160;TPM&#160;should&#160;not need to be&#160;trusted&#160;in order to trust&#160;a<br/>vTPM&#160;built on&#160;top of it. In&#160;practice, however, &#160;this&#160;is infeasible:&#160;the&#160;physical&#160;TPM&#160;would</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft137">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft137">13/48</p>
</div>
<!-- Page 14 -->
<a name="14"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft1416{font-size:18px;font-family:TimesNewRomanPS;color:#000000;}
	.ft1417{font-size:10px;font-family:TimesNewRomanPS;color:#000000;}
-->
</style>
<div id="page14-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42014.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft147">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft147">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft145">be&#160;rendered&#160;useless,&#160;&#160;as&#160;no&#160;owner&#160;protected&#160;commands&#160;could&#160;be&#160;used.&#160;A&#160;possible&#160;way<br/>to&#160;solve&#160;this dilemma&#160;is&#160;to take&#160;owner authority out for the physical&#160;TPM of&#160;the&#160;hands<br/>of a&#160;physical&#160;person&#160;such as&#160;the&#160;administrator,&#160;and&#160;let&#160;software,&#160;namely,&#160;the&#160;trusted<br/>virtualization&#160;layer&#160;(TVL),&#160;”own” the TPM&#160;instead.&#160;This approach&#160;can&#160;be motivated&#160;by<br/>the fact&#160;that&#160;the&#160;TVL has&#160;to&#160;be&#160;trusted&#160;in any&#160;case, and access to&#160;owner&#160;authorized<br/>functionality&#160;can effectively&#160;be enforced&#160;by&#160;binding&#160;authorization&#160;secrets to a specific<br/>PCR configuration&#160;that&#160;correspond&#160;to a trustworthy&#160;TVL.</p>
<p style="position:absolute;top:312px;left:85px;white-space:nowrap" class="ft1415"><b>4.2.1&#160;Protecting Owner&#160;Authorization Data&#160;</b></p>
<p style="position:absolute;top:339px;left:85px;white-space:nowrap" class="ft145">Knowing&#160;the owner&#160;authorization&#160;data&#160;does&#160;not allow&#160;for&#160;unlimited&#160;access to all<br/>secrets and&#160;capabilities of&#160;a&#160;TPM.&#160;For&#160;example,&#160;usage&#160;of&#160;certain&#160;storage&#160;and&#160;signing<br/>keys&#160;in the hierarchy&#160;can be&#160;restricted&#160;by&#160;means of&#160;per-key&#160;authorization&#160;data.<br/>However,&#160;any user with&#160;owner&#160;access&#160;can&#160;authorize&#160;the migration&#160;of&#160;a key currently<br/>loaded&#160;into&#160;the&#160;hardware&#160;TPM&#160;– an&#160;operation&#160;that&#160;can&#160;compromise&#160;a vTPM&#160;whose&#160;state<br/>is protected&#160;by&#160;that&#160;key.&#160;Our&#160;approach&#160;to reduce&#160;trust&#160;in&#160;external&#160;users&#160;such&#160;as<br/>administrators&#160;is to&#160;mediate&#160;all&#160;owner-authorized&#160;operations&#160;through&#160;software&#160;by<br/>making&#160;the&#160;owner&#160;authorization&#160;data&#160;exclusively&#160;available&#160;to&#160;the&#160;TVL.&#160;The&#160;TVL&#160;needs<br/>to&#160;provide&#160;appropriate&#160;interfaces&#160;to handle&#160;vTPM&#160;instances&#160;on&#160;behalf&#160;of their<br/>respective&#160;owners.&#160;<br/>To&#160;ensure&#160;that&#160;the owner authorization&#160;data is&#160;kept&#160;secret, taking ownership&#160;of&#160;the<br/>physical&#160;TPM&#160;must&#160;be&#160;done&#160;automatically&#160;(e.g.,&#160;as&#160;part&#160;of the&#160;installation&#160;procedure).<br/>The new owner authorization&#160;data should&#160;be a hard-to-guess&#160;random&#160;nonce that&#160;is<br/>being&#160;kept&#160;secret by&#160;the&#160;TVL.&#160;This authentication&#160;data&#160;must&#160;be&#160;stored&#160;persistently<br/>such&#160;that&#160;only the&#160;TVL&#160;is&#160;able&#160;to access it; for&#160;example&#160;after&#160;a&#160;reboot.&#160;This&#160;is achieved<br/>using the&#160;sealing and&#160;unsealing&#160;functionality&#160;of&#160;the&#160;physical&#160;TPM.&#160; Note&#160;that&#160;no&#160;owner<br/>privileges&#160;are required for unsealing&#160;data,&#160;so&#160;the TVL&#160;can pass&#160;a sealed&#160;blob<br/>containing the authorization&#160;secret&#160;that&#160;was&#160;retrieved from a storage&#160;medium&#160;to the<br/>TPM&#160;in order to&#160;obtain&#160;owner privileges&#160;during&#160;its initialization&#160;phase.&#160;</p>
<p style="position:absolute;top:740px;left:85px;white-space:nowrap" class="ft1415"><b>4.2.2&#160;Implications&#160;of Public&#160;SRK&#160;Authorization&#160;Data&#160;</b></p>
<p style="position:absolute;top:766px;left:85px;white-space:nowrap" class="ft145">For&#160;practical&#160;reasons,&#160;the&#160;TVL&#160;must&#160;be able to&#160;unseal&#160;the owner&#160;authorization&#160;data<br/>without&#160;knowing&#160;any additional&#160;secrets.&#160;This&#160;implies&#160;that&#160;the&#160;SRK&#160;needs&#160;to&#160;be<br/>accessible&#160;using&#160;a&#160;well-known&#160;password.&#160;This&#160;requirement&#160;is acceptable, because&#160;all<br/>cryptographic&#160;keys and&#160;sealed&#160;data&#160;below&#160;the SRK&#160;are locked&#160;to&#160;specific&#160;PCR<br/>configurations&#160;and&#160;are&#160;optionally&#160;protected&#160;by&#160;additional&#160;authentication&#160;values.&#160;<br/>Typically,&#160;authentication&#160;data&#160;is needed&#160;whenever a new&#160;TPM&#160;object such&#160;as a<br/>protected&#160;key is created.&#160;The&#160;TCG&#160;specifications&#160;forbid&#160;to&#160;send the authentication&#160;data<br/>in&#160;the clear,&#160;though.&#160;Before&#160;it&#160;is&#160;transmitted&#160;over&#160;the&#160;LPC&#160;bus,&#160;it&#160;must&#160;be encrypted<br/>using the&#160;authentication&#160;data&#160;of its&#160;immediate&#160;parent&#160;entity. The&#160;TPM&#160;specification<br/>requires&#160;the encryption&#160;scheme&#160;to&#160;be XOR,&#160;with&#160;the&#160;SHA-1&#160;hash&#160;sum&#160;of the&#160;parent<br/>entity’s&#160;authentication&#160;data&#160;and&#160;a rolling&#160;session&#160;nonce:</p>
<p style="position:absolute;top:1000px;left:138px;white-space:nowrap" class="ft1416"><i>child_auth</i></p>
<p style="position:absolute;top:1007px;left:215px;white-space:nowrap" class="ft1417"><i>enc</i></p>
<p style="position:absolute;top:1000px;left:230px;white-space:nowrap" class="ft1416"><i>&#160;:= XOR( child_auth, (parent_auth || session_nonce))</i></p>
<p style="position:absolute;top:1025px;left:85px;white-space:nowrap" class="ft145">An attacker&#160;with physical&#160;access to&#160;the&#160;platform&#160;running&#160;the TVL might&#160;try&#160;to&#160;obtain<br/>the cipher&#160;text&#160;by&#160;listening&#160;on&#160;the&#160;LPC&#160;bus using&#160;appropriate&#160;equipment.&#160;Because&#160;our<br/>approach&#160;requires&#160;the authentication&#160;data&#160;of the&#160;SRK&#160;to&#160;be&#160;public&#160;,&#160;he&#160;might&#160;be&#160;able<br/>to&#160;learn&#160;about&#160;the&#160;plain&#160;text authentication&#160;data&#160;of direct&#160;child&#160;keys,&#160;provided&#160;he can<br/>guess&#160;the session&#160;nonce.&#160;It is conceivable&#160;that&#160;the attacker&#160;could&#160;even&#160;learn&#160;about&#160;all</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft147">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft147">14/48</p>
</div>
<!-- Page 15 -->
<a name="15"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page15-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42015.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft157">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft157">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft155">authentication&#160;data&#160;for&#160;keys&#160;associated&#160;with&#160;the&#160;physical&#160;TPM.&#160;<br/>TPM-equipped&#160;computers&#160;as specified by&#160;the TCG are&#160;not&#160;required&#160;to&#160;withstand<br/>hardware&#160;attacks.&#160;However,&#160;as&#160;we do&#160;not&#160;make&#160;assumptions&#160;about&#160;the<br/>trustworthiness&#160;e.g.&#160;of&#160;administrators&#160;of&#160;physical&#160;servers&#160;e.g.&#160;In&#160;a&#160;data center,&#160;we<br/>emphasize&#160;that&#160;this&#160;kind&#160;of&#160;hardware&#160;based&#160;attack&#160;is&#160;&#160; feasible.&#160;The&#160;quality of&#160;the<br/>session&#160;nonces, which&#160;are&#160;partly&#160;generated by&#160;the&#160;software&#160;using&#160;the TPM,&#160;are<br/>required&#160;to&#160;be of&#160;high&#160;quality&#160;so&#160;as&#160;to&#160;make&#160;guessing&#160;them&#160;as&#160;hard&#160;as possible.&#160;</p>
<p style="position:absolute;top:321px;left:85px;white-space:nowrap" class="ft151"><b>4.3&#160;Virtual&#160;TPMs and&#160;the&#160;Basic&#160;Management&#160;and&#160;Security&#160;Interface</b></p>
<p style="position:absolute;top:350px;left:85px;white-space:nowrap" class="ft155">In&#160;OpenTC,&#160;the Basic&#160;Management&#160;and&#160;Security Interface&#160;(BMSI)[13]&#160;was&#160;designed<br/>such&#160;that&#160;a software-implemented&#160;vTPM&#160;can be built on&#160;top&#160;of it. One&#160;of its&#160;purposes&#160;is<br/>to provide&#160;the mediation&#160;of&#160;owner&#160;related&#160;TPM&#160;functionality&#160;as described above.&#160;In<br/>other words:&#160;the&#160;BMSI&#160;is&#160;a practical&#160;realization&#160;of&#160;the software-based&#160;vTPM<br/>architecture&#160;described&#160;in&#160;this&#160;chapter.<br/>&#160;We&#160;will&#160;now&#160;discuss&#160;how&#160;the properties&#160;and the trustworthiness&#160;of this&#160;interface&#160;can<br/>be&#160;communicated&#160;in&#160;a&#160;remote&#160;attestation&#160;scenario.&#160;In&#160;order&#160;to trust&#160;the BMSI&#160;and&#160;the<br/>keys&#160;in the physical&#160;TPM,&#160;a remote&#160;party must&#160;know&#160;the&#160;identity of&#160;the owner&#160;of the<br/>physical&#160;TPM.&#160;The&#160;remote&#160;party&#160;should&#160;only&#160;trust&#160;the&#160;BMSI&#160;if the BMSI&#160;itself took<br/>ownership&#160;of&#160;the&#160;platform.&#160;With&#160;the&#160;owner&#160;authorization&#160;data&#160;being&#160;sealed&#160;under&#160;its<br/>own configuration&#160;as&#160;reflected in the PCRs,&#160;the&#160;BMSI&#160;can also&#160;determine&#160;which&#160;entity<br/>(i.e.,&#160;software&#160;stack)&#160;originally&#160;performed&#160;the sealing&#160;operation&#160;using TPM<br/>functionality.&#160;The verification&#160;procedure&#160;to&#160;determine&#160;the&#160;creator&#160;of&#160;the sealed&#160;data&#160;is<br/>done&#160;in&#160;two steps:&#160;</p>
<p style="position:absolute;top:636px;left:112px;white-space:nowrap" class="ft152">1.</p>
<p style="position:absolute;top:636px;left:139px;white-space:nowrap" class="ft151"><b>Determine&#160;Platform:</b></p>
<p style="position:absolute;top:636px;left:330px;white-space:nowrap" class="ft152">&#160;Apart&#160;from&#160;checking the&#160;PCR configuration&#160;at&#160;the&#160;time</p>
<p style="position:absolute;top:656px;left:139px;white-space:nowrap" class="ft1511"><i>TPM_Unseal()</i></p>
<p style="position:absolute;top:656px;left:250px;white-space:nowrap" class="ft152">&#160;is&#160;called, the TPM&#160;also&#160;ensures&#160;that&#160;it&#160;never&#160;releases&#160;data&#160;unless</p>
<p style="position:absolute;top:675px;left:139px;white-space:nowrap" class="ft155">the&#160;sealed&#160;blob has&#160;originally&#160;been&#160;created by itself.&#160;Thus, the&#160;BMSI implicitly<br/>knows that&#160;the data&#160;has been&#160;sealed&#160;on&#160;the&#160;same&#160;physical&#160;platform&#160;once the<br/>TPM returned&#160;the unsealed&#160;data.&#160;</p>
<p style="position:absolute;top:741px;left:112px;white-space:nowrap" class="ft152">2.</p>
<p style="position:absolute;top:741px;left:139px;white-space:nowrap" class="ft151"><b>Determine&#160;Creator&#160;PCR:s</b></p>
<p style="position:absolute;top:741px;left:372px;white-space:nowrap" class="ft152">&#160;The TPM&#160;captures&#160;the&#160;current PCR values at&#160;the</p>
<p style="position:absolute;top:761px;left:139px;white-space:nowrap" class="ft152">time&#160;of the&#160;</p>
<p style="position:absolute;top:761px;left:235px;white-space:nowrap" class="ft1511"><i>TPM_Seal()</i></p>
<p style="position:absolute;top:761px;left:326px;white-space:nowrap" class="ft152">&#160;operation&#160;and includes&#160;them&#160;in&#160;the&#160;sealed blob&#160;that&#160;is</p>
<p style="position:absolute;top:780px;left:139px;white-space:nowrap" class="ft155">created.&#160;The TPM does not&#160;use this&#160;creator PCR&#160;configuration&#160;itself,&#160;however, it<br/>verifies its integrity.&#160;After unsealing&#160;the&#160;data,&#160;the BMSI&#160;can extract the&#160;creator<br/>PCR values&#160;from&#160;a copy of the sealed&#160;blob&#160;and&#160;verify&#160;them&#160;using&#160;known-good<br/>values.&#160;</p>
<p style="position:absolute;top:866px;left:85px;white-space:nowrap" class="ft155">Using&#160;this procedure,&#160;the BMSI&#160;can identify&#160;the entity that&#160; sealed the&#160;owner<br/>authorization&#160;value.&#160;Thus,&#160;it can&#160;determine&#160;with&#160;certainty whether or not&#160;it&#160;took<br/>ownership&#160;of&#160;the&#160;TPM&#160;itself.&#160;Alternatively,&#160;the&#160;BMSI&#160;might&#160;also&#160;decide to&#160;trust&#160;in&#160;the<br/>integrity&#160;and secrecy&#160;of the&#160;obtained owner secret if the creator PCR&#160;configuration<br/>matches&#160;a platform&#160;installer&#160;known&#160;to&#160;be trusted.&#160;<br/>A&#160;remote&#160;party&#160;can&#160;learn&#160;about&#160;the the identity&#160;of the&#160;challenged&#160;platform&#160;in a<br/>successful&#160;remote&#160;attestation.&#160;For&#160;example,&#160;the&#160;BMSI&#160;could&#160;just&#160;refuse&#160;to&#160;start&#160;up&#160;if it<br/>finds&#160;an&#160;owner&#160;authorization&#160;to be&#160;invalid;&#160;a reply&#160;to a remote&#160;attestation&#160;request&#160;then<br/>carries&#160;the implicit&#160;information&#160;that&#160;owner functionality&#160;is only&#160;accessible&#160;to the BMSI.&#160;<br/>The very&#160;same&#160;protection&#160;scheme that&#160;is used&#160;to&#160;protect&#160;the&#160;owner&#160;authorization&#160;data<br/>can also&#160;be&#160;used&#160;to&#160;keep&#160;other&#160;authorization&#160;values&#160;such&#160;secret (e.g.,&#160;for monotonic<br/>counters&#160;and non-volatile storage&#160;in the TPM).&#160;</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft157">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft157">15/48</p>
</div>
<!-- Page 16 -->
<a name="16"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page16-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42016.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft167">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft167">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:172px;left:85px;white-space:nowrap" class="ft169"><b>5&#160;</b></p>
<p style="position:absolute;top:169px;left:117px;white-space:nowrap" class="ft1610"><b>vTPM&#160;Lifecycle</b></p>
<p style="position:absolute;top:199px;left:85px;white-space:nowrap" class="ft1612">Hardware&#160;TPMs&#160;are subjected&#160;to a&#160;defined&#160;life&#160;cycle&#160;that comprises&#160;stages&#160;of<br/>manufacturing,&#160;maintenance,&#160;usage&#160;and&#160;eventually&#160;destruction.&#160;In&#160;principle,&#160;this life<br/>cycle also&#160;applies&#160;to&#160;virtual TPMs,&#160;however,&#160;the&#160;security measures&#160;that&#160;apply to&#160;each<br/>stage&#160;are&#160;different&#160;for&#160;vTPMs.&#160;Furthermore,&#160;the actual&#160;measures&#160;can depend&#160;on the<br/>way&#160;a&#160;virtual&#160;TPM&#160;is&#160;implemented.<br/>This&#160;chapter&#160;discusses&#160;how the&#160;life cycle for&#160;hardware&#160;TPMs&#160;can&#160;be&#160;mapped&#160;to the</p>
<p style="position:absolute;top:323px;left:85px;white-space:nowrap" class="ft1611"><i>disaggregated&#160;vTPM&#160;section&#160;model</i></p>
<p style="position:absolute;top:323px;left:375px;white-space:nowrap" class="ft162">&#160;as&#160;chosen&#160;by&#160;OpenTC&#160;and&#160;introduced&#160;in&#160;section</p>
<p style="position:absolute;top:342px;left:85px;white-space:nowrap" class="ft165">2.2Our&#160;working&#160;hypothesis&#160;is that&#160;the&#160;disaggregated&#160;model&#160;leverages&#160;the respective<br/>strengths&#160;of the two&#160;other ones while&#160;avoiding some&#160;of&#160;their difficulties.&#160;</p>
<p style="position:absolute;top:408px;left:85px;white-space:nowrap" class="ft161"><b>5.1&#160;Virtual&#160;TPM&#160;manufacturing&#160;</b></p>
<p style="position:absolute;top:436px;left:85px;white-space:nowrap" class="ft165">The first&#160;step in the&#160;vTPM&#160;lifecycle is its creation.&#160;While&#160;this process&#160;is well&#160;understood<br/>and&#160;defined&#160;for&#160;hardware&#160;TPMs,&#160;additional&#160;parameters&#160;and&#160;security&#160;measures&#160;have&#160;to<br/>be&#160;taken into&#160;account&#160;when&#160;creating&#160;a&#160;software&#160;TPM.&#160;We&#160;will&#160;first&#160;describe&#160;a<br/>theoretical&#160;HW manufacturing&#160;process&#160;which we will&#160;then transpose&#160;to&#160;the<br/>peculiarities&#160;of the&#160;vTPM.&#160;</p>
<p style="position:absolute;top:559px;left:85px;white-space:nowrap" class="ft1615"><b>5.1.1&#160;Process for Hardware TPMs&#160;and&#160;Computing Platforms&#160;</b></p>
<p style="position:absolute;top:586px;left:85px;white-space:nowrap" class="ft165">Physical&#160;TPMs&#160;must&#160;protect cryptographic&#160;secrets&#160;(symmetric&#160;and&#160;asymmetric&#160;keys)<br/>from&#160;a&#160;computer&#160;CPU&#160;and&#160;DMA capable&#160;devices.&#160;They&#160;also&#160;have&#160;to&#160;withstand&#160;a&#160;certain<br/>level of physical&#160;attacks.&#160;TPMs must&#160;only&#160;allow&#160;a specific&#160;set of operation&#160;on these<br/>secrets.&#160;Usually,&#160;this&#160;is&#160;achieved&#160;by&#160;using&#160;a&#160;separate&#160;processing&#160;engine&#160;(processor)<br/>which&#160;implements&#160;the TPM functionalities.&#160;TPMs come&#160;with&#160;dedicated&#160;processors&#160;and<br/>approved&#160;firmware&#160;implementing the&#160;TCG specification.&#160;All&#160;hardware&#160;TPMs implement<br/>the same&#160;logic&#160;and&#160;can&#160;be considered&#160;identical from&#160;a&#160;functional&#160;point&#160;of&#160;view.<br/>In&#160;the&#160;last&#160;stage&#160;of&#160;the&#160;manufacturing&#160;process, the&#160;TPM obtains&#160;its life&#160;long&#160;identity: its<br/>Endorsement&#160;Key (EK).&#160;The specification allows the&#160;TPM&#160;to&#160;generate&#160;this&#160;key&#160;itself<br/>during&#160;the first&#160;power&#160;up.&#160;Alternatively,&#160;the manufacturer&#160;can&#160;create&#160;and&#160;inject the<br/>key into the TPM.&#160;Whichever solution&#160;is&#160;chosen&#160;by the manufacturer,&#160;the end&#160;result<br/>should&#160;always&#160;be:</p>
<p style="position:absolute;top:837px;left:112px;white-space:nowrap" class="ft1613">●</p>
<p style="position:absolute;top:834px;left:139px;white-space:nowrap" class="ft165">The TPM&#160;has a statistically&#160;unique&#160;asymmetric&#160;key pair stored&#160;for&#160;its whole&#160;life<br/>in&#160;its&#160;non-volatile&#160;memory&#160;(Endorsement&#160;Key, EK).</p>
<p style="position:absolute;top:884px;left:112px;white-space:nowrap" class="ft1613">●</p>
<p style="position:absolute;top:881px;left:139px;white-space:nowrap" class="ft165">The TPM&#160;manufacturer&#160;creates a certificate&#160;for&#160;this&#160;EK.&#160;This certificate vouches<br/>for&#160;the genuineness&#160;of&#160;the TPM&#160;and its&#160;identity.</p>
<p style="position:absolute;top:929px;left:85px;white-space:nowrap" class="ft165">At&#160;some&#160;later stage,&#160;TPMs are&#160;integrated&#160;with&#160;a&#160;computing&#160;device&#160;by a&#160;platform<br/>manufacturer.&#160;'Integrated'&#160;means&#160;that the&#160;TPM&#160;is&#160;physically&#160;'bound'&#160;to a&#160;hardware<br/>platform&#160;– soldered,&#160;glued&#160;and&#160;attached&#160;by whatever&#160;other&#160;means&#160;that&#160;are deemed<br/>appropriate&#160;to&#160;make&#160;the&#160;TPM and&#160;the&#160;platform&#160;hard&#160;to&#160;separate.&#160;The platform<br/>manufacturer&#160;publishes&#160;that&#160;(and&#160;how)&#160;a specific&#160;TPM&#160;has&#160;been integrated&#160;with&#160;(bound<br/>to) a&#160;specific&#160;type&#160;of physical&#160;platform.&#160;This&#160;enables a&#160;remote&#160;party&#160;to extend its&#160;trust<br/>in the TPM to&#160;the&#160;physical&#160;platform&#160;and,&#160;ultimately, to&#160;the&#160;software&#160;running&#160;on&#160;this<br/>platform.&#160;The&#160;stronger&#160;the&#160;binding,&#160;the&#160;more&#160;confidence&#160;can&#160;be&#160;put in&#160;the this&#160;'chain<br/>of trust'.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft167">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft167">16/48</p>
</div>
<!-- Page 17 -->
<a name="17"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft1718{font-size:16px;font-family:IHJABC+BitstreamVeraSans;color:#000000;}
-->
</style>
<div id="page17-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42017.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft177">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft177">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft1715"><b>5.1.2&#160;Creating&#160;a new&#160;Virtual TPM</b></p>
<p style="position:absolute;top:178px;left:85px;white-space:nowrap" class="ft175">Analogous&#160;to&#160;hardware&#160;TPMs,&#160;Virtual&#160;TPMs&#160;are&#160;also&#160;dedicated&#160;software&#160;implementing&#160;a<br/>specific&#160;behavior&#160;as&#160;defined&#160;by&#160;the TCG&#160;specification.&#160;However,&#160;the main&#160;difference&#160;is<br/>that&#160;Virtual&#160;TPMs&#160;are&#160;not&#160;executed on&#160;a&#160;separate&#160;processor.&#160;They&#160;are&#160;effectively<br/>implemented&#160;as&#160;software&#160;running&#160;on&#160;the&#160;main&#160;CPU with&#160;all&#160;other&#160;software.&#160;The<br/>protection&#160;offered&#160;by Virtual&#160;TPMs is therefore&#160;crucially&#160;dependent on&#160;the security and<br/>isolation&#160;properties&#160;of the&#160;vTPM&#160;execution environment.&#160;The&#160;manufacturer&#160;of&#160;the<br/>Virtual&#160;TPM&#160;will have&#160;to&#160;take into&#160;consideration&#160;not&#160;only&#160;the actual&#160;code of the Virtual<br/>TPM,&#160;but also&#160;the code of the whole&#160;environment&#160;the vTPM&#160;depends&#160;on.&#160;Additionally,<br/>the vTPM&#160;must&#160;include code&#160;to&#160;protect&#160;its&#160;secrets&#160;both&#160;at&#160;runtime&#160;(isolation&#160;from&#160;other<br/>software&#160;running&#160;on&#160;the&#160;platform)&#160;and&#160;in&#160;standby&#160;mode&#160;(secure&#160;offline&#160;storage&#160;of the<br/>secrets).<br/>This,&#160;of course,&#160;makes the concept&#160;of&#160;“Manufacturer”&#160;more&#160;ambiguous&#160;for&#160;a Virtual<br/>TPM&#160;as it&#160;could&#160;involve&#160;the entities who&#160;wrote&#160;the&#160;vTPM&#160;code, the&#160;underlying&#160;code<br/>system&#160;codes,&#160;as&#160;well as&#160;the&#160;system&#160;administrator,&#160;the&#160;platform&#160;manufacturer,&#160;the<br/>TPM&#160;manufacturer,&#160;etc...&#160;For our discussion,&#160;we will call the&#160;manufacturer&#160;of a vTPM<br/>the entity&#160;that&#160;is able&#160;to vouch&#160;for&#160;the&#160;vTPM&#160;security&#160;properties.&#160;In&#160;other&#160;word,&#160;the<br/>vTPM&#160;manufacturer&#160;is the&#160;entity that&#160;is willing to vouch for&#160;the trustworthiness&#160;of a<br/>vTPM&#160;materialized&#160;through&#160;the issuing&#160;of a digital&#160;certificate.<br/>For&#160;the runtime&#160;protection,&#160;we will&#160;assume&#160;that&#160;we&#160;have&#160;a&#160;trusted&#160;hypervisor&#160;that&#160;uses<br/>hardware&#160;support&#160;in&#160;CPUs to&#160;provide&#160;strong&#160;isolation&#160;between running&#160;processes<br/>(which&#160;in&#160;the case of&#160;Xen are&#160;domains,&#160;and&#160;in&#160;the&#160;case&#160;of&#160;L4 are tasks).&#160;For the offline<br/>protection,&#160;we assume&#160;that&#160;the&#160;Virtual&#160;TPM&#160;is provided&#160;with&#160;an&#160;interface&#160;providing&#160;a<br/>protected&#160;storage&#160;integrated&#160;with&#160;the&#160;chain&#160;of trust&#160;such&#160;as&#160;the&#160;one&#160;defined&#160;in&#160;the<br/>BMSI[13].&#160;We will discuss&#160;this&#160;integration in&#160;subsequent&#160;chapters&#160;dealing with&#160;Trusted<br/>Virtual&#160;Platforms&#160;and&#160;vTPM&#160;design.<br/>Similar&#160;to&#160;the&#160;manufacturing&#160;process&#160;for hardware&#160;TPMs,&#160;we&#160;consider&#160;two&#160;cases for a<br/>Virtual&#160;TPM to&#160;obtain its&#160;identity:</p>
<p style="position:absolute;top:735px;left:112px;white-space:nowrap" class="ft1713">●</p>
<p style="position:absolute;top:732px;left:139px;white-space:nowrap" class="ft175">The Virtual&#160;TPM&#160;generates&#160;its own&#160;Endorsement&#160;Key,&#160;which&#160;will&#160;get&#160;certified&#160;by<br/>the manufacturer</p>
<p style="position:absolute;top:782px;left:112px;white-space:nowrap" class="ft1713">●</p>
<p style="position:absolute;top:779px;left:139px;white-space:nowrap" class="ft172">The Virtual&#160;TPM&#160;manufacturer&#160;inserts&#160;an&#160;externally&#160;generated&#160;key</p>
<p style="position:absolute;top:808px;left:85px;white-space:nowrap" class="ft172">These&#160;cases&#160;are discussed&#160;in the&#160;following&#160;two&#160;sub-sections.</p>
<p style="position:absolute;top:854px;left:85px;white-space:nowrap" class="ft1715"><b>5.1.2.1&#160;vTPM Generated&#160;Endorsement Key</b></p>
<p style="position:absolute;top:880px;left:85px;white-space:nowrap" class="ft175">In&#160;this&#160;solution,&#160;the first&#160;time&#160;a vTPM&#160;is&#160;instantiated,&#160;it&#160;generates&#160;its own&#160;endorsement<br/>key pair&#160;and&#160;seals&#160;its private&#160;part&#160;using&#160;an&#160;existing&#160;security interface (such as&#160;the<br/>hardware&#160;TPM,&#160;the&#160;BMSI,&#160;or&#160;the&#160;HIM).&#160;In&#160;order&#160;to&#160;make&#160;the vTPM&#160;persistent,&#160;the&#160;result<br/>of&#160;this operation&#160;must&#160;be&#160;stored&#160;on&#160;a&#160;non-volatile storage&#160;(such&#160;as a&#160;hard&#160;disk).&#160;The<br/>result&#160;is encrypted&#160;by&#160;the&#160;underlying&#160;layer,&#160;so we&#160;do&#160;not need&#160;special provisions&#160;for<br/>securing&#160;the&#160;data.&#160;The&#160;encrypted&#160;chunk&#160;of key data will&#160;be&#160;referred&#160;to&#160;as&#160;the&#160;vTPM<br/>Non-Volatile&#160;Blob&#160;(vTPM-NVB). The vTPM-NVB&#160;must&#160;be&#160;provided&#160;to the&#160;vTPM&#160;at&#160;each<br/>instantiation.<br/>After&#160;generating&#160;the&#160;EK, the manufacturer&#160;needs&#160;to&#160;certify&#160;it.&#160;Again,&#160;there are&#160;two<br/>options:</p>
<p style="position:absolute;top:1093px;left:112px;white-space:nowrap" class="ft1713">●</p>
<p style="position:absolute;top:1090px;left:139px;white-space:nowrap" class="ft1718"><i><b>Direct&#160;Certification:</b></i></p>
<p style="position:absolute;top:1090px;left:323px;white-space:nowrap" class="ft172">&#160;The&#160;manufacturer&#160;directly reads&#160;the public&#160;part&#160;of the EK</p>
<p style="position:absolute;top:1109px;left:139px;white-space:nowrap" class="ft172">that&#160;was&#160;generated&#160;by the vTPM&#160;and&#160;issues&#160;a certificate for it. This&#160;requires&#160;for</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft177">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft177">17/48</p>
</div>
<!-- Page 18 -->
<a name="18"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft1819{font-size:15px;line-height:17px;font-family:IHILJD+BitstreamVeraSans;color:#000000;}
-->
</style>
<div id="page18-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42018.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft187">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft187">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:139px;white-space:nowrap" class="ft185">the manufacturer&#160;to&#160;have&#160;full&#160;understanding&#160;in&#160;and&#160;control&#160;over&#160;the<br/>environment&#160;that&#160;was&#160;used&#160;to instantiate&#160;this&#160;vTPM. This&#160;solution&#160;is&#160;probably<br/>more&#160;appropriate&#160;for&#160;corporate&#160;scenarios where&#160;platforms&#160;are under the&#160;control<br/>of a centralized&#160;entity.</p>
<p style="position:absolute;top:240px;left:112px;white-space:nowrap" class="ft1813">●</p>
<p style="position:absolute;top:237px;left:139px;white-space:nowrap" class="ft1818"><i><b>Indirect&#160;Certification:</b></i></p>
<p style="position:absolute;top:237px;left:339px;white-space:nowrap" class="ft182">&#160;In&#160;this&#160;case, the vTPM&#160;needs to&#160;“convince”&#160;the</p>
<p style="position:absolute;top:256px;left:139px;white-space:nowrap" class="ft185">manufacturer&#160;of its&#160;genuineness&#160;before the manufacturer&#160;accepts to&#160;issue&#160;a<br/>certificate.&#160;To do so, the vTPM&#160;uses&#160;an&#160;existing&#160;security&#160;interface&#160;to obtain&#160;a<br/>signature&#160;of&#160;its EK public&#160;part&#160;and&#160;the&#160;current&#160;platform&#160;configuration.&#160;This<br/>operation&#160;(quote&#160;operation)&#160;can&#160;again&#160;be&#160;provided&#160;by an&#160;underlying&#160;TPM&#160;or&#160;the<br/>BMSI.&#160;The&#160;manufacturer&#160;can&#160;then verify&#160;this&#160;signature,&#160;verify&#160;that&#160;the&#160;integrity<br/>of the environment&#160;is suitable for&#160;creating&#160;a&#160;vTPM&#160;and&#160;protecting&#160;its&#160;secrets.&#160;If<br/>these&#160;conditions&#160;are&#160;met,&#160;the&#160;manufacturer&#160;can issue&#160;a&#160;certificate&#160;for&#160;the&#160;EK of<br/>this&#160;vTPM</p>
<p style="position:absolute;top:390px;left:219px;white-space:nowrap" class="ft184">1</p>
<p style="position:absolute;top:390px;left:225px;white-space:nowrap" class="ft182">.</p>
<p style="position:absolute;top:437px;left:85px;white-space:nowrap" class="ft1815"><b>5.1.2.2&#160;Manufacturer Generated&#160;Endorsement Key</b></p>
<p style="position:absolute;top:463px;left:85px;white-space:nowrap" class="ft185">Here, the vTPM&#160;manufacturer&#160;generates&#160;the&#160;vTPM&#160;EK&#160;using&#160;its own&#160;computing<br/>resources.&#160;He&#160;sends&#160;this&#160;key to&#160;the&#160;destination platform&#160;that&#160;will later&#160;instantiate&#160;the<br/>vTPM.&#160;In effect,&#160;the&#160;vTPM&#160;manufacturer&#160;is&#160;creating&#160;the&#160;vTPM-NVB&#160;“a priori”&#160;for&#160;a<br/>specific&#160;platform.&#160;This&#160;is&#160;only feasible&#160;if:</p>
<p style="position:absolute;top:552px;left:112px;white-space:nowrap" class="ft1813">●</p>
<p style="position:absolute;top:549px;left:139px;white-space:nowrap" class="ft185">The manufacturer&#160;has&#160;appropriate&#160;means&#160;to&#160;identify&#160;the&#160;platform&#160;and&#160;to<br/>validate&#160;its trust&#160;state.</p>
<p style="position:absolute;top:599px;left:112px;white-space:nowrap" class="ft1813">●</p>
<p style="position:absolute;top:596px;left:139px;white-space:nowrap" class="ft185">The security&#160;interface&#160;provided&#160;to&#160;the vTPM&#160;provides&#160;a sealing&#160;function&#160;that<br/>accepts created encrypted blobs that&#160;were created remotely&#160;(similar&#160;to the</p>
<p style="position:absolute;top:635px;left:139px;white-space:nowrap" class="ft1811"><i>TPM_UnBind()</i></p>
<p style="position:absolute;top:635px;left:254px;white-space:nowrap" class="ft182">&#160;function&#160;([14], Section&#160;10.3)</p>
<p style="position:absolute;top:666px;left:112px;white-space:nowrap" class="ft1813">●</p>
<p style="position:absolute;top:663px;left:139px;white-space:nowrap" class="ft185">The key used&#160;by&#160;the&#160;security&#160;interface&#160;to&#160;protect&#160;the blobs&#160;is itself sealed to&#160;the<br/>integrity metrics of&#160;the environment&#160;the&#160;vTPM&#160;will&#160;be&#160;executed&#160;in.</p>
<p style="position:absolute;top:710px;left:85px;white-space:nowrap" class="ft185">If the&#160;manufacturer&#160;can&#160;verify each&#160;of these&#160;assertions,&#160;he&#160;generates&#160;both&#160;the vTPM-<br/>NVB&#160;and the corresponding&#160;vTPM&#160;EK certificate.&#160;As above,&#160;the vTPM-NVB&#160;can be<br/>stored&#160;by the manufacturer&#160;on&#160;a non-volatile&#160;storage&#160;(such&#160;as&#160;hard&#160;disk)&#160;which&#160;will&#160;be<br/>made&#160;accessible&#160;to the vTPM&#160;code&#160;at the time&#160;of&#160;its instantiation.<br/>Both&#160;cases are&#160;similar&#160;with&#160;regard&#160;to using&#160;the security interface. We&#160;will&#160;therefore<br/>limit&#160;our&#160;discussion&#160;to&#160;the first&#160;case&#160;only.</p>
<p style="position:absolute;top:862px;left:85px;white-space:nowrap" class="ft181"><b>5.2&#160;Virtual&#160;TPM&#160;Instantiation</b></p>
<p style="position:absolute;top:890px;left:85px;white-space:nowrap" class="ft185">A vTPM&#160;instance&#160;is&#160;typically&#160;assigned&#160;to&#160;one&#160;specific virtual&#160;machine&#160;in order&#160;to<br/>protect&#160;sensitive&#160;data&#160;for&#160;this&#160;VM,&#160;and&#160;other&#160;VMs&#160;must&#160;not&#160;be&#160;able&#160;to&#160;observe&#160;or<br/>modify&#160;the state&#160;of this vTPM&#160;instance. This mutual&#160;isolation&#160;is provided&#160;by&#160;the<br/>hypervisor&#160;layer;&#160;a vTPM&#160;is&#160;ultimately nothing&#160;but&#160;a piece of&#160;software&#160;that&#160;is executed<br/>under&#160;its&#160;control.&#160;If&#160;the hypervisor&#160;can&#160;not&#160;be trusted,&#160;a vTPM&#160;running&#160;in&#160;its&#160;context<br/>cannot&#160;be trusted either.&#160;<br/>Care&#160;must&#160;therefore&#160;be&#160;taken&#160;that&#160;the&#160;vTPM&#160;can only&#160;exist&#160;in&#160;the&#160;context&#160;of&#160;this<br/>hypervisor&#160;system&#160;and&#160;the physical&#160;TPM&#160;assigned&#160;to&#160;it. This&#160;has&#160;to&#160;be&#160;validated&#160;by</p>
<p style="position:absolute;top:1069px;left:85px;white-space:nowrap" class="ft187">1&#160;As a variant, the&#160;key&#160;used by&#160;the underlying&#160;security&#160;interface could be part&#160;of&#160;the</p>
<p style="position:absolute;top:1087px;left:106px;white-space:nowrap" class="ft187">manufacturer&#160;PKI. In&#160;this case,&#160;the security&#160;interface&#160;can&#160;play&#160;the roles&#160;of the&#160;manufacturer</p>
<p style="position:absolute;top:1104px;left:106px;white-space:nowrap" class="ft1819">for the&#160;purpose&#160;of issuing vTPM EK&#160;Certificate. Thus, this removes one step&#160;involving&#160;the<br/>manufacturer.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft187">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft187">18/48</p>
</div>
<!-- Page 19 -->
<a name="19"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page19-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42019.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft197">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft197">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft195">remote&#160;parties who&#160;want&#160;to estimate&#160;the&#160;trustworthiness&#160;of the vTPM,&#160;and&#160;the&#160;physical<br/>TPM&#160;is employed&#160;to&#160;provide&#160;the&#160;necessary&#160;attestation&#160;information.<br/>The binding&#160;between&#160;hypervisor,&#160;physical&#160;TPM and&#160;virtual&#160;TPM&#160;must&#160;be&#160;performed<br/>during&#160;vTPM&#160;instantiation.&#160;The&#160;setup&#160;of&#160;the vTPM&#160;ensures&#160;the binding&#160;to&#160;the<br/>hypervisor&#160;as&#160;described in the following&#160;subsection.&#160;We then describe the binding&#160;of<br/>the vTPM&#160;to its associated&#160;VM.&#160;</p>
<p style="position:absolute;top:302px;left:85px;white-space:nowrap" class="ft1915"><b>5.2.1&#160;vTPM Startup</b></p>
<p style="position:absolute;top:329px;left:85px;white-space:nowrap" class="ft191"><b>Decryption</b></p>
<p style="position:absolute;top:357px;left:85px;white-space:nowrap" class="ft195">Once a TPM has&#160;been&#160;created as described&#160;in&#160;section 5.1.2,&#160;it&#160;needs to&#160;be instantiated<br/>for&#160;the VM&#160;it&#160;will&#160;be&#160;attached&#160;to.&#160;Similar&#160;to&#160;their&#160;hardware&#160;counterparts,&#160;vTPMs need&#160;to<br/>maintain&#160;some&#160;persistent state&#160;information.&#160;Some&#160;of this&#160;data&#160;is security sensitive,<br/>while some&#160;of it&#160;is&#160;public.&#160;We refer&#160;to it as&#160;</p>
<p style="position:absolute;top:415px;left:439px;white-space:nowrap" class="ft1911"><i>VTPM&#160;State&#160;Structure&#160;</i></p>
<p style="position:absolute;top:415px;left:621px;white-space:nowrap" class="ft192">(VTPM-SS)</p>
<p style="position:absolute;top:415px;left:706px;white-space:nowrap" class="ft1911"><i>.&#160;</i></p>
<p style="position:absolute;top:415px;left:717px;white-space:nowrap" class="ft192">The</p>
<p style="position:absolute;top:434px;left:85px;white-space:nowrap" class="ft195">security&#160;sensitive&#160;data&#160;(VTPM-NVB,&#160;see )&#160;is&#160;encrypted&#160;with&#160;a&#160;key that&#160;is protected by<br/>the&#160;underlying&#160;security interface.&#160;</p>
<p style="position:absolute;top:865px;left:85px;white-space:nowrap" class="ft192">The VTPM-NVB&#160;consists&#160;of&#160;two&#160;sections.&#160;The&#160;first&#160;one&#160;contains&#160;the&#160;private&#160;part&#160;of the</p>
<p style="position:absolute;top:884px;left:85px;white-space:nowrap" class="ft1911"><i>vTPM endorsement&#160;key</i></p>
<p style="position:absolute;top:884px;left:279px;white-space:nowrap" class="ft192">&#160;(see&#160;chapter&#160;5.1.2.2). This&#160;section&#160;constitutes&#160;the “essence”&#160;of</p>
<p style="position:absolute;top:903px;left:85px;white-space:nowrap" class="ft1912">the vTPM&#160;identity and&#160;remains&#160;immutable&#160;for&#160;its&#160;lifetime.&#160;The second&#160;section&#160;contains<br/>the private&#160;data&#160;the&#160;vTPM&#160;requires&#160;to perform&#160;its operations.&#160;This data&#160;will&#160;be&#160;updated<br/>by&#160;the&#160;vTPM&#160;throughout its&#160;life time.&#160;Examples are the&#160;private part&#160;of&#160;the&#160;Storage Root<br/>Key&#160;and&#160;the&#160;Owner Authorization&#160;secret&#160;that&#160;will be&#160;inserted&#160;once&#160;the&#160;ownership&#160;of&#160;the<br/>vTPM&#160;has been&#160;taken.&#160;The&#160;vTPM&#160;can&#160;use this&#160;section&#160;to store&#160;any&#160;other&#160;data&#160;it requires<br/>for&#160;its&#160;operation&#160;(for&#160;instance, authorization&#160;data&#160;of&#160;a TPM&#160;key).<br/>Contrary&#160;to the VTPM-NV</p>
<p style="position:absolute;top:1027px;left:292px;white-space:nowrap" class="ft1918"><i><b>B</b></i></p>
<p style="position:absolute;top:1027px;left:304px;white-space:nowrap" class="ft1911"><i>&#160;</i></p>
<p style="position:absolute;top:1027px;left:310px;white-space:nowrap" class="ft192">section</p>
<p style="position:absolute;top:1027px;left:369px;white-space:nowrap" class="ft1911"><i>,&#160;</i></p>
<p style="position:absolute;top:1027px;left:380px;white-space:nowrap" class="ft192">the</p>
<p style="position:absolute;top:1027px;left:407px;white-space:nowrap" class="ft1911"><i>&#160;VTPM&#160;Non-Volatile&#160;Data&#160;or&#160;</i></p>
<p style="position:absolute;top:1027px;left:635px;white-space:nowrap" class="ft192">VTPM-NV</p>
<p style="position:absolute;top:1027px;left:710px;white-space:nowrap" class="ft1918"><i><b>D</b></i></p>
<p style="position:absolute;top:1027px;left:724px;white-space:nowrap" class="ft192">&#160;structure</p>
<p style="position:absolute;top:1047px;left:85px;white-space:nowrap" class="ft195">stores&#160;non-confidential&#160;information,&#160;such&#160;as&#160;the&#160;public&#160;parts&#160;of the&#160;vTPM&#160;Endorsement<br/>Key the Storage&#160;Root&#160;Key. While&#160;this data&#160;is&#160;not secret, its integrity is&#160;crucial&#160;for&#160;the<br/>proper&#160;operation&#160;of the vTPM. The&#160;VTPM-VNB&#160;structure&#160;must&#160;therefore&#160;include a<br/>cryptographic&#160;link&#160;with&#160;the&#160;VTPM-NVD&#160;to&#160;verify&#160;and&#160;guarantee&#160;data&#160;integrity.&#160;This link</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft197">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft197">19/48</p>
</div>
<!-- Page 20 -->
<a name="20"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page20-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42020.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft207">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft207">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft205">is implemented&#160;as&#160;a&#160;cryptographic&#160;digest&#160;of the VTPM-NVD&#160;structure.&#160;<br/>How&#160;a vTPM&#160;is provided&#160;with&#160;its&#160;VTPM-SS is&#160;implementation specific.&#160;After&#160;obtaining<br/>the corresponding&#160;data, the&#160;vTPM&#160;uses functionalities&#160;provided&#160;by&#160;the&#160;underlying<br/>security&#160;interface&#160;to decrypt&#160;the VTPM-NVB&#160;part.&#160;Note&#160;that&#160;the security&#160;interface<br/>should&#160;successfully&#160;complete&#160;this operation&#160;only&#160;if all&#160;integrity&#160;requirements&#160;for&#160;the<br/>vTPM&#160;instantiation&#160;are met&#160;(successful&#160;integrity checks of the hypervisor,&#160;the&#160;security<br/>service vTPM&#160;etc).&#160;As explained&#160;in section ,&#160;the integrity information&#160;should&#160;also<br/>include&#160;the&#160;binding&#160;information&#160;of the&#160;vTPM.<br/>Once&#160;the&#160;VTPM-NVB has&#160;been&#160;decrypted,&#160;the&#160;vTPM can&#160;verify&#160;the integrity of the<br/>public&#160;structure&#160;VTPM-NVD.&#160;If the&#160;hash&#160;of&#160;the&#160;VTPM-NVD&#160;structure&#160;corresponds&#160;to the<br/>hash present&#160;in&#160;the&#160;VTPM-NVB, the&#160;vTPM&#160;accepts the&#160;data&#160;as&#160;representing&#160;its initial<br/>state&#160;on which&#160;all further operations&#160;will be based.</p>
<p style="position:absolute;top:408px;left:85px;white-space:nowrap" class="ft201"><b>Initialization&#160;of Virtual&#160;PCRs</b></p>
<p style="position:absolute;top:437px;left:85px;white-space:nowrap" class="ft2012">Values&#160;in&#160;their&#160;lower&#160;PCRs&#160;of&#160;hardware&#160;TPMs&#160;are&#160;set at&#160;boot&#160;time&#160;by&#160;the&#160;Core Root&#160;of<br/>Trust for&#160;Measurement&#160;(CRTM).&#160;For&#160;vTPM,&#160;the&#160;equivalent&#160;of CRTM measurements&#160;are<br/>provided&#160;by the set&#160;software&#160;components&#160;that&#160;are involved in the instantiation&#160;of&#160;the<br/>vTPM&#160;and in providing&#160;its corresponding&#160;execution&#160;environment.&#160;<br/>Establishing&#160;trust&#160;in&#160;CRTMs is a&#160;non-trivial&#160;exercise, even&#160;if&#160;we&#160;are&#160;just dealing with<br/>hardware&#160;TPMs.&#160;From&#160;the user's&#160;point&#160;of&#160;view, this trust&#160;will&#160;typically stem&#160;from&#160;his<br/>knowledge&#160;that both the hardware&#160;TPM&#160;and&#160;the CRTM&#160;are&#160;integrated&#160;with&#160;the platform<br/>in front&#160;of him&#160;(the CRTM&#160;for the&#160;hardware&#160;TPM&#160;ideally&#160;resides&#160;in&#160;a read-only section&#160;of<br/>the platform&#160;BIOS).&#160;One&#160;function&#160;of&#160;the&#160;CRTM&#160;is&#160;to measure&#160;itself prior&#160;to&#160;measuring<br/>any&#160;other&#160;software&#160;components&#160;and&#160;to&#160;log&#160;the&#160;result&#160;into the first&#160;register&#160;of the TPM<br/>(PCR0).&#160;The&#160;user&#160;can&#160;not&#160;actually verify&#160;this&#160;value, however, unless&#160;the platform<br/>vendor&#160;has published&#160;the&#160;expected result&#160;the CRTM&#160;self-measurement.&#160;In&#160;theory,&#160;this<br/>could be&#160;facilitated by platform&#160;and conformance&#160;certificates.&#160;In practice, however,<br/>these&#160;credentials&#160;have&#160;yet to be&#160;produced&#160;by the platform&#160;vendors.&#160;At&#160;this&#160;stage&#160;in<br/>time,&#160;the values&#160;in&#160;the PCR0&#160;of hardware&#160;TPMs&#160;are&#160;completely&#160;arbitrary&#160;from&#160;the<br/>user's&#160;perspective. They&#160;are a&#160;convenient way to distinguish&#160;between&#160;different<br/>implementations&#160;and&#160;versions&#160;of CRTMs,&#160;but&#160;they neither&#160;provide&#160;security&#160;nor<br/>establish&#160;trust.<br/>If we&#160;want to establish&#160;</p>
<p style="position:absolute;top:800px;left:277px;white-space:nowrap" class="ft2011"><i>implicit</i></p>
<p style="position:absolute;top:800px;left:337px;white-space:nowrap" class="ft202">&#160;trust&#160;in&#160;the CRTM&#160;of a&#160;vTPM,&#160;we&#160;have to&#160;bind&#160;and&#160;start</p>
<p style="position:absolute;top:819px;left:85px;white-space:nowrap" class="ft205">the vTPM&#160;and&#160;the VM&#160;in&#160;a&#160;special way that&#160;is discussed&#160;in section 5.3.&#160;Alternatively,<br/>the&#160;CRTM of the vTPM&#160;can create an&#160;explicit&#160;link between&#160;itself and&#160;the&#160;CRTM&#160;of the<br/>VM&#160;attached&#160;to&#160;the vTPM.&#160;To&#160;do&#160;so,&#160;it&#160;requires&#160;the&#160;privilege&#160;to&#160;take&#160;a measurement&#160;of<br/>the&#160;CRTM&#160;of the VM&#160;and extend&#160;the PCR0&#160;of&#160;the vTPM&#160;with&#160;this&#160;value.&#160;In&#160;such&#160;a&#160;case,<br/>the PCR0&#160;no&#160;longer&#160;contains&#160;an&#160;arbitrary&#160;value,&#160;but&#160;the&#160;CRTM&#160;integrity measurement<br/>of the VM&#160;in question.<br/>Existing&#160;vTPM&#160;solutions&#160;such&#160;as&#160;[1]&#160;propose&#160;to&#160;directly map the lower&#160;PCRs&#160;of&#160;the<br/>physical&#160;TPM&#160;to&#160;the&#160;lower&#160;vPCRs&#160;of&#160;the&#160;vTPM.&#160;These&#160;PCRs&#160;contain&#160;measurements&#160;that<br/>concern&#160;the&#160;hardware&#160;platfom,&#160;its&#160;BIOS,&#160;bootloader,&#160;and&#160;hypervisor.&#160;The direct<br/>mapping&#160;of physical&#160;(TPM)&#160;to&#160;virtual&#160;(vTPM)&#160;PCRs&#160;is&#160;a&#160;straightforward&#160;method&#160;to<br/>enable&#160;(remote)&#160;integrity&#160;verification&#160;of&#160;the underlying&#160;hypervisor,&#160;using&#160;a (remote)<br/>attestation procedure&#160;with the VM&#160;and&#160;its&#160;vTPM. However,&#160;it&#160;is&#160;limited&#160;as&#160;it&#160;makes&#160;the<br/>following&#160;assumptions:</p>
<p style="position:absolute;top:1090px;left:112px;white-space:nowrap" class="ft2013">●</p>
<p style="position:absolute;top:1087px;left:139px;white-space:nowrap" class="ft205">The vTPM&#160;must&#160;be given&#160;access to&#160;a&#160;dedicated AIK&#160;(attestation&#160;Identity Key)&#160;in<br/>the hardware&#160;TPM.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft207">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft207">20/48</p>
</div>
<!-- Page 21 -->
<a name="21"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page21-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42021.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft217">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft217">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:154px;left:112px;white-space:nowrap" class="ft2113">●</p>
<p style="position:absolute;top:151px;left:139px;white-space:nowrap" class="ft212">The vTPM&#160;is the&#160;only&#160;entity&#160;able&#160;to&#160;use this&#160;dedicated&#160;key.</p>
<p style="position:absolute;top:179px;left:85px;white-space:nowrap" class="ft215">These&#160;requirements&#160;must&#160;be&#160;met to&#160;masquerade&#160;a&#160;remote attestation&#160;result that<br/>coming&#160;from&#160;the&#160;hardware&#160;TPM&#160;as one&#160;that&#160;appears&#160;to come&#160;from&#160;the&#160;vTPM&#160;(and&#160;only<br/>this&#160;specific&#160;one).&#160;<br/>The approach&#160;requires&#160;that&#160;all&#160;vTPM&#160;keys (that can&#160;be certified)&#160;have to&#160;be stored&#160;in<br/>the hardware&#160;TPM,&#160;which&#160;limits&#160;the&#160;vTPM&#160;model&#160;that&#160;can&#160;be implemented.&#160;All&#160;vTPMs<br/>share the&#160;same&#160;endorsement&#160;key,&#160;which&#160;makes&#160;migration&#160;in&#160;certain use&#160;cases<br/>impossible.&#160;Furthermore,&#160;the&#160;direct&#160;mapping&#160;of&#160;physical&#160;to&#160;virtual&#160;PCRs establishes&#160;a<br/>linkage&#160;to&#160;the underlying&#160;hardware&#160;platform&#160;that&#160;is based&#160;exclusively&#160;on&#160;cryptographic<br/>digests of specific&#160;binary&#160;components&#160;and configuration&#160;information.&#160;As&#160;outlined<br/>earlier, this&#160;inhibits to&#160;migrate&#160;virtual&#160;machines&#160;between platforms&#160;with&#160;that&#160;provide<br/>identical&#160;security&#160;properties&#160;by means&#160;of&#160;different&#160;implementations.<br/>To address&#160;this problem,&#160;indirect&#160;mapping&#160;through&#160;property&#160;providers&#160;[15]&#160;acting&#160;as<br/>trusted&#160;third&#160;parties&#160;has&#160;been&#160;suggested.&#160;On its&#160;creation,&#160;the&#160;vTPM&#160;instance&#160;requests<br/>the physical&#160;TPM&#160;to read&#160;out all&#160;relevant&#160;PCRs,&#160;i.e.,&#160;from&#160;PCR0&#160;to PCRn.&#160;Then&#160;each<br/>property&#160;provider&#160;is invoked&#160;to map&#160;these&#160;values&#160;according&#160;to&#160;his strategy.</p>
<p style="position:absolute;top:485px;left:85px;white-space:nowrap" class="ft2111"><i>PropertyProvider_A</i></p>
<p style="position:absolute;top:485px;left:244px;white-space:nowrap" class="ft212">&#160;could map&#160;the values&#160;of PCR0,...,PCR7&#160;directly&#160;to</p>
<p style="position:absolute;top:504px;left:85px;white-space:nowrap" class="ft212">vPCR0:A,...,vPCR7:A,&#160;whereas&#160;</p>
<p style="position:absolute;top:504px;left:337px;white-space:nowrap" class="ft2111"><i>PropertyProvider_B</i></p>
<p style="position:absolute;top:504px;left:496px;white-space:nowrap" class="ft212">&#160;could&#160;choose&#160;to&#160;digest&#160;all the</p>
<p style="position:absolute;top:524px;left:85px;white-space:nowrap" class="ft212">physical&#160;measurements&#160;into one&#160;single&#160;vPCR.&#160;Finally,&#160;</p>
<p style="position:absolute;top:524px;left:532px;white-space:nowrap" class="ft2111"><i>PropertyProvider_C</i></p>
<p style="position:absolute;top:524px;left:690px;white-space:nowrap" class="ft212">&#160;could</p>
<p style="position:absolute;top:543px;left:85px;white-space:nowrap" class="ft215">translate&#160;the&#160;PCR values&#160;into&#160;abstract&#160;properties&#160;(cf.&#160;[16]) using&#160;certificates [17][18]<br/>[19].&#160;<br/>This&#160;allows to&#160;simultaneously&#160;support&#160;different&#160;mappings,&#160;and&#160;by defining&#160;a&#160;policy&#160;for<br/>each vTPM&#160;instance,&#160;it&#160;becomes possible&#160;to&#160;control&#160;which&#160;mapping&#160;will be&#160;actually<br/>used.&#160;For&#160;instance,&#160;to&#160;support&#160;availability&#160;of sealed data&#160;after&#160;migration,&#160;we can&#160;define<br/>to&#160;use&#160;the certificate-based&#160;property&#160;provider&#160;when&#160;the VM wants to&#160;seal&#160;data to<br/>vPCR0,...,vPCR7.&#160;Further&#160;details on&#160;property&#160;based&#160;attestation&#160;and&#160;sealing&#160;are<br/>discussed&#160;in&#160;chapter&#160;7.</p>
<p style="position:absolute;top:732px;left:85px;white-space:nowrap" class="ft211"><b>5.3&#160;Binding&#160;Virtual&#160;TPMs&#160;to&#160;VMs</b></p>
<p style="position:absolute;top:761px;left:85px;white-space:nowrap" class="ft215">The implementation&#160;of a&#160;vTPM&#160;mandates&#160;to&#160;check&#160;and&#160;safeguard&#160;its integrity as&#160;well<br/>as&#160;that&#160;of&#160;its execution environment.&#160;We&#160;also&#160;have&#160;to&#160;isolate&#160;it&#160;from&#160;other&#160;software<br/>running&#160;on the platform&#160;as&#160;well&#160;as&#160;possible.&#160;Ultimately,&#160;we&#160;want&#160;assurance&#160;that<br/>information&#160;reported&#160;by&#160;the vTPMs&#160;actually&#160;reflects&#160;the&#160;integrity&#160;state&#160;of its associated<br/>VM, and&#160;that the policy of&#160;a&#160;VM&#160;is&#160;enforced&#160;by&#160;on its behalf&#160;by the associated&#160;vTPM.&#160;<br/>This&#160;requires to establish&#160;and&#160;maintain&#160;a&#160;proper&#160;binding&#160;between&#160;vTPM&#160;and&#160;its<br/>associated&#160;VM.&#160;To&#160;stay&#160;in line&#160;with the&#160;spirit&#160;of the TCG&#160;specification,&#160;a virtual&#160;TPM<br/>needs to&#160;have the following&#160;properties:</p>
<p style="position:absolute;top:935px;left:112px;white-space:nowrap" class="ft2113">●</p>
<p style="position:absolute;top:932px;left:139px;white-space:nowrap" class="ft215">An exclusive&#160;communication&#160;channel&#160;between&#160;the vTPM and&#160;its VM.&#160;To&#160;prevent<br/>impersonation,&#160;no&#160;other&#160;components&#160;must be&#160;allowed&#160;to&#160;send&#160;or&#160;receive<br/>communication&#160;transmitted&#160;over&#160;this channel.</p>
<p style="position:absolute;top:1002px;left:112px;white-space:nowrap" class="ft2113">●</p>
<p style="position:absolute;top:999px;left:139px;white-space:nowrap" class="ft215">The vTPM&#160;must&#160;instantiated,&#160;started&#160;and&#160;ready&#160;to&#160;be connected before&#160;its<br/>corresponding&#160;VM&#160;is&#160;started.&#160;Since.&#160;the&#160;vTPM&#160;stores&#160;the&#160;VM's integrity&#160;, it&#160;must<br/>ready&#160;to&#160;receive&#160;the&#160;very&#160;first&#160;measurement&#160;of&#160;the VM's&#160;own&#160;CRTM&#160;before&#160;the<br/>CRTM&#160;performs&#160;the first&#160;</p>
<p style="position:absolute;top:1056px;left:342px;white-space:nowrap" class="ft2111"><i>TPM_Extend</i></p>
<p style="position:absolute;top:1056px;left:442px;white-space:nowrap" class="ft212">&#160;command.&#160;Failure&#160;to meet&#160;this</p>
<p style="position:absolute;top:1076px;left:139px;white-space:nowrap" class="ft212">requirement&#160;would compromise&#160;the&#160;chain of trust for the guest&#160;VM.</p>
<p style="position:absolute;top:1107px;left:112px;white-space:nowrap" class="ft2113">●</p>
<p style="position:absolute;top:1104px;left:139px;white-space:nowrap" class="ft212">The vTPM&#160;must&#160;only&#160;“exist” if and&#160;as&#160;long&#160;all&#160;of the&#160;above&#160;conditions&#160;(including</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft217">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft217">21/48</p>
</div>
<!-- Page 22 -->
<a name="22"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page22-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42022.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft227">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft227">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:139px;white-space:nowrap" class="ft225">this&#160;one) are&#160;enforced&#160;and&#160;have&#160;been enforced&#160;since the&#160;vTPM&#160;has been<br/>started.</p>
<p style="position:absolute;top:216px;left:85px;white-space:nowrap" class="ft2215"><b>5.3.1&#160;Protected communication channel</b></p>
<p style="position:absolute;top:243px;left:85px;white-space:nowrap" class="ft225">The protocols&#160;defined&#160;by&#160;TCG&#160;to communicate&#160;with&#160;a&#160;TPM&#160;guarantee&#160;the&#160;integrity of<br/>the information&#160;sent and&#160;received&#160;by the&#160;use&#160;of cryptographic&#160;means.&#160;The protocols<br/>provide&#160;a certain&#160;level&#160;of confidentiality&#160;for&#160;the&#160;data transmitted.&#160;From&#160;a&#160;theoretical<br/>point of&#160;view, we&#160;could limit&#160;the&#160;requirement on&#160;the&#160;communication&#160;channel&#160;between<br/>a VM&#160;and its&#160;vTPM&#160;to&#160;be writable&#160;only by the&#160;VM while being&#160;readable&#160;by&#160;any other<br/>entity. Confidential&#160;communication&#160;between a VM and&#160;its associated&#160;vTPM&#160;has to&#160;be<br/>provided,&#160;though,&#160;if&#160;the owner of the hardware&#160;TPM&#160;considered&#160;to&#160;be&#160;untrusted.<br/>Protected&#160;communication&#160;between the&#160;VM&#160;and&#160;its&#160;vTPM&#160;should&#160;be&#160;operational&#160;and&#160;at<br/>any given&#160;time. Even temporarily&#160;unavailability&#160;should&#160;be interpreted&#160;as&#160;a change&#160;in<br/>the&#160;integrity of the vTPM&#160;environment.<br/>The mechanism&#160;used&#160;to&#160;bind&#160;the&#160;vTPM&#160;with&#160;its VM&#160;part&#160;of&#160;the conditions&#160;for the<br/>existence&#160;of the vTPM.&#160;Whether based&#160;on&#160;cryptographic&#160;protocol&#160;or&#160;simply&#160;enforced&#160;by<br/>the overall&#160;design&#160;of&#160;the&#160;system,&#160;the&#160;nature&#160;and&#160;properties&#160;of the protection<br/>mechanism&#160;must&#160;therefore&#160;be&#160;captured&#160;as&#160;part&#160;of&#160;the&#160;integrity metrics&#160;of the vTPM<br/>environment.&#160;</p>
<p style="position:absolute;top:576px;left:85px;white-space:nowrap" class="ft2215"><b>5.3.2&#160;Boot Order&#160;and Initial&#160;Measurements</b></p>
<p style="position:absolute;top:602px;left:85px;white-space:nowrap" class="ft225">Virtual&#160;PCRS&#160;of&#160;the&#160;vTPM&#160;must&#160;genuinely&#160;represent&#160;the&#160;current&#160;state&#160;of the&#160;VM.&#160;The<br/>vTPM&#160;must&#160;be&#160;capable&#160;to&#160;respond&#160;to&#160;</p>
<p style="position:absolute;top:622px;left:393px;white-space:nowrap" class="ft2211"><i>TPM_extend</i></p>
<p style="position:absolute;top:622px;left:493px;white-space:nowrap" class="ft222">&#160;onwards&#160;from the&#160;point in time&#160;when</p>
<p style="position:absolute;top:641px;left:85px;white-space:nowrap" class="ft225">its associated&#160;VM&#160;is&#160;being&#160;activated.&#160;Before&#160;this VM&#160;is started,&#160;the&#160;vTPM&#160;must&#160;have<br/>been instantiated&#160;– all&#160;its internal&#160;state&#160;has been initialized, and&#160;the&#160;communication<br/>channel&#160;must&#160;be&#160;up&#160;and&#160;running.&#160;<br/>This&#160;can&#160;be&#160;achieved&#160;by&#160;the&#160;systemic&#160;and mandatory&#160;creation&#160;of&#160;a vTPM&#160;for every<br/>newly created&#160;VM.&#160;The&#160;subsystem&#160;launching&#160;the&#160;VM&#160;would&#160;first&#160;instantiate&#160;a vTPM<br/>using a fresh&#160;and&#160;unique&#160;VTPM-NVB, then&#160;allocate&#160;the&#160;resources&#160;for&#160;the&#160;VM,&#160;sets&#160;up its<br/>communications&#160;channels, and&#160;finally&#160;starts&#160;the&#160;VM.&#160;The&#160;VM's&#160;CRTM&#160;can&#160;be<br/>instrumented&#160;to&#160;abort&#160;the&#160;boot&#160;process&#160;if&#160;it&#160;can&#160;not&#160;interact&#160;with the vTPM. This<br/>requires&#160;to&#160;measure&#160;and&#160;report&#160;the&#160;integrity&#160;state of the VM's&#160;CRTM&#160;to the&#160;vTPM's<br/>PCR0. Measurement and invocation&#160;of&#160;the&#160;</p>
<p style="position:absolute;top:823px;left:439px;white-space:nowrap" class="ft2211"><i>TPM_extend</i></p>
<p style="position:absolute;top:823px;left:539px;white-space:nowrap" class="ft222">&#160;command&#160;would&#160;be&#160;performed</p>
<p style="position:absolute;top:842px;left:85px;white-space:nowrap" class="ft225">by the VM's&#160;CRTM,&#160;that&#160;is,&#160;the&#160;virtual&#160;boot-loader.<br/>Initialization&#160;events&#160;preceding the actual launch of&#160;a&#160;particular&#160;VM&#160;(including&#160;the&#160;setup<br/>of its communication&#160;channel&#160;to the vTPM&#160;as&#160;well as&#160;the&#160;CRTM of the VM)&#160;must&#160;be<br/>captured,&#160;measured&#160;and&#160;reported&#160;to&#160;the vTPM,&#160;as&#160;well as&#160;mechanisms&#160;used&#160;to&#160;enforce<br/>the boot&#160;order&#160;of the&#160;vTPM&#160;and&#160;its&#160;VM.&#160;They are part&#160;of&#160;the conditions&#160;of the vTPM's<br/>existence.</p>
<p style="position:absolute;top:993px;left:85px;white-space:nowrap" class="ft2215"><b>5.3.3&#160;Conditional&#160;Existence&#160;</b></p>
<p style="position:absolute;top:1020px;left:85px;white-space:nowrap" class="ft2212">The existence condition&#160;stipulates&#160;that&#160;a vTPM&#160;must&#160;always&#160;have&#160;the properties&#160;the<br/>manufacturer&#160;vouches&#160;for. If&#160;these&#160;properties&#160;can&#160;not be&#160;guaranteed&#160;(even<br/>temporarily),&#160;the&#160;vTPM&#160;should&#160;simply&#160;not&#160;exist.&#160;This requirement&#160;must&#160;be addressed<br/>within&#160;the context of&#160;a&#160;Trusted&#160;Virtual&#160;Platform.<br/>A&#160;vTPM&#160;ceases to&#160;“exist”&#160;if it can&#160;not access&#160;the&#160;cryptographic&#160;material&#160;needed&#160;to</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft227">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft227">22/48</p>
</div>
<!-- Page 23 -->
<a name="23"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page23-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42023.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft237">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft237">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft235">perform&#160;its operations&#160;. This includes&#160;the&#160;protected&#160;sections&#160;of the VTPM-VNB&#160;and&#160;any<br/>other keys&#160;and secrets&#160;generated or loaded&#160;by the&#160;vTPM&#160;since its&#160;instantiation.<br/>Although it is sufficient&#160;to withdraw&#160;access&#160;to&#160;these secrets, it&#160;might&#160;be&#160;easier&#160;for<br/>practical&#160;implementation&#160;to terminate&#160;its&#160;existence&#160;by&#160;destroying&#160;the&#160;whole vTPM<br/>instance&#160;Again,&#160;the&#160;mechanisms&#160;used to&#160;enforce&#160;the conditional creation&#160;and<br/>destruction&#160;of&#160;the&#160;vTPM&#160;must&#160;be captured&#160;as&#160;integrity measurements&#160;of the execution<br/>environment&#160;the&#160;vTPM. This&#160;requirement&#160;is “circular”, it&#160;means&#160;that&#160;a&#160;vTPM&#160;should<br/>only&#160;exists in&#160;an&#160;environment&#160;that&#160;has been&#160;vouched for&#160;by&#160;the&#160;vTPM&#160;manufacturer&#160;to<br/>enforce&#160;the&#160;conditions for&#160;its existence.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft237">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft237">23/48</p>
</div>
<!-- Page 24 -->
<a name="24"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page24-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42024.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft247">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft247">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:172px;left:85px;white-space:nowrap" class="ft249"><b>6&#160;</b></p>
<p style="position:absolute;top:169px;left:117px;white-space:nowrap" class="ft2410"><b>vTPMs&#160;and Trusted&#160;Virtual&#160;Platforms</b></p>
<p style="position:absolute;top:614px;left:85px;white-space:nowrap" class="ft241"><b>6.1&#160;Definitions</b></p>
<p style="position:absolute;top:642px;left:85px;white-space:nowrap" class="ft245">A Virtual&#160;Platform&#160;(VP)&#160;is&#160;the&#160;virtual&#160;equivalent&#160;of&#160;a&#160;physical&#160;platform&#160;like a&#160;laptop&#160;or&#160;a<br/>server.&#160;As&#160;a physical&#160;platform&#160;consists&#160;of&#160;different&#160;components,&#160;the&#160;VP&#160;needs&#160;virtual<br/>counterparts&#160;as illustrated&#160;in&#160;Figure&#160;3.&#160;The VP layout&#160;requires&#160;at&#160;least&#160;one&#160;Virtual<br/>Machine&#160;(VM)&#160;as&#160;execution&#160;environment,&#160;a&#160;virtual&#160;memory&#160;and&#160;a&#160;virtual&#160;TPM&#160;to<br/>guarantee&#160;the trustworthiness&#160;of this basic&#160;VP. Other components&#160;such&#160;as&#160;virtual<br/>storage&#160;(vSto),&#160;virtual&#160;networking&#160;devices (vNet),&#160;virtual&#160;human&#160;interface devices<br/>(vHID)&#160;or&#160;generic virtual&#160;devices (vDev)&#160;are optional.&#160;We distinguish&#160;</p>
<p style="position:absolute;top:788px;left:112px;white-space:nowrap" class="ft2413">●</p>
<p style="position:absolute;top:785px;left:139px;white-space:nowrap" class="ft245">simple&#160;resource&#160;components,&#160;which are directly related to the&#160;underlying<br/>physical&#160;hardware&#160;(i.e.&#160;a&#160;virtual&#160;network&#160;card&#160;multiplexed&#160;by the virtualization<br/>layer),&#160;and&#160;</p>
<p style="position:absolute;top:855px;left:112px;white-space:nowrap" class="ft2413">●</p>
<p style="position:absolute;top:852px;left:139px;white-space:nowrap" class="ft245">virtual&#160;machines&#160;dedicated&#160;to&#160;providing&#160;a&#160;certain&#160;type of hardware&#160;or&#160;device<br/>service (i.e.&#160;a VM&#160;acting&#160;as&#160;a&#160;virtual&#160;network&#160;switch&#160;to&#160;provide&#160;preconfigured<br/>ports&#160;to&#160;the execution&#160;environment).&#160;</p>
<p style="position:absolute;top:918px;left:85px;white-space:nowrap" class="ft245">The&#160;VP&#160;is dependent&#160;on&#160;several&#160;services&#160;as&#160;depicted&#160;in&#160;Figure&#160;2.&#160;These&#160;services&#160;allow<br/>the&#160;VP to&#160;be agnostic&#160;with&#160;regard&#160;to&#160;the specific implementation&#160;of&#160;the underlying<br/>virtual&#160;machine&#160;monitor&#160;(VMM).&#160;&#160;They&#160;also allow&#160;to&#160;distribute&#160;a virtual&#160;platform&#160;among<br/>different&#160;physical&#160;hosts.&#160;</p>
<p style="position:absolute;top:1004px;left:85px;white-space:nowrap" class="ft2411"><i>Device services</i></p>
<p style="position:absolute;top:1004px;left:214px;white-space:nowrap" class="ft242">&#160;are&#160;handled&#160;by&#160;the VMM.&#160;They&#160;provide&#160;resource&#160;access of&#160;virtual</p>
<p style="position:absolute;top:1023px;left:85px;white-space:nowrap" class="ft245">machines&#160;in an&#160;abstract&#160;way,&#160;that&#160;is,&#160;independently of&#160;the&#160;specific&#160;VMM<br/>implementation.&#160;Device services can&#160;be&#160;regarded&#160;as VMM&#160;specific&#160;hardware&#160;drivers.<br/>They&#160;enable VM&#160;access&#160;to&#160;physical hardware&#160;by&#160;exposing&#160;virtual&#160;(multiplexed)<br/>counterparts&#160;of the device&#160;interfaces.&#160;</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft247">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft247">24/48</p>
<p style="position:absolute;top:542px;left:121px;white-space:nowrap" class="ft2415"><b>Figure 2: Virtual&#160;Platform Layout</b></p>
</div>
<!-- Page 25 -->
<a name="25"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page25-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42025.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft257">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft257">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:656px;left:85px;white-space:nowrap" class="ft252">The&#160;</p>
<p style="position:absolute;top:656px;left:121px;white-space:nowrap" class="ft2511"><i>management&#160;layer</i></p>
<p style="position:absolute;top:656px;left:278px;white-space:nowrap" class="ft252">&#160;is split&#160;to&#160;into&#160;two&#160;parts.&#160;(1) Physical&#160;platform&#160;management</p>
<p style="position:absolute;top:675px;left:85px;white-space:nowrap" class="ft2512">provides&#160;features&#160;to&#160;manage&#160;access or&#160;configuration&#160;of the real&#160;hardware&#160;whereas&#160;(2)<br/>virtual&#160;platform&#160;management&#160;takes care of&#160;handling&#160;VP&#160;specific&#160;tasks&#160;such as&#160;VP<br/>migration&#160;or&#160;setup.&#160;<br/>Finally,&#160;there&#160;are a&#160;number of&#160;</p>
<p style="position:absolute;top:741px;left:337px;white-space:nowrap" class="ft2511"><i>supporting&#160;services</i></p>
<p style="position:absolute;top:741px;left:499px;white-space:nowrap" class="ft252">.&#160;They constitute&#160;a&#160;binding&#160;layer</p>
<p style="position:absolute;top:761px;left:85px;white-space:nowrap" class="ft255">between&#160;physical&#160;and&#160;virtual&#160;platform,&#160;providing&#160;services to&#160;resource&#160;services,<br/>management&#160;layer&#160;and&#160;the&#160;VP itself).&#160;With&#160;regard&#160;to vTPMs&#160;the&#160;integrity and<br/>credential&#160;service are&#160;of&#160;special interest, since they&#160;are&#160;able&#160;to&#160;offer&#160;strongly bound<br/>vTPMs&#160;(see&#160;section&#160;6.2.2).&#160;</p>
<p style="position:absolute;top:864px;left:85px;white-space:nowrap" class="ft251"><b>6.2&#160;Generalization&#160;of&#160;binding property</b></p>
<p style="position:absolute;top:893px;left:85px;white-space:nowrap" class="ft255">VPs&#160;are&#160;geared&#160;towards&#160;offering&#160;similar&#160;levels of isolation&#160;and protection&#160;as physical<br/>platforms.&#160;On&#160;physical&#160;platforms,&#160;the&#160;strong&#160;binding&#160;between&#160;different&#160;platform<br/>components&#160;relies&#160;on&#160;physical&#160;features&#160;(electrical&#160;connections,&#160;circuits&#160;soldered&#160;to&#160;a<br/>motherboard,&#160;casing.)&#160;On virtual&#160;platforms,&#160;a&#160;strong&#160;binding&#160;between&#160;VP components<br/>has&#160;to be&#160;safeguarded&#160;by software&#160;mechanisms&#160;which&#160;are&#160;part&#160;of the VP's&#160;Trusted<br/>Computing&#160;Base.&#160;</p>
<p style="position:absolute;top:1035px;left:85px;white-space:nowrap" class="ft2515"><b>6.2.1&#160;Binding of components&#160;using&#160;HIM</b></p>
<p style="position:absolute;top:1061px;left:85px;white-space:nowrap" class="ft255">The hierarchical&#160;integrity&#160;management&#160;(HIM) framework&#160;presented&#160;in&#160;[20]&#160;is the<br/>essential&#160;part&#160;to keep track&#160;which&#160;and&#160;how&#160;VP&#160;components&#160;are&#160;bound to&#160;each&#160;other.&#160;It<br/>acts as the&#160;integrity&#160;service&#160;in&#160;the&#160;supporting&#160;service layer&#160;of&#160;the&#160;VP concept. The&#160;HIM<br/>does&#160;not measure components, but only&#160;manages&#160;such measurements.&#160;In other</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft257">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft257">25/48</p>
<p style="position:absolute;top:596px;left:91px;white-space:nowrap" class="ft2515"><b>Figure&#160;3: Virtual Platform&#160;Services</b></p>
</div>
<!-- Page 26 -->
<a name="26"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page26-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42026.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft267">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft267">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft265">words,&#160;the&#160;HIM relies on&#160;measurements&#160;being supplied&#160;by&#160;other services.&#160;For&#160;example,<br/>such&#160;a&#160;service&#160;could&#160;implement&#160;to&#160;copy a&#160;subset&#160;of&#160;values from&#160;the hardware&#160;TPM&#160;to<br/>the HIM,&#160;or&#160;it&#160;could&#160;be&#160;a&#160;VM&#160;loader&#160;that&#160;performs&#160;measurements&#160;of VM&#160;images&#160;prior&#160;to<br/>starting&#160;them.<br/>The&#160;HIM concepts allows to&#160;define&#160;parent/child dependencies between measurements<br/>of individual&#160;components&#160;and/or&#160;software.&#160;It&#160;supports&#160;reversible,&#160;dynamic&#160;changes&#160;of<br/>measurements&#160;(registers&#160;can&#160;be marked&#160;as&#160;dynamic).&#160;<br/>Suppose,&#160;for instance,&#160;a firewall&#160;component&#160;acting&#160;as vNet&#160;device&#160;for a VP.&#160;Its<br/>standard&#160;configuration&#160;would&#160;typically be&#160;stored&#160;as&#160;static&#160;measurement.&#160;However,&#160;if<br/>the policy&#160;allows&#160;users to temporarily&#160;open&#160;ports&#160;(to&#160;use&#160;e.g.&#160;a&#160;peer-to-peer network),<br/>the measurements&#160;corresponding&#160;to the peer-to-peer&#160;configuration&#160;can be&#160;stored&#160;in&#160;a<br/>dynamic&#160;register. The platform&#160;would be&#160;considered&#160;untrustworthy&#160;as&#160;long as&#160;these<br/>ports are used. Once&#160;they&#160;are closed&#160;again,&#160;the integrity state&#160;of&#160;the&#160;network<br/>component&#160;can&#160;be&#160;reverted&#160;back to&#160;trusted.&#160;<br/>The strong&#160;binding&#160;between&#160;components&#160;is realized by hierarchical&#160;dependencies. If a<br/>component&#160;(X)&#160;registers&#160;other&#160;ones (Y,Z),&#160;X is considered&#160;parent&#160;of Y and&#160;Z;&#160;Y&#160;and&#160;Z<br/>are&#160;child&#160;components&#160;of X.&#160;Y and Z can already&#160;be parents,&#160;or&#160;they&#160;can become<br/>parents&#160;of&#160;newly registered&#160;children.&#160;A child component&#160;can&#160;have&#160;multiple&#160;parent.&#160;If<br/>the&#160;integrity of a&#160;parent&#160;component&#160;is&#160;compromised,&#160;all child&#160;components&#160;are<br/>considered&#160;compromised&#160;as&#160;well.&#160;To&#160;exemplify&#160;this, the VP&#160;layout of Figure&#160;3 can&#160;be<br/>configured&#160;so that&#160;the&#160;integrity of the&#160;first&#160;VM&#160;and&#160;the vMem&#160;needs to be intact<br/>(parent&#160;components)&#160;for the vSto&#160;or&#160;vNet&#160;devices (child&#160;components)&#160;to&#160;become<br/>available.<br/>The description&#160;of&#160;the&#160;VP layout&#160;(as identified&#160;by&#160;component&#160;measurements&#160;and&#160;their<br/>dependencies)&#160;is stored&#160;external&#160;to the&#160;VP&#160;in&#160;a separate&#160;TPM. The description&#160;is&#160;thus<br/>protected&#160;it from&#160;being&#160;changed&#160;by&#160;the&#160;VP&#160;it&#160;describes.&#160;Storing the layout outside&#160;of<br/>the VP&#160;safeguards&#160;that&#160;the VP comprises&#160;of all&#160;necessary&#160;components,&#160;each&#160;of&#160;them<br/>with&#160;verified&#160;integrity.</p>
<p style="position:absolute;top:752px;left:85px;white-space:nowrap" class="ft2615"><b>6.2.2&#160;VTPM and&#160;HIM</b></p>
<p style="position:absolute;top:778px;left:85px;white-space:nowrap" class="ft265">The architecture&#160;of a&#160;vTPM&#160;consists&#160;of a&#160;front-end&#160;that&#160;exposes a&#160;standardized<br/>hardware&#160;TPM interface,&#160;and&#160;an implementation&#160;of the TPM&#160;logic&#160;that&#160;stores&#160;the vTPM<br/>keys&#160;with&#160;the help&#160;of&#160;the HIM.&#160;<br/>The&#160;HIM service&#160;allows the creation of vTPMs&#160;that&#160;are&#160;bound&#160;to the integrity&#160;of&#160;the<br/>physical&#160;and/or&#160;the&#160;virtual&#160;platform.&#160;In&#160;this&#160;case,&#160;access&#160;to&#160;resources&#160;and&#160;functionality<br/>of a particular&#160;vTPM&#160;(e.g. its&#160;keys,&#160;or&#160;the&#160;capability&#160;to do&#160;remote&#160;attestation)&#160;will<br/>depend&#160;on&#160;the&#160;integrity of all&#160;components&#160;that were&#160;registered&#160;as&#160;its parents.&#160;vTPMs<br/>can&#160;be associated&#160;exclusively with&#160;a&#160;specific&#160;component&#160;or&#160;application.&#160;The&#160;associated<br/>component&#160;can&#160;be&#160;registered&#160;as a&#160;parent&#160;for&#160;the vTPM,&#160;in&#160;which&#160;case vTPM&#160;keys&#160;for<br/>signing&#160;will&#160;only&#160;be&#160;released&#160;if&#160;the assigned&#160;component&#160;is in&#160;a&#160;trusted state as well.<br/>Different&#160;VP&#160;components&#160;can&#160;make&#160;use&#160;of&#160;multiple&#160;vTPM.&#160;Eventually,&#160;this&#160;can&#160;lead to&#160;a<br/>distributed&#160;Virtual&#160;Platform.&#160;Each&#160;component&#160;might&#160;be&#160;able&#160;to exist&#160;on its&#160;own in an<br/>untrusted&#160;state,&#160;but&#160;only&#160;the union&#160;of&#160;all&#160;components&#160;is able&#160;to&#160;compose&#160;the VP as&#160;a<br/>whole.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft267">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft267">26/48</p>
</div>
<!-- Page 27 -->
<a name="27"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page27-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42027.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft277">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft277">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft271"><b>6.3&#160;Bootstrapping&#160;a&#160;Virtual&#160;Platform&#160;with&#160;a&#160;VTPM</b></p>
<p style="position:absolute;top:179px;left:85px;white-space:nowrap" class="ft275">The&#160;boot&#160;process of a VP starts&#160;with&#160;the&#160;initial&#160;measurement&#160;of the core components.<br/>The measurements&#160;are&#160;performed&#160;by&#160;the&#160;launcher(s)&#160;of&#160;the VP core&#160;components&#160;and<br/>are&#160;logged&#160;by a&#160;VP external&#160;(possibly&#160;virtual) TPM.&#160;These measurements&#160;are&#160;compared<br/>to&#160;the ones&#160;stored&#160;by&#160;the&#160;HIM service.&#160;In&#160;case&#160;they&#160;match,&#160;the next&#160;level&#160;of<br/>components&#160;can be&#160;started.&#160;<br/>For&#160;example,&#160;assume&#160;a vSto&#160;component&#160;for enabling&#160;access&#160;to a remote&#160;storage<br/>medium&#160;though&#160;a local&#160;interface.&#160;We&#160;require&#160;that&#160;this component&#160;should&#160;only&#160;become<br/>operational&#160;if the&#160;kernel&#160;of&#160;its execution environment&#160;was&#160;verified.&#160;To this end, we will<br/>initialize a vTPM&#160;inside&#160;the&#160;VP&#160;which is&#160;attached&#160;to the&#160;execution&#160;environment&#160;and<br/>bound&#160;to&#160;the&#160;integrity of the&#160;kernel.&#160;The signing&#160;keys&#160;for&#160;the&#160;vTPM&#160;will be bound&#160;to&#160;the<br/>measurements&#160;of&#160;an&#160;untampered&#160;kernel.&#160;Thus, the&#160;vTPM&#160;can&#160;only use&#160;these&#160;keys&#160;if<br/>the&#160;measurement&#160;values&#160;of the kernel&#160;are&#160;as&#160;expected.&#160;The&#160;vTPM&#160;behaves like<br/>hardware&#160;TPM&#160;on&#160;a&#160;physical&#160;platform,&#160;in&#160;that&#160;it&#160;implicitly confirms&#160;the&#160;integrity of&#160;the<br/>kernel&#160;bootup&#160;with&#160;each&#160;operation&#160;that uses&#160;keys&#160;bound&#160;to&#160;the corresponding<br/>measurements.<br/>Upon&#160;successful&#160;launch&#160;of&#160;vSto,&#160;applications&#160;using&#160;this&#160;service could&#160;be&#160;started&#160;and<br/>measured&#160;by&#160;a&#160;vTPM attached&#160;to the execution environment. This&#160;vTPM&#160;can&#160;be&#160;used<br/>by&#160;external&#160;parties&#160;for remote&#160;attestation (i.e. a&#160;banking&#160;house can&#160;request&#160;a<br/>measurement&#160;of the&#160;browser&#160;used for&#160;online&#160;banking) offering&#160;a possibility&#160;to&#160;use&#160;a<br/>trusted&#160;(bound&#160;the the platform)&#160;TPM&#160;without&#160;direct&#160;access the the&#160;hardware&#160;TPM.&#160;<br/>As mentioned&#160;above,&#160;the HIM&#160;supports&#160;dynamic&#160;measurements&#160;and&#160;ex-post&#160;reversal<br/>to a trusted&#160;state. This&#160;allows&#160;a certain grad&#160;of flexibility&#160;when&#160;starting up VP<br/>components,&#160;provided&#160;that&#160;support&#160;for re-initialization is&#160;available.&#160;In&#160;this case,&#160;a<br/>component&#160;could be&#160;initialized&#160;in&#160;a less restrictive&#160;mode&#160;to&#160;perform&#160;certain system<br/>tasks.&#160;At a&#160;later&#160;stage,&#160;they&#160;could&#160;be&#160;re-initialized&#160;to&#160;a know&#160;trusted&#160;state.<br/>This&#160;mechanism&#160;allows&#160;to&#160;introduce&#160;a&#160;provisional&#160;association&#160;of&#160;a&#160;component&#160;to a VP<br/>that&#160;changes&#160;into a&#160;strong&#160;binding&#160;once&#160;trusted re-initialization&#160;has taken&#160;place.<br/>Clearly,&#160;this option&#160;has&#160;to&#160;be used&#160;with&#160;care:&#160;even&#160;with&#160;a&#160;less&#160;restrictive&#160;policy,&#160;the<br/>component&#160;must&#160;not&#160;be&#160;in&#160;a position&#160;to&#160;subvert&#160;the TCB of the virtual&#160;platform.&#160;<br/>Note&#160;that&#160;this kind&#160;of 'untrusted&#160;initialization'&#160;wil&#160;be&#160;measured&#160;and&#160;logged&#160;to as well,<br/>resulting&#160;in one or more&#160;unexpected&#160;PCR values.&#160;Consequently,&#160;all vTPM&#160;signing&#160;keys<br/>bound&#160;to&#160;these&#160;expected&#160;PCR&#160;values&#160;are&#160;inaccessible.&#160;This&#160;may&#160;inhibit&#160;the verification<br/>and&#160;attestation&#160;of&#160;certain&#160;VP components&#160;and&#160;the overall&#160;VP as&#160;long&#160;as the<br/>corresponding&#160;value has&#160;not been&#160;reset as&#160;a result&#160;of&#160;a&#160;trusted&#160;component<br/>reinitialization.&#160;</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft277">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft277">27/48</p>
</div>
<!-- Page 28 -->
<a name="28"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft2820{font-size:16px;line-height:20px;font-family:IHILJD+BitstreamVeraSans;color:#000000;}
-->
</style>
<div id="page28-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42028.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft287">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft287">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:172px;left:85px;white-space:nowrap" class="ft289"><b>7&#160;</b></p>
<p style="position:absolute;top:169px;left:117px;white-space:nowrap" class="ft2810"><b>Enhancing vTPM Functionalities</b></p>
<p style="position:absolute;top:199px;left:85px;white-space:nowrap" class="ft285">The enhanced&#160;vTPM&#160;architecture proposed&#160;in&#160;the&#160;following&#160;sections&#160;supports&#160;usage<br/>strategies&#160;for&#160;cryptographic&#160;keys&#160;that are&#160;based&#160;on&#160;a&#160;user-defined&#160;policy of the<br/>hypervisor&#160;system.&#160;This&#160;requires&#160;no&#160;modifications&#160;of the VM&#160;software:&#160;the driver&#160;in&#160;the<br/>guest&#160;OS that&#160;now&#160;interfaces&#160;a&#160;vTPM&#160;instead&#160;of&#160;a&#160;hardware&#160;TPM.&#160;Existing&#160;TPM-enabled<br/>applications&#160;directly&#160;benefit&#160;from&#160;the flexibility of the underlying&#160;vTPM.&#160;<br/>The set&#160;of&#160;new vTPM&#160;measurement&#160;functions&#160;implemented&#160;for&#160;this&#160;purpose&#160;can be<br/>used&#160;to&#160;realize&#160;so-called&#160;</p>
<p style="position:absolute;top:323px;left:291px;white-space:nowrap" class="ft2811"><i>property-based</i></p>
<p style="position:absolute;top:323px;left:418px;white-space:nowrap" class="ft282">&#160;attestation&#160;and&#160;sealing.&#160;Before&#160;describing&#160;the</p>
<p style="position:absolute;top:342px;left:85px;white-space:nowrap" class="ft285">details of the design,&#160;we briefly&#160;introduce&#160;the&#160;general&#160;concept&#160;of&#160;property-based<br/>attestation.</p>
<p style="position:absolute;top:408px;left:85px;white-space:nowrap" class="ft281"><b>7.1&#160;Property-Based&#160;Attestation</b></p>
<p style="position:absolute;top:436px;left:85px;white-space:nowrap" class="ft285">Attestation&#160;based&#160;on&#160;the measurements&#160;of binaries&#160;and&#160;configuration&#160;files&#160;comes with<br/>several&#160;drawbacks:&#160;</p>
<p style="position:absolute;top:486px;left:112px;white-space:nowrap" class="ft2813">●</p>
<p style="position:absolute;top:483px;left:139px;white-space:nowrap" class="ft285">Disclosure&#160;of platform&#160;configuration&#160;details could&#160;be&#160;abused&#160;for&#160;platform<br/>tracking&#160;(privacy)&#160;and&#160;for&#160;discriminating&#160;against&#160;specific&#160;system&#160;configurations;</p>
<p style="position:absolute;top:534px;left:112px;white-space:nowrap" class="ft2813">●</p>
<p style="position:absolute;top:531px;left:139px;white-space:nowrap" class="ft285">Lack of flexibility.&#160;Data bound&#160;to&#160;a particular&#160;platform&#160;configuration&#160;is rendered<br/>inaccessible&#160;after&#160;system&#160;migration,&#160;update&#160;or&#160;misconfiguration&#160;(data<br/>availability);&#160;</p>
<p style="position:absolute;top:600px;left:112px;white-space:nowrap" class="ft2813">●</p>
<p style="position:absolute;top:597px;left:139px;white-space:nowrap" class="ft285">Limited&#160;scalability.&#160;A multitude&#160;of valid trusted&#160;platform&#160;configurations&#160;may<br/>exist,&#160;each of&#160;which&#160;has&#160;to be&#160;known&#160;and&#160;managed.&#160;</p>
<p style="position:absolute;top:645px;left:85px;white-space:nowrap" class="ft2820">To address&#160;these problems,&#160;it&#160;was&#160;proposed&#160;to attest abstract&#160;properties&#160;describing<br/>the characteristics&#160;and&#160;the behaviour&#160;of&#160;a&#160;program&#160;or&#160;system&#160;instead&#160;of attesting&#160;hash<br/>values&#160;of binaries&#160;and&#160;configuration&#160;files.&#160;As&#160;an example,&#160;consider&#160;the&#160;property&#160;that&#160;a<br/>hypervisor&#160;has&#160;been&#160;certified&#160;according&#160;to&#160;a&#160;certain&#160;Common&#160;Criteria&#160;protection<br/>profile.&#160;Such&#160;properties&#160;apply to&#160;different&#160;binaries,&#160;and&#160;they&#160;may&#160;be maintained&#160;even<br/>if&#160;the corresponding&#160;binaries&#160;change.<br/>Haldar&#160;et al.&#160;[21]&#160;present&#160;an&#160;approach&#160;exploiting&#160;security&#160;properties&#160;of&#160;programming<br/>languages,&#160;e.g.,&#160;type-safety.&#160;This&#160;allows to&#160;provide&#160;a mechanism&#160;for&#160;runtime<br/>attestation.&#160;However,&#160;it&#160;requires&#160;a trusted&#160;language-specific&#160;execution&#160;environment<br/>and&#160;is&#160;limited to&#160;applications&#160;written in that&#160;language.&#160;Jiang et&#160;al. [22]&#160;have&#160;shown<br/>that&#160;it&#160;is possible&#160;to&#160;have&#160;certificates stating&#160;that&#160;the key holder&#160;of&#160;a certain&#160;public&#160;key<br/>has a desired&#160;property,&#160;e.g.,&#160;to&#160;be&#160;an&#160;application&#160;running&#160;inside an&#160;untampered&#160;secure<br/>coprocessor.&#160;<br/>A&#160;pragmatic&#160;approach&#160;for&#160;property-based&#160;attestation&#160;uses&#160;property&#160;certificates [20]<br/>[18][19]. A trusted&#160;third party&#160;(TTP)&#160;issues&#160;certificates&#160;</p>
<p style="position:absolute;top:936px;left:539px;white-space:nowrap" class="ft2816"><i>cert(pkTTP , p, m)</i></p>
<p style="position:absolute;top:933px;left:672px;white-space:nowrap" class="ft282">, signed&#160;by the</p>
<p style="position:absolute;top:952px;left:85px;white-space:nowrap" class="ft285">TTP’s&#160;public&#160;key&#160;pkTTP&#160;, and&#160;stating&#160;that&#160;a&#160;binary&#160;with&#160;hash&#160;m has&#160;the&#160;property&#160;p.<br/>When&#160;a&#160;PCR&#160;of&#160;the TPM&#160;is&#160;going&#160;to&#160;be extended&#160;with&#160;a&#160;measurement&#160;value,&#160;a<br/>translation&#160;function&#160;looks&#160;for&#160;a matching&#160;certificate.&#160;If the function&#160;can&#160;find&#160;and&#160;verify<br/>a&#160;matching&#160;certificate,&#160;it&#160;extends&#160;the&#160;PCR&#160;with&#160;the public&#160;key pkTTP or,&#160;as&#160;proposed&#160;by<br/>[16],&#160;with&#160;a&#160;bit string&#160;representation&#160;of&#160;p.&#160;If&#160;no&#160;certificate&#160;is found&#160;or the verification<br/>fails,&#160;the&#160;PCR&#160;is&#160;extended&#160;with&#160;zero.&#160;<br/>These&#160;approaches&#160;can&#160;be&#160;applied&#160;to existing&#160;hardware&#160;TPMs or&#160;software-implemented<br/>virtual&#160;Trusted&#160;Platform&#160;Modules (vTPMs)&#160;by&#160;adding&#160;the translation function to a<br/>trusted&#160;component&#160;outside&#160;of&#160;the&#160;(v)TPM.&#160;In&#160;the design&#160;described&#160;in&#160;this&#160;chapter,&#160;the</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft287">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft287">28/48</p>
</div>
<!-- Page 29 -->
<a name="29"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft2921{font-size:15px;line-height:17px;font-family:IHILJB+BitstreamVeraSans;color:#000000;}
-->
</style>
<div id="page29-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42029.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft297">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft297">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft295">translation&#160;functions&#160;are&#160;performed&#160;inside&#160;the vTPM.&#160;This&#160;allows&#160;us&#160;to&#160;control&#160;the<br/>translation&#160;in each&#160;vTPM&#160;instance&#160;individually&#160;and&#160;reduces&#160;the&#160;dependency from<br/>external&#160;software&#160;components,&#160;such as&#160;running&#160;in&#160;virtual&#160;machines&#160;(VMs).&#160;<br/>Applying&#160;property-based&#160;measurement&#160;and&#160;attestation increases&#160;the flexibility in the<br/>choice&#160;of&#160;the hypervisor&#160;and&#160;allows&#160;for&#160;easier updates&#160;of&#160;applications&#160;– a&#160;VM&#160;can&#160;still<br/>use&#160;sealed data or&#160;run&#160;attestation&#160;procedures&#160;if&#160;the&#160;properties&#160;of&#160;the programs&#160;remain<br/>the same.&#160;By&#160;working&#160;on the basis&#160;of&#160;abstract&#160;properties&#160;rather&#160;than&#160;concrete<br/>configuration&#160;details,&#160;property&#160;based&#160;attestation&#160;can&#160;also&#160;enhance&#160;user&#160;privacy.<br/>Details of individual&#160;system&#160;configurations&#160;do&#160;not have&#160;to&#160;be&#160;disclosed,&#160;which makes&#160;it<br/>harder&#160;to fingerprint&#160;and&#160;track&#160;TC enabled&#160;endpoints.&#160;The&#160;drawback&#160;of&#160;property&#160;based<br/>methods&#160;is that&#160;they&#160;rely heavily on trusted&#160;intermediaries&#160;that&#160;provide&#160;the mapping<br/>between concrete&#160;configuration&#160;and&#160;abstract&#160;properties.</p>
<p style="position:absolute;top:417px;left:85px;white-space:nowrap" class="ft291"><b>7.2&#160;Enhanced&#160;vTPM&#160;Architecture</b></p>
<p style="position:absolute;top:446px;left:85px;white-space:nowrap" class="ft295">Figure&#160;4 shows&#160;the&#160;logical&#160;design&#160;of&#160;our&#160;vTPM.&#160;The main&#160;building&#160;blocks are&#160;explained<br/>in the following&#160;sub-sections.are:&#160;</p>
<p style="position:absolute;top:496px;left:112px;white-space:nowrap" class="ft2913">●</p>
<p style="position:absolute;top:493px;left:139px;white-space:nowrap" class="ft2918"><i><b>PropertyManagement:&#160;</b></i></p>
<p style="position:absolute;top:493px;left:354px;white-space:nowrap" class="ft292">represents&#160;the virtual&#160;PCRs&#160;and&#160;manages&#160;different</p>
<p style="position:absolute;top:512px;left:139px;white-space:nowrap" class="ft292">mechanisms&#160;to store&#160;and read measurement&#160;values&#160;</p>
<p style="position:absolute;top:543px;left:112px;white-space:nowrap" class="ft2913">●</p>
<p style="position:absolute;top:540px;left:139px;white-space:nowrap" class="ft2918"><i><b>KeyManagement:</b></i></p>
<p style="position:absolute;top:540px;left:302px;white-space:nowrap" class="ft292">&#160;is&#160;responsible&#160;for&#160;creating&#160;and loading&#160;keys&#160;</p>
<p style="position:absolute;top:540px;left:673px;white-space:nowrap" class="ft2918"><i><b>vTPMPolicy</b></i></p>
<p style="position:absolute;top:560px;left:139px;white-space:nowrap" class="ft292">holds&#160;the user-defined&#160;policy&#160;of the&#160;vTPM instance&#160;</p>
<p style="position:absolute;top:591px;left:112px;white-space:nowrap" class="ft2913">●</p>
<p style="position:absolute;top:588px;left:139px;white-space:nowrap" class="ft2918"><i><b>CryptographicFunctions</b></i></p>
<p style="position:absolute;top:588px;left:362px;white-space:nowrap" class="ft292">&#160;provide&#160;monotonic&#160;counters,&#160;random&#160;number</p>
<p style="position:absolute;top:607px;left:139px;white-space:nowrap" class="ft292">generation,&#160;hashing,&#160;etc.&#160;</p>
<p style="position:absolute;top:638px;left:112px;white-space:nowrap" class="ft2913">●</p>
<p style="position:absolute;top:635px;left:139px;white-space:nowrap" class="ft2918"><i><b>MigrationController&#160;</b></i></p>
<p style="position:absolute;top:635px;left:328px;white-space:nowrap" class="ft292">is&#160;responsible&#160;for&#160;migrating&#160;the&#160;vTPM&#160;to&#160;another</p>
<p style="position:absolute;top:654px;left:139px;white-space:nowrap" class="ft292">platform.&#160;</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft297">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft297">29/48</p>
<p style="position:absolute;top:1047px;left:143px;white-space:nowrap" class="ft2921"><b>Figure 4: Logical&#160;architecture of&#160;property&#160;based attestation&#160;enhanced<br/>vTPM</b></p>
</div>
<!-- Page 30 -->
<a name="30"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft3022{font-size:18px;font-family:IHIOAJ+OpenSymbol;color:#000000;}
	.ft3023{font-size:11px;font-family:TimesNewRomanPS;color:#000000;}
	.ft3024{font-size:18px;font-family:TimesNewRomanPSMT;color:#000000;}
-->
</style>
<div id="page30-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42030.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft307">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft307">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft3015"><b>7.2.1&#160;Property Management and&#160;Property&#160;Providers</b></p>
<p style="position:absolute;top:178px;left:85px;white-space:nowrap" class="ft305">In&#160;order&#160;to&#160;support&#160;property&#160;based&#160;strategies&#160;for&#160;vTPMs,&#160;the process&#160;of&#160;recording<br/>measurements&#160;into&#160;the&#160;TPMs has&#160;to be&#160;defined&#160;in&#160;a&#160;more&#160;general&#160;way.&#160;To&#160;this end,&#160;we<br/>redefine the extension function&#160;of&#160;the&#160;TPM:&#160;</p>
<p style="position:absolute;top:249px;left:296px;white-space:nowrap" class="ft3016"><i>Extend</i></p>
<p style="position:absolute;top:245px;left:349px;white-space:nowrap" class="ft3022"></p>
<p style="position:absolute;top:249px;left:354px;white-space:nowrap" class="ft3016"><i>i&#160;,&#160;m</i></p>
<p style="position:absolute;top:245px;left:385px;white-space:nowrap" class="ft3022"></p>
<p style="position:absolute;top:249px;left:392px;white-space:nowrap" class="ft3016"><i>:&#160;PCR</i></p>
<p style="position:absolute;top:258px;left:435px;white-space:nowrap" class="ft3023"><i>i</i></p>
<p style="position:absolute;top:245px;left:441px;white-space:nowrap" class="ft3022"></p>
<p style="position:absolute;top:249px;left:458px;white-space:nowrap" class="ft3016"><i>translate</i></p>
<p style="position:absolute;top:245px;left:523px;white-space:nowrap" class="ft3022"></p>
<p style="position:absolute;top:249px;left:531px;white-space:nowrap" class="ft3016"><i>PCR</i></p>
<p style="position:absolute;top:258px;left:565px;white-space:nowrap" class="ft3023"><i>i</i></p>
<p style="position:absolute;top:249px;left:571px;white-space:nowrap" class="ft3016"><i>,&#160;m</i></p>
<p style="position:absolute;top:245px;left:592px;white-space:nowrap" class="ft3022"></p>
<p style="position:absolute;top:277px;left:85px;white-space:nowrap" class="ft305">Our&#160;vTPM&#160;design&#160;is&#160;based&#160;on&#160;a&#160;plug-in-like&#160;architecture for&#160;various vPCR&#160;extension<br/>strategies.&#160;If a vTPM&#160;has to&#160;maintain&#160;full&#160;compatibility&#160;with the TCG&#160;specification,</p>
<p style="position:absolute;top:322px;left:98px;white-space:nowrap" class="ft3016"><i>translate</i></p>
<p style="position:absolute;top:318px;left:175px;white-space:nowrap" class="ft302">is&#160;would simply be&#160;defined as</p>
<p style="position:absolute;top:320px;left:432px;white-space:nowrap" class="ft3016"><i>SHA1</i></p>
<p style="position:absolute;top:316px;left:476px;white-space:nowrap" class="ft3022"></p>
<p style="position:absolute;top:320px;left:484px;white-space:nowrap" class="ft3016"><i>PCR</i></p>
<p style="position:absolute;top:330px;left:517px;white-space:nowrap" class="ft3023"><i>i</i></p>
<p style="position:absolute;top:316px;left:520px;white-space:nowrap" class="ft3022">∥</p>
<p style="position:absolute;top:320px;left:530px;white-space:nowrap" class="ft3016"><i>m</i></p>
<p style="position:absolute;top:316px;left:544px;white-space:nowrap" class="ft3022"></p>
<p style="position:absolute;top:318px;left:563px;white-space:nowrap" class="ft302">. Other&#160;extension&#160;strategies</p>
<p style="position:absolute;top:340px;left:85px;white-space:nowrap" class="ft302">are&#160;possible,&#160;each of&#160;them&#160;is realized&#160;by a&#160;</p>
<p style="position:absolute;top:340px;left:440px;white-space:nowrap" class="ft3011"><i>PropertyProvider</i></p>
<p style="position:absolute;top:340px;left:579px;white-space:nowrap" class="ft302">&#160;module&#160;implementing&#160;its</p>
<p style="position:absolute;top:360px;left:85px;white-space:nowrap" class="ft302">own&#160;</p>
<p style="position:absolute;top:364px;left:137px;white-space:nowrap" class="ft3016"><i>translate</i></p>
<p style="position:absolute;top:359px;left:203px;white-space:nowrap" class="ft3022">&#160;</p>
<p style="position:absolute;top:360px;left:229px;white-space:nowrap" class="ft302">function.&#160;For&#160;example,&#160;a&#160;</p>
<p style="position:absolute;top:360px;left:436px;white-space:nowrap" class="ft3011"><i>PropertyProvider</i></p>
<p style="position:absolute;top:360px;left:575px;white-space:nowrap" class="ft302">&#160;could produce&#160;a</p>
<p style="position:absolute;top:381px;left:85px;white-space:nowrap" class="ft302">cumulative&#160;hash&#160;of all input values&#160;similar&#160;to the TCG's&#160;definition&#160;of&#160;the</p>
<p style="position:absolute;top:385px;left:692px;white-space:nowrap" class="ft3016"><i>Extend</i></p>
<p style="position:absolute;top:402px;left:85px;white-space:nowrap" class="ft3020">command.&#160;Alternatively,&#160;this could&#160;be&#160;implemented&#160;by&#160;simply&#160;concatenating&#160;the<br/>inputs&#160;on each invocation&#160;of</p>
<p style="position:absolute;top:426px;left:333px;white-space:nowrap" class="ft3016"><i>Extend</i></p>
<p style="position:absolute;top:422px;left:396px;white-space:nowrap" class="ft302">.</p>
<p style="position:absolute;top:451px;left:85px;white-space:nowrap" class="ft3020">To add&#160;measurement&#160;values&#160;to&#160;the&#160;virtual&#160;PCRs&#160;of the&#160;vTPM,&#160;the&#160;VM-hosted&#160;guest&#160;OS<br/>simply&#160;invokes&#160;the standard</p>
<p style="position:absolute;top:475px;left:332px;white-space:nowrap" class="ft3024">TPM_Extend</p>
<p style="position:absolute;top:471px;left:430px;white-space:nowrap" class="ft3022">&#160;</p>
<p style="position:absolute;top:472px;left:457px;white-space:nowrap" class="ft302">function,&#160;specifying&#160;the PCR&#160;number</p>
<p style="position:absolute;top:475px;left:772px;white-space:nowrap" class="ft3016"><i>i</i></p>
<p style="position:absolute;top:493px;left:85px;white-space:nowrap" class="ft302">and the hash&#160;value</p>
<p style="position:absolute;top:497px;left:257px;white-space:nowrap" class="ft3016"><i>m</i></p>
<p style="position:absolute;top:493px;left:283px;white-space:nowrap" class="ft302">representing&#160;the&#160;measurement&#160;to be&#160;stored in this&#160;register.</p>
<p style="position:absolute;top:514px;left:85px;white-space:nowrap" class="ft302">The&#160;</p>
<p style="position:absolute;top:514px;left:121px;white-space:nowrap" class="ft3011"><i>PropertyManagement</i></p>
<p style="position:absolute;top:514px;left:300px;white-space:nowrap" class="ft302">&#160;component&#160;calls&#160;each&#160;registered&#160;</p>
<p style="position:absolute;top:514px;left:581px;white-space:nowrap" class="ft3011"><i>PropertyProvider</i></p>
<p style="position:absolute;top:514px;left:720px;white-space:nowrap" class="ft302">, who,&#160;in</p>
<p style="position:absolute;top:534px;left:85px;white-space:nowrap" class="ft302">turn,&#160;&#160;apply&#160;their&#160;translation&#160;function&#160;to&#160;the&#160;measurement&#160;value</p>
<p style="position:absolute;top:538px;left:629px;white-space:nowrap" class="ft3016"><i>m</i></p>
<p style="position:absolute;top:534px;left:655px;white-space:nowrap" class="ft302">and&#160;store&#160;the</p>
<p style="position:absolute;top:556px;left:85px;white-space:nowrap" class="ft302">result&#160;in the vPCR&#160;with&#160;the&#160;index&#160;</p>
<p style="position:absolute;top:559px;left:374px;white-space:nowrap" class="ft3016"><i>i</i></p>
<p style="position:absolute;top:556px;left:392px;white-space:nowrap" class="ft302">.&#160;The general&#160;form&#160;of&#160;the PCR&#160;extension&#160;is as</p>
<p style="position:absolute;top:576px;left:85px;white-space:nowrap" class="ft302">follows:&#160;</p>
<p style="position:absolute;top:609px;left:205px;white-space:nowrap" class="ft3024">PropertyProvider</p>
<p style="position:absolute;top:618px;left:332px;white-space:nowrap" class="ft3023"><i>j</i></p>
<p style="position:absolute;top:609px;left:338px;white-space:nowrap" class="ft3016"><i>.</i></p>
<p style="position:absolute;top:609px;left:345px;white-space:nowrap" class="ft3024">Extend</p>
<p style="position:absolute;top:605px;left:399px;white-space:nowrap" class="ft3022"></p>
<p style="position:absolute;top:609px;left:404px;white-space:nowrap" class="ft3016"><i>i&#160;,&#160;m</i></p>
<p style="position:absolute;top:605px;left:434px;white-space:nowrap" class="ft3022"></p>
<p style="position:absolute;top:609px;left:441px;white-space:nowrap" class="ft3016"><i>:&#160;vPCR</i></p>
<p style="position:absolute;top:618px;left:493px;white-space:nowrap" class="ft3023"><i>i&#160;,&#160;j</i></p>
<p style="position:absolute;top:605px;left:509px;white-space:nowrap" class="ft3022"></p>
<p style="position:absolute;top:609px;left:527px;white-space:nowrap" class="ft3024">translate</p>
<p style="position:absolute;top:618px;left:589px;white-space:nowrap" class="ft3023"><i>j</i></p>
<p style="position:absolute;top:605px;left:594px;white-space:nowrap" class="ft3022"></p>
<p style="position:absolute;top:609px;left:602px;white-space:nowrap" class="ft3016"><i>vPCR</i></p>
<p style="position:absolute;top:618px;left:644px;white-space:nowrap" class="ft3023"><i>i&#160;,&#160;j</i></p>
<p style="position:absolute;top:609px;left:661px;white-space:nowrap" class="ft3016"><i>,&#160;m</i></p>
<p style="position:absolute;top:605px;left:683px;white-space:nowrap" class="ft3022"></p>
<p style="position:absolute;top:637px;left:85px;white-space:nowrap" class="ft302">Each&#160;</p>
<p style="position:absolute;top:637px;left:130px;white-space:nowrap" class="ft3011"><i>PropertyProvider</i></p>
<p style="position:absolute;top:637px;left:270px;white-space:nowrap" class="ft302">&#160;has&#160;its own&#160;vector&#160;of&#160;virtual&#160;PCRs.&#160;As depicted&#160;in Figure&#160;5,&#160;this</p>
<p style="position:absolute;top:656px;left:85px;white-space:nowrap" class="ft302">yields&#160;a matrix of vPCRs&#160;containing&#160;the&#160;values&#160;for&#160;each&#160;vTPM.&#160;</p>
<p style="position:absolute;top:992px;left:85px;white-space:nowrap" class="ft302">As an&#160;example&#160;of&#160;different&#160;property&#160;providers,&#160;consider&#160;a&#160;virtual&#160;machine</p>
<p style="position:absolute;top:994px;left:707px;white-space:nowrap" class="ft3016"><i>VM</i></p>
<p style="position:absolute;top:1004px;left:735px;white-space:nowrap" class="ft3023"><i>k</i></p>
<p style="position:absolute;top:992px;left:752px;white-space:nowrap" class="ft302">that</p>
<p style="position:absolute;top:1016px;left:85px;white-space:nowrap" class="ft302">wants to extend</p>
<p style="position:absolute;top:1018px;left:233px;white-space:nowrap" class="ft3016"><i>PCR</i></p>
<p style="position:absolute;top:1028px;left:267px;white-space:nowrap" class="ft3023"><i>i</i></p>
<p style="position:absolute;top:1016px;left:283px;white-space:nowrap" class="ft302">with a hash&#160;value</p>
<p style="position:absolute;top:1020px;left:441px;white-space:nowrap" class="ft3016"><i>m</i></p>
<p style="position:absolute;top:1016px;left:468px;white-space:nowrap" class="ft302">of&#160;a binary,&#160;when the&#160;guest OS within</p>
<p style="position:absolute;top:1042px;left:98px;white-space:nowrap" class="ft3016"><i>VM</i></p>
<p style="position:absolute;top:1052px;left:126px;white-space:nowrap" class="ft3023"><i>k</i></p>
<p style="position:absolute;top:1040px;left:143px;white-space:nowrap" class="ft302">loads&#160;and&#160;measures&#160;a&#160;software&#160;component.&#160;</p>
<p style="position:absolute;top:1042px;left:524px;white-space:nowrap" class="ft3016"><i>VM</i></p>
<p style="position:absolute;top:1052px;left:552px;white-space:nowrap" class="ft3023"><i>k</i></p>
<p style="position:absolute;top:1040px;left:570px;white-space:nowrap" class="ft302">Is&#160;associated&#160;with&#160;a&#160;vTPM</p>
<p style="position:absolute;top:1064px;left:85px;white-space:nowrap" class="ft302">instance&#160;</p>
<p style="position:absolute;top:1067px;left:173px;white-space:nowrap" class="ft3016"><i>vTPM</i></p>
<p style="position:absolute;top:1076px;left:219px;white-space:nowrap" class="ft3023"><i>k</i></p>
<p style="position:absolute;top:1064px;left:237px;white-space:nowrap" class="ft302">. Suppose&#160;there&#160;are&#160;two&#160;PCR&#160;extension&#160;strategies,&#160;a&#160;</p>
<p style="position:absolute;top:1064px;left:673px;white-space:nowrap" class="ft3011"><i>HashProvider</i></p>
<p style="position:absolute;top:1088px;left:85px;white-space:nowrap" class="ft302">and a&#160;</p>
<p style="position:absolute;top:1088px;left:137px;white-space:nowrap" class="ft3011"><i>CertificateProvider</i></p>
<p style="position:absolute;top:1088px;left:291px;white-space:nowrap" class="ft302">. The&#160;</p>
<p style="position:absolute;top:1088px;left:338px;white-space:nowrap" class="ft3011"><i>HashProvider</i></p>
<p style="position:absolute;top:1088px;left:448px;white-space:nowrap" class="ft302">&#160;just&#160;extends</p>
<p style="position:absolute;top:1091px;left:569px;white-space:nowrap" class="ft3016"><i>PCR</i></p>
<p style="position:absolute;top:1100px;left:602px;white-space:nowrap" class="ft3023"><i>i</i></p>
<p style="position:absolute;top:1088px;left:618px;white-space:nowrap" class="ft302">&#160;with the hash</p>
<p style="position:absolute;top:1092px;left:749px;white-space:nowrap" class="ft3016"><i>m</i></p>
<p style="position:absolute;top:1088px;left:775px;white-space:nowrap" class="ft302">.</p>
<p style="position:absolute;top:1110px;left:85px;white-space:nowrap" class="ft302">The task&#160;of the</p>
<p style="position:absolute;top:1110px;left:209px;white-space:nowrap" class="ft3018"><i><b>&#160;</b></i></p>
<p style="position:absolute;top:1110px;left:215px;white-space:nowrap" class="ft3011"><i>CertificateProvider</i></p>
<p style="position:absolute;top:1110px;left:369px;white-space:nowrap" class="ft302">, on&#160;the&#160;other hand,&#160;is to find&#160;a corresponding</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft307">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft307">30/48</p>
<p style="position:absolute;top:926px;left:114px;white-space:nowrap" class="ft3015"><b>Figure 5: Matrix of vPCRs for&#160;a&#160;vTPM&#160;instance</b></p>
</div>
<!-- Page 31 -->
<a name="31"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft3125{font-size:11px;font-family:IHIOAJ+OpenSymbol;color:#000000;}
	.ft3126{font-size:11px;font-family:TimesNewRomanPSMT;color:#000000;}
	.ft3127{font-size:16px;line-height:21px;font-family:IHILJD+BitstreamVeraSans;color:#000000;}
-->
</style>
<div id="page31-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42031.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft317">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft317">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft312">property&#160;certificate.&#160;</p>
<p style="position:absolute;top:182px;left:85px;white-space:nowrap" class="ft312">In&#160;this&#160;example,&#160;the vTPM&#160;has to&#160;provide&#160;two&#160;PCRs&#160;for</p>
<p style="position:absolute;top:184px;left:547px;white-space:nowrap" class="ft3116"><i>PCR</i></p>
<p style="position:absolute;top:193px;left:581px;white-space:nowrap" class="ft3123"><i>i</i></p>
<p style="position:absolute;top:182px;left:597px;white-space:nowrap" class="ft312">, i.e.,</p>
<p style="position:absolute;top:184px;left:651px;white-space:nowrap" class="ft3116"><i>vPCR</i></p>
<p style="position:absolute;top:193px;left:694px;white-space:nowrap" class="ft3123"><i>i.hash</i></p>
<p style="position:absolute;top:182px;left:733px;white-space:nowrap" class="ft312">and</p>
<p style="position:absolute;top:208px;left:98px;white-space:nowrap" class="ft3116"><i>vPCR</i></p>
<p style="position:absolute;top:217px;left:141px;white-space:nowrap" class="ft3123"><i>i.cert</i></p>
<p style="position:absolute;top:206px;left:176px;white-space:nowrap" class="ft312">. However,&#160;when</p>
<p style="position:absolute;top:208px;left:328px;white-space:nowrap" class="ft3116"><i>VM</i></p>
<p style="position:absolute;top:217px;left:356px;white-space:nowrap" class="ft3123"><i>k</i></p>
<p style="position:absolute;top:206px;left:373px;white-space:nowrap" class="ft312">requests&#160;to&#160;read&#160;the&#160;current&#160;PCR&#160;value,&#160;e.g.,&#160;by</p>
<p style="position:absolute;top:230px;left:85px;white-space:nowrap" class="ft312">invoking&#160;the function&#160;</p>
<p style="position:absolute;top:233px;left:278px;white-space:nowrap" class="ft3124">TPM_PCRRead</p>
<p style="position:absolute;top:229px;left:398px;white-space:nowrap" class="ft3122"></p>
<p style="position:absolute;top:233px;left:404px;white-space:nowrap" class="ft3116"><i>i</i></p>
<p style="position:absolute;top:229px;left:411px;white-space:nowrap" class="ft3122"></p>
<p style="position:absolute;top:230px;left:430px;white-space:nowrap" class="ft312">, the VM&#160;is only&#160;aware&#160;of&#160;an&#160;abstract&#160;</p>
<p style="position:absolute;top:232px;left:752px;white-space:nowrap" class="ft3116"><i>PCR</i></p>
<p style="position:absolute;top:241px;left:786px;white-space:nowrap" class="ft3123"><i>i</i></p>
<p style="position:absolute;top:251px;left:85px;white-space:nowrap" class="ft315">and the returned&#160;data&#160;must&#160;be of fixed-length for&#160;compliance&#160;to the&#160;TCG&#160;specification.<br/>This&#160;is achieved by&#160;the&#160;</p>
<p style="position:absolute;top:271px;left:280px;white-space:nowrap" class="ft3111"><i>PropertyFilter</i></p>
<p style="position:absolute;top:271px;left:393px;white-space:nowrap" class="ft312">&#160;that&#160;defines,&#160;based&#160;on&#160;</p>
<p style="position:absolute;top:271px;left:589px;white-space:nowrap" class="ft3111"><i>vTPMPolicy</i></p>
<p style="position:absolute;top:271px;left:681px;white-space:nowrap" class="ft312">, which</p>
<p style="position:absolute;top:290px;left:85px;white-space:nowrap" class="ft315">property&#160;provider&#160;has&#160;to be&#160;used&#160;when&#160;reading&#160;this particular&#160;vPCR.&#160;The&#160;responsible<br/>provider&#160;then&#160;returns&#160;the&#160;requested&#160;value.</p>
<p style="position:absolute;top:355px;left:85px;white-space:nowrap" class="ft3115"><b>7.2.2&#160;User-Defined vTPM&#160;Policy</b></p>
<p style="position:absolute;top:382px;left:85px;white-space:nowrap" class="ft312">The&#160;user&#160;of the hypervisor&#160;system&#160;can&#160;specify&#160;a&#160;</p>
<p style="position:absolute;top:382px;left:487px;white-space:nowrap" class="ft3111"><i>vTPMPolicy</i></p>
<p style="position:absolute;top:382px;left:580px;white-space:nowrap" class="ft312">&#160;per&#160;vTPM&#160;instance&#160;when</p>
<p style="position:absolute;top:401px;left:85px;white-space:nowrap" class="ft315">the instance&#160;is created.&#160;The&#160;policy specifies&#160;what&#160;information&#160;about&#160;the&#160;system&#160;state<br/>is actually&#160;visible&#160;to the&#160;VM&#160;and,&#160;hence,&#160;to&#160;other&#160;systems&#160;the&#160;VM is&#160;allowed&#160;to<br/>communicate&#160;with.&#160;This&#160;is possible&#160;due to the&#160;selection of&#160;property&#160;providers&#160;which<br/>define&#160;possible&#160;translations&#160;of measurement&#160;values.&#160;For&#160;all&#160;vTPM&#160;operations,&#160;the<br/>policy&#160;defines the property&#160;provider&#160;has to be&#160;used.&#160;For&#160;example,&#160;a&#160;policy&#160;can define<br/>to always&#160;use the&#160;</p>
<p style="position:absolute;top:497px;left:236px;white-space:nowrap" class="ft3111"><i>CertificateProvider</i></p>
<p style="position:absolute;top:497px;left:390px;white-space:nowrap" class="ft3118"><i><b>&#160;</b></i></p>
<p style="position:absolute;top:497px;left:396px;white-space:nowrap" class="ft312">for&#160;sealing&#160;operations&#160;requested&#160;by&#160;the&#160;VM&#160;in</p>
<p style="position:absolute;top:516px;left:85px;white-space:nowrap" class="ft3112">order&#160;to&#160;enable&#160;flexible migration&#160;to a certified platform.&#160;<br/>For&#160;each vTPM&#160;instance,&#160;the&#160;</p>
<p style="position:absolute;top:544px;left:324px;white-space:nowrap" class="ft3111"><i>vTPMPolicy</i></p>
<p style="position:absolute;top:544px;left:416px;white-space:nowrap" class="ft312">&#160;specifies&#160;the key usage&#160;strategy to&#160;be</p>
<p style="position:absolute;top:564px;left:85px;white-space:nowrap" class="ft315">applied.&#160;This allows&#160;to outsource&#160;privacy&#160;issues&#160;which the VM&#160;would&#160;otherwise&#160;have to<br/>handle&#160;itself. For&#160;instance,&#160;the policy may&#160;define&#160;when&#160;to use&#160;a particular&#160;vAIK&#160;and<br/>how often&#160;it can be used&#160;until&#160;the&#160;</p>
<p style="position:absolute;top:602px;left:369px;white-space:nowrap" class="ft3111"><i>KeyManagement</i></p>
<p style="position:absolute;top:602px;left:508px;white-space:nowrap" class="ft312">&#160;component&#160;has&#160;to&#160;generate&#160;a&#160;new</p>
<p style="position:absolute;top:621px;left:85px;white-space:nowrap" class="ft312">one.&#160;Key management&#160;aspects are described&#160;in more&#160;detail&#160;in&#160;[15].</p>
<p style="position:absolute;top:667px;left:85px;white-space:nowrap" class="ft311"><b>7.3&#160;Realizing Property-Based&#160;Functionality&#160;with&#160;vTPM</b></p>
<p style="position:absolute;top:696px;left:85px;white-space:nowrap" class="ft315">This&#160;section&#160;describes&#160;how&#160;property&#160;can&#160;be&#160;used&#160;to&#160;providers&#160;to&#160;realize property-based<br/>attestation and&#160;property-based&#160;sealing in the vTPM.&#160;</p>
<p style="position:absolute;top:761px;left:85px;white-space:nowrap" class="ft3115"><b>7.3.1&#160;Property-Based Attestation</b></p>
<p style="position:absolute;top:787px;left:85px;white-space:nowrap" class="ft312">The&#160;</p>
<p style="position:absolute;top:787px;left:121px;white-space:nowrap" class="ft3111"><i>CertificateProvider</i></p>
<p style="position:absolute;top:787px;left:275px;white-space:nowrap" class="ft312">&#160;is one&#160;example&#160;of a property&#160;provider&#160;that&#160;uses&#160;property</p>
<p style="position:absolute;top:807px;left:85px;white-space:nowrap" class="ft3127">certificates&#160;issued&#160;by&#160;a TTP. As mentioned in&#160;section&#160;7.2.1,&#160;it&#160;applies its translation<br/>function to&#160;extend&#160;</p>
<p style="position:absolute;top:830px;left:255px;white-space:nowrap" class="ft3116"><i>vPCR</i></p>
<p style="position:absolute;top:840px;left:298px;white-space:nowrap" class="ft3123"><i>i.cert</i></p>
<p style="position:absolute;top:828px;left:333px;white-space:nowrap" class="ft312">&#160;with&#160;the public&#160;key&#160;</p>
<p style="position:absolute;top:830px;left:516px;white-space:nowrap" class="ft3116"><i>pk</i></p>
<p style="position:absolute;top:840px;left:534px;white-space:nowrap" class="ft3123"><i>TTP</i></p>
<p style="position:absolute;top:828px;left:566px;white-space:nowrap" class="ft312">of&#160;the&#160;trusted&#160;third&#160;party.</p>
<p style="position:absolute;top:861px;left:85px;white-space:nowrap" class="ft312">During&#160;the attestation&#160;phase,&#160;the&#160;verifier&#160;first&#160;requests&#160;</p>
<p style="position:absolute;top:859px;left:557px;white-space:nowrap" class="ft3122"></p>
<p style="position:absolute;top:863px;left:564px;white-space:nowrap" class="ft3116"><i>PCR</i></p>
<p style="position:absolute;top:873px;left:599px;white-space:nowrap" class="ft3123"><i>i</i></p>
<p style="position:absolute;top:863px;left:606px;white-space:nowrap" class="ft3116"><i>,</i></p>
<p style="position:absolute;top:863px;left:611px;white-space:nowrap" class="ft3124">...</p>
<p style="position:absolute;top:863px;left:628px;white-space:nowrap" class="ft3116"><i>,&#160;PCR</i></p>
<p style="position:absolute;top:873px;left:671px;white-space:nowrap" class="ft3123"><i>j</i></p>
<p style="position:absolute;top:859px;left:676px;white-space:nowrap" class="ft3122"></p>
<p style="position:absolute;top:861px;left:694px;white-space:nowrap" class="ft312">&#160;of&#160;</p>
<p style="position:absolute;top:864px;left:734px;white-space:nowrap" class="ft3116"><i>VM</i></p>
<p style="position:absolute;top:873px;left:762px;white-space:nowrap" class="ft3123"><i>k</i></p>
<p style="position:absolute;top:861px;left:779px;white-space:nowrap" class="ft312">. In</p>
<p style="position:absolute;top:883px;left:85px;white-space:nowrap" class="ft312">turn,&#160;the VM&#160;requests&#160;its&#160;vTPM&#160;to&#160;</p>
<p style="position:absolute;top:883px;left:366px;white-space:nowrap" class="ft3111"><i>quote</i></p>
<p style="position:absolute;top:883px;left:414px;white-space:nowrap" class="ft312">&#160;the corresponding&#160;vPCRs&#160;with&#160;the key</p>
<p style="position:absolute;top:907px;left:98px;white-space:nowrap" class="ft3116"><i>vAIK</i></p>
<p style="position:absolute;top:916px;left:137px;white-space:nowrap" class="ft3123"><i>ID</i></p>
<p style="position:absolute;top:905px;left:162px;white-space:nowrap" class="ft312">:</p>
<p style="position:absolute;top:936px;left:151px;white-space:nowrap" class="ft3122"></p>
<p style="position:absolute;top:940px;left:160px;white-space:nowrap" class="ft3116"><i>pcrData&#160;,&#160;sig</i></p>
<p style="position:absolute;top:936px;left:252px;white-space:nowrap" class="ft3122">=</p>
<p style="position:absolute;top:940px;left:273px;white-space:nowrap" class="ft3116"><i>vTPM</i></p>
<p style="position:absolute;top:949px;left:319px;white-space:nowrap" class="ft3123"><i>k</i></p>
<p style="position:absolute;top:940px;left:326px;white-space:nowrap" class="ft3116"><i>.</i></p>
<p style="position:absolute;top:940px;left:333px;white-space:nowrap" class="ft3124">Quote</p>
<p style="position:absolute;top:936px;left:379px;white-space:nowrap" class="ft3122"></p>
<p style="position:absolute;top:940px;left:386px;white-space:nowrap" class="ft3116"><i>vAIK</i></p>
<p style="position:absolute;top:949px;left:425px;white-space:nowrap" class="ft3123"><i>ID</i></p>
<p style="position:absolute;top:940px;left:440px;white-space:nowrap" class="ft3116"><i>,&#160;nonce&#160;,</i></p>
<p style="position:absolute;top:936px;left:498px;white-space:nowrap" class="ft3122">[</p>
<p style="position:absolute;top:940px;left:505px;white-space:nowrap" class="ft3116"><i>i&#160;,</i></p>
<p style="position:absolute;top:940px;left:520px;white-space:nowrap" class="ft3124">...</p>
<p style="position:absolute;top:940px;left:536px;white-space:nowrap" class="ft3116"><i>,&#160;j</i></p>
<p style="position:absolute;top:936px;left:552px;white-space:nowrap" class="ft3122">]</p>
<p style="position:absolute;top:970px;left:85px;white-space:nowrap" class="ft312">Here,&#160;</p>
<p style="position:absolute;top:973px;left:150px;white-space:nowrap" class="ft3116"><i>pcrData</i></p>
<p style="position:absolute;top:970px;left:223px;white-space:nowrap" class="ft312">&#160;denotes&#160;the quoted&#160;vPCR&#160;values,&#160;</p>
<p style="position:absolute;top:973px;left:521px;white-space:nowrap" class="ft3116"><i>sig</i></p>
<p style="position:absolute;top:970px;left:555px;white-space:nowrap" class="ft312">&#160;denotes&#160;the vTPM's&#160;signature</p>
<p style="position:absolute;top:991px;left:85px;white-space:nowrap" class="ft312">over</p>
<p style="position:absolute;top:994px;left:137px;white-space:nowrap" class="ft3116"><i>pcrData</i></p>
<p style="position:absolute;top:991px;left:210px;white-space:nowrap" class="ft312">and</p>
<p style="position:absolute;top:994px;left:254px;white-space:nowrap" class="ft3116"><i>nonce</i></p>
<p style="position:absolute;top:991px;left:310px;white-space:nowrap" class="ft312">. The&#160;</p>
<p style="position:absolute;top:991px;left:356px;white-space:nowrap" class="ft3111"><i>PropertyManagement</i></p>
<p style="position:absolute;top:991px;left:536px;white-space:nowrap" class="ft312">&#160;of the&#160;vTPM&#160;decides – in</p>
<p style="position:absolute;top:1011px;left:85px;white-space:nowrap" class="ft312">accordance&#160;with&#160;the&#160;</p>
<p style="position:absolute;top:1011px;left:258px;white-space:nowrap" class="ft3111"><i>vTPMPolicy</i></p>
<p style="position:absolute;top:1011px;left:351px;white-space:nowrap" class="ft312">&#160;– which&#160;</p>
<p style="position:absolute;top:1011px;left:423px;white-space:nowrap" class="ft3111"><i>PropertyProvider</i></p>
<p style="position:absolute;top:1011px;left:562px;white-space:nowrap" class="ft312">&#160;is to&#160;be used&#160;for&#160;attestation.&#160;</p>
<p style="position:absolute;top:1042px;left:85px;white-space:nowrap" class="ft312">In our&#160;example,&#160;this&#160;is&#160;the&#160;</p>
<p style="position:absolute;top:1042px;left:306px;white-space:nowrap" class="ft3111"><i>CertificateProvider.&#160;</i></p>
<p style="position:absolute;top:1042px;left:471px;white-space:nowrap" class="ft312">Consequently</p>
<p style="position:absolute;top:1042px;left:584px;white-space:nowrap" class="ft3111"><i>,</i></p>
<p style="position:absolute;top:1042px;left:590px;white-space:nowrap" class="ft312">&#160;</p>
<p style="position:absolute;top:1044px;left:608px;white-space:nowrap" class="ft3116"><i>vTPM</i></p>
<p style="position:absolute;top:1054px;left:654px;white-space:nowrap" class="ft3123"><i>k</i></p>
<p style="position:absolute;top:1042px;left:672px;white-space:nowrap" class="ft312">will&#160;use the key</p>
<p style="position:absolute;top:1066px;left:85px;white-space:nowrap" class="ft312">identified by&#160;</p>
<p style="position:absolute;top:1068px;left:207px;white-space:nowrap" class="ft3116"><i>vAIK</i></p>
<p style="position:absolute;top:1078px;left:246px;white-space:nowrap" class="ft3123"><i>ID</i></p>
<p style="position:absolute;top:1066px;left:271px;white-space:nowrap" class="ft312">&#160;to&#160;sign&#160;the&#160;values&#160;of&#160;</p>
<p style="position:absolute;top:1068px;left:462px;white-space:nowrap" class="ft3116"><i>vPCR</i></p>
<p style="position:absolute;top:1075px;left:505px;white-space:nowrap" class="ft3125">[</p>
<p style="position:absolute;top:1078px;left:509px;white-space:nowrap" class="ft3123"><i>i&#160;,</i></p>
<p style="position:absolute;top:1078px;left:518px;white-space:nowrap" class="ft3126">...</p>
<p style="position:absolute;top:1078px;left:527px;white-space:nowrap" class="ft3123"><i>,&#160;j</i></p>
<p style="position:absolute;top:1075px;left:537px;white-space:nowrap" class="ft3125">]</p>
<p style="position:absolute;top:1078px;left:541px;white-space:nowrap" class="ft3123"><i>.cert</i></p>
<p style="position:absolute;top:1066px;left:574px;white-space:nowrap" class="ft312">.</p>
<p style="position:absolute;top:1098px;left:85px;white-space:nowrap" class="ft312">The&#160;verifier&#160;checks the signature</p>
<p style="position:absolute;top:1102px;left:371px;white-space:nowrap" class="ft3116"><i>sig</i></p>
<p style="position:absolute;top:1098px;left:405px;white-space:nowrap" class="ft312">and decides whether</p>
<p style="position:absolute;top:1102px;left:593px;white-space:nowrap" class="ft3116"><i>pcrData</i></p>
<p style="position:absolute;top:1098px;left:666px;white-space:nowrap" class="ft312">represent&#160;the</p>
<p style="position:absolute;top:1118px;left:85px;white-space:nowrap" class="ft312">desired&#160;properties.&#160;Note&#160;that,&#160;depending&#160;on&#160;the&#160;use&#160;case,&#160;the&#160;</p>
<p style="position:absolute;top:1118px;left:601px;white-space:nowrap" class="ft3111"><i>vTPMPolicy</i></p>
<p style="position:absolute;top:1118px;left:693px;white-space:nowrap" class="ft312">&#160;may&#160;be</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft317">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft317">31/48</p>
</div>
<!-- Page 32 -->
<a name="32"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft3228{font-size:18px;line-height:22px;font-family:TimesNewRomanPSMT;color:#000000;}
-->
</style>
<div id="page32-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42032.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft327">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft327">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft325">defined&#160;such&#160;as to restrict&#160;attestation&#160;to certain&#160;property&#160;providers.&#160;This&#160;implements&#160;a<br/>privacy&#160;protecting&#160;mechanism,&#160;as it allows&#160;to control&#160;which&#160;information&#160;about&#160;the VM<br/>and the user's&#160;system&#160;is revealed to&#160;a&#160;remote party.</p>
<p style="position:absolute;top:236px;left:85px;white-space:nowrap" class="ft3215"><b>7.3.2&#160;Property-Based Sealing</b></p>
<p style="position:absolute;top:265px;left:85px;white-space:nowrap" class="ft322">For&#160;sealing&#160;with the&#160;vTPM,&#160;a virtual&#160;machine&#160;</p>
<p style="position:absolute;top:267px;left:471px;white-space:nowrap" class="ft3216"><i>VM</i></p>
<p style="position:absolute;top:276px;left:499px;white-space:nowrap" class="ft3223"><i>k</i></p>
<p style="position:absolute;top:265px;left:516px;white-space:nowrap" class="ft322">first&#160;chooses&#160;a handle</p>
<p style="position:absolute;top:291px;left:98px;white-space:nowrap" class="ft3216"><i>vBindkeyID</i></p>
<p style="position:absolute;top:287px;left:196px;white-space:nowrap" class="ft322">of a&#160;binding&#160;key that&#160;was&#160;previously&#160;created in the virtual&#160;TPM&#160;instance</p>
<p style="position:absolute;top:312px;left:98px;white-space:nowrap" class="ft3216"><i>vTPM</i></p>
<p style="position:absolute;top:322px;left:144px;white-space:nowrap" class="ft3223"><i>k</i></p>
<p style="position:absolute;top:310px;left:162px;white-space:nowrap" class="ft322">. The VM&#160;and&#160;then invokes&#160;the command&#160;to&#160;seal</p>
<p style="position:absolute;top:314px;left:575px;white-space:nowrap" class="ft3216"><i>data</i></p>
<p style="position:absolute;top:310px;left:620px;white-space:nowrap" class="ft322">under&#160;a specified&#160;set</p>
<p style="position:absolute;top:334px;left:85px;white-space:nowrap" class="ft322">of virtual&#160;PCRs&#160;</p>
<p style="position:absolute;top:332px;left:224px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:336px;left:231px;white-space:nowrap" class="ft3216"><i>PCR</i></p>
<p style="position:absolute;top:346px;left:266px;white-space:nowrap" class="ft3223"><i>i</i></p>
<p style="position:absolute;top:336px;left:271px;white-space:nowrap" class="ft3216"><i>,</i></p>
<p style="position:absolute;top:336px;left:278px;white-space:nowrap" class="ft3224">...</p>
<p style="position:absolute;top:336px;left:295px;white-space:nowrap" class="ft3216"><i>,&#160;PCR</i></p>
<p style="position:absolute;top:346px;left:338px;white-space:nowrap" class="ft3223"><i>j</i></p>
<p style="position:absolute;top:332px;left:342px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:334px;left:361px;white-space:nowrap" class="ft322">. The&#160;vTPM&#160;realizes&#160;the sealing function as&#160;follows:&#160;</p>
<p style="position:absolute;top:369px;left:151px;white-space:nowrap" class="ft3216"><i>vTPM</i></p>
<p style="position:absolute;top:379px;left:197px;white-space:nowrap" class="ft3223"><i>k</i></p>
<p style="position:absolute;top:369px;left:205px;white-space:nowrap" class="ft3216"><i>.</i></p>
<p style="position:absolute;top:369px;left:212px;white-space:nowrap" class="ft3224">Seal</p>
<p style="position:absolute;top:365px;left:245px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:369px;left:251px;white-space:nowrap" class="ft3216"><i>vBindkeyID&#160;,</i></p>
<p style="position:absolute;top:365px;left:346px;white-space:nowrap" class="ft3222">[</p>
<p style="position:absolute;top:369px;left:352px;white-space:nowrap" class="ft3216"><i>i&#160;,</i></p>
<p style="position:absolute;top:369px;left:366px;white-space:nowrap" class="ft3224">...</p>
<p style="position:absolute;top:369px;left:383px;white-space:nowrap" class="ft3216"><i>,&#160;j</i></p>
<p style="position:absolute;top:365px;left:399px;white-space:nowrap" class="ft3222">]</p>
<p style="position:absolute;top:369px;left:407px;white-space:nowrap" class="ft3216"><i>,&#160;data</i></p>
<p style="position:absolute;top:365px;left:447px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:369px;left:454px;white-space:nowrap" class="ft3216"><i>:</i></p>
<p style="position:absolute;top:394px;left:154px;white-space:nowrap" class="ft3216"><i>provider&#160;:</i></p>
<p style="position:absolute;top:390px;left:224px;white-space:nowrap" class="ft3222">=</p>
<p style="position:absolute;top:394px;left:240px;white-space:nowrap" class="ft3216"><i>vTPMPolicy.askForProvider</i></p>
<p style="position:absolute;top:390px;left:452px;white-space:nowrap" class="ft3222">[</p>
<p style="position:absolute;top:394px;left:464px;white-space:nowrap" class="ft3216"><i>i&#160;,</i></p>
<p style="position:absolute;top:394px;left:479px;white-space:nowrap" class="ft3224">...</p>
<p style="position:absolute;top:394px;left:494px;white-space:nowrap" class="ft3216"><i>,&#160;j</i></p>
<p style="position:absolute;top:390px;left:511px;white-space:nowrap" class="ft3222">]</p>
<p style="position:absolute;top:394px;left:525px;white-space:nowrap" class="ft3216"><i>;</i></p>
<p style="position:absolute;top:417px;left:151px;white-space:nowrap" class="ft3224">FOR</p>
<p style="position:absolute;top:417px;left:190px;white-space:nowrap" class="ft3216"><i>l&#160;:</i></p>
<p style="position:absolute;top:413px;left:203px;white-space:nowrap" class="ft3222">=</p>
<p style="position:absolute;top:417px;left:218px;white-space:nowrap" class="ft3216"><i>i</i></p>
<p style="position:absolute;top:417px;left:227px;white-space:nowrap" class="ft3224">TO</p>
<p style="position:absolute;top:417px;left:256px;white-space:nowrap" class="ft3216"><i>j</i></p>
<p style="position:absolute;top:417px;left:264px;white-space:nowrap" class="ft3224">DO</p>
<p style="position:absolute;top:413px;left:292px;white-space:nowrap" class="ft3222">∝</p>
<p style="position:absolute;top:426px;left:304px;white-space:nowrap" class="ft3223"><i>l</i></p>
<p style="position:absolute;top:417px;left:310px;white-space:nowrap" class="ft3216"><i>:</i></p>
<p style="position:absolute;top:413px;left:316px;white-space:nowrap" class="ft3222">=</p>
<p style="position:absolute;top:417px;left:332px;white-space:nowrap" class="ft3216"><i>provider.PCRRead</i></p>
<p style="position:absolute;top:413px;left:473px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:417px;left:480px;white-space:nowrap" class="ft3216"><i>l</i></p>
<p style="position:absolute;top:413px;left:487px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:417px;left:493px;white-space:nowrap" class="ft3216"><i>;</i></p>
<p style="position:absolute;top:441px;left:154px;white-space:nowrap" class="ft3216"><i>pk&#160;:</i></p>
<p style="position:absolute;top:437px;left:179px;white-space:nowrap" class="ft3222">=</p>
<p style="position:absolute;top:441px;left:195px;white-space:nowrap" class="ft3224">KeyManagement</p>
<p style="position:absolute;top:441px;left:321px;white-space:nowrap" class="ft3216"><i>.&#160;getPublicKey</i></p>
<p style="position:absolute;top:437px;left:427px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:441px;left:435px;white-space:nowrap" class="ft3216"><i>vBindkeyID</i></p>
<p style="position:absolute;top:437px;left:520px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:441px;left:528px;white-space:nowrap" class="ft3216"><i>;</i></p>
<p style="position:absolute;top:464px;left:151px;white-space:nowrap" class="ft3216"><i>ed&#160;:</i></p>
<p style="position:absolute;top:460px;left:178px;white-space:nowrap" class="ft3222">=</p>
<p style="position:absolute;top:464px;left:193px;white-space:nowrap" class="ft3224">encrypt</p>
<p style="position:absolute;top:460px;left:249px;white-space:nowrap" class="ft3222">[</p>
<p style="position:absolute;top:464px;left:258px;white-space:nowrap" class="ft3216"><i>pk</i></p>
<p style="position:absolute;top:460px;left:277px;white-space:nowrap" class="ft3222">]</p>
<p style="position:absolute;top:464px;left:290px;white-space:nowrap" class="ft3216"><i>i</i></p>
<p style="position:absolute;top:460px;left:294px;white-space:nowrap" class="ft3222">∥</p>
<p style="position:absolute;top:464px;left:304px;white-space:nowrap" class="ft3224">prop</p>
<p style="position:absolute;top:473px;left:338px;white-space:nowrap" class="ft3223"><i>i</i></p>
<p style="position:absolute;top:460px;left:340px;white-space:nowrap" class="ft3222">∥</p>
<p style="position:absolute;top:464px;left:349px;white-space:nowrap" class="ft3224">...</p>
<p style="position:absolute;top:460px;left:362px;white-space:nowrap" class="ft3222">∥</p>
<p style="position:absolute;top:464px;left:375px;white-space:nowrap" class="ft3216"><i>j</i></p>
<p style="position:absolute;top:460px;left:380px;white-space:nowrap" class="ft3222">∥</p>
<p style="position:absolute;top:464px;left:390px;white-space:nowrap" class="ft3224">prop</p>
<p style="position:absolute;top:473px;left:425px;white-space:nowrap" class="ft3223"><i>j</i></p>
<p style="position:absolute;top:460px;left:427px;white-space:nowrap" class="ft3222">∥</p>
<p style="position:absolute;top:464px;left:437px;white-space:nowrap" class="ft3216"><i>data</i></p>
<p style="position:absolute;top:460px;left:471px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:464px;left:479px;white-space:nowrap" class="ft3216"><i>;</i></p>
<p style="position:absolute;top:489px;left:152px;white-space:nowrap" class="ft3224">return</p>
<p style="position:absolute;top:489px;left:197px;white-space:nowrap" class="ft3216"><i>ed</i></p>
<p style="position:absolute;top:516px;left:85px;white-space:nowrap" class="ft322">The&#160;</p>
<p style="position:absolute;top:516px;left:121px;white-space:nowrap" class="ft3211"><i>PropertyProvider</i></p>
<p style="position:absolute;top:516px;left:260px;white-space:nowrap" class="ft322">&#160;used&#160;by&#160;the&#160;vTPM&#160;is determined&#160;by its&#160;</p>
<p style="position:absolute;top:516px;left:587px;white-space:nowrap" class="ft3211"><i>vTPMPolicy&#160;</i></p>
<p style="position:absolute;top:516px;left:685px;white-space:nowrap" class="ft322">(note that&#160;the</p>
<p style="position:absolute;top:535px;left:85px;white-space:nowrap" class="ft322">choice of&#160;the&#160;</p>
<p style="position:absolute;top:535px;left:197px;white-space:nowrap" class="ft3211"><i>PropertyProvider</i></p>
<p style="position:absolute;top:535px;left:336px;white-space:nowrap" class="ft322">&#160;can&#160;be&#160;made&#160;dependent&#160;on&#160;the&#160;combination&#160;of&#160;vPCRs</p>
<p style="position:absolute;top:554px;left:85px;white-space:nowrap" class="ft322">used for&#160;the sealing&#160;operation). The vTPM&#160;instructs&#160;the&#160;</p>
<p style="position:absolute;top:554px;left:545px;white-space:nowrap" class="ft3211"><i>KeyManagement</i></p>
<p style="position:absolute;top:554px;left:685px;white-space:nowrap" class="ft322">&#160;component&#160;to</p>
<p style="position:absolute;top:573px;left:85px;white-space:nowrap" class="ft322">load&#160;the&#160;corresponding&#160;binding&#160;key,&#160;retrieves&#160;the&#160;vPCR&#160;values of&#160;the&#160;specified</p>
<p style="position:absolute;top:593px;left:85px;white-space:nowrap" class="ft3211"><i>PropertyProvider</i></p>
<p style="position:absolute;top:593px;left:224px;white-space:nowrap" class="ft322">, and&#160;encrypts</p>
<p style="position:absolute;top:597px;left:356px;white-space:nowrap" class="ft3216"><i>data</i></p>
<p style="position:absolute;top:593px;left:401px;white-space:nowrap" class="ft322">and&#160;the values in&#160;the specified vPCR&#160;registers.</p>
<p style="position:absolute;top:623px;left:85px;white-space:nowrap" class="ft325">To&#160;unseal the data&#160;again, the VM instructs&#160;the vTPM&#160;to perform&#160;the&#160;following<br/>procedure:</p>
<p style="position:absolute;top:675px;left:152px;white-space:nowrap" class="ft3216"><i>vTPM</i></p>
<p style="position:absolute;top:684px;left:197px;white-space:nowrap" class="ft3223"><i>k</i></p>
<p style="position:absolute;top:675px;left:205px;white-space:nowrap" class="ft3216"><i>.</i></p>
<p style="position:absolute;top:675px;left:212px;white-space:nowrap" class="ft3224">UnSeal</p>
<p style="position:absolute;top:671px;left:267px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:675px;left:274px;white-space:nowrap" class="ft3216"><i>vBindkeyID&#160;,ed</i></p>
<p style="position:absolute;top:671px;left:389px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:675px;left:395px;white-space:nowrap" class="ft3216"><i>:</i></p>
<p style="position:absolute;top:695px;left:151px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:700px;left:158px;white-space:nowrap" class="ft3216"><i>sk&#160;,&#160;pk</i></p>
<p style="position:absolute;top:695px;left:205px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:700px;left:212px;white-space:nowrap" class="ft3216"><i>:</i></p>
<p style="position:absolute;top:695px;left:219px;white-space:nowrap" class="ft3222">=</p>
<p style="position:absolute;top:700px;left:233px;white-space:nowrap" class="ft3224">KeyManagement</p>
<p style="position:absolute;top:700px;left:359px;white-space:nowrap" class="ft3216"><i>.&#160;getKeyPair</i></p>
<p style="position:absolute;top:695px;left:452px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:700px;left:458px;white-space:nowrap" class="ft3216"><i>vBindkeyID</i></p>
<p style="position:absolute;top:695px;left:545px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:700px;left:552px;white-space:nowrap" class="ft3216"><i>;</i></p>
<p style="position:absolute;top:718px;left:151px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:722px;left:158px;white-space:nowrap" class="ft3216"><i>i</i></p>
<p style="position:absolute;top:718px;left:163px;white-space:nowrap" class="ft3222">∥</p>
<p style="position:absolute;top:722px;left:173px;white-space:nowrap" class="ft3224">prop</p>
<p style="position:absolute;top:732px;left:205px;white-space:nowrap" class="ft3223"><i>i</i></p>
<p style="position:absolute;top:718px;left:209px;white-space:nowrap" class="ft3222">∥</p>
<p style="position:absolute;top:722px;left:218px;white-space:nowrap" class="ft3224">...</p>
<p style="position:absolute;top:718px;left:230px;white-space:nowrap" class="ft3222">∥</p>
<p style="position:absolute;top:722px;left:242px;white-space:nowrap" class="ft3216"><i>j</i></p>
<p style="position:absolute;top:718px;left:247px;white-space:nowrap" class="ft3222">∥</p>
<p style="position:absolute;top:722px;left:257px;white-space:nowrap" class="ft3224">prop</p>
<p style="position:absolute;top:732px;left:293px;white-space:nowrap" class="ft3223"><i>j</i></p>
<p style="position:absolute;top:718px;left:295px;white-space:nowrap" class="ft3222">∥</p>
<p style="position:absolute;top:722px;left:305px;white-space:nowrap" class="ft3216"><i>data</i></p>
<p style="position:absolute;top:718px;left:338px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:722px;left:346px;white-space:nowrap" class="ft3216"><i>:</i></p>
<p style="position:absolute;top:718px;left:351px;white-space:nowrap" class="ft3222">=</p>
<p style="position:absolute;top:722px;left:367px;white-space:nowrap" class="ft3216"><i>decrypt</i></p>
<p style="position:absolute;top:718px;left:423px;white-space:nowrap" class="ft3222">[</p>
<p style="position:absolute;top:722px;left:430px;white-space:nowrap" class="ft3216"><i>sk</i></p>
<p style="position:absolute;top:718px;left:448px;white-space:nowrap" class="ft3222">]</p>
<p style="position:absolute;top:722px;left:461px;white-space:nowrap" class="ft3216"><i>ed</i></p>
<p style="position:absolute;top:718px;left:480px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:722px;left:488px;white-space:nowrap" class="ft3216"><i>;</i></p>
<p style="position:absolute;top:747px;left:154px;white-space:nowrap" class="ft3216"><i>provider&#160;:</i></p>
<p style="position:absolute;top:743px;left:226px;white-space:nowrap" class="ft3222">=</p>
<p style="position:absolute;top:747px;left:240px;white-space:nowrap" class="ft3224">vTPMPolicy</p>
<p style="position:absolute;top:747px;left:335px;white-space:nowrap" class="ft3216"><i>.&#160;askForProvider</i></p>
<p style="position:absolute;top:743px;left:458px;white-space:nowrap" class="ft3222">[</p>
<p style="position:absolute;top:747px;left:471px;white-space:nowrap" class="ft3216"><i>i&#160;,</i></p>
<p style="position:absolute;top:747px;left:486px;white-space:nowrap" class="ft3224">...</p>
<p style="position:absolute;top:747px;left:502px;white-space:nowrap" class="ft3216"><i>,&#160;j</i></p>
<p style="position:absolute;top:743px;left:519px;white-space:nowrap" class="ft3222">]</p>
<p style="position:absolute;top:747px;left:531px;white-space:nowrap" class="ft3216"><i>;</i></p>
<p style="position:absolute;top:769px;left:152px;white-space:nowrap" class="ft3224">FOR</p>
<p style="position:absolute;top:769px;left:190px;white-space:nowrap" class="ft3216"><i>l&#160;:</i></p>
<p style="position:absolute;top:765px;left:204px;white-space:nowrap" class="ft3222">=</p>
<p style="position:absolute;top:769px;left:219px;white-space:nowrap" class="ft3216"><i>i</i></p>
<p style="position:absolute;top:769px;left:227px;white-space:nowrap" class="ft3224">TO</p>
<p style="position:absolute;top:769px;left:256px;white-space:nowrap" class="ft3216"><i>j</i></p>
<p style="position:absolute;top:769px;left:264px;white-space:nowrap" class="ft3224">DO BEGIN</p>
<p style="position:absolute;top:792px;left:152px;white-space:nowrap" class="ft3224">prop</p>
<p style="position:absolute;top:801px;left:186px;white-space:nowrap" class="ft3223"><i>l</i></p>
<p style="position:absolute;top:792px;left:191px;white-space:nowrap" class="ft3216"><i>'&#160;:</i></p>
<p style="position:absolute;top:788px;left:204px;white-space:nowrap" class="ft3222">=</p>
<p style="position:absolute;top:792px;left:221px;white-space:nowrap" class="ft3216"><i>provider.PCRRead</i></p>
<p style="position:absolute;top:788px;left:362px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:792px;left:368px;white-space:nowrap" class="ft3216"><i>l</i></p>
<p style="position:absolute;top:788px;left:375px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:792px;left:382px;white-space:nowrap" class="ft3216"><i>;</i></p>
<p style="position:absolute;top:818px;left:152px;white-space:nowrap" class="ft3224">if</p>
<p style="position:absolute;top:814px;left:166px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:818px;left:174px;white-space:nowrap" class="ft3224">prop</p>
<p style="position:absolute;top:827px;left:208px;white-space:nowrap" class="ft3223"><i>l</i></p>
<p style="position:absolute;top:818px;left:212px;white-space:nowrap" class="ft3216"><i>'</i></p>
<p style="position:absolute;top:814px;left:218px;white-space:nowrap" class="ft3222">≠</p>
<p style="position:absolute;top:818px;left:233px;white-space:nowrap" class="ft3224">prop</p>
<p style="position:absolute;top:827px;left:267px;white-space:nowrap" class="ft3223"><i>l</i></p>
<p style="position:absolute;top:814px;left:272px;white-space:nowrap" class="ft3222"></p>
<p style="position:absolute;top:818px;left:278px;white-space:nowrap" class="ft3216"><i>return</i></p>
<p style="position:absolute;top:814px;left:326px;white-space:nowrap" class="ft3222">∅</p>
<p style="position:absolute;top:818px;left:344px;white-space:nowrap" class="ft3216"><i>;</i></p>
<p style="position:absolute;top:842px;left:152px;white-space:nowrap" class="ft3228">END<br/>return</p>
<p style="position:absolute;top:865px;left:199px;white-space:nowrap" class="ft3216"><i>data</i></p>
<p style="position:absolute;top:892px;left:85px;white-space:nowrap" class="ft322">The vTPM&#160;first&#160;loads&#160;the&#160;binding&#160;key&#160;pair&#160;identified&#160;by&#160;</p>
<p style="position:absolute;top:896px;left:550px;white-space:nowrap" class="ft3216"><i>vBindkeyID</i></p>
<p style="position:absolute;top:892px;left:647px;white-space:nowrap" class="ft322">&#160;and&#160;decrypts&#160;the</p>
<p style="position:absolute;top:914px;left:85px;white-space:nowrap" class="ft322">sealed&#160;data&#160;blob</p>
<p style="position:absolute;top:917px;left:236px;white-space:nowrap" class="ft3216"><i>ed</i></p>
<p style="position:absolute;top:914px;left:266px;white-space:nowrap" class="ft322">. Again,&#160;the&#160;</p>
<p style="position:absolute;top:914px;left:366px;white-space:nowrap" class="ft3211"><i>PropertyProvider</i></p>
<p style="position:absolute;top:914px;left:505px;white-space:nowrap" class="ft322">&#160;is determined&#160;by the&#160;</p>
<p style="position:absolute;top:914px;left:687px;white-space:nowrap" class="ft3211"><i>vTPMPolicy</i></p>
<p style="position:absolute;top:914px;left:780px;white-space:nowrap" class="ft322">.</p>
<p style="position:absolute;top:934px;left:85px;white-space:nowrap" class="ft3227">The current&#160;vPCR&#160;values&#160;are&#160;compared&#160;to the&#160;values&#160;stored&#160;in the sealed&#160;data.&#160;Only&#160;if<br/>all matching&#160;pairs are&#160;equal, the plain&#160;</p>
<p style="position:absolute;top:959px;left:418px;white-space:nowrap" class="ft3216"><i>data</i></p>
<p style="position:absolute;top:956px;left:463px;white-space:nowrap" class="ft322">&#160;is returned&#160;to&#160;</p>
<p style="position:absolute;top:958px;left:599px;white-space:nowrap" class="ft3216"><i>VM</i></p>
<p style="position:absolute;top:967px;left:627px;white-space:nowrap" class="ft3223"><i>k</i></p>
<p style="position:absolute;top:956px;left:644px;white-space:nowrap" class="ft322">.</p>
<p style="position:absolute;top:986px;left:85px;white-space:nowrap" class="ft322">A</p>
<p style="position:absolute;top:986px;left:96px;white-space:nowrap" class="ft3211"><i>&#160;PropertyProvider</i></p>
<p style="position:absolute;top:986px;left:241px;white-space:nowrap" class="ft322">&#160;(like&#160;</p>
<p style="position:absolute;top:986px;left:287px;white-space:nowrap" class="ft3211"><i>CertificateProvider</i></p>
<p style="position:absolute;top:986px;left:441px;white-space:nowrap" class="ft322">&#160;in the&#160;example&#160;above)&#160;is&#160;especially</p>
<p style="position:absolute;top:1005px;left:85px;white-space:nowrap" class="ft325">interesting&#160;if sealing is&#160;done&#160;relative&#160;to&#160;vPCRs representing&#160;software&#160;components&#160;in<br/>the VM.&#160;Depending&#160;on&#160;the&#160;realization of&#160;the property&#160;provider,&#160;unsealing&#160;will&#160;be<br/>possible&#160;even&#160;if the&#160;measured&#160;applications&#160;of&#160;the VM&#160;are changed,&#160;as&#160;long&#160;as thebut<br/>same&#160;properties&#160;abstract&#160;properties&#160;are&#160;maintained.&#160;In this&#160;case, the equivalence&#160;of<br/>the changed component&#160;would be&#160;vouched&#160;for&#160;by&#160;a corresponding&#160;property&#160;certificate<br/>which&#160;must&#160;be&#160;available&#160;and&#160;valid.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft327">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft327">32/48</p>
</div>
<!-- Page 33 -->
<a name="33"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page33-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42033.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft337">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft337">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft335">Property-based sealing&#160;can&#160;also&#160;be&#160;used&#160;to&#160;ensure&#160;the availability of&#160;sealed data&#160;after<br/>migration&#160;of&#160;a VM&#160;and&#160;its corresponding&#160;vTPM&#160;to&#160;a&#160;platform&#160;with&#160;a&#160;different&#160;binary<br/>implementation.&#160;This&#160;can, for example,&#160;be&#160;achieved,&#160;by&#160;using&#160;a&#160;</p>
<p style="position:absolute;top:189px;left:617px;white-space:nowrap" class="ft3311"><i>CertificateProvider</i></p>
<p style="position:absolute;top:189px;left:771px;white-space:nowrap" class="ft332">&#160;for</p>
<p style="position:absolute;top:209px;left:85px;white-space:nowrap" class="ft3327">the&#160;whole&#160;set of virtual PCRs,&#160;representing&#160;the&#160;properties&#160;of&#160;the underlying&#160;hypervisor<br/>platform.&#160;that&#160;is,</p>
<p style="position:absolute;top:232px;left:236px;white-space:nowrap" class="ft3316"><i>vPCR</i></p>
<p style="position:absolute;top:239px;left:279px;white-space:nowrap" class="ft3325">[</p>
<p style="position:absolute;top:242px;left:282px;white-space:nowrap" class="ft3326">0,.&#160;..</p>
<p style="position:absolute;top:242px;left:301px;white-space:nowrap" class="ft3323"><i>,</i></p>
<p style="position:absolute;top:242px;left:306px;white-space:nowrap" class="ft3326">7</p>
<p style="position:absolute;top:239px;left:312px;white-space:nowrap" class="ft3325">]</p>
<p style="position:absolute;top:242px;left:316px;white-space:nowrap" class="ft3323"><i>.cert</i></p>
<p style="position:absolute;top:230px;left:349px;white-space:nowrap" class="ft332">,&#160;On&#160;a&#160;migration&#160;target&#160;platform&#160;with&#160;a&#160;certificate</p>
<p style="position:absolute;top:252px;left:85px;white-space:nowrap" class="ft335">stating&#160;the&#160;same&#160;properties&#160;as&#160;the source&#160;platforms,&#160;the PCR values&#160;would&#160;be<br/>identical.&#160;It is beyond&#160;the scope&#160;of this&#160;document&#160;to&#160;discuss&#160;the migration&#160;procedure<br/>and security&#160;considerations&#160;in&#160;detail. For further information&#160;on&#160;migration&#160;under&#160;the<br/>the enhanced&#160;design,&#160;see&#160;[15].&#160;</p>
<p style="position:absolute;top:356px;left:85px;white-space:nowrap" class="ft3315"><b>7.3.3&#160;Conclusion</b></p>
<p style="position:absolute;top:382px;left:85px;white-space:nowrap" class="ft335">The vTPM&#160;architecture&#160;described in this&#160;chapter&#160;supports&#160;several&#160;approaches&#160;for<br/>measuring&#160;the&#160;platform's&#160;state and&#160;for&#160;generating&#160;cryptographic&#160;keys. The&#160;enhanced<br/>design&#160;allows&#160;to&#160;implement&#160;property-based&#160;sealing&#160;and attestation&#160;in&#160;a vTPM.&#160;Using<br/>mechanism&#160;based&#160;on&#160;properties,&#160;it becomes&#160;possible&#160;to migrate&#160;protected data&#160;and<br/>cryptographic&#160;keys&#160;of the&#160;vTPM.&#160;The design&#160;also supports&#160;flexible&#160;and&#160;privacy<br/>preserving&#160;forms of&#160;remote&#160;attestation.&#160;TPM-enabled&#160;applications&#160;executed&#160;in&#160;a&#160;VM<br/>can&#160;directly&#160;benefit from&#160;this&#160;flexibility&#160;without&#160;the&#160;need for modification.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft337">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft337">33/48</p>
</div>
<!-- Page 34 -->
<a name="34"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page34-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42034.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft347">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft347">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:172px;left:85px;white-space:nowrap" class="ft349"><b>8&#160;</b></p>
<p style="position:absolute;top:169px;left:117px;white-space:nowrap" class="ft3410"><b>Design</b></p>
<p style="position:absolute;top:199px;left:85px;white-space:nowrap" class="ft345">This&#160;section&#160;summarizes&#160;the&#160;architecture&#160;to&#160;be&#160;implemented&#160;for&#160;both&#160;Xen&#160;and&#160;L4 for<br/>the&#160;remaining&#160;duration of&#160;the OpenTC&#160;project.&#160;The&#160;choice is based&#160;on&#160;the options,<br/>requirements&#160;and&#160;scenarios&#160;that&#160;have&#160;been&#160;discussed&#160;in this&#160;document.</p>
<p style="position:absolute;top:284px;left:85px;white-space:nowrap" class="ft341"><b>8.1&#160;Implementation&#160;for Xen</b></p>
<p style="position:absolute;top:330px;left:85px;white-space:nowrap" class="ft3415"><b>8.1.1&#160;Overview</b></p>
<p style="position:absolute;top:356px;left:85px;white-space:nowrap" class="ft345">The implementation&#160;of the TPM Virtualization&#160;Architecture&#160;is&#160;very&#160;similar&#160;to&#160;the Virtual<br/>Platform&#160;design described&#160;in&#160;section .&#160;We&#160;will therefore&#160;only highlight&#160;the main<br/>components&#160;of the&#160;Virtual&#160;Platform&#160;framework&#160;necessary&#160;to implement&#160;vTPM&#160;in&#160;Xen.<br/>These&#160;components&#160;are&#160;summarized&#160;in Figure&#160;6.</p>
<p style="position:absolute;top:835px;left:85px;white-space:nowrap" class="ft345">The architecture&#160;utilizes components&#160;already&#160;developed by&#160;WP4&#160;(such as the Domain<br/>Builder and the&#160;BMSI&#160;interface)&#160;and&#160;relies on&#160;the&#160;following components:</p>
<p style="position:absolute;top:886px;left:112px;white-space:nowrap" class="ft3413">●</p>
<p style="position:absolute;top:883px;left:139px;white-space:nowrap" class="ft341"><b>Modified&#160;libxc:</b></p>
<p style="position:absolute;top:883px;left:276px;white-space:nowrap" class="ft342">&#160;The domain controlling&#160;library&#160;(libXC) in Xen&#160;</p>
<p style="position:absolute;top:883px;left:654px;white-space:nowrap" class="ft3411"><i>Dom0</i></p>
<p style="position:absolute;top:883px;left:703px;white-space:nowrap" class="ft342">&#160;is modified</p>
<p style="position:absolute;top:902px;left:139px;white-space:nowrap" class="ft345">to use&#160;the&#160;new domain builder.&#160;It&#160;is extended to&#160;pass&#160;the extra configuration<br/>data&#160;related&#160;to&#160;the layout&#160;of the Virtual&#160;Platform&#160;that&#160;needs to&#160;be instantiated.<br/>Note that the libxc&#160;still works&#160;at the&#160;level&#160;of&#160;instantiating&#160;individual&#160;VMs. It has<br/>no&#160;concept&#160;of a&#160;virtual&#160;platform&#160;as&#160;a&#160;whole,&#160;but&#160;merely passes&#160;additional<br/>information&#160;to&#160;DomB</p>
<p style="position:absolute;top:1010px;left:112px;white-space:nowrap" class="ft3413">●</p>
<p style="position:absolute;top:1007px;left:139px;white-space:nowrap" class="ft341"><b>DomB:</b></p>
<p style="position:absolute;top:1007px;left:201px;white-space:nowrap" class="ft342">&#160;The new&#160;domain&#160;builder&#160;implements&#160;multiple&#160;components&#160;using&#160;the</p>
<p style="position:absolute;top:1026px;left:139px;white-space:nowrap" class="ft345">Basic&#160;Management&#160;and&#160;Security&#160;Interface&#160;(BMSI)[13]&#160;as&#160;base&#160;for&#160;their<br/>implementation.&#160;In particular,&#160;DomB&#160;implements the&#160;H-BMSI interface.&#160;This&#160;is<br/>combination&#160;of&#160;the&#160;HIM[20]&#160;interface&#160;and the CMS interface&#160;that&#160;implements&#160;a<br/>hierarchical version&#160;of the&#160;BMSI. DomB&#160;also implements&#160;the&#160;Virtual Platform<br/>logic&#160;which&#160;is&#160;responsible&#160;for&#160;the enforcement&#160;of&#160;the&#160;boot sequence&#160;of the&#160;vTPM</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft347">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft347">34/48</p>
</div>
<!-- Page 35 -->
<a name="35"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page35-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42035.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft357">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft357">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:139px;white-space:nowrap" class="ft352">as&#160;described&#160;in&#160;section&#160;5.3 .</p>
<p style="position:absolute;top:182px;left:112px;white-space:nowrap" class="ft3513">●</p>
<p style="position:absolute;top:179px;left:139px;white-space:nowrap" class="ft351"><b>DomU-VTPM:</b></p>
<p style="position:absolute;top:179px;left:261px;white-space:nowrap" class="ft352">&#160;This&#160;domain&#160;implements&#160;the&#160;device&#160;model&#160;for&#160;the&#160;virtual&#160;TPM</p>
<p style="position:absolute;top:198px;left:139px;white-space:nowrap" class="ft352">(VTPM-DM) for VMs&#160;running&#160;in&#160;a Xen&#160;</p>
<p style="position:absolute;top:198px;left:445px;white-space:nowrap" class="ft3511"><i>DomU</i></p>
<p style="position:absolute;top:198px;left:496px;white-space:nowrap" class="ft352">. It&#160;provides&#160;a&#160;virtual,&#160;TIS&#160;[10]</p>
<p style="position:absolute;top:218px;left:139px;white-space:nowrap" class="ft355">compatible&#160;interface&#160;to&#160;DomU and&#160;uses the&#160;H-BMSI&#160;(see&#160;above)&#160;as&#160;its<br/>underlying&#160;security&#160;interface.&#160;It&#160;uses this&#160;interface&#160;to&#160;implement&#160;the various<br/>TPM&#160;functions.</p>
<p style="position:absolute;top:302px;left:85px;white-space:nowrap" class="ft3515"><b>8.1.2&#160;Life&#160;cycle</b></p>
<p style="position:absolute;top:329px;left:85px;white-space:nowrap" class="ft352">In&#160;this&#160;section,&#160;we assume&#160;a&#160;platform&#160;and&#160;the&#160;BMSI&#160;setup&#160;as&#160;described&#160;in section&#160;4.3.</p>
<p style="position:absolute;top:360px;left:112px;white-space:nowrap" class="ft3513">●</p>
<p style="position:absolute;top:357px;left:139px;white-space:nowrap" class="ft351"><b>Starting&#160;a vTPM</b></p>
<p style="position:absolute;top:357px;left:288px;white-space:nowrap" class="ft352">: Standard&#160;Xen&#160;management&#160;applications&#160;are used&#160;to&#160;create&#160;a</p>
<p style="position:absolute;top:376px;left:139px;white-space:nowrap" class="ft355">paravirtualized&#160;vTPM&#160;domain.&#160;It consists&#160;of&#160;the&#160;vTPM&#160;code&#160;that&#160;is hosted&#160;by&#160;the<br/>mini-OS&#160;environment&#160;developed&#160;by WP4.&#160;When&#160;starting&#160;for the&#160;first&#160;time,&#160;the<br/>vTPM&#160;generates a&#160;new&#160;Endorsement&#160;Key pair&#160;using&#160;the&#160;H-BMSI.&#160;The private&#160;part<br/>of the Endorsement&#160;key&#160;is&#160;&#160;protected by&#160;the BMSI, it&#160;can be&#160;accessed&#160;by the<br/>vTPM&#160;only,&#160;and&#160;only&#160;via&#160;the H-BMSI.&#160;The vTPM&#160;also&#160;uses&#160;the H-BMSI&#160;interface&#160;to<br/>perform&#160;a&#160;quote&#160;operation,&#160;using&#160;the cryptographic&#160;hash&#160;of&#160;the public&#160;part of<br/>the&#160;vTPM&#160;Endorsement&#160;Key as the&#160;external&#160;nonce&#160;for this operation.&#160;By using<br/>the H-BMSI&#160;</p>
<p style="position:absolute;top:511px;left:236px;white-space:nowrap" class="ft3511"><i>quote</i></p>
<p style="position:absolute;top:511px;left:284px;white-space:nowrap" class="ft352">&#160;operation,&#160;the&#160;integrity of the&#160;vTPM,&#160;DomB&#160;and&#160;Xen&#160;are</p>
<p style="position:absolute;top:530px;left:139px;white-space:nowrap" class="ft355">implicitly linked&#160;to the&#160;hash&#160;of the&#160;public&#160;part&#160;of&#160;the Endorsement&#160;Key.&#160;Finally,<br/>the VTPM&#160;stores the result&#160;of the&#160;initialization operation,&#160;that&#160;is, the public&#160;part<br/>of the Endorsement&#160;Key, the&#160;encrypted private&#160;part of the endorsement&#160;key and<br/>the result&#160;of the quote&#160;operation,&#160;in&#160;XenStore&#160;using&#160;the&#160;standard&#160;Xenbus<br/>mechanims.&#160;(not shown&#160;in&#160;figure).&#160;</p>
<p style="position:absolute;top:645px;left:139px;white-space:nowrap" class="ft355">The management&#160;application&#160;must&#160;ensure&#160;the&#160;persistence&#160;of&#160;this data&#160;(which<br/>forms&#160;the VTPM-SS&#160;as&#160;described&#160;in&#160;section&#160;5.2)and&#160;to&#160;provide&#160;it&#160;back on&#160;the<br/>next&#160;instantiation&#160;of&#160;the&#160;vTPM.&#160;Thus,&#160;if the&#160;vTPM&#160;domain&#160;detects this&#160;data<br/>structure&#160;at boot time,&#160;it&#160;skips the initialization&#160;procedure&#160;described&#160;above.<br/>Instead,&#160;it&#160;simply&#160;loads&#160;the existing&#160;VTPM-SS&#160;data&#160;using&#160;the&#160;H-BMSI.</p>
<p style="position:absolute;top:753px;left:112px;white-space:nowrap" class="ft3513">●</p>
<p style="position:absolute;top:750px;left:139px;white-space:nowrap" class="ft351"><b>Starting&#160;a VM</b></p>
<p style="position:absolute;top:750px;left:267px;white-space:nowrap" class="ft352">:&#160;The new VM&#160;is started&#160;normally.&#160;However,&#160;the&#160;domain&#160;ID of&#160;its</p>
<p style="position:absolute;top:769px;left:139px;white-space:nowrap" class="ft355">associated&#160;vTPM&#160;is passed&#160;as&#160;additional&#160;part&#160;of&#160;its configuration&#160;information.<br/>This&#160;information&#160;is&#160;interpreted&#160;by&#160;the&#160;</p>
<p style="position:absolute;top:788px;left:453px;white-space:nowrap" class="ft3511"><i>Virtual&#160;Platform&#160;Builder</i></p>
<p style="position:absolute;top:788px;left:646px;white-space:nowrap" class="ft352">&#160;and&#160;initiates&#160;the</p>
<p style="position:absolute;top:808px;left:139px;white-space:nowrap" class="ft352">following&#160;sequence of actions:</p>
<p style="position:absolute;top:839px;left:139px;white-space:nowrap" class="ft3513">●</p>
<p style="position:absolute;top:836px;left:166px;white-space:nowrap" class="ft355">The&#160;VP-Builder&#160;measures&#160;the virtual&#160;CRTM&#160;of&#160;the&#160;VM (as&#160;it does for&#160;every<br/>new&#160;VM)&#160;and&#160;stores&#160;the result&#160;in&#160;the&#160;HIM database.&#160;Note that&#160;the result&#160;will</p>
<p style="position:absolute;top:874px;left:166px;white-space:nowrap" class="ft3511"><i>not</i></p>
<p style="position:absolute;top:874px;left:193px;white-space:nowrap" class="ft352">&#160;be&#160;stored&#160;in&#160;the vTPM&#160;PRC0,&#160;allowing&#160;to&#160;use it for&#160;arbitrary&#160;purposes.</p>
<p style="position:absolute;top:905px;left:139px;white-space:nowrap" class="ft3513">●</p>
<p style="position:absolute;top:902px;left:166px;white-space:nowrap" class="ft355">The VP-Builder&#160;verifies&#160;that&#160;the&#160;vTPM&#160;device&#160;model&#160;of&#160;the VM&#160;(identified&#160;by<br/>the domain&#160;ID) is active and&#160;properly&#160;configured.&#160;This ensures&#160;that&#160;access&#160;to<br/>the TIS&#160;interface&#160;by the VM&#160;will&#160;be&#160;correctly&#160;handled&#160;by the VTPM&#160;device<br/>model.</p>
<p style="position:absolute;top:991px;left:139px;white-space:nowrap" class="ft3513">●</p>
<p style="position:absolute;top:988px;left:166px;white-space:nowrap" class="ft355">The VP-Builder&#160;updates&#160;the&#160;HIM&#160;integrity&#160;database&#160;with&#160;a&#160;dependency<br/>relation&#160;between&#160;the vTPM&#160;and&#160;the&#160;VM.&#160;This establishes&#160;the binding&#160;between<br/>both&#160;components</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft357">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft357">35/48</p>
</div>
<!-- Page 36 -->
<a name="36"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page36-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42036.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft367">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft367">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft361"><b>8.2&#160;Implementation&#160;for L4/Fiasco&#160;and L4Env</b></p>
<p style="position:absolute;top:197px;left:85px;white-space:nowrap" class="ft3615"><b>8.2.1&#160;Overview</b></p>
<p style="position:absolute;top:550px;left:85px;white-space:nowrap" class="ft365">Each&#160;L4Linux&#160;VM a&#160;is&#160;associated&#160;to a virtual TPM&#160;emulated in&#160;software.&#160;The software<br/>runs&#160;as&#160;native L4&#160;task;&#160;its memory&#160;is&#160;thereby isolated&#160;from&#160;the VM&#160;kernel and Linux<br/>user&#160;applications.&#160;The&#160;vTPM&#160;implemented&#160;as&#160;L4&#160;service&#160;is based on&#160;that&#160;of&#160;the&#160;TPM<br/>Emulator&#160;project,&#160;which was&#160;ported&#160;to&#160;the&#160;L4Env environment&#160;and adapted to<br/>integrate&#160;closely with other&#160;basic&#160;L4Env services.&#160;<br/>In&#160;order&#160;to&#160;connect to&#160;a vTPM,&#160;each&#160;L4Linux&#160;kernel&#160;can&#160;load&#160;a&#160;vTPM&#160;stub&#160;driver.&#160;This<br/>stub&#160;driver&#160;exports&#160;the&#160;known&#160;TPM&#160;device&#160;(/dev/tpm)&#160;to&#160;Linux and&#160;manages&#160;the<br/>transfer&#160;of&#160;data&#160;written&#160;to and&#160;are&#160;read&#160;from&#160;the device.&#160;To&#160;transfer&#160;data&#160;between<br/>L4Linux&#160;and&#160;the vTPM&#160;instance,&#160;the stub&#160;drivers&#160;use&#160;IPC primitives&#160;of&#160;the L4/Fiasco<br/>microkernel.&#160;<br/>Figure&#160;7 illustrates&#160;the&#160;architecture.&#160;Beside&#160;the&#160;L4/Fiasco&#160;microkernel&#160;and basic&#160;L4Env<br/>services,&#160;the&#160;main&#160;components&#160;for handling&#160;L4Linux&#160;VMs and&#160;vTPMs&#160;are:&#160;</p>
<p style="position:absolute;top:810px;left:112px;white-space:nowrap" class="ft3613">●</p>
<p style="position:absolute;top:807px;left:139px;white-space:nowrap" class="ft362">A&#160;service&#160;able to&#160;access&#160;the&#160;hardware&#160;TPM&#160;-&#160;(</p>
<p style="position:absolute;top:807px;left:516px;white-space:nowrap" class="ft3611"><i>HW TPM Service</i></p>
<p style="position:absolute;top:807px;left:651px;white-space:nowrap" class="ft362">)</p>
<p style="position:absolute;top:839px;left:112px;white-space:nowrap" class="ft3613">●</p>
<p style="position:absolute;top:836px;left:139px;white-space:nowrap" class="ft362">A&#160;virtual&#160;TPM&#160;service&#160;based&#160;on&#160;the&#160;TPM&#160;Emulator&#160;project&#160;- (</p>
<p style="position:absolute;top:836px;left:631px;white-space:nowrap" class="ft3611"><i>vTPM&#160;Service</i></p>
<p style="position:absolute;top:836px;left:741px;white-space:nowrap" class="ft362">)</p>
<p style="position:absolute;top:867px;left:112px;white-space:nowrap" class="ft3613">●</p>
<p style="position:absolute;top:864px;left:139px;white-space:nowrap" class="ft362">The&#160;L4Linux&#160;Virtual&#160;Machine&#160;-&#160;(</p>
<p style="position:absolute;top:864px;left:396px;white-space:nowrap" class="ft3611"><i>L4Linux kernel</i></p>
<p style="position:absolute;top:864px;left:517px;white-space:nowrap" class="ft362">)</p>
<p style="position:absolute;top:895px;left:112px;white-space:nowrap" class="ft3613">●</p>
<p style="position:absolute;top:892px;left:139px;white-space:nowrap" class="ft362">A service for&#160;measurement&#160;and loading&#160;the&#160;VM&#160;and&#160;vTPM&#160;- (</p>
<p style="position:absolute;top:892px;left:637px;white-space:nowrap" class="ft3611"><i>Loader&#160;Service</i></p>
<p style="position:absolute;top:892px;left:760px;white-space:nowrap" class="ft362">)</p>
<p style="position:absolute;top:923px;left:112px;white-space:nowrap" class="ft3613">●</p>
<p style="position:absolute;top:920px;left:139px;white-space:nowrap" class="ft362">A service&#160;recognizing&#160;shutdown&#160;of VMs&#160;-&#160;(</p>
<p style="position:absolute;top:920px;left:485px;white-space:nowrap" class="ft3611"><i>Events&#160;Service</i></p>
<p style="position:absolute;top:920px;left:607px;white-space:nowrap" class="ft362">)</p>
<p style="position:absolute;top:951px;left:112px;white-space:nowrap" class="ft3613">●</p>
<p style="position:absolute;top:948px;left:139px;white-space:nowrap" class="ft362">A&#160;service&#160;to&#160;load&#160;and&#160;store&#160;data&#160;of&#160;vTPMs&#160;- (</p>
<p style="position:absolute;top:948px;left:505px;white-space:nowrap" class="ft3611"><i>Storage&#160;Service</i></p>
<p style="position:absolute;top:948px;left:636px;white-space:nowrap" class="ft362">)</p>
<p style="position:absolute;top:977px;left:85px;white-space:nowrap" class="ft362">The&#160;</p>
<p style="position:absolute;top:977px;left:121px;white-space:nowrap" class="ft3611"><i>HW&#160;TPM service</i></p>
<p style="position:absolute;top:977px;left:254px;white-space:nowrap" class="ft362">&#160;contains&#160;the TPM&#160;driver&#160;and&#160;accepts&#160;TPM&#160;command&#160;blobs&#160;which</p>
<p style="position:absolute;top:996px;left:85px;white-space:nowrap" class="ft3612">are sent&#160;to&#160;the hardware&#160;TPM via the&#160;driver. The service&#160;is used&#160;by&#160;the&#160;emulated<br/>software&#160;TPMs.&#160;<br/>The&#160;</p>
<p style="position:absolute;top:1043px;left:121px;white-space:nowrap" class="ft3611"><i>vTPM&#160;service</i></p>
<p style="position:absolute;top:1043px;left:229px;white-space:nowrap" class="ft362">&#160;acts&#160;as&#160;the&#160;TPM for&#160;a&#160;VM&#160;instance.&#160;L4Linux&#160;VMs&#160;contain&#160;a&#160;vTPM&#160;stub</p>
<p style="position:absolute;top:1062px;left:85px;white-space:nowrap" class="ft3612">driver&#160;that&#160;is&#160;responsible&#160;for&#160;sending&#160;and for receiving&#160;TPM&#160;command&#160;blobs&#160;for&#160;and<br/>from&#160;the&#160;vTPM.&#160;<br/>New&#160;VM and&#160;vTPM&#160;instances&#160;are&#160;started&#160;by&#160;the&#160;</p>
<p style="position:absolute;top:1110px;left:481px;white-space:nowrap" class="ft3611"><i>loader</i></p>
<p style="position:absolute;top:1110px;left:533px;white-space:nowrap" class="ft362">. This&#160;component&#160;produces&#160;the</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft367">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft367">36/48</p>
</div>
<!-- Page 37 -->
<a name="37"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page37-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42037.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft377">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft377">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft3712">initial&#160;measurements&#160;of the VM&#160;image&#160;and its configuration&#160;file&#160;and writes&#160;the&#160;results<br/>into the vTPM.<br/>The&#160;</p>
<p style="position:absolute;top:198px;left:121px;white-space:nowrap" class="ft3711"><i>storage&#160;service</i></p>
<p style="position:absolute;top:198px;left:248px;white-space:nowrap" class="ft372">&#160;is&#160;used&#160;to&#160;save&#160;and&#160;to restore&#160;internal&#160;vTPM&#160;state between&#160;VM</p>
<p style="position:absolute;top:218px;left:85px;white-space:nowrap" class="ft3712">uptimes.&#160;This&#160;VTPM-SS&#160;information&#160;comprises,&#160;e.g.,&#160;of the private&#160;keys&#160;such as&#160;vEK,<br/>vSRK.&#160;The&#160;data&#160;will&#160;be&#160;sealed&#160;before&#160;sending&#160;it to&#160;the&#160;storage&#160;service&#160;and&#160;unsealed<br/>before&#160;it can&#160;be restored&#160;into&#160;a vTPM.&#160;<br/>The&#160;</p>
<p style="position:absolute;top:284px;left:121px;white-space:nowrap" class="ft3711"><i>event service</i></p>
<p style="position:absolute;top:284px;left:232px;white-space:nowrap" class="ft372">&#160;is required&#160;for notifications&#160;about&#160;VM instances&#160;that&#160;shut&#160;down.&#160;The</p>
<p style="position:absolute;top:303px;left:85px;white-space:nowrap" class="ft375">service collects and&#160;receives exit&#160;events&#160;of&#160;VMs&#160;and&#160;propagates&#160;them&#160;to&#160;other<br/>services.&#160;The&#160;vTPM&#160;service&#160;is&#160;registered&#160;for&#160;receiving&#160;the&#160;exit events&#160;of its&#160;associated<br/>VM. If&#160;a&#160;vTPM&#160;receives&#160;such&#160;an&#160;event,&#160;it&#160;seals&#160;its&#160;state&#160;using&#160;the&#160;underlying&#160;hardware<br/>TPM&#160;and&#160;sends&#160;the&#160;sealed&#160;data&#160;to&#160;the storage&#160;service.&#160;</p>
<p style="position:absolute;top:407px;left:85px;white-space:nowrap" class="ft3715"><b>8.2.2&#160;Lifecycle</b></p>
<p style="position:absolute;top:437px;left:112px;white-space:nowrap" class="ft3713">●</p>
<p style="position:absolute;top:434px;left:139px;white-space:nowrap" class="ft371"><b>Starting&#160;a new&#160;vTPM:</b></p>
<p style="position:absolute;top:434px;left:339px;white-space:nowrap" class="ft372">&#160;First&#160;the loader&#160;evaluates&#160;a configuration&#160;file&#160;that</p>
<p style="position:absolute;top:453px;left:139px;white-space:nowrap" class="ft375">contains&#160;the vTPM&#160;to be&#160;started&#160;and&#160;under which&#160;name&#160;it&#160;has to&#160;be registered.<br/>This&#160;name&#160;is part&#160;of&#160;command&#160;line parameter&#160;of the&#160;L4Linux VM&#160;instance.&#160;It<br/>enables&#160;the vTPM&#160;stub&#160;driver&#160;to retrieve&#160;its&#160;associated&#160;vTPM&#160;instance.&#160;After&#160;the<br/>loader&#160;has started&#160;the vTPM&#160;instance, it&#160;measures&#160;the configuration&#160;file&#160;and the<br/>binary&#160;of the VM&#160;and logs&#160;the&#160;result&#160;into&#160;the&#160;vTPM.&#160;At&#160;this stage,&#160;the&#160;VM&#160;can be<br/>started.&#160;The vTPM&#160;will&#160;be&#160;detected&#160;during&#160;boot-up; the software&#160;of&#160;the&#160;VM&#160;is<br/>able&#160;to&#160;take vTPM&#160;ownership&#160;and to&#160;perform&#160;other&#160;operations.</p>
<p style="position:absolute;top:599px;left:112px;white-space:nowrap" class="ft3713">●</p>
<p style="position:absolute;top:596px;left:139px;white-space:nowrap" class="ft371"><b>Shutting&#160;down&#160;a&#160;vTPM:</b></p>
<p style="position:absolute;top:596px;left:355px;white-space:nowrap" class="ft372">&#160;The&#160;vTPM&#160;is bound&#160;to&#160;a particular&#160;VM&#160;instance. When</p>
<p style="position:absolute;top:616px;left:139px;white-space:nowrap" class="ft375">receiving&#160;the&#160;exit event of its&#160;associated&#160;VM,&#160;the&#160;vTPM&#160;seals&#160;its&#160;internal&#160;state<br/>using the&#160;hardware&#160;TPM. The sealed&#160;data&#160;is send&#160;by the&#160;vTPM&#160;to&#160;the&#160;storage<br/>service which&#160;makes&#160;the&#160;data&#160;persistent.&#160;Finally,&#160;the vTPM&#160;service&#160;terminates<br/>itself.&#160;</p>
<p style="position:absolute;top:704px;left:112px;white-space:nowrap" class="ft3713">●</p>
<p style="position:absolute;top:701px;left:139px;white-space:nowrap" class="ft371"><b>Restarting&#160;a&#160;vTPM</b></p>
<p style="position:absolute;top:701px;left:310px;white-space:nowrap" class="ft372">:&#160;The&#160;procedure&#160;is similar&#160;to starting&#160;a new&#160;vTPM.&#160;During</p>
<p style="position:absolute;top:721px;left:139px;white-space:nowrap" class="ft375">instantiation,&#160;however,&#160;the&#160;vTPM&#160;requests&#160;its sealed data&#160;from&#160;the storage<br/>service.&#160;This data&#160;is&#160;is&#160;unsealed by&#160;the&#160;hardware&#160;TPM&#160;and&#160;can than&#160;be restored<br/>by&#160;the vTPM.&#160;</p>
<p style="position:absolute;top:787px;left:85px;white-space:nowrap" class="ft375">The&#160;vPCR&#160;registers&#160;of the&#160;vTPM&#160;instances&#160;contain only the hashes&#160;of binaries&#160;and<br/>configuration&#160;files&#160;for&#160;its&#160;associated&#160;VM. The “missing&#160;link” between the virtual<br/>instances&#160;(vTPM/VM)&#160;and&#160;the physical&#160;ones (hardware&#160;TPM/microkernel&#160;operating<br/>system)&#160;is created during&#160;the attestation&#160;process.&#160;</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft377">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft377">37/48</p>
</div>
<!-- Page 38 -->
<a name="38"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page38-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42038.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft387">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft387">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:172px;left:85px;white-space:nowrap" class="ft389"><b>9&#160;</b></p>
<p style="position:absolute;top:169px;left:117px;white-space:nowrap" class="ft3810"><b>Summary</b></p>
<p style="position:absolute;top:199px;left:85px;white-space:nowrap" class="ft385">This&#160;deliverable&#160;documents&#160;analysis,&#160;requirements and&#160;design&#160;of a&#160;unified&#160;Virtual&#160;TPM<br/>architecture&#160;for&#160;both&#160;Virtualization&#160;technologies&#160;used&#160;in the&#160;OpenTC&#160;project,&#160;Xen&#160;and<br/>L4. We&#160;reviewed &#160;TPM&#160;architectures&#160;that are currently available&#160;on these&#160;virtualization<br/>solutions and&#160;identified&#160;a number of&#160;limitations. These&#160;include the&#160;lack&#160;of&#160;strong<br/>isolation&#160;between Virtual&#160;TPM&#160;instances,&#160;large&#160;Trusted Computing&#160;Base for<br/>enforcement of the Virtual&#160;TPM security,&#160;the&#160;limited&#160;model&#160;for integrating&#160;the&#160;Virtual<br/>TPMs&#160;and&#160;the&#160;hardware&#160;TPM,&#160;and&#160;lack&#160;of&#160;support&#160;for&#160;providing&#160;secure&#160;binding&#160;between<br/>the Virtual&#160;TPM&#160;and&#160;its corresponding&#160;Virtual&#160;Machine.&#160;We used&#160;the&#160;well&#160;understood<br/>hardware&#160;model&#160;as&#160;an&#160;analogy&#160;for&#160;discussing&#160;the general life&#160;cycle of TPMs&#160;and&#160;its<br/>mapping&#160;to&#160;its virtual&#160;counterpart.<br/>The&#160;requirement&#160;analysis&#160;for the specificities&#160;of the&#160;Virtual&#160;TPM&#160;addresses&#160;several<br/>limitations&#160;of&#160;hardware&#160;based&#160;TPMs.&#160;In&#160;particular,&#160;we propose&#160;a&#160;security interface&#160;(an<br/>extension&#160;of the BMSI&#160;defined&#160;in&#160;a&#160;previous&#160;deliverable)&#160;that&#160;links&#160;with&#160;the hardware<br/>TPM&#160;without&#160;the&#160;need&#160;for&#160;an&#160;owner of&#160;the&#160;hardware&#160;TPM.&#160;We designed&#160;this&#160;model&#160;so<br/>that&#160;the security&#160;service&#160;implementing&#160;this&#160;interface&#160;can be&#160;the&#160;owner of the&#160;hardware<br/>TPM.&#160;This enables us to&#160;utilize&#160;security&#160;functionality&#160;provided&#160;by the hardware&#160;TPM<br/>while limiting&#160;the level&#160;of&#160;trust&#160;that must&#160;be placed&#160;in the owner of the physical<br/>platform.&#160;It also allows multiple&#160;virtual&#160;TPMs&#160;to&#160;be implemented&#160;using&#160;the security<br/>interface&#160;with&#160;different&#160;owners&#160;for&#160;each virtual&#160;TPM.&#160;This model&#160;is important&#160;for virtual<br/>data&#160;centres where&#160;different&#160;virtual&#160;machines&#160;hosted&#160;by&#160;the&#160;same&#160;physical&#160;platform<br/>may&#160;have&#160;a different&#160;owner.<br/>Virtual&#160;TPMs&#160;as&#160;described&#160;in this architecture&#160;are&#160;software&#160;components&#160;which&#160;may<br/>provide&#160;more&#160;or&#160;less&#160;functionality&#160;as a&#160;hardware&#160;TPM.&#160;We&#160;therefore&#160;included&#160;a<br/>discussion&#160;on&#160;some&#160;possible&#160;future&#160;for&#160;enhancing&#160;existing&#160;virtual&#160;TPMs by adding<br/>support&#160;for&#160;property&#160;based&#160;mechanism.&#160;This is&#160;one&#160;example&#160;of how&#160;TPM virtualization<br/>can&#160;be used&#160;to&#160;provide&#160;more&#160;flexible&#160;security&#160;services&#160;that&#160;are&#160;based&#160;on&#160;the&#160;same<br/>basic&#160;concepts&#160;that&#160;Trusted&#160;Computing&#160;has been&#160;defining&#160;for hardware&#160;TPMs. The&#160;final<br/>section outlines the&#160;implementation&#160;of vTPMs&#160;for&#160;Xen&#160;and L4 that&#160;will&#160;be&#160;performed by<br/>WP04&#160;during&#160;the remaining&#160;time&#160;of&#160;the&#160;OpenTC&#160;project.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft387">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft387">38/48</p>
</div>
<!-- Page 39 -->
<a name="39"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page39-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42039.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft397">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft397">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:172px;left:85px;white-space:nowrap" class="ft399"><b>10&#160;</b></p>
<p style="position:absolute;top:169px;left:127px;white-space:nowrap" class="ft3910"><b>Abbreviations</b></p>
<p style="position:absolute;top:199px;left:113px;white-space:nowrap" class="ft391"><b>Abbreviation</b></p>
<p style="position:absolute;top:199px;left:303px;white-space:nowrap" class="ft391"><b>Explanation</b></p>
<p style="position:absolute;top:218px;left:113px;white-space:nowrap" class="ft392">AIK</p>
<p style="position:absolute;top:218px;left:303px;white-space:nowrap" class="ft392">Attestation&#160;identity key</p>
<p style="position:absolute;top:238px;left:113px;white-space:nowrap" class="ft392">API</p>
<p style="position:absolute;top:238px;left:303px;white-space:nowrap" class="ft392">Application&#160;Programming&#160;Interface</p>
<p style="position:absolute;top:257px;left:113px;white-space:nowrap" class="ft392">BMSI</p>
<p style="position:absolute;top:257px;left:303px;white-space:nowrap" class="ft392">Basic&#160;Management&#160;Service&#160;Interface</p>
<p style="position:absolute;top:276px;left:113px;white-space:nowrap" class="ft392">CPU</p>
<p style="position:absolute;top:276px;left:303px;white-space:nowrap" class="ft392">Central&#160;Processing&#160;Unit</p>
<p style="position:absolute;top:295px;left:113px;white-space:nowrap" class="ft392">CRTM</p>
<p style="position:absolute;top:295px;left:303px;white-space:nowrap" class="ft392">Core&#160;Root&#160;for Trust&#160;for&#160;Measurement</p>
<p style="position:absolute;top:315px;left:113px;white-space:nowrap" class="ft392">DMA</p>
<p style="position:absolute;top:315px;left:303px;white-space:nowrap" class="ft392">Direct&#160;Memory&#160;Access&#160;</p>
<p style="position:absolute;top:334px;left:113px;white-space:nowrap" class="ft392">Dom0</p>
<p style="position:absolute;top:334px;left:303px;white-space:nowrap" class="ft392">Xen controller&#160;domain</p>
<p style="position:absolute;top:353px;left:113px;white-space:nowrap" class="ft392">DomB</p>
<p style="position:absolute;top:353px;left:303px;white-space:nowrap" class="ft392">Xen domain&#160;builder&#160;domain</p>
<p style="position:absolute;top:373px;left:113px;white-space:nowrap" class="ft392">DomU</p>
<p style="position:absolute;top:373px;left:303px;white-space:nowrap" class="ft392">Xen user&#160;domain</p>
<p style="position:absolute;top:392px;left:113px;white-space:nowrap" class="ft392">EK</p>
<p style="position:absolute;top:392px;left:303px;white-space:nowrap" class="ft392">Endorsement&#160;Key</p>
<p style="position:absolute;top:411px;left:113px;white-space:nowrap" class="ft392">GUI</p>
<p style="position:absolute;top:411px;left:303px;white-space:nowrap" class="ft392">Graphical&#160;User&#160;Interface&#160;</p>
<p style="position:absolute;top:430px;left:113px;white-space:nowrap" class="ft392">GUID</p>
<p style="position:absolute;top:430px;left:303px;white-space:nowrap" class="ft392">Globally Unique&#160;Identifier&#160;(a&#160;128-bit value)</p>
<p style="position:absolute;top:450px;left:113px;white-space:nowrap" class="ft392">GVTPM</p>
<p style="position:absolute;top:450px;left:303px;white-space:nowrap" class="ft392">Generalized TPM&#160;Virtualization</p>
<p style="position:absolute;top:469px;left:113px;white-space:nowrap" class="ft392">HIM</p>
<p style="position:absolute;top:469px;left:303px;white-space:nowrap" class="ft392">Hierarchical&#160;Integrity&#160;Management</p>
<p style="position:absolute;top:488px;left:113px;white-space:nowrap" class="ft392">LPC</p>
<p style="position:absolute;top:488px;left:303px;white-space:nowrap" class="ft392">Low&#160;Pin&#160;Count&#160;(bus)</p>
<p style="position:absolute;top:508px;left:113px;white-space:nowrap" class="ft392">NVRAM</p>
<p style="position:absolute;top:508px;left:303px;white-space:nowrap" class="ft392">Non-Volatile&#160;RAM</p>
<p style="position:absolute;top:526px;left:113px;white-space:nowrap" class="ft392">OS</p>
<p style="position:absolute;top:526px;left:303px;white-space:nowrap" class="ft392">Operating&#160;System</p>
<p style="position:absolute;top:545px;left:113px;white-space:nowrap" class="ft392">PCR</p>
<p style="position:absolute;top:545px;left:303px;white-space:nowrap" class="ft392">Platform&#160;Configuration&#160;Register</p>
<p style="position:absolute;top:565px;left:113px;white-space:nowrap" class="ft392">SRK</p>
<p style="position:absolute;top:565px;left:303px;white-space:nowrap" class="ft392">Storage&#160;Root&#160;Key</p>
<p style="position:absolute;top:584px;left:113px;white-space:nowrap" class="ft392">SSH</p>
<p style="position:absolute;top:584px;left:303px;white-space:nowrap" class="ft392">Secure Shell</p>
<p style="position:absolute;top:603px;left:113px;white-space:nowrap" class="ft392">SSL</p>
<p style="position:absolute;top:603px;left:303px;white-space:nowrap" class="ft392">Secure Sockets&#160;Layer</p>
<p style="position:absolute;top:622px;left:113px;white-space:nowrap" class="ft392">STPM</p>
<p style="position:absolute;top:622px;left:304px;white-space:nowrap" class="ft392">Simple&#160;TPM&#160;service for&#160;L4</p>
<p style="position:absolute;top:642px;left:113px;white-space:nowrap" class="ft392">TC</p>
<p style="position:absolute;top:642px;left:303px;white-space:nowrap" class="ft392">Trusted Computing</p>
<p style="position:absolute;top:661px;left:113px;white-space:nowrap" class="ft392">TCB</p>
<p style="position:absolute;top:661px;left:303px;white-space:nowrap" class="ft392">Trusted&#160;Computing&#160;Base</p>
<p style="position:absolute;top:680px;left:113px;white-space:nowrap" class="ft392">TCG</p>
<p style="position:absolute;top:680px;left:303px;white-space:nowrap" class="ft392">Trusted&#160;Computing&#160;Group</p>
<p style="position:absolute;top:699px;left:113px;white-space:nowrap" class="ft392">TCS</p>
<p style="position:absolute;top:699px;left:303px;white-space:nowrap" class="ft392">TCG&#160;Core&#160;Service</p>
<p style="position:absolute;top:719px;left:113px;white-space:nowrap" class="ft392">TCSI</p>
<p style="position:absolute;top:719px;left:303px;white-space:nowrap" class="ft392">TCG-Interface&#160;</p>
<p style="position:absolute;top:738px;left:113px;white-space:nowrap" class="ft392">TPM</p>
<p style="position:absolute;top:738px;left:303px;white-space:nowrap" class="ft392">Trusted&#160;Platform&#160;Module</p>
<p style="position:absolute;top:757px;left:113px;white-space:nowrap" class="ft392">TSS</p>
<p style="position:absolute;top:757px;left:303px;white-space:nowrap" class="ft392">Trusted&#160;Software&#160;Stack</p>
<p style="position:absolute;top:777px;left:113px;white-space:nowrap" class="ft392">TTP</p>
<p style="position:absolute;top:777px;left:303px;white-space:nowrap" class="ft392">Trusted&#160;Third&#160;Party</p>
<p style="position:absolute;top:796px;left:113px;white-space:nowrap" class="ft392">TTVL</p>
<p style="position:absolute;top:796px;left:303px;white-space:nowrap" class="ft392">Trusted Virtualization&#160;Layer</p>
<p style="position:absolute;top:815px;left:113px;white-space:nowrap" class="ft392">VDEV</p>
<p style="position:absolute;top:815px;left:303px;white-space:nowrap" class="ft392">Virtual&#160;Device</p>
<p style="position:absolute;top:834px;left:113px;white-space:nowrap" class="ft392">VHID</p>
<p style="position:absolute;top:834px;left:303px;white-space:nowrap" class="ft392">Virtual&#160;Human&#160;Interface&#160;Device</p>
<p style="position:absolute;top:854px;left:113px;white-space:nowrap" class="ft392">VM</p>
<p style="position:absolute;top:854px;left:303px;white-space:nowrap" class="ft392">Virtual&#160;Machine</p>
<p style="position:absolute;top:873px;left:113px;white-space:nowrap" class="ft392">VMM</p>
<p style="position:absolute;top:873px;left:303px;white-space:nowrap" class="ft392">Virtual&#160;Machine Monitor also known&#160;as hypervisor</p>
<p style="position:absolute;top:892px;left:113px;white-space:nowrap" class="ft392">VNET</p>
<p style="position:absolute;top:892px;left:303px;white-space:nowrap" class="ft392">Virtual&#160;Network</p>
<p style="position:absolute;top:912px;left:113px;white-space:nowrap" class="ft392">VSTO</p>
<p style="position:absolute;top:912px;left:303px;white-space:nowrap" class="ft392">Virtual&#160;Storage</p>
<p style="position:absolute;top:931px;left:113px;white-space:nowrap" class="ft392">VTPM</p>
<p style="position:absolute;top:931px;left:303px;white-space:nowrap" class="ft392">Virtual&#160;TPM&#160;</p>
<p style="position:absolute;top:950px;left:113px;white-space:nowrap" class="ft392">VTPM-NVB</p>
<p style="position:absolute;top:950px;left:303px;white-space:nowrap" class="ft392">Virtual&#160;TPM&#160;Non&#160;Volatile&#160;Blob</p>
<p style="position:absolute;top:969px;left:113px;white-space:nowrap" class="ft392">VTPM-NVD</p>
<p style="position:absolute;top:969px;left:303px;white-space:nowrap" class="ft392">Virtual&#160;TPM&#160;Non&#160;Volatile&#160;Data</p>
<p style="position:absolute;top:989px;left:113px;white-space:nowrap" class="ft392">VTPM-SS</p>
<p style="position:absolute;top:989px;left:303px;white-space:nowrap" class="ft392">Virtual&#160;TPM&#160;State Structure</p>
<p style="position:absolute;top:1008px;left:113px;white-space:nowrap" class="ft392">WP</p>
<p style="position:absolute;top:1008px;left:303px;white-space:nowrap" class="ft392">Work&#160;Package</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft397">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft397">39/48</p>
</div>
<!-- Page 40 -->
<a name="40"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft4029{font-size:18px;font-family:ArialMT;color:#000000;}
	.ft4030{font-size:15px;font-family:ArialMT;color:#000000;}
-->
</style>
<div id="page40-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42040.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft407">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft407">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:172px;left:85px;white-space:nowrap" class="ft409"><b>11&#160;</b></p>
<p style="position:absolute;top:169px;left:127px;white-space:nowrap" class="ft4010"><b>Implementation details</b></p>
<p style="position:absolute;top:199px;left:85px;white-space:nowrap" class="ft405">This&#160;section&#160;describes&#160;the&#160;software&#160;components&#160;that&#160;have been&#160;developed&#160;by&#160;WP4<br/>partners&#160;in&#160;the course&#160;of&#160;the project&#160;in&#160;order to&#160;implement&#160;the&#160;vTPM&#160;architecture<br/>described&#160;in&#160;this&#160;document.&#160;The software&#160;components&#160;have&#160;been packaged&#160;and<br/>distributed&#160;as part of the&#160;project&#160;wide&#160;prototype&#160;activity.&#160;All the&#160;software&#160;described&#160;in<br/>this&#160;section&#160;has been released&#160;under&#160;open&#160;source&#160;license&#160;and&#160;has been&#160;contributed&#160;by<br/>Work&#160;Package 4&#160;to&#160;the&#160;OpenTC&#160;project.</p>
<p style="position:absolute;top:332px;left:85px;white-space:nowrap" class="ft401"><b>11.1&#160;Software components and&#160;their description</b></p>
<p style="position:absolute;top:378px;left:85px;white-space:nowrap" class="ft4015"><b>11.1.1&#160;MLRPC Library</b></p>
<p style="position:absolute;top:405px;left:85px;white-space:nowrap" class="ft405">A crucial requirement&#160;for&#160;the&#160;communication&#160;between the HIM&#160;service&#160;and&#160;its&#160;clients is<br/>that&#160;the HIM&#160;service&#160;knows&#160;the&#160;origin&#160;of&#160;each&#160;request.&#160;For example,&#160;it&#160;needs to&#160;know<br/>which&#160;client&#160;sent&#160;a request&#160;to&#160;retrieve&#160;sealed&#160;data&#160;that&#160;must&#160;only be&#160;accessible&#160;to&#160;a<br/>specific&#160;trusted application.&#160;However, the&#160;HIM&#160;service&#160;does&#160;not&#160;have&#160;full&#160;information<br/>about&#160;how&#160;software&#160;is structured&#160;in&#160;the system.&#160;Initially,&#160;it knows&#160;only about&#160;clients<br/>such&#160;as&#160;a VM&#160;or&#160;programs&#160;running&#160;directly on&#160;top&#160;of&#160;the Xen&#160;hypervisor&#160;or&#160;L4<br/>microkernel,&#160;because those&#160;are created and registered&#160;with HIM by&#160;a&#160;trustworthy<br/>platform&#160;service&#160;(e.g.,&#160;BMSI).&#160;A&#160;Linux program&#160;running&#160;inside&#160;a VM&#160;is not&#160;known&#160;to<br/>HIM, until&#160;the kernel&#160;running&#160;inside&#160;this VM&#160;tells HIM about&#160;it. Similarly,&#160;a Java<br/>application&#160;that&#160;wants to&#160;use&#160;HIM relies on&#160;its&#160;Java&#160;VM&#160;that&#160;might&#160;run&#160;as a&#160;Linux<br/>process&#160;to&#160;register&#160;it&#160;with&#160;HIM.<br/>This approach&#160;is acceptable,&#160;because&#160;a<br/>Linux program&#160;has&#160;to trust&#160;its&#160;parent,<br/>the Linux&#160;kernel,&#160;in&#160;any&#160;case.&#160;Figure&#160;1<br/>illustrates&#160;these&#160;trust&#160;and&#160;parent-child<br/>relationships.&#160;We&#160;exploit&#160;these<br/>relationships&#160;when&#160;generating<br/>trustworthy&#160;information&#160;about&#160;an&#160;HIM<br/>client's&#160;location&#160;in&#160;the tree&#160;of software<br/>components&#160;by forwarding&#160;HIM<br/>requests&#160;along the path&#160;of software<br/>components&#160;from&#160;the client&#160;to the&#160;HIM<br/>service.&#160;Each parent&#160;extends the<br/>request with&#160;a&#160;local&#160;ID designating&#160;the<br/>child it received the&#160;request&#160;from,&#160;and<br/>then&#160;forwards&#160;it&#160;to&#160;its own&#160;parent&#160;(see<br/>Figures&#160;2,&#160;3).&#160;For&#160;example,&#160;the&#160;Linux<br/>kernel&#160;might&#160;add&#160;the client&#160;program's<br/>process&#160;ID&#160;to the message,&#160;which&#160;is<br/>then&#160;extended by the virtualisation<br/>layer&#160;with&#160;an&#160;identifier&#160;designating&#160;the<br/>VM&#160;that&#160;is&#160;running&#160;this&#160;Linux kernel.<br/>That&#160;way,&#160;the IDs&#160;in a message&#160;that<br/>arrives&#160;at&#160;the&#160;HIM service encode&#160;the<br/>full path&#160;the&#160;request&#160;took starting&#160;at<br/>the&#160;client. The HIM&#160;service&#160;can then<br/>determine&#160;the&#160;identity&#160;of any client,</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft407">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft407">40/48</p>
<p style="position:absolute;top:1065px;left:443px;white-space:nowrap" class="ft4015"><b>Figure&#160;1:&#160;Hierarchical&#160;structure&#160;of&#160;HIM</b></p>
<p style="position:absolute;top:1083px;left:443px;white-space:nowrap" class="ft4021"><b>service&#160;and clients. Communication<br/>between clients&#160;and server&#160;is</b></p>
<p style="position:absolute;top:1118px;left:443px;white-space:nowrap" class="ft4015"><b>implemented in libmlrpc.</b></p>
<p style="position:absolute;top:703px;left:456px;white-space:nowrap" class="ft4029">Linux VM</p>
<p style="position:absolute;top:1014px;left:629px;white-space:nowrap" class="ft4029">HIM</p>
<p style="position:absolute;top:888px;left:483px;white-space:nowrap" class="ft4029">Linux Kernel</p>
<p style="position:absolute;top:787px;left:480px;white-space:nowrap" class="ft4029">App</p>
<p style="position:absolute;top:776px;left:581px;white-space:nowrap" class="ft4029">JVM&#160; &#160; &#160; &#160;&#160;</p>
<p style="position:absolute;top:699px;left:570px;white-space:nowrap" class="ft4030">Java</p>
<p style="position:absolute;top:717px;left:571px;white-space:nowrap" class="ft4030">App</p>
<p style="position:absolute;top:699px;left:637px;white-space:nowrap" class="ft4030">Java</p>
<p style="position:absolute;top:717px;left:638px;white-space:nowrap" class="ft4030">App</p>
<p style="position:absolute;top:895px;left:749px;white-space:nowrap" class="ft4029">vTPM</p>
<p style="position:absolute;top:981px;left:599px;white-space:nowrap" class="ft4030">MLRPC</p>
<p style="position:absolute;top:898px;left:599px;white-space:nowrap" class="ft4030">MLRPC</p>
<p style="position:absolute;top:798px;left:599px;white-space:nowrap" class="ft4030">MLRPC</p>
</div>
<!-- Page 41 -->
<a name="41"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft4131{font-size:14px;font-family:IHPHHK+ArialUnicodeMS;color:#000000;}
	.ft4132{font-size:18px;font-family:ArialMT;color:#ccccff;}
-->
</style>
<div id="page41-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42041.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft417">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft417">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft415">based&#160;on the fact&#160;that&#160;each&#160;component trusts&#160;its parent.&#160;(The&#160;HIM&#160;service&#160;itself needs<br/>only&#160;trust&#160;in&#160;the&#160;integrity of the&#160;identifier&#160;of&#160;the VM&#160;or&#160;program&#160;that&#160;it received&#160;the<br/>message&#160;from&#160;and&#160;that&#160;is located&#160;directly above&#160;itself in&#160;the tree&#160;of&#160;trust.)</p>
<p style="position:absolute;top:246px;left:85px;white-space:nowrap" class="ft415">Unfortunately,&#160;the handling of this kind&#160;of path&#160;information&#160;is<br/>not&#160;supported&#160;by&#160;standard&#160;RPC&#160;schemes,&#160;for&#160;example,&#160;the<br/>model&#160;implemented&#160;by IDL&#160;compilers&#160;such&#160;as&#160;DICE.&#160;They only<br/>support&#160;the marshalling&#160;of function&#160;call&#160;arguments&#160;and&#160;return<br/>values,&#160;but cannot&#160;automatically&#160;add&#160;routing information<br/>across&#160;multiple&#160;layers&#160;as required for HIM.&#160;Furthermore,&#160;there<br/>are&#160;different&#160;mechanisms&#160;used&#160;for&#160;communication&#160;between<br/>each&#160;two&#160;layers (e.g.,&#160;L4&#160;IPC,&#160;Linux&#160;syscalls).&#160;We&#160;therefore<br/>developed&#160;the Multi-Layer Remote&#160;Procedure&#160;Call&#160;library<br/>“libmlrpc”,&#160;which meets HIM's&#160;requirement:</p>
<p style="position:absolute;top:452px;left:85px;white-space:nowrap" class="ft4131">•</p>
<p style="position:absolute;top:451px;left:90px;white-space:nowrap" class="ft412">Marshalling/unmarshalling&#160;of&#160;arguments&#160;and return&#160;values&#160;for</p>
<p style="position:absolute;top:471px;left:85px;white-space:nowrap" class="ft412">RPC-like&#160;communication</p>
<p style="position:absolute;top:504px;left:85px;white-space:nowrap" class="ft4131">•</p>
<p style="position:absolute;top:503px;left:90px;white-space:nowrap" class="ft412">Trustworthy&#160;generation&#160;of&#160;a&#160;unique&#160;ID&#160;for&#160;each&#160;client&#160;via the</p>
<p style="position:absolute;top:522px;left:85px;white-space:nowrap" class="ft412">previously&#160;described&#160;path&#160;scheme</p>
<p style="position:absolute;top:556px;left:85px;white-space:nowrap" class="ft4131">•</p>
<p style="position:absolute;top:555px;left:90px;white-space:nowrap" class="ft412">Adaptability&#160;to different&#160;execution environments&#160;and</p>
<p style="position:absolute;top:574px;left:85px;white-space:nowrap" class="ft415">(pluggable)&#160;support&#160;for&#160;different&#160;communication&#160;schemes&#160;at<br/>each level in the tree of software&#160;components</p>
<p style="position:absolute;top:627px;left:85px;white-space:nowrap" class="ft4131">•</p>
<p style="position:absolute;top:626px;left:90px;white-space:nowrap" class="ft412">Low complexity&#160;and&#160;little&#160;infrastructure&#160;requirements</p>
<p style="position:absolute;top:654px;left:85px;white-space:nowrap" class="ft4112">Libmlrpc&#160;is implemented&#160;as&#160;a&#160;cross-platform&#160;library&#160;that<br/>forwards&#160;requests&#160;downwards&#160;in&#160;the&#160;tree&#160;of software<br/>components,&#160;receives&#160;replies from&#160;lower levels&#160;and&#160;passes<br/>them&#160;up to&#160;the&#160;caller&#160;at&#160;the next&#160;upper&#160;level. It&#160;also supports<br/>marshalling&#160;of primitive&#160;and&#160;complex&#160;data&#160;types&#160;into an&#160;opaque<br/>message&#160;buffer&#160;that&#160;can easily&#160;be&#160;transmitted&#160;among&#160;layers via<br/>various&#160;communication&#160;mechanisms.&#160;The library&#160;takes care of<br/>encoding&#160;the path&#160;taken&#160;by a&#160;request&#160;by rewrapping&#160;each<br/>received&#160;copy of a&#160;message&#160;in a new message&#160;with&#160;the copy<br/>being&#160;the&#160;payload.&#160;It&#160;therefore&#160;allows&#160;clients to&#160;perform&#160;remote<br/>procedure&#160;calls to&#160;a service at&#160;a&#160;lower&#160;level&#160;of the&#160;software<br/>stack&#160;in&#160;traceable&#160;manner.<br/>A program&#160;using&#160;libmlrpc&#160;can assume&#160;the&#160;following roles:</p>
<p style="position:absolute;top:928px;left:111px;white-space:nowrap" class="ft4131">•</p>
<p style="position:absolute;top:927px;left:116px;white-space:nowrap" class="ft411"><b>Client:</b></p>
<p style="position:absolute;top:927px;left:177px;white-space:nowrap" class="ft412">&#160;Usually&#160;an application&#160;at&#160;a&#160;high level inside the tree</p>
<p style="position:absolute;top:946px;left:138px;white-space:nowrap" class="ft415">of software&#160;components.&#160;It&#160;marshals&#160;the&#160;arguments&#160;of<br/>the&#160;RPC&#160;and forwards&#160;the resulting&#160;request&#160;message&#160;to<br/>its&#160;parent.&#160;It&#160;then&#160;waits&#160;for&#160;the&#160;reply and&#160;unmarshals&#160;the<br/>return&#160;codes&#160;received&#160;from&#160;the&#160;service&#160;that&#160;has&#160;been<br/>called.</p>
<p style="position:absolute;top:1056px;left:111px;white-space:nowrap" class="ft4131">•</p>
<p style="position:absolute;top:1055px;left:116px;white-space:nowrap" class="ft411"><b>Forwarder:</b></p>
<p style="position:absolute;top:1055px;left:219px;white-space:nowrap" class="ft412">&#160;Located&#160;at&#160;middle layers.&#160;The&#160;task&#160;of&#160;a&#160;libmlrpc</p>
<p style="position:absolute;top:1074px;left:138px;white-space:nowrap" class="ft415">forwarder&#160;is&#160;to&#160;receive&#160;messages&#160;from&#160;uper&#160;layers,&#160;and<br/>then&#160;passing&#160;them on&#160;downwards&#160;in&#160;the&#160;tree. It&#160;also&#160;tells<br/>libmlrpc&#160;with&#160;which&#160;local&#160;ID the&#160;request&#160;message&#160;has&#160;to</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft417">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft417">41/48</p>
<p style="position:absolute;top:1026px;left:644px;white-space:nowrap" class="ft4115"><b>Figure 3:</b></p>
<p style="position:absolute;top:1044px;left:644px;white-space:nowrap" class="ft4115"><b>Forwarding&#160;of</b></p>
<p style="position:absolute;top:1061px;left:644px;white-space:nowrap" class="ft4115"><b>MLRPC messages</b></p>
<p style="position:absolute;top:1079px;left:644px;white-space:nowrap" class="ft4115"><b>between layers.</b></p>
<p style="position:absolute;top:737px;left:694px;white-space:nowrap" class="ft4129">MLRPC</p>
<p style="position:absolute;top:758px;left:703px;white-space:nowrap" class="ft4129">Client</p>
<p style="position:absolute;top:860px;left:694px;white-space:nowrap" class="ft4129">MLRPC</p>
<p style="position:absolute;top:881px;left:685px;white-space:nowrap" class="ft4129">Forwarder</p>
<p style="position:absolute;top:983px;left:694px;white-space:nowrap" class="ft4129">MLRPC</p>
<p style="position:absolute;top:1004px;left:700px;white-space:nowrap" class="ft4129">Server</p>
<p style="position:absolute;top:658px;left:709px;white-space:nowrap" class="ft4129">App</p>
<p style="position:absolute;top:445px;left:634px;white-space:nowrap" class="ft4115"><b>Figure 2: MLRPC</b></p>
<p style="position:absolute;top:463px;left:634px;white-space:nowrap" class="ft4115"><b>messages&#160;are</b></p>
<p style="position:absolute;top:480px;left:634px;white-space:nowrap" class="ft4121"><b>recursively<br/>wrapped,&#160;with&#160;local</b></p>
<p style="position:absolute;top:515px;left:634px;white-space:nowrap" class="ft4115"><b>IDs of each&#160;layer</b></p>
<p style="position:absolute;top:532px;left:634px;white-space:nowrap" class="ft4115"><b>specifying the&#160;path</b></p>
<p style="position:absolute;top:550px;left:634px;white-space:nowrap" class="ft4115"><b>that a&#160;request</b></p>
<p style="position:absolute;top:567px;left:634px;white-space:nowrap" class="ft4115"><b>message took.</b></p>
<p style="position:absolute;top:271px;left:681px;white-space:nowrap" class="ft4129">L4&#160;Task ID</p>
<p style="position:absolute;top:316px;left:679px;white-space:nowrap" class="ft4129">Process ID</p>
<p style="position:absolute;top:367px;left:686px;white-space:nowrap" class="ft4132">Message</p>
<p style="position:absolute;top:388px;left:690px;white-space:nowrap" class="ft4132">Payload</p>
</div>
<!-- Page 42 -->
<a name="42"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft4233{font-size:16px;font-family:IHILJD+BitstreamVeraSans;color:#000080;}
-->
</style>
<div id="page42-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42042.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft427">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft427">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:138px;white-space:nowrap" class="ft425">be extended.&#160;(It is possible,&#160;though&#160;not&#160;required,&#160;for&#160;a&#160;forwarder&#160;to&#160;inspect&#160;and/<br/>or&#160;modify&#160;messages&#160;or&#160;implement&#160;access&#160;control.)&#160;See&#160;Figure&#160;2.</p>
<p style="position:absolute;top:204px;left:111px;white-space:nowrap" class="ft4231">•</p>
<p style="position:absolute;top:203px;left:116px;white-space:nowrap" class="ft421"><b>Server:</b></p>
<p style="position:absolute;top:203px;left:184px;white-space:nowrap" class="ft422">&#160;Located&#160;at&#160;lowest&#160;layer in the&#160;tree. The server-side functionality&#160;of</p>
<p style="position:absolute;top:222px;left:138px;white-space:nowrap" class="ft425">libmlrpc&#160;automatically&#160;extracts&#160;the path&#160;from&#160;the received&#160;message&#160;while<br/>removing&#160;all&#160;wrapping&#160;layers that&#160;were added.&#160;The raw&#160;message&#160;buffer&#160;and&#160;the<br/>string-encoded&#160;path&#160;is then passed&#160;to&#160;a user-provided&#160;handler&#160;function.&#160;It<br/>unmarshals&#160;the&#160;arguments&#160;of&#160;the&#160;RPC&#160;and handles&#160;the&#160;request,&#160;taking&#160;the<br/>identity information&#160;encoded in the path&#160;into&#160;account.&#160;This user&#160;function&#160;is<br/>responsible&#160;for&#160;creating&#160;a&#160;reply&#160;message,&#160;which&#160;is then&#160;routed&#160;back by&#160;libmlrpc<br/>to&#160;the&#160;client&#160;based&#160;on&#160;the&#160;respective&#160;local&#160;IDs&#160;encoded&#160;in&#160;the previously<br/>recorded&#160;path.&#160;</p>
<p style="position:absolute;top:385px;left:85px;white-space:nowrap" class="ft425">Libmlrpc&#160;has a low-complexity,&#160;flexible&#160;interface and&#160;its implementation&#160;has little<br/>dependencies.&#160;This also makes&#160;it suitable&#160;for&#160;use&#160;in&#160;the&#160;Linux kernel,&#160;but also&#160;in native<br/>L4&#160;or&#160;Xen MiniOS&#160;applications.&#160;Marshalling,&#160;unmarshalling,&#160;and&#160;handling&#160;of the path<br/>information&#160;is&#160;performed&#160;by&#160;platform-independent&#160;parts of libmlrpc&#160;and&#160;are available<br/>for&#160;regular&#160;Linux applications,&#160;Xen&#160;and&#160;L4.&#160;The logic&#160;that&#160;is actually&#160;transmitting&#160;a<br/>message&#160;from&#160;one&#160;layer to&#160;another&#160;is&#160;implemented in transport-specific&#160;code that&#160;is<br/>linked&#160;to the&#160;layer-specific&#160;flavours&#160;of libmlrpc.&#160;WP4 implemented&#160;libmlrpc&#160;support&#160;for<br/>L4&#160;IPC&#160;and UNIX domain&#160;sockets.</p>
<p style="position:absolute;top:565px;left:85px;white-space:nowrap" class="ft4215"><b>11.1.2&#160;MLRPC Stub&#160;Code&#160;Generator</b></p>
<p style="position:absolute;top:592px;left:85px;white-space:nowrap" class="ft425">The libmlrpc&#160;API provides&#160;all the necessary&#160;methods&#160;for&#160;an application to&#160;marshal<br/>methods&#160;parameters&#160;and execute&#160;a remote&#160;procedure&#160;call&#160;(RPC)&#160;to a specific&#160;service.<br/>However,&#160;developers&#160;of&#160;services&#160;for&#160;large&#160;and complex&#160;RPC&#160;interfaces&#160;can benefit<br/>from&#160;automatic&#160;generation&#160;of client&#160;and server-side&#160;stubs.&#160;<br/>HP&#160;has developed&#160;a&#160;code&#160;generator&#160;that&#160;uses&#160;the&#160;C++ class&#160;declaration&#160;of&#160;a service<br/>interface&#160;(typically&#160;it's&#160;header file)&#160;to automatically&#160;create&#160;class&#160;implementations&#160;for<br/>the client&#160;and the server. The&#160;code&#160;generator&#160;uses&#160;the&#160;open&#160;source&#160;software&#160;SWIG<br/>(</p>
<p style="position:absolute;top:735px;left:92px;white-space:nowrap" class="ft4233">www.swig.org</p>
<p style="position:absolute;top:735px;left:207px;white-space:nowrap" class="ft422">)&#160;to parse&#160;the C++&#160;header&#160;file&#160;of the&#160;service.&#160;The result&#160;of this&#160;parsing</p>
<p style="position:absolute;top:754px;left:85px;white-space:nowrap" class="ft425">is an XML representation&#160;of&#160;the interface&#160;which&#160;is&#160;then&#160;used&#160;to&#160;produce&#160;the&#160;various<br/>files&#160;using XSLT&#160;mechanism.&#160;For&#160;the&#160;client,&#160;all marshalling&#160;and the&#160;forwarding&#160;of the<br/>message&#160;buffer&#160;with&#160;the request is done&#160;transparently.&#160;Return values&#160;and&#160;output<br/>parameters&#160;are&#160;handled&#160;automatically,&#160;too.&#160;The generated&#160;server&#160;code contains&#160;a<br/>dispatcher&#160;method that,&#160;for&#160;each method of the service interface,&#160;is augmented&#160;with<br/>user-provided&#160;code that&#160;handles&#160;the&#160;incoming&#160;request.<br/>The service&#160;interface&#160;of HIM uses&#160;libmlrpc&#160;and&#160;the stub&#160;code&#160;generator&#160;to&#160;allow&#160;clients<br/>running&#160;as&#160;native&#160;L4&#160;tasks&#160;or as&#160;Linux programs&#160;to&#160;use&#160;HIM.</p>
<p style="position:absolute;top:944px;left:85px;white-space:nowrap" class="ft4215"><b>11.1.3&#160;BMSI</b></p>
<p style="position:absolute;top:970px;left:85px;white-space:nowrap" class="ft425">The theoretical and practical&#160;work on&#160;TPM virtualisation&#160;in WP4&#160;necessitated<br/>enhancements&#160;to the underlying&#160;BMSI, specifically&#160;in the&#160;context of platform&#160;and&#160;TPM<br/>initialisation.&#160;HP&#160;and&#160;TUD&#160;decided&#160;to go&#160;forward&#160;with the&#160;“no-owner” model&#160;described<br/>in&#160;Section&#160;.&#160;With&#160;this&#160;approach,&#160;&#160;the BMSI&#160;is&#160;responsible&#160;of&#160;taking&#160;ownership&#160;of&#160;the TPM<br/>and&#160;restricts&#160;owner-privileged&#160;TPM&#160;operations&#160;to&#160;itself.&#160;Other&#160;applications&#160;and&#160;platform<br/>security&#160;services&#160;can&#160;only access&#160;the usual&#160;BMSI&#160;interfaces.<br/>To&#160;integrate&#160;support&#160;for&#160;the “no-owner”&#160;model&#160;into&#160;the&#160;BMSI,&#160;it was&#160;necessary&#160;to<br/>extend&#160;the&#160;BMSI&#160;to&#160;control&#160;the process&#160;of&#160;initialising&#160;the&#160;platform.&#160;The API&#160;of&#160;the BMSI</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft427">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft427">42/48</p>
</div>
<!-- Page 43 -->
<a name="43"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page43-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42043.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft437">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft437">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft4312">has&#160;been&#160;extended&#160;to&#160;allow&#160;an&#160;external&#160;support&#160;tool&#160;to bootstrap&#160;and&#160;later&#160;reinitialise<br/>the BMSI&#160;service.&#160;This&#160;tool&#160;also&#160;provides&#160;access to persistent&#160;storage,&#160;which&#160;is&#160;needed<br/>for&#160;the sealed&#160;internal&#160;state&#160;of&#160;the BMSI (owner&#160;authdata,&#160;software&#160;keys for&#160;encryption<br/>and signatures).<br/>A&#160;new interface&#160;called&#160;BMSI_TPMImpl&#160;has&#160;been specified&#160;to&#160;bootstrap&#160;BMSI&#160;on&#160;a TPM-<br/>enabled&#160;platform.&#160;It is conceivable&#160;to have&#160;a BMSI&#160;implementation&#160;on top&#160;of another<br/>trusted&#160;computing&#160;technology,&#160;for&#160;example,&#160;a&#160;secure cryptographic&#160;coprocessor.&#160;In<br/>such&#160;a&#160;case,&#160;the&#160;newly&#160;added&#160;interface&#160;might look&#160;different.&#160;However,&#160;without&#160;a&#160;deep<br/>understanding&#160;of potential&#160;alternatives&#160;to&#160;a TPM,&#160;it&#160;is&#160;infeasible&#160;to&#160;develop&#160;a generic<br/>interface.&#160;As OpenTC&#160;is focusing&#160;specifically&#160;on&#160;TPM-based&#160;platforms,&#160;we decided&#160;on&#160;a<br/>TPM-specific&#160;interface.<br/>The new BMSI_TPMImpl&#160;provides&#160;the&#160;following&#160;new&#160;functions:</p>
<p style="position:absolute;top:414px;left:85px;white-space:nowrap" class="ft4331">•</p>
<p style="position:absolute;top:413px;left:90px;white-space:nowrap" class="ft431"><b>BMSI_TPMImpl_init()</b></p>
<p style="position:absolute;top:413px;left:280px;white-space:nowrap" class="ft432">: Instructs&#160;the&#160;BMSI&#160;to&#160;take&#160;ownership&#160;of the&#160;TPM and&#160;create&#160;a</p>
<p style="position:absolute;top:432px;left:85px;white-space:nowrap" class="ft435">new&#160;set of credentials&#160;(AES&#160;software&#160;key for BMSI&#160;sealing&#160;and unsealing,&#160;RSA<br/>signature&#160;key for&#160;for&#160;quote support).&#160;The&#160;output&#160;of this&#160;command&#160;is&#160;an&#160;encrypted&#160;blob<br/>that&#160;contains&#160;the newly created&#160;secrets&#160;as well as&#160;the&#160;secret&#160;owner&#160;authdata&#160;sealed<br/>against&#160;the PCR configuration&#160;of the basic&#160;platform&#160;running&#160;the&#160;BMSI.</p>
<p style="position:absolute;top:524px;left:85px;white-space:nowrap" class="ft4331">•</p>
<p style="position:absolute;top:522px;left:90px;white-space:nowrap" class="ft431"><b>BMSI_TPMImpl_initFromState()</b></p>
<p style="position:absolute;top:522px;left:378px;white-space:nowrap" class="ft432">:&#160;Restores&#160;the internal&#160;state&#160;and&#160;credentials&#160;of the</p>
<p style="position:absolute;top:542px;left:85px;white-space:nowrap" class="ft432">BMSI from&#160;a blob&#160;that has&#160;previously&#160;been&#160;created by&#160;BMSI_TPMImpl_init().</p>
<p style="position:absolute;top:576px;left:85px;white-space:nowrap" class="ft4331">•</p>
<p style="position:absolute;top:574px;left:90px;white-space:nowrap" class="ft431"><b>BMSI_TPMImpl_reset()</b></p>
<p style="position:absolute;top:574px;left:297px;white-space:nowrap" class="ft432">: Resets the&#160;owner of the physical&#160;platform&#160;TPM and</p>
<p style="position:absolute;top:594px;left:85px;white-space:nowrap" class="ft435">invalidates&#160;the credentials&#160;of the BMSI.<br/>The new interface&#160;is&#160;not&#160;accessible&#160;to&#160;regular&#160;BMSI&#160;clients (i.e.,&#160;applications&#160;or&#160;other<br/>platform&#160;services),&#160;but can&#160;be used&#160;only&#160;by&#160;the&#160;bootstrap&#160;tool. We&#160;implemented&#160;</p>
<p style="position:absolute;top:641px;left:755px;white-space:nowrap" class="ft431"><b>bmsi-</b></p>
<p style="position:absolute;top:660px;left:85px;white-space:nowrap" class="ft431"><b>init-l4lx</b></p>
<p style="position:absolute;top:660px;left:156px;white-space:nowrap" class="ft432">,&#160;a&#160;BMSI bootstrap&#160;tool that&#160;makes&#160;use&#160;of&#160;this interface&#160;on&#160;the&#160;L4&#160;version&#160;of</p>
<p style="position:absolute;top:679px;left:85px;white-space:nowrap" class="ft435">the BMSI.&#160;(With&#160;minimal&#160;adaptations,&#160;this tool&#160;can&#160;also&#160;supports&#160;a&#160;Xen implementation<br/>of the BMSI.)&#160;The&#160;bmsi-init-l4lx&#160;tool&#160;automatically&#160;determines&#160;if the BMSI&#160;has&#160;already<br/>been&#160;initialized&#160;based&#160;on&#160;the&#160;presence&#160;or&#160;absence&#160;of the&#160;sealed&#160;blob&#160;in persistent<br/>storage.&#160;This&#160;tool is&#160;executed&#160;during&#160;the boot&#160;process&#160;of the OpenTC&#160;platform.</p>
<p style="position:absolute;top:783px;left:85px;white-space:nowrap" class="ft4315"><b>11.1.4&#160;BMSI&#160;on&#160;L4</b></p>
<p style="position:absolute;top:810px;left:85px;white-space:nowrap" class="ft435">As described&#160;in&#160;section&#160;,&#160;the BMSI&#160;implementation&#160;on&#160;L4 consists&#160;of the&#160;following&#160;main<br/>components:</p>
<p style="position:absolute;top:863px;left:85px;white-space:nowrap" class="ft4331">•</p>
<p style="position:absolute;top:862px;left:90px;white-space:nowrap" class="ft431"><b>Lightweight&#160;TPM multiplexer&#160;“Lyon”</b></p>
<p style="position:absolute;top:862px;left:431px;white-space:nowrap" class="ft432">:&#160;Lyon&#160;is the component&#160;of&#160;the L4-based</p>
<p style="position:absolute;top:881px;left:85px;white-space:nowrap" class="ft432">BMSI&#160;that&#160;implements&#160;the&#160;BMSI_Integrity&#160;interface.</p>
<p style="position:absolute;top:915px;left:85px;white-space:nowrap" class="ft4331">•</p>
<p style="position:absolute;top:913px;left:90px;white-space:nowrap" class="ft431"><b>Loader&#160;service</b></p>
<p style="position:absolute;top:913px;left:226px;white-space:nowrap" class="ft432">:&#160;Is the&#160;L4&#160;back&#160;end of the BMSI&#160;that&#160;provides&#160;the core functionality&#160;of</p>
<p style="position:absolute;top:933px;left:85px;white-space:nowrap" class="ft435">the BMSI_Management&#160;interface.&#160;It&#160;loads&#160;and&#160;measures&#160;executables&#160;and&#160;modules<br/>passed&#160;to&#160;them, including&#160;L4Linux&#160;kernels&#160;and their RAM disks.&#160;The&#160;measurement&#160;is<br/>then&#160;reported&#160;to&#160;Lyon.</p>
<p style="position:absolute;top:1005px;left:85px;white-space:nowrap" class="ft4331">•</p>
<p style="position:absolute;top:1004px;left:90px;white-space:nowrap" class="ft431"><b>libbmsi</b></p>
<p style="position:absolute;top:1004px;left:157px;white-space:nowrap" class="ft432">:&#160;Wrapper&#160;library&#160;that&#160;maps&#160;BMSI APIs&#160;to&#160;the&#160;loader&#160;service&#160;and&#160;Lyon</p>
<p style="position:absolute;top:1032px;left:85px;white-space:nowrap" class="ft435">Lyon&#160;has&#160;been&#160;extended&#160;to&#160;support&#160;the&#160;functionality&#160;specified by the&#160;newly&#160;added<br/>BMSI_TPMImpl&#160;interface&#160;and&#160;now supports&#160;the “no-owner”&#160;model.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft437">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft437">43/48</p>
</div>
<!-- Page 44 -->
<a name="44"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page44-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42044.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft447">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft447">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft4415"><b>11.1.5&#160;BMSI&#160;on&#160;Xen</b></p>
<p style="position:absolute;top:178px;left:85px;white-space:nowrap" class="ft445">Because&#160;the management&#160;model&#160;of Xen&#160;is&#160;slightly&#160;more&#160;complicated,&#160;the<br/>implementation&#160;of the&#160;BMSI&#160;on&#160;Xen&#160;was limited&#160;to&#160;the Security&#160;Interface&#160;and&#160;the<br/>bootstrap&#160;interface.&#160;The&#160;resource&#160;management&#160;and&#160;configuration&#160;for the&#160;guest&#160;VMs<br/>was&#160;left&#160;to&#160;the existing&#160;legacy&#160;applications&#160;such&#160;as&#160;XenD in&#160;order&#160;to retain<br/>compatibility&#160;with existing&#160;standard&#160;software.&#160;In particular,&#160;this&#160;was&#160;critical&#160;to ensure<br/>the work&#160;done&#160;by Work&#160;Package&#160;5&#160;on&#160;libvirt[23]&#160;would&#160;remain&#160;compatible&#160;with&#160;our<br/>implementation.&#160;Most&#160;of&#160;the&#160;code&#160;that&#160;makes&#160;the BMSI&#160;implementation&#160;on&#160;Xen&#160;has<br/>been&#160;a&#160;porting&#160;of&#160;the L4 version&#160;to a&#160;Linux&#160;based&#160;daemon&#160;running&#160;in&#160;the management<br/>Domain&#160;0.</p>
<p style="position:absolute;top:390px;left:85px;white-space:nowrap" class="ft4413">•</p>
<p style="position:absolute;top:388px;left:112px;white-space:nowrap" class="ft441"><b>BMSId</b></p>
<p style="position:absolute;top:388px;left:171px;white-space:nowrap" class="ft442">&#160;: This&#160;Linux daemon&#160;implements&#160;the Integrity&#160;Interface part&#160;of the BMSI&#160;and</p>
<p style="position:absolute;top:407px;left:112px;white-space:nowrap" class="ft445">is based&#160;on&#160;the&#160;source&#160;code&#160;of “Lyon”&#160;described&#160;above.&#160;It&#160;uses LibMLRPC&#160;as its<br/>communication&#160;library&#160;and&#160;uses the&#160;libtpm&#160;to connect&#160;to&#160;the TPM device driver&#160;in<br/>Domain&#160;0 at&#160;boot&#160;time. Once&#160;the BMSId hs unsealed&#160;it&#160;credential&#160;(or created&#160;a new<br/>one)&#160;with the help of&#160;the&#160;bmsi-init-xen tool, it&#160;releases&#160;the&#160;TPM and make&#160;it<br/>available&#160;to&#160;the&#160;rest&#160;of the&#160;platform.&#160;Before&#160;releasing&#160;the&#160;TPM,&#160;it&#160;executes&#160;an<br/>Extend operation&#160;to&#160;invalid&#160;future&#160;unsealing&#160;of&#160;its credential by software&#160;started<br/>later during&#160;the&#160;boot.</p>
<p style="position:absolute;top:553px;left:85px;white-space:nowrap" class="ft4413">•</p>
<p style="position:absolute;top:550px;left:112px;white-space:nowrap" class="ft441"><b>bmsi-init-xen&#160;</b></p>
<p style="position:absolute;top:550px;left:241px;white-space:nowrap" class="ft442">:&#160;This linux&#160;application&#160;is a&#160;port&#160;of&#160;the&#160;</p>
<p style="position:absolute;top:550px;left:558px;white-space:nowrap" class="ft441"><b>bmsi-init-l4lx</b></p>
<p style="position:absolute;top:550px;left:681px;white-space:nowrap" class="ft442">&#160;tool&#160;described</p>
<p style="position:absolute;top:569px;left:112px;white-space:nowrap" class="ft445">above&#160;to&#160;Xen using&#160;the libmlrpc&#160;to communicate&#160;with&#160;BMSId&#160;during&#160;the&#160;boot&#160;of<br/>Domain&#160;0.&#160;It&#160;performs&#160;the same&#160;sequence&#160;of&#160;operation&#160;as&#160;the one described&#160;for</p>
<p style="position:absolute;top:608px;left:112px;white-space:nowrap" class="ft441"><b>bmsi-init-l4lx</b></p>
<p style="position:absolute;top:608px;left:235px;white-space:nowrap" class="ft442">.</p>
<p style="position:absolute;top:682px;left:85px;white-space:nowrap" class="ft4415"><b>11.1.6&#160;HIMd (Hierarchical&#160;Integrity Management daemon)</b></p>
<p style="position:absolute;top:727px;left:85px;white-space:nowrap" class="ft4415"><b>11.1.6.1&#160;Description</b></p>
<p style="position:absolute;top:753px;left:85px;white-space:nowrap" class="ft445">HIMd&#160;(Hierarchical&#160;Integrity&#160;Management&#160;daemon)&#160;is a service&#160;which&#160;records the<br/>integrity&#160;of&#160;the&#160;components&#160;of a system&#160;as&#160;well as the&#160;dependencies between them as<br/>described&#160;in&#160;[20]. HIMd&#160;is used&#160;to&#160;hold the integrity&#160;of&#160;the&#160;vTPMs and their<br/>configuration&#160;relatively&#160;to&#160;the&#160;VM&#160;they&#160;are&#160;bound&#160;to&#160;as&#160;explained in&#160;section vTPMs&#160;and<br/>Trusted&#160;Virtual&#160;Platforms.&#160;A&#160;first&#160;prototype&#160;of HIMd&#160;was&#160;developed&#160;by&#160;HP&#160;in Work<br/>Package&#160;5.&#160;This&#160;prototype&#160;was in&#160;the form&#160;of a Linux&#160;daemon&#160;serving&#160;request&#160;over tcp/<br/>ip&#160;based&#160;protocol.&#160;While&#160;the&#160;network&#160;based&#160;implementation&#160;could not&#160;provide&#160;a<br/>trusted&#160;path&#160;between a&#160;components&#160;and&#160;HIMd,&#160;the&#160;client&#160;tools included&#160;with&#160;the<br/>prototype&#160;was capable&#160;of&#160;simulating&#160;path&#160;information&#160;which&#160;confirmed&#160;the logic&#160;of<br/>HIMd.</p>
<p style="position:absolute;top:963px;left:85px;white-space:nowrap" class="ft4415"><b>11.1.6.2&#160;L4&#160;Port</b></p>
<p style="position:absolute;top:990px;left:85px;white-space:nowrap" class="ft445">The first&#160;modification&#160;we did&#160;to&#160;HIMd&#160;(done&#160;by&#160;TUD) was&#160;to&#160;make&#160;it compatible&#160;with<br/>the L4&#160;environment&#160;(L4Env)&#160;and&#160;its&#160;build&#160;system.&#160;It has&#160;also&#160;been made&#160;compatible&#160;to<br/>run&#160;as&#160;an&#160;L4&#160;Task&#160;instead&#160;as&#160;a&#160;Linux&#160;process.</p>
<p style="position:absolute;top:1074px;left:85px;white-space:nowrap" class="ft4415"><b>11.1.6.3&#160;MLRPC Integration</b></p>
<p style="position:absolute;top:1101px;left:85px;white-space:nowrap" class="ft445">We then&#160;replaced&#160;the network&#160;based&#160;Inter-Process&#160;Communication&#160;(IPC)&#160;with&#160;the<br/>MLRPC&#160;Library,&#160;using&#160;the&#160;MLRPC&#160;stub&#160;code&#160;generator&#160;(11.1.2)&#160;and&#160;integrate&#160;the</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft447">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft447">44/48</p>
</div>
<!-- Page 45 -->
<a name="45"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page45-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42045.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft457">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft457">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft455">trusted&#160;path information&#160;with the HIM model.&#160;The&#160;main&#160;server&#160;loop&#160;of the&#160;MLRPC<br/>library&#160;is&#160;customized&#160;(during&#160;the automatic&#160;code&#160;generation)&#160;to&#160;extract&#160;the&#160;path<br/>information&#160;of&#160;the caller&#160;and&#160;establish&#160;a&#160;context that&#160;is then&#160;being&#160;used&#160;by HIMd's<br/>logic&#160;to determine&#160;the parent&#160;and&#160;child&#160;relationship&#160;between&#160;the components.</p>
<p style="position:absolute;top:255px;left:85px;white-space:nowrap" class="ft4515"><b>11.1.6.4&#160;BMSI&#160;Integration</b></p>
<p style="position:absolute;top:281px;left:85px;white-space:nowrap" class="ft455">Finally,&#160;we&#160;completed the implementation&#160;of&#160;HIMd&#160;to&#160;integrate&#160;with&#160;the&#160;BMSI. The<br/>implementation&#160;of the&#160;seal&#160;and&#160;unseal&#160;functions&#160;were added&#160;to use&#160;the&#160;corresponding<br/>BMSI&#160;commands,&#160;while using&#160;the&#160;HIM model&#160;for access&#160;control&#160;based&#160;on&#160;the&#160;integrity<br/>of the calling&#160;component.&#160;To&#160;do&#160;so,&#160;a composite&#160;hash of the&#160;component&#160;and&#160;all its<br/>ancestors&#160;is created&#160;by HIMd&#160;and&#160;used&#160;as&#160;the&#160;nonce for&#160;the BMSI&#160;Seal.&#160;Similarly,&#160;HIMd<br/>uses&#160;the&#160;same&#160;mechanisms&#160;of compositing&#160;hashes when&#160;reporting the&#160;integrity&#160;of&#160;a<br/>component&#160;in&#160;the&#160;HIM tree, by using&#160;the BMSI&#160;Quote&#160;command.&#160;This&#160;ensures&#160;a<br/>continuous&#160;link&#160;to&#160;the&#160;BMSI which is&#160;de facto&#160;the Trusted&#160;Computing&#160;Base&#160;of&#160;the&#160;whole<br/>system.</p>
<p style="position:absolute;top:481px;left:85px;white-space:nowrap" class="ft4515"><b>11.1.6.5&#160;LibXC&#160;integration&#160;for&#160;Xen</b></p>
<p style="position:absolute;top:508px;left:85px;white-space:nowrap" class="ft455">CUCL&#160;produced&#160;a&#160;patch&#160;to&#160;the Xen-C&#160;library&#160;(LibXC) which&#160;is responsible&#160;for&#160;the low<br/>level management&#160;of the&#160;hypervisor&#160;(such&#160;as&#160;allocating virtual&#160;machines,&#160;managing<br/>virtual&#160;devices,&#160;etc...).&#160;The&#160;patch&#160;added&#160;the possibility&#160;to&#160;compute&#160;of&#160;a&#160;Hash&#160;(using&#160;the<br/>SHA1&#160;algorithm)&#160;of the kernel&#160;and&#160;initial&#160;ramdisk&#160;of paravirtualized&#160;guest&#160;operating<br/>systems.&#160;HP&#160;then&#160;modified&#160;this patch&#160;to&#160;report&#160;this integrity measurement&#160;to&#160;HIMd<br/>using the&#160;LibMLRPC.</p>
<p style="position:absolute;top:650px;left:85px;white-space:nowrap" class="ft4515"><b>11.1.7&#160;Software&#160;TPM with HIM binding</b></p>
<p style="position:absolute;top:705px;left:85px;white-space:nowrap" class="ft451"><b>L4:</b></p>
<p style="position:absolute;top:736px;left:85px;white-space:nowrap" class="ft4513">•</p>
<p style="position:absolute;top:733px;left:112px;white-space:nowrap" class="ft455">The integrity&#160;reporting&#160;of the&#160;VM and&#160;of the&#160;software&#160;TPM and&#160;sealing&#160;and<br/>unsealing&#160;of&#160;the&#160;software&#160;TPM&#160;state&#160;has&#160;been&#160;changed as&#160;following.</p>
<p style="position:absolute;top:783px;left:85px;white-space:nowrap" class="ft4513">•</p>
<p style="position:absolute;top:780px;left:112px;white-space:nowrap" class="ft455">The L4&#160;Loader&#160;was&#160;extended&#160;to&#160;report&#160;integrity&#160;measurements&#160;to&#160;BMSI/Lyon&#160;resp.<br/>HIM. The integrity&#160;reporting&#160;are configurable&#160;by&#160;loader&#160;script.&#160;In&#160;our&#160;scenario,&#160;the<br/>L4&#160;Loader&#160;registers&#160;HIM to&#160;the&#160;BMSI&#160;(using&#160;Lyon) during&#160;boot&#160;time&#160;and&#160;VMs&#160;and&#160;its<br/>associated&#160;software&#160;TPMs&#160;are registered&#160;and&#160;measured&#160;to HIM.</p>
<p style="position:absolute;top:869px;left:85px;white-space:nowrap" class="ft4513">•</p>
<p style="position:absolute;top:866px;left:112px;white-space:nowrap" class="ft455">The software&#160;TPM&#160;stores&#160;and&#160;restores&#160;its&#160;internal&#160;state&#160;(e.g.&#160;EK, SRK) when&#160;it's<br/>shutting&#160;down&#160;respective&#160;booting&#160;up.&#160;The storage&#160;bindings&#160;of&#160;the&#160;software&#160;TPM&#160;to<br/>make&#160;the internal&#160;state&#160;persistence&#160;has&#160;been adapted&#160;to use&#160;the HIM_store&#160;and<br/>HIM_retrieve&#160;function&#160;provided&#160;by HIM.&#160;</p>
<p style="position:absolute;top:955px;left:85px;white-space:nowrap" class="ft4513">•</p>
<p style="position:absolute;top:952px;left:112px;white-space:nowrap" class="ft455">The software&#160;TPM&#160;shuts&#160;down&#160;when&#160;the associated&#160;VM&#160;stops&#160;and&#160;the&#160;appropriate<br/>event is received.&#160;The software&#160;TPM invokes&#160;the storage&#160;bindings,&#160;which&#160;hands&#160;the<br/>data&#160;for&#160;encryption&#160;over&#160;to&#160;the HIM.&#160;HIM&#160;adds&#160;the measurement&#160;of&#160;the&#160;registered<br/>HIM&#160;component&#160;to&#160;the&#160;software&#160;TPM&#160;data&#160;and&#160;forwards&#160;it&#160;to&#160;BMSI.&#160;BMSI uses Lyon<br/>to seal the&#160;data and&#160;return the encrypted&#160;data&#160;back&#160;via HIM&#160;to the software&#160;TPM.<br/>The software&#160;TPM&#160;stores&#160;the&#160;encrypted&#160;data&#160;by&#160;sending&#160;it to&#160;a file&#160;service&#160;provider.</p>
<p style="position:absolute;top:1079px;left:85px;white-space:nowrap" class="ft4513">•</p>
<p style="position:absolute;top:1076px;left:112px;white-space:nowrap" class="ft455">When&#160;the VM&#160;and&#160;the associated&#160;software&#160;TPM is&#160;restarted,&#160;the&#160;software&#160;TPM<br/>requests&#160;a file&#160;service&#160;provider&#160;for&#160;the encrypted data.&#160;This&#160;data&#160;is&#160;handed&#160;over to<br/>HIM&#160;by&#160;invoking&#160;HIM_retrieve,&#160;and&#160;HIM&#160;provides&#160;it&#160;to BMSI.&#160;BMSI&#160;uses Lyon&#160;to</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft457">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft457">45/48</p>
</div>
<!-- Page 46 -->
<a name="46"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page46-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42046.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft467">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft467">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:151px;left:112px;white-space:nowrap" class="ft465">unseal&#160;the decrypted&#160;data&#160;and,&#160;if&#160;successful,&#160;forwards&#160;the decrypted&#160;data&#160;to&#160;HIM.<br/>HIM&#160;checks whether&#160;the&#160;current measurement&#160;of&#160;the&#160;started&#160;software&#160;TPM&#160;is&#160;the<br/>same&#160;as the&#160;measurement&#160;incorporated&#160;during&#160;encryption&#160;of the&#160;data. If&#160;so, the<br/>decrypted&#160;data&#160;are&#160;provided&#160;to the software&#160;TPM,&#160;which&#160;then&#160;can&#160;continue&#160;starting<br/>with&#160;the&#160;restored internal&#160;data&#160;(e.g.&#160;EK,&#160;SRK).</p>
<p style="position:absolute;top:302px;left:85px;white-space:nowrap" class="ft461"><b>11.2&#160;Packaging&#160;and&#160;software&#160;distribution</b></p>
<p style="position:absolute;top:330px;left:85px;white-space:nowrap" class="ft465">All&#160;the software&#160;described&#160;in&#160;this&#160;section&#160;has&#160;been&#160;packaged&#160;and&#160;is hosted&#160;on&#160;the<br/>development&#160;subversion&#160;repository&#160;at&#160;suse<br/>(</p>
<p style="position:absolute;top:369px;left:92px;white-space:nowrap" class="ft4633">https://opentc.suse.de/svn/devel/packages/opentc/</p>
<p style="position:absolute;top:369px;left:513px;white-space:nowrap" class="ft462">).&#160;A copy&#160;of&#160;this&#160;repository&#160;will&#160;be</p>
<p style="position:absolute;top:388px;left:85px;white-space:nowrap" class="ft465">provided&#160;to&#160;the&#160;European&#160;Commission&#160;as&#160;part&#160;of the overall&#160;software&#160;deliverable&#160;the<br/>OpenTC&#160;project has been producing.&#160;Furthermore,&#160;all&#160;the components&#160;have been<br/>approved&#160;by the&#160;contributing&#160;parties to&#160;be released&#160;under&#160;open&#160;source licenses.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft467">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft467">46/48</p>
</div>
<!-- Page 47 -->
<a name="47"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page47-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42047.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft477">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft477">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:172px;left:85px;white-space:nowrap" class="ft479"><b>12&#160;</b></p>
<p style="position:absolute;top:169px;left:127px;white-space:nowrap" class="ft4710"><b>References</b></p>
<p style="position:absolute;top:255px;left:85px;white-space:nowrap" class="ft475">[1] Berger, Stefan&#160;and&#160;Caceres,&#160;Ramon&#160;and Goldman, Kenneth A.&#160;and Perez,&#160;Ronald<br/>and&#160;Sailer,&#160;Reiner&#160;and&#160;van&#160;Doorn,&#160;Leendert,&#160;&#34;vTPM:&#160;virtualizing&#160;the&#160;trusted&#160;platform<br/>module&#34;,&#160;in&#160;USENIX-SS'06:&#160;Proceedings&#160;of the 15th&#160;conference&#160;on&#160;USENIX Security<br/>Symposium,&#160;August&#160;2006<br/>[2]&#160;Trusted&#160;Computing&#160;Group:&#160;TPM&#160;Main&#160;Specification&#160;( November&#160;2003)<br/>https://www.trustedcomputinggroup.org<br/>[3]&#160;Scarlata,&#160;Vincent&#160;and&#160;Rozas,&#160;Carlos&#160;and&#160;Wiseman,&#160;Monty and&#160;Grawrock,&#160;David&#160;and<br/>Vishik,&#160;Claire:&#160;&#34; TPM Virtualization:&#160;Building a General&#160;Framework&#34;&#160;, Trusted<br/>Computing,&#160;2007<br/>[4]&#160;A. Fischer&#160;and&#160;C.&#160;I. Dalton&#160;and&#160;B.&#160;Balacheff,&#160;&#34;A&#160;security&#160;management&#160;framework&#160;for<br/>trusted virtual&#160;infrastructures&#34;,&#160;in&#160;HP TechCon&#160;2007,&#160;April&#160;2007<br/>[5]&#160;Anderson,&#160;Melvin&#160;J. and Moffie, Micha and Dalton,&#160;Chris&#160;I.: &#34; Towards&#160;Trustworthy<br/>Virtualisation&#160;Environments:&#160;Xen&#160;Library&#160;OS&#160;Security&#160;Service&#160;Infrastructure&#34;&#160;, Hewlett-<br/>Packard&#160;Laboratories,&#160;April2007<br/>[6]&#160;D.&#160;Plaquin&#160;and&#160;M. Nicholes,&#160;&#34;Providing&#160;trust&#160;for&#160;management&#160;of utility&#160;computing<br/>services&#34;,&#160;in&#160;HP&#160;TechCon&#160;2005,&#160;April&#160;2005<br/>[7]&#160;University&#160;of&#160;Cambridge:&#160;&#34;Xen&#160;v3.0&#160;- Interface&#160;Manual&#34;&#160;(&#160;2007)<br/>[8]&#160;University&#160;of Cambrdige:&#160;&#34;Xen v3.0&#160;- User's&#160;Manual&#34;&#160;( 2007)<br/>[9]&#160;Barham,&#160;Paul&#160;and&#160;Dragovic,&#160;Boris&#160;and&#160;Fraser,&#160;Keir&#160;and&#160;Hand, Steven&#160;and Harris,<br/>Tim&#160;and&#160;Ho,&#160;Alex&#160;and Neugebauer,&#160;Rolf&#160;and&#160;Pratt, Ian and Warfield,&#160;Andrew,&#160;&#34;Xen&#160;and<br/>the art&#160;of&#160;virtualization&#34;,&#160;in&#160;SOSP&#160;'03:&#160;Proceedings&#160;of&#160;the nineteenth&#160;ACM&#160;symposium<br/>on&#160;Operating&#160;systems&#160;principles,&#160;2003<br/>[10]&#160;Trusted&#160;Computing&#160;Group:&#160;TCG PC&#160;Client&#160;Specific&#160;TPM&#160;Interface&#160;Specification (TIS)<br/>( July&#160;2005)<br/>https://www.trustedcomputinggroup.org/groups/pc_client/TCG_PCClientTPMSpecificatio<br/>n_1-20_1-00_FINAL.pdf<br/>[11]&#160;: &#34;TrouSerS&#160;: The&#160;open-source&#160;TCG Software&#160;Stack&#160;&#34;&#160;(sourceforge)<br/>http://trousers.sourceforge.net/&#160;<br/>[12]&#160;Infineon: &#34;Infineon&#160;TSS&#160;for Linux&#160;&#34; (OpenTC&#160;interal&#160;repository)<br/>https://svn.opentc.net/Workpackage<br/>%2003/IFX_TSS_Stack/TSS_final_version_20071130/&#160;<br/>[13] OpenTC: Basic&#160;Management&#160;and&#160;Security&#160;Interface&#160;(&#160;June 2006)<br/>https://svn.opentc.net/Workpackage%2004/Deliverables/BMSI/BMSI_v01.pdf<br/>[14]&#160;Trusted&#160;Computing&#160;Group:&#160;TCG TPM&#160;Specification&#160;: TPM&#160;Main&#160;Part&#160;3:&#160;Commands<br/>(2007)<br/>https://www.trustedcomputinggroup.org/specs/TPM/mainP3Commandsrev103.zip<br/>[15]&#160;Sadeghi,&#160;Ahmad-Reza&#160;and&#160;Stuble,&#160;Christian&#160;and&#160;Winandy,&#160;Marcel, &#34;Property-<br/>Based&#160;TPM Virtualization&#34;,&#160;in ISC&#160;'08:&#160;Proceedings&#160;of&#160;the 11th&#160;international&#160;conference<br/>on&#160;Information&#160;Security,&#160;2008<br/>[16]&#160;Kuhn,&#160;Ulrich&#160;and&#160;Selhorst,&#160;Marcel&#160;and&#160;Stuble,&#160;Christian,&#160;&#34;Realizing&#160;property-based<br/>attestation&#160;and&#160;sealing&#160;with&#160;commonly&#160;available&#160;hard-&#160;and&#160;software&#34;,&#160;in STC&#160;'07:<br/>Proceedings of the 2007&#160;ACM workshop&#160;on Scalable&#160;trusted computing,&#160;2007<br/>[17]&#160;Chen, Liqun&#160;and&#160;Landfermann,&#160;Rainer&#160;and Lohr,&#160;Hans&#160;and Rohe,&#160;Markus&#160;and<br/>Sadeghi,&#160;Ahmad-Reza&#160;and&#160;Stuble, Christian,&#160;&#34;A&#160;protocol&#160;for&#160;property-based<br/>attestation&#34;,&#160;in STC&#160;'06:&#160;Proceedings&#160;of&#160;the&#160;first&#160;ACM&#160;workshop&#160;on&#160;Scalable&#160;trusted<br/>computing,&#160;2006</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft477">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft477">47/48</p>
</div>
<!-- Page 48 -->
<a name="48"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page48-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.7_TPM_Virtualisation_Architecture_document_v2_M42048.png" alt="background image"/>
<p style="position:absolute;top:92px;left:356px;white-space:nowrap" class="ft487">VTPM Architecture</p>
<p style="position:absolute;top:92px;left:618px;white-space:nowrap" class="ft487">FINAL&#160;|&#160;1.0 _Update</p>
<p style="position:absolute;top:170px;left:85px;white-space:nowrap" class="ft485">[18]&#160;J.&#160;Poritz&#160;and&#160;M.&#160;Schunter&#160;and&#160;E. Van&#160;Herreweghen&#160;and&#160;M.&#160;Waidner:&#160;&#34;&#160;Property<br/>attestation—&#160;scalable&#160;and&#160;privacy-friendly&#160;security&#160;assessment&#160;of&#160;peer&#160;computers&#34;&#160;,&#160;<br/>IBM&#160;Research,&#160;May2004<br/>[19]&#160;Sadeghi,&#160;Ahmad-Reza&#160;and&#160;Stuble,&#160;Christian,&#160;&#34;Property-based&#160;attestation&#160;for<br/>computing&#160;platforms:&#160;caring about properties,&#160;not&#160;mechanisms&#34;,&#160;in&#160;NSPW&#160;'04:<br/>Proceedings&#160;of the 2004&#160;workshop&#160;on&#160;New&#160;security&#160;paradigms,&#160;2004<br/>[20]&#160;S.&#160;Cabuk&#160;and&#160;D.&#160;Plaquin&#160;and&#160;T.&#160;Hong&#160;and&#160;D.&#160;Murray:&#160;&#34;&#160;Improving&#160;Policy<br/>Verification&#160;Capabilities of Trusted&#160;Platforms&#34;&#160;, Hewlett-Packard&#160;Laboratories,<br/>June2008<br/>[21]&#160;Vivek&#160;Haldar&#160;and&#160;Deepak&#160;Chandra&#160;and&#160;Michael&#160;Franz,&#160;&#34;Semantic&#160;Remote<br/>Attestation&#160;- A&#160;Virtual&#160;Machine&#160;directed&#160;approach&#160;to&#160;Trusted&#160;Computing&#34;,&#160;in&#160;USENIX<br/>Virtual&#160;Machine&#160;Research&#160;and&#160;Technology&#160;Symposium,&#160;2004<br/>[22]&#160;Jiang,&#160;S.&#160;and&#160;Smith,&#160;S.&#160;and&#160;Minami,&#160;K., &#34;Securing&#160;Web servers&#160;against&#160;insider<br/>attack&#34;,&#160;in Computer&#160;Security Applications&#160;Conference,&#160;2001.&#160;ACSAC&#160;2001.<br/>Proceedings 17th&#160;Annual,&#160;Dec.&#160;2001<br/>[23]&#160;Redhat&#160;Emerging&#160;Technology&#160;Project:&#160;&#34;Libvirt&#160;: The virtualization&#160;API&#160;&#34;&#160;(open<br/>source)&#160;http://libvirt.org/&#160;</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft487">Open_TC&#160;Deliverable D04.7&#160;</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft487">48/48</p>
</div>
</body>
</html>
