<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>otcD04.8-vGalium</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="generator" content="pdftohtml 0.36"/>
<meta name="author" content="schnitzer"/>
<meta name="date" content="2009-05-29T14:13:24+00:00"/>
<style type="text/css">
<!--
.xflip {
    -moz-transform: scaleX(-1);
    -webkit-transform: scaleX(-1);
    -o-transform: scaleX(-1);
    transform: scaleX(-1);
    filter: fliph;
}
.yflip {
    -moz-transform: scaleY(-1);
    -webkit-transform: scaleY(-1);
    -o-transform: scaleY(-1);
    transform: scaleY(-1);
    filter: flipv;
}
.xyflip {
    -moz-transform: scaleX(-1) scaleY(-1);
    -webkit-transform: scaleX(-1) scaleY(-1);
    -o-transform: scaleX(-1) scaleY(-1);
    transform: scaleX(-1) scaleY(-1);
    filter: fliph + flipv;
}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<!-- Page 1 -->
<a name="1"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft10{font-size:27px;font-family:IIHPKK+BitstreamVeraSans;color:#000000;}
	.ft11{font-size:16px;font-family:IIHPKK+BitstreamVeraSans;color:#000000;}
	.ft12{font-size:16px;font-family:IIHPKM+BitstreamVeraSans;color:#000000;}
	.ft13{font-size:10px;font-family:IIHPKM+BitstreamVeraSans;color:#000000;}
	.ft14{font-size:16px;line-height:19px;font-family:IIHPKM+BitstreamVeraSans;color:#000000;}
	.ft15{font-size:16px;line-height:19px;font-family:IIHPKK+BitstreamVeraSans;color:#000000;}
-->
</style>
<div id="page1-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content001.png" alt="background image"/>
<p style="position:absolute;top:242px;left:227px;white-space:nowrap" class="ft10"><b>Voluntary Deliverable D04.8&#160;</b></p>
<p style="position:absolute;top:273px;left:89px;white-space:nowrap" class="ft10"><b>Secure Multiplexing of&#160;Accelerated 3D Content</b></p>
<p style="position:absolute;top:351px;left:91px;white-space:nowrap" class="ft11"><b>Project&#160;number</b></p>
<p style="position:absolute;top:351px;left:425px;white-space:nowrap" class="ft12">IST-027635</p>
<p style="position:absolute;top:376px;left:91px;white-space:nowrap" class="ft11"><b>Project&#160;acronym</b></p>
<p style="position:absolute;top:376px;left:425px;white-space:nowrap" class="ft12">Open_TC</p>
<p style="position:absolute;top:402px;left:91px;white-space:nowrap" class="ft11"><b>Project&#160;title</b></p>
<p style="position:absolute;top:402px;left:425px;white-space:nowrap" class="ft12">Open Trusted Computing</p>
<p style="position:absolute;top:427px;left:91px;white-space:nowrap" class="ft11"><b>Deliverable&#160;type</b></p>
<p style="position:absolute;top:427px;left:425px;white-space:nowrap" class="ft12">Report,&#160;Prototype</p>
<p style="position:absolute;top:470px;left:91px;white-space:nowrap" class="ft11"><b>Deliverable&#160;reference&#160;number</b></p>
<p style="position:absolute;top:470px;left:425px;white-space:nowrap" class="ft12">IST-027635/D04.8/FINAL|1.0</p>
<p style="position:absolute;top:502px;left:91px;white-space:nowrap" class="ft11"><b>Deliverable&#160;title</b></p>
<p style="position:absolute;top:493px;left:425px;white-space:nowrap" class="ft14">Secure&#160;Multiplexing&#160;of&#160;Accelerated&#160;3D<br/>Content</p>
<p style="position:absolute;top:534px;left:91px;white-space:nowrap" class="ft11"><b>WP&#160;contributing&#160;to&#160;the&#160;deliverable</b></p>
<p style="position:absolute;top:534px;left:425px;white-space:nowrap" class="ft12">WP04</p>
<p style="position:absolute;top:560px;left:91px;white-space:nowrap" class="ft11"><b>Due&#160;date</b></p>
<p style="position:absolute;top:560px;left:425px;white-space:nowrap" class="ft12">April&#160;2009&#160;(M42)</p>
<p style="position:absolute;top:585px;left:91px;white-space:nowrap" class="ft11"><b>Actual&#160;submission&#160;date</b></p>
<p style="position:absolute;top:585px;left:425px;white-space:nowrap" class="ft12">29&#160;May&#160;2009</p>
<p style="position:absolute;top:628px;left:91px;white-space:nowrap" class="ft11"><b>Responsible&#160;Organisation</b></p>
<p style="position:absolute;top:628px;left:424px;white-space:nowrap" class="ft12">CUCL</p>
<p style="position:absolute;top:654px;left:91px;white-space:nowrap" class="ft11"><b>Authors</b></p>
<p style="position:absolute;top:654px;left:424px;white-space:nowrap" class="ft12">CUCL&#160;(Chris&#160;Smowton)</p>
<p style="position:absolute;top:676px;left:91px;white-space:nowrap" class="ft11"><b>Abstract</b></p>
<p style="position:absolute;top:676px;left:424px;white-space:nowrap" class="ft14">In&#160;this&#160;report&#160;a new approach&#160;to API&#160;remoting<br/>for&#160;GPU virtualisation&#160;is described&#160;which&#160;aims<br/>to&#160;reduce&#160;the&#160;amount&#160;of&#160;trusted&#160;code<br/>involved&#160;in&#160;3D&#160;rendering&#160;for&#160;guest&#160;VMs.&#160;To<br/>achieve&#160;this it&#160;uses a modular&#160;driver<br/>framework&#160;to export&#160;large&#160;proportions&#160;of<br/>complex&#160;3D&#160;graphics&#160;drivers&#160;into the guest's<br/>domain.&#160;It further&#160;provides&#160;a secure<br/>graphical user&#160;interface&#160;to untrusted<br/>domains.&#160;The&#160;implementation&#160;of Xen3D&#160;is<br/>described,&#160;which&#160;remotes the Gallium<br/>graphics&#160;driver&#160;model,&#160;a&#160;system&#160;designed&#160;for<br/>the creation&#160;of&#160;highly modular&#160;graphics<br/>drivers,&#160;and&#160;serves&#160;as&#160;a&#160;proof&#160;of concept.</p>
<p style="position:absolute;top:948px;left:91px;white-space:nowrap" class="ft11"><b>Keywords</b></p>
<p style="position:absolute;top:948px;left:424px;white-space:nowrap" class="ft12">WP4,&#160;Xen,&#160;3D,&#160;graphics</p>
<p style="position:absolute;top:991px;left:92px;white-space:nowrap" class="ft11"><b>Dissemination&#160;level</b></p>
<p style="position:absolute;top:991px;left:423px;white-space:nowrap" class="ft12">Public</p>
<p style="position:absolute;top:1017px;left:92px;white-space:nowrap" class="ft11"><b>Revision</b></p>
<p style="position:absolute;top:1017px;left:423px;white-space:nowrap" class="ft12">FINAL|1.0</p>
<p style="position:absolute;top:1068px;left:90px;white-space:nowrap" class="ft11"><b>Instrument</b></p>
<p style="position:absolute;top:1068px;left:271px;white-space:nowrap" class="ft12">IP</p>
<p style="position:absolute;top:1058px;left:452px;white-space:nowrap" class="ft15"><b>Start&#160;date&#160;of the<br/>project</b></p>
<p style="position:absolute;top:1068px;left:632px;white-space:nowrap" class="ft12">1</p>
<p style="position:absolute;top:1066px;left:643px;white-space:nowrap" class="ft13">st</p>
<p style="position:absolute;top:1068px;left:652px;white-space:nowrap" class="ft12">&#160;November&#160;2005</p>
<p style="position:absolute;top:1097px;left:90px;white-space:nowrap" class="ft11"><b>Thematic&#160;Priority</b></p>
<p style="position:absolute;top:1097px;left:271px;white-space:nowrap" class="ft12">IST</p>
<p style="position:absolute;top:1097px;left:452px;white-space:nowrap" class="ft11"><b>Duration</b></p>
<p style="position:absolute;top:1097px;left:632px;white-space:nowrap" class="ft12">42 months</p>
</div>
<!-- Page 2 -->
<a name="2"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft26{font-size:15px;font-family:IIHPKM+BitstreamVeraSans;color:#000000;}
	.ft27{font-size:24px;font-family:IIHPKK+BitstreamVeraSans;color:#000000;}
-->
</style>
<div id="page2-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content002.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft26">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft26">FINAL|1.0</p>
<p style="position:absolute;top:169px;left:85px;white-space:nowrap" class="ft27"><b>Table of&#160;Contents</b></p>
<p style="position:absolute;top:206px;left:85px;white-space:nowrap" class="ft24">1&#160;&#160;Foreword....................................................................................................................3<br/>2&#160;&#160;Introduction&#160;..............................................................................................................3</p>
<p style="position:absolute;top:244px;left:94px;white-space:nowrap" class="ft22">2.1&#160;Summary&#160;of&#160;work done..........................................................................................4</p>
<p style="position:absolute;top:264px;left:85px;white-space:nowrap" class="ft22">3&#160;&#160;Aims&#160;of&#160;secure&#160;graphics&#160;virtualisation.......................................................................5</p>
<p style="position:absolute;top:283px;left:94px;white-space:nowrap" class="ft24">3.1&#160;Security&#160;and&#160;Isolation.............................................................................................5<br/>3.2&#160;Secure Interaction..................................................................................................6<br/>3.3&#160;Generality...............................................................................................................6<br/>3.4&#160;Performance...........................................................................................................7</p>
<p style="position:absolute;top:360px;left:85px;white-space:nowrap" class="ft22">4&#160;&#160;Xen3D:&#160;A 3D Graphical&#160;Remoting&#160;and&#160;Composition System......................................7</p>
<p style="position:absolute;top:379px;left:94px;white-space:nowrap" class="ft24">4.1&#160;Introduction&#160;to&#160;Gallium...........................................................................................8<br/>4.2&#160;Xen3D&#160;Architectural&#160;Overview...............................................................................9<br/>4.3&#160;Marshalling&#160;Pipe&#160;Commands................................................................................10<br/>4.4&#160;Detailed&#160;Implementation......................................................................................10</p>
<p style="position:absolute;top:456px;left:85px;white-space:nowrap" class="ft22">5&#160;&#160;Discussion&#160;and&#160;Lessons&#160;Learned..............................................................................12</p>
<p style="position:absolute;top:475px;left:94px;white-space:nowrap" class="ft24">5.1&#160;Security&#160;and Trusted Code...................................................................................12<br/>5.2&#160;Generality and&#160;Portability.....................................................................................14<br/>5.3&#160;Suitability of Gallium&#160;for&#160;Remoting.......................................................................15<br/>5.4&#160;Future&#160;Directions..................................................................................................16<br/>5.5&#160;Improving&#160;Gallium................................................................................................16</p>
<p style="position:absolute;top:571px;left:85px;white-space:nowrap" class="ft22">6&#160;&#160;Conclusion...............................................................................................................17</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft26">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft26">2/17</p>
</div>
<!-- Page 3 -->
<a name="3"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft38{font-size:15px;font-family:IIIAOG+BitstreamVeraSerif;color:#000000;}
	.ft39{font-size:18px;font-family:IIHPKK+BitstreamVeraSans;color:#000000;}
-->
</style>
<div id="page3-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content003.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft36">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft36">FINAL|1.0</p>
<p style="position:absolute;top:172px;left:85px;white-space:nowrap" class="ft38"><b>1&#160;</b></p>
<p style="position:absolute;top:169px;left:117px;white-space:nowrap" class="ft39"><b>Foreword</b></p>
<p style="position:absolute;top:199px;left:85px;white-space:nowrap" class="ft34">This&#160;deliverable&#160;was&#160;not&#160;originally&#160;planned&#160;in&#160;the contract&#160;but&#160;was introduced&#160;by&#160;work<br/>package&#160;4 to&#160;capture&#160;some&#160;of the technical&#160;work&#160;that&#160;has&#160;been&#160;performed&#160;during&#160;the<br/>last 18&#160;months&#160;of the project.&#160;The&#160;work&#160;on&#160;high&#160;performance&#160;and secure&#160;graphic<br/>virtualisation&#160;was indeed introduced&#160;during&#160;the&#160;last&#160;period&#160;as&#160;a&#160;challenging&#160;research<br/>area,&#160;critical&#160;to&#160;demonstrate&#160;the&#160;usability&#160;and user&#160;experience of&#160;a trusted&#160;virtualised<br/>platform.&#160;While addressing&#160;the technical challenges&#160;of&#160;such&#160;a research project,&#160;work<br/>package&#160;4 (and&#160;CUCL&#160;in&#160;particular)&#160;produced&#160;a&#160;significant&#160;amount&#160;of software&#160;in&#160;the<br/>form&#160;of&#160;a&#160;prototype&#160;which&#160;would&#160;not have&#160;been&#160;captured&#160;by any other&#160;deliverable.<br/>This&#160;was our motivation&#160;to&#160;introduce&#160;this&#160;new deliverable&#160;which details both the<br/>research&#160;done&#160;for&#160;high&#160;performance&#160;and&#160;secure&#160;graphic&#160;virtualisation&#160;and&#160;the software<br/>components&#160;that&#160;have&#160;been&#160;developed.&#160;The&#160;software&#160;packages&#160;described&#160;in&#160;this<br/>document&#160;will&#160;be delivered&#160;to&#160;the&#160;European&#160;Commission&#160;as&#160;part&#160;of the overall<br/>software&#160;packages&#160;produced&#160;by&#160;the whole&#160;project&#160;and&#160;currently&#160;hosted&#160;on&#160;the&#160;OpenTC<br/>versioning&#160;servers.&#160;All&#160;the&#160;software&#160;components&#160;described&#160;in&#160;this&#160;document&#160;have&#160;been<br/>released&#160;under&#160;an&#160;open&#160;source&#160;license&#160;by CUCL.</p>
<p style="position:absolute;top:508px;left:85px;white-space:nowrap" class="ft38"><b>2&#160;</b></p>
<p style="position:absolute;top:505px;left:117px;white-space:nowrap" class="ft39"><b>Introduction&#160;</b></p>
<p style="position:absolute;top:535px;left:85px;white-space:nowrap" class="ft34">Virtual&#160;machines&#160;(VMs)&#160;have,&#160;since&#160;their resurgence&#160;as a concept&#160;at&#160;the&#160;beginning&#160;of<br/>the decade,&#160;primarily&#160;seen&#160;use&#160;in&#160;server&#160;applications.&#160;However,&#160;as the typical&#160;amount<br/>of memory&#160;fitted&#160;to workstations&#160;and&#160;desktop&#160;computers&#160;has&#160;risen,&#160;so&#160;has&#160;the<br/>practicality&#160;of using&#160;a virtual&#160;machine&#160;monitor&#160;(VMM)&#160;to run&#160;multiple&#160;virtual&#160;machines<br/>on&#160;the desktop.&#160;This&#160;may serve&#160;to provide&#160;fault&#160;isolation for important&#160;applications (for<br/>example,&#160;to&#160;run&#160;a&#160;secure&#160;VPN&#160;connection&#160;out of&#160;a different&#160;VM&#160;to that&#160;which&#160;is&#160;used<br/>for&#160;web&#160;browsing,&#160;and&#160;so&#160;which is&#160;vulnerable&#160;to&#160;malware&#160;infection), to provide&#160;a<br/>sandbox&#160;environment&#160;for&#160;developers,&#160;or&#160;to&#160;permit&#160;the concurrent&#160;use of multiple<br/>operating&#160;systems.</p>
<p style="position:absolute;top:727px;left:85px;white-space:nowrap" class="ft34">Because&#160;the earlier&#160;use&#160;cases&#160;were&#160;primarily&#160;server-oriented,&#160;VMMs&#160;and&#160;operating<br/>systems&#160;targeting&#160;a VMM&#160;tended&#160;to&#160;focus&#160;on&#160;the&#160;efficient&#160;virtualisation&#160;of disk&#160;and<br/>network&#160;I/O. However, they neglected&#160;devices&#160;such&#160;as&#160;sound&#160;and&#160;graphics&#160;hardware<br/>which&#160;are&#160;of little use&#160;in&#160;the&#160;server&#160;room,&#160;but are&#160;crucial on the desktop.</p>
<p style="position:absolute;top:823px;left:85px;white-space:nowrap" class="ft34">Virtualisation&#160;of&#160;graphics&#160;hardware&#160;to&#160;provide&#160;high&#160;fidelity,&#160;security&#160;and&#160;performance<br/>is challenging.&#160;This&#160;is principally&#160;due&#160;to the highly&#160;complex&#160;nature&#160;of&#160;graphics<br/>hardware&#160;compared&#160;to,&#160;for&#160;example,&#160;networking&#160;hardware.&#160;Graphics&#160;hardware&#160;can&#160;be<br/>programmed&#160;to&#160;perform&#160;complex&#160;tasks,&#160;and&#160;the&#160;languages&#160;used&#160;by programmers&#160;are<br/>correspondingly&#160;highly&#160;expressive&#160;and&#160;complex.&#160;Software&#160;providing&#160;a&#160;virtual&#160;GPU&#160;must<br/>therefore&#160;either emulate&#160;complex&#160;hardware,&#160;or&#160;remote a complex&#160;API.</p>
<p style="position:absolute;top:957px;left:85px;white-space:nowrap" class="ft34">Recently,&#160;several commercial&#160;products&#160;and&#160;academic projects&#160;have&#160;endeavoured to<br/>provide&#160;full&#160;3D acceleration; many&#160;different&#160;pieces of software&#160;provide&#160;support&#160;for<br/>various&#160;combinations&#160;of&#160;host&#160;operating&#160;system,&#160;guest&#160;operating&#160;system,&#160;and&#160;graphics<br/>API.&#160;In most&#160;cases&#160;these have&#160;used&#160;API&#160;remoting&#160;techniques,&#160;which&#160;has&#160;meant&#160;running<br/>a complete&#160;graphics&#160;driver&#160;in the VMM's&#160;trusted&#160;domain,&#160;significantly&#160;inflating&#160;the<br/>trusted&#160;computing&#160;base.&#160;This&#160;naturally&#160;introduces&#160;the&#160;risk&#160;that&#160;a bug&#160;in&#160;this&#160;new<br/>trusted&#160;code may&#160;break&#160;isolation&#160;between&#160;virtual&#160;machines,&#160;perhaps&#160;to&#160;the&#160;point&#160;of<br/>causing&#160;the&#160;entire&#160;physical&#160;machine&#160;to fail.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft36">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft36">3/17</p>
</div>
<!-- Page 4 -->
<a name="4"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft410{font-size:14px;font-family:IIIBCG+ArialUnicodeMS;color:#000000;}
-->
</style>
<div id="page4-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content004.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft46">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft46">FINAL|1.0</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft44">Projects&#160;also&#160;exist&#160;which&#160;attempt&#160;to provide&#160;a&#160;secure graphical&#160;user&#160;interface:&#160;an<br/>environment&#160;in&#160;which&#160;graphical&#160;programs&#160;may&#160;be interacted&#160;with&#160;whilst&#160;remaining<br/>isolated&#160;from&#160;one another such&#160;that&#160;they&#160;may not&#160;eavesdrop&#160;on input events or<br/>observe&#160;or&#160;manipulate&#160;the display&#160;of&#160;another.</p>
<p style="position:absolute;top:247px;left:85px;white-space:nowrap" class="ft44">This&#160;report&#160;describes&#160;the design&#160;and&#160;implementation&#160;of a&#160;system&#160;which&#160;aims&#160;to<br/>combine&#160;and&#160;improve&#160;on&#160;these&#160;in&#160;providing&#160;a&#160;secure&#160;GUI to&#160;guest&#160;VMs&#160;with&#160;support&#160;for<br/>hardware&#160;3D&#160;rendering.&#160;It aims&#160;to&#160;ameliorate&#160;the&#160;security issues&#160;of&#160;previous&#160;systems<br/>by&#160;moving&#160;more&#160;3D&#160;driver&#160;code&#160;out&#160;of&#160;the trusted&#160;domain&#160;and&#160;into&#160;the&#160;guests.</p>
<p style="position:absolute;top:342px;left:85px;white-space:nowrap" class="ft41"><b>2.1&#160;Summary&#160;of work&#160;done</b></p>
<p style="position:absolute;top:376px;left:85px;white-space:nowrap" class="ft410">•</p>
<p style="position:absolute;top:375px;left:90px;white-space:nowrap" class="ft42">&#160;Developed&#160;an&#160;OpenGL&#160;driver for installation&#160;in guest virtual&#160;machines&#160;which provides</p>
<p style="position:absolute;top:394px;left:85px;white-space:nowrap" class="ft44">remoting&#160;of rendering&#160;operations&#160;using&#160;the&#160;Gallium&#160;pipe&#160;driver&#160;layer&#160;as&#160;a&#160;remoting<br/>point</p>
<p style="position:absolute;top:438px;left:85px;white-space:nowrap" class="ft410">•</p>
<p style="position:absolute;top:437px;left:90px;white-space:nowrap" class="ft42">&#160;Developed&#160;compositing&#160;software&#160;which&#160;accelerates&#160;rendering&#160;of those&#160;rendering</p>
<p style="position:absolute;top:456px;left:85px;white-space:nowrap" class="ft42">operations</p>
<p style="position:absolute;top:481px;left:85px;white-space:nowrap" class="ft410">•</p>
<p style="position:absolute;top:480px;left:90px;white-space:nowrap" class="ft42">&#160;Modified&#160;the&#160;XenLinux&#160;kernel&#160;to&#160;provide&#160;support&#160;for&#160;accelerated&#160;rendering</p>
<p style="position:absolute;top:504px;left:85px;white-space:nowrap" class="ft410">•</p>
<p style="position:absolute;top:503px;left:90px;white-space:nowrap" class="ft42">&#160;Developed&#160;an&#160;architecture&#160;for&#160;secure&#160;VM-switching&#160;by the&#160;user&#160;of the&#160;compositor</p>
<p style="position:absolute;top:522px;left:85px;white-space:nowrap" class="ft42">software&#160;making&#160;use a trusted domain&#160;displaying&#160;all trusted user&#160;interface.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft46">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft46">4/17</p>
</div>
<!-- Page 5 -->
<a name="5"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page5-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content005.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft56">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft56">FINAL|1.0</p>
<p style="position:absolute;top:172px;left:85px;white-space:nowrap" class="ft58"><b>3&#160;</b></p>
<p style="position:absolute;top:169px;left:117px;white-space:nowrap" class="ft59"><b>Aims&#160;of secure graphics virtualisation</b></p>
<p style="position:absolute;top:199px;left:85px;white-space:nowrap" class="ft54">The following&#160;four&#160;aims&#160;are&#160;necessary&#160;properties&#160;of&#160;software&#160;providing&#160;3D&#160;graphics<br/>virtualisation:</p>
<p style="position:absolute;top:262px;left:85px;white-space:nowrap" class="ft510">•</p>
<p style="position:absolute;top:261px;left:90px;white-space:nowrap" class="ft52">&#160;To&#160;guarantee&#160;isolation&#160;between&#160;clients,&#160;a&#160;vital&#160;feature&#160;as a&#160;common&#160;use&#160;case&#160;for</p>
<p style="position:absolute;top:280px;left:85px;white-space:nowrap" class="ft52">virtual&#160;machines&#160;is to isolate&#160;potentially&#160;dangerous&#160;or&#160;buggy&#160;software,</p>
<p style="position:absolute;top:305px;left:85px;white-space:nowrap" class="ft510">•</p>
<p style="position:absolute;top:304px;left:90px;white-space:nowrap" class="ft52">&#160;To take&#160;measures&#160;against&#160;guests impersonating&#160;one another,&#160;such that&#160;the&#160;user&#160;may</p>
<p style="position:absolute;top:323px;left:85px;white-space:nowrap" class="ft54">always&#160;be&#160;confident&#160;that&#160;they&#160;are&#160;interacting&#160;with the VM they&#160;wish to&#160;(a&#160;vital&#160;property<br/>because preventing&#160;VMs&#160;from&#160;interfering&#160;with&#160;one&#160;another is pointless if&#160;they&#160;can<br/>simply&#160;masquerade&#160;as&#160;another),</p>
<p style="position:absolute;top:387px;left:85px;white-space:nowrap" class="ft510">•</p>
<p style="position:absolute;top:385px;left:90px;white-space:nowrap" class="ft52">&#160;To&#160;produce&#160;a&#160;system&#160;as&#160;general&#160;across&#160;APIs,&#160;operating&#160;systems&#160;and&#160;VMMs&#160;as</p>
<p style="position:absolute;top:405px;left:85px;white-space:nowrap" class="ft54">possible,&#160;as&#160;this will&#160;reduce&#160;the volume&#160;of&#160;trusted&#160;code&#160;required&#160;to support&#160;a&#160;range&#160;of<br/>situations,&#160;and</p>
<p style="position:absolute;top:449px;left:85px;white-space:nowrap" class="ft510">•</p>
<p style="position:absolute;top:447px;left:90px;white-space:nowrap" class="ft52">&#160;To&#160;attain&#160;efficiency&#160;in spite&#160;of these&#160;constraints,&#160;as&#160;the system&#160;is&#160;useless&#160;if&#160;it cannot</p>
<p style="position:absolute;top:467px;left:85px;white-space:nowrap" class="ft52">beat&#160;software&#160;rendering&#160;by guests&#160;followed&#160;by&#160;bitmap&#160;copying.</p>
<p style="position:absolute;top:505px;left:85px;white-space:nowrap" class="ft54">All&#160;previous&#160;solutions&#160;share&#160;the&#160;common&#160;element of dividing&#160;the&#160;graphics&#160;rendering<br/>pipeline&#160;into two&#160;stages:&#160;an&#160;untrusted&#160;element, which&#160;runs in&#160;the&#160;guest's&#160;context and<br/>which&#160;cannot&#160;violate&#160;VM&#160;fault&#160;isolation,&#160;and a trusted&#160;element&#160;which runs&#160;in&#160;the&#160;host's,<br/>or trusted&#160;domain's&#160;context. This trusted&#160;code&#160;has&#160;direct&#160;access to&#160;the&#160;graphics<br/>hardware,&#160;and&#160;may,&#160;due&#160;to a&#160;bug&#160;or malicious&#160;addition,&#160;permit&#160;guests&#160;to&#160;break<br/>isolation,&#160;either&#160;subverting&#160;the&#160;host or impersonating&#160;another&#160;guest.&#160;It&#160;is therefore&#160;in<br/>the interests&#160;of security&#160;that&#160;as&#160;little&#160;code&#160;as&#160;possible&#160;should&#160;be&#160;trusted,&#160;and&#160;that&#160;that<br/>which&#160;is&#160;trusted&#160;should&#160;be rigorously&#160;reviewed&#160;and&#160;tested.</p>
<p style="position:absolute;top:677px;left:85px;white-space:nowrap" class="ft51"><b>3.1&#160;Security&#160;and&#160;Isolation</b></p>
<p style="position:absolute;top:705px;left:85px;white-space:nowrap" class="ft54">Our first&#160;aim&#160;was&#160;to provide&#160;secure&#160;multiplexing&#160;of the&#160;graphics&#160;hardware&#160;fitted&#160;to&#160;the<br/>host,&#160;such&#160;that, in&#160;common&#160;with other VMM&#160;multiplexers&#160;(such&#160;as those&#160;concerning<br/>network&#160;and block&#160;devices),&#160;clients&#160;would be&#160;both&#160;unable&#160;to&#160;deny service&#160;to&#160;other<br/>clients,&#160;and&#160;unable&#160;to&#160;cause&#160;faults&#160;in other&#160;clients.&#160;Specifically&#160;we aim to&#160;preserve<br/>confidentiality,&#160;in that&#160;no&#160;untrusted&#160;VM&#160;should&#160;be&#160;able&#160;to&#160;discover&#160;what&#160;another&#160;is<br/>drawing,&#160;integrity,&#160;in that&#160;no VM's&#160;drawing&#160;may&#160;be modified&#160;by&#160;another,&#160;and<br/>availability,&#160;in&#160;that&#160;failures&#160;of&#160;VMs engaged&#160;in&#160;3D&#160;drawing&#160;should&#160;not affect&#160;others,&#160;as<br/>well as&#160;no&#160;graphics&#160;commands&#160;being&#160;able&#160;to&#160;deny others&#160;the&#160;ability&#160;to draw.</p>
<p style="position:absolute;top:878px;left:85px;white-space:nowrap" class="ft54">The threat&#160;model&#160;which must&#160;be&#160;dealt&#160;with&#160;is&#160;one&#160;in&#160;which&#160;software&#160;running&#160;in<br/>untrusted&#160;VMs&#160;may&#160;attempt&#160;to&#160;violate&#160;any&#160;of the above&#160;constraints&#160;by&#160;delivering<br/>potentially&#160;malformed&#160;drawing&#160;commands,&#160;either to&#160;exploit the intended behaviour&#160;of<br/>the remoting&#160;software&#160;or&#160;graphics&#160;hardware,&#160;or&#160;else&#160;in&#160;the&#160;hope&#160;of discovering&#160;and<br/>exploiting&#160;an&#160;error.</p>
<p style="position:absolute;top:993px;left:85px;white-space:nowrap" class="ft54">Because&#160;local users are&#160;already able&#160;to&#160;run&#160;multiple&#160;3D applications&#160;concurrently,<br/>drivers&#160;are&#160;required to securely&#160;multiplex&#160;the&#160;hardware,&#160;which may&#160;not&#160;be capable&#160;of<br/>managing&#160;multiple rendering&#160;contexts in&#160;hardware.&#160;By representing&#160;remote&#160;clients as<br/>though&#160;they are local clients,&#160;this existing&#160;ability can be&#160;used to&#160;provide&#160;isolation<br/>between&#160;VMs,&#160;albeit&#160;isolation&#160;which&#160;is weaker&#160;than inter-VM isolation.&#160;This&#160;utilisation<br/>of the host's&#160;pre-existing&#160;ability&#160;to isolate clients&#160;is&#160;common&#160;to&#160;other API-remoting<br/>solutions.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft56">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft56">5/17</p>
</div>
<!-- Page 6 -->
<a name="6"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page6-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content006.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft66">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft66">FINAL|1.0</p>
<p style="position:absolute;top:170px;left:85px;white-space:nowrap" class="ft64">More&#160;important&#160;is the&#160;ability to&#160;trust&#160;that&#160;code which is&#160;running&#160;in&#160;the&#160;trusted&#160;domain,<br/>and&#160;therefore&#160;could,&#160;through&#160;a&#160;bug or&#160;malicious&#160;addition,&#160;break&#160;inter-VM isolation.&#160;To<br/>this&#160;ends&#160;we&#160;aimed&#160;to&#160;minimise&#160;the&#160;amount&#160;of code running&#160;in the&#160;trusted domain,<br/>such&#160;that&#160;this code&#160;might&#160;be&#160;of practical&#160;size&#160;for&#160;hand&#160;inspection&#160;and&#160;verification.&#160;A<br/>further&#160;aim&#160;was&#160;to&#160;maximise&#160;the&#160;generality&#160;of&#160;the&#160;trusted&#160;code, such&#160;that&#160;the&#160;system<br/>could&#160;be&#160;adapted&#160;to&#160;different&#160;operating&#160;systems,&#160;graphics&#160;APIs&#160;and&#160;graphics&#160;hardware<br/>without&#160;major alteration&#160;to the&#160;trusted&#160;code, and therefore&#160;need&#160;for&#160;re-verification.<br/>This&#160;generality might&#160;also&#160;serve&#160;to&#160;improve&#160;the reliability of the trusted&#160;code:&#160;because<br/>these sections of&#160;code&#160;would&#160;be&#160;used&#160;by&#160;all&#160;of&#160;the system's&#160;users,&#160;regardless&#160;of&#160;their<br/>specific&#160;graphics&#160;hardware,&#160;the code&#160;would&#160;receive&#160;heavy exposure&#160;and&#160;testing,<br/>making&#160;the discovery&#160;of&#160;bugs&#160;more&#160;likely.&#160;</p>
<p style="position:absolute;top:401px;left:85px;white-space:nowrap" class="ft64">Finally,&#160;wherever&#160;we&#160;divided&#160;the&#160;graphics&#160;stack&#160;into&#160;trusted&#160;and untrusted&#160;elements,&#160;it<br/>would&#160;be&#160;necessary&#160;to&#160;verify&#160;each&#160;call&#160;into&#160;trusted&#160;code&#160;in&#160;order&#160;to&#160;ensure&#160;that&#160;the&#160;call<br/>did&#160;not attempt&#160;to&#160;access&#160;resources&#160;belonging to&#160;another&#160;VM. We&#160;aimed to&#160;divide&#160;it in<br/>such&#160;a&#160;manner&#160;that verification&#160;of the admissibility&#160;of&#160;calls into&#160;the&#160;trusted&#160;code is<br/>easy and&#160;efficient, as&#160;this would&#160;serve&#160;to&#160;make&#160;the&#160;remoting&#160;code simple&#160;and<br/>therefore&#160;easy&#160;to&#160;check&#160;for bugs,&#160;as&#160;well&#160;as minimising&#160;the&#160;performance&#160;penalty<br/>incurred&#160;through&#160;remoting.</p>
<p style="position:absolute;top:572px;left:85px;white-space:nowrap" class="ft61"><b>3.2&#160;Secure&#160;Interaction</b></p>
<p style="position:absolute;top:600px;left:85px;white-space:nowrap" class="ft64">Whilst&#160;the&#160;above&#160;measures&#160;make&#160;it&#160;less&#160;likely for&#160;a client&#160;to subvert&#160;the host&#160;or&#160;other<br/>guests&#160;to a&#160;software&#160;error&#160;in&#160;the&#160;graphics&#160;driver,&#160;they&#160;do&#160;not&#160;prevent&#160;guests from<br/>attempting&#160;to deceive the&#160;user&#160;into&#160;believing&#160;they&#160;are&#160;interacting with&#160;a different<br/>guest.&#160;To&#160;this end,&#160;it&#160;was&#160;a&#160;further&#160;aim&#160;to provide&#160;the user&#160;with&#160;a&#160;secure&#160;means&#160;of<br/>choosing which VM&#160;they&#160;wish&#160;to interact&#160;with, and&#160;determining&#160;which VM&#160;they&#160;are<br/>currently&#160;interacting&#160;with.</p>
<p style="position:absolute;top:735px;left:85px;white-space:nowrap" class="ft64">By providing&#160;a&#160;secure&#160;attention sequence&#160;which&#160;is recognised&#160;by&#160;host&#160;software&#160;but&#160;not<br/>forwarded&#160;to&#160;any&#160;VM, and&#160;which always&#160;immediately&#160;shows only the display&#160;of&#160;a<br/>nominated&#160;trusted&#160;VM, users&#160;can be guaranteed&#160;the ability to&#160;gain access&#160;to a known<br/>machine.&#160;By&#160;delegating&#160;to&#160;only that&#160;trusted&#160;VM the right&#160;to&#160;select another VM&#160;for<br/>viewing,&#160;users&#160;can&#160;be&#160;assured&#160;that,&#160;assuming&#160;the&#160;host&#160;or&#160;trusted&#160;VM&#160;was not itself<br/>already&#160;subverted,&#160;they&#160;are&#160;indeed at&#160;all times&#160;interacting&#160;with the VM they&#160;intend&#160;to.</p>
<p style="position:absolute;top:869px;left:85px;white-space:nowrap" class="ft64">In&#160;order&#160;to&#160;guarantee&#160;that&#160;this security is&#160;provided,&#160;it&#160;is&#160;necessary&#160;to&#160;ensure&#160;a&#160;secure<br/>I/O&#160;path&#160;from&#160;the&#160;user's&#160;physical&#160;I/O devices to the&#160;host's&#160;control software&#160;and&#160;the<br/>trusted VM.</p>
<p style="position:absolute;top:964px;left:85px;white-space:nowrap" class="ft61"><b>3.3&#160;Generality</b></p>
<p style="position:absolute;top:992px;left:85px;white-space:nowrap" class="ft64">As mentioned&#160;above,&#160;providing&#160;a&#160;means of&#160;virtualisation&#160;which includes&#160;maximally<br/>flexible&#160;trusted&#160;elements (i.e. one which&#160;is&#160;portable&#160;between&#160;host&#160;operating&#160;systems,<br/>guest&#160;operating systems&#160;and graphics APIs&#160;without&#160;significant&#160;alteration&#160;of those<br/>trusted&#160;elements)&#160;would be&#160;beneficial from&#160;a security&#160;point&#160;of view;&#160;however,&#160;that&#160;is<br/>not the&#160;only advantage&#160;of&#160;such a solution.</p>
<p style="position:absolute;top:1107px;left:85px;white-space:nowrap" class="ft62">We aimed&#160;to&#160;divide&#160;the graphics&#160;driver&#160;into two&#160;elements: a hardware-independent</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft66">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft66">6/17</p>
</div>
<!-- Page 7 -->
<a name="7"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page7-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content007.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft76">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft76">FINAL|1.0</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft74">element running&#160;in the&#160;guest,&#160;and&#160;a hardware-dependent&#160;but graphics&#160;API-<br/>independent&#160;element&#160;running&#160;in the&#160;trusted&#160;domain.&#160;This approach&#160;to&#160;modularisation<br/>means&#160;that&#160;the&#160;hardware-independent&#160;aspects of driver&#160;development&#160;effort&#160;can&#160;be<br/>shared&#160;between drivers.&#160;Therefore,&#160;all drivers&#160;could&#160;benefit&#160;directly from&#160;that&#160;shared<br/>effort&#160;and&#160;so rapidly&#160;gain&#160;support&#160;for&#160;new API&#160;revisions,&#160;or entirely&#160;new APIs;&#160;by<br/>comparison,&#160;previous&#160;remoting&#160;solutions&#160;which&#160;are&#160;bound&#160;to&#160;a&#160;specific&#160;API&#160;will&#160;be&#160;less<br/>able&#160;to&#160;take advantage&#160;of&#160;shared&#160;code to&#160;support&#160;new&#160;revisions&#160;of those&#160;interfaces.<br/>This&#160;means&#160;that&#160;as&#160;well&#160;as&#160;providing&#160;a&#160;smaller&#160;trusted&#160;codebase&#160;than&#160;other<br/>approaches,&#160;such&#160;a&#160;modular&#160;solution&#160;is likely to&#160;adapt&#160;to&#160;new&#160;developments&#160;faster.<br/>Given,&#160;for&#160;example,&#160;the&#160;marked&#160;departure&#160;of Direct3D&#160;10 from&#160;its predecessor,&#160;this<br/>ability&#160;to adapt&#160;seems&#160;likely to&#160;be a&#160;very&#160;practical advantage.</p>
<p style="position:absolute;top:399px;left:85px;white-space:nowrap" class="ft71"><b>3.4&#160;Performance</b></p>
<p style="position:absolute;top:428px;left:85px;white-space:nowrap" class="ft74">Our&#160;final&#160;aim&#160;was to&#160;provide&#160;a virtualisation&#160;solution&#160;with&#160;performance&#160;comparable&#160;to<br/>3D&#160;accelerated&#160;applications&#160;running&#160;directly on&#160;the&#160;host.&#160;In&#160;order to&#160;achieve this&#160;it&#160;is<br/>necessary&#160;to&#160;maximise&#160;command&#160;batching,&#160;which&#160;in&#160;turn&#160;means&#160;avoiding&#160;tight<br/>synchronisation&#160;between VMs.</p>
<p style="position:absolute;top:524px;left:85px;white-space:nowrap" class="ft74">This&#160;aim&#160;may also&#160;go&#160;hand&#160;in&#160;hand&#160;with&#160;that&#160;of achieving&#160;security:&#160;if the graphics<br/>stack is divided&#160;in&#160;such&#160;a manner&#160;as to&#160;make&#160;the&#160;marshalling&#160;and&#160;validation of calls<br/>into the trusted&#160;portion&#160;easy and&#160;simple, this&#160;process&#160;will&#160;be both faster&#160;and&#160;easier&#160;to<br/>verify&#160;than&#160;more&#160;difficult&#160;marshalling&#160;code.</p>
<p style="position:absolute;top:640px;left:85px;white-space:nowrap" class="ft78"><b>4&#160;</b></p>
<p style="position:absolute;top:638px;left:117px;white-space:nowrap" class="ft79"><b>Xen3D: A 3D Graphical Remoting&#160;and&#160;Composition&#160;System</b></p>
<p style="position:absolute;top:668px;left:85px;white-space:nowrap" class="ft74">We&#160;implemented&#160;Xen3D,&#160;a set&#160;of&#160;virtual&#160;graphics&#160;drivers&#160;to&#160;run on&#160;guest&#160;VMs&#160;coupled<br/>with&#160;a compositor&#160;application&#160;run&#160;on&#160;the&#160;host&#160;system.</p>
<p style="position:absolute;top:725px;left:85px;white-space:nowrap" class="ft74">The system&#160;as&#160;currently&#160;implemented&#160;supports&#160;Linux&#160;guests&#160;running&#160;Xorg&#160;and&#160;a&#160;Linux<br/>host running&#160;any X server.&#160;It depends&#160;on&#160;the&#160;Xen hypervisor,&#160;because&#160;it uses&#160;Xen-<br/>specific&#160;shared&#160;memory&#160;mechanisms&#160;for interdomain&#160;communication,&#160;but&#160;is otherwise<br/>hypervisor-independent.&#160;It&#160;currently&#160;only supports&#160;the&#160;OpenGL&#160;graphics&#160;API.</p>
<p style="position:absolute;top:821px;left:85px;white-space:nowrap" class="ft74">In&#160;our&#160;implementation&#160;we&#160;make&#160;use of&#160;Tungsten&#160;Graphics'&#160;Gallium3D&#160;driver<br/>architecture&#160;to&#160;facilitate&#160;the&#160;separation&#160;of drivers&#160;into&#160;untrusted&#160;and&#160;trusted<br/>components,&#160;without producing&#160;a&#160;system&#160;too&#160;hardware-specific&#160;to&#160;be easily&#160;adapted.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft76">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft76">7/17</p>
</div>
<!-- Page 8 -->
<a name="8"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft811{font-size:15px;font-family:IIIBLE+BitstreamVeraSans;color:#000000;}
-->
</style>
<div id="page8-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content008.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft86">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft86">FINAL|1.0</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft81"><b>4.1&#160;Introduction&#160;to&#160;Gallium</b></p>
<p style="position:absolute;top:963px;left:85px;white-space:nowrap" class="ft84">Gallium is a driver&#160;architecture developed&#160;by Tungsten&#160;Graphics&#160;which&#160;is&#160;ordinarily<br/>utilised as&#160;a labour-saving device for developers of ordinary,&#160;non-virtualised&#160;graphics<br/>drivers.&#160;It saves&#160;work&#160;by dividing&#160;graphics&#160;drivers&#160;into&#160;three&#160;modular&#160;layers:&#160;a State<br/>Tracker,&#160;which implements&#160;a&#160;graphics&#160;API&#160;and&#160;is&#160;hardware-independent,&#160;a&#160;Pipe&#160;Driver<br/>which&#160;is&#160;hardware&#160;dependent,&#160;API-independent&#160;and&#160;operating&#160;system&#160;independent,<br/>and&#160;a Window System&#160;Driver&#160;which&#160;is API-independent,&#160;hardware&#160;dependent&#160;and<br/>operating&#160;system&#160;dependent.&#160;This&#160;modular&#160;architecture permits multiple&#160;drivers to<br/>share&#160;state&#160;tracker&#160;modules,&#160;with&#160;each driver&#160;author&#160;contributing&#160;only a&#160;single&#160;pipe<br/>driver&#160;and&#160;a&#160;window&#160;system&#160;module&#160;per&#160;OS&#160;to&#160;be supported.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft86">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft86">8/17</p>
<p style="position:absolute;top:889px;left:85px;white-space:nowrap" class="ft811"><i>Illustration&#160;1:&#160;Possible linkages of&#160;Gallium&#160;components: the state&#160;tracker&#160;at&#160;the&#160;top,&#160;OS-</i></p>
<p style="position:absolute;top:907px;left:85px;white-space:nowrap" class="ft811"><i>independent pipe&#160;drivers&#160;in&#160;the&#160;middle&#160;row,&#160;and&#160;OS-dependent&#160;components&#160;below</i></p>
</div>
<!-- Page 9 -->
<a name="9"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page9-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content009.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft96">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft96">FINAL|1.0</p>
<p style="position:absolute;top:170px;left:85px;white-space:nowrap" class="ft94">Illustration&#160;1&#160;illustrates&#160;possible&#160;ways&#160;in&#160;which&#160;these modules&#160;can&#160;be&#160;linked&#160;to&#160;produce<br/>a complete&#160;graphics&#160;driver.</p>
<p style="position:absolute;top:246px;left:85px;white-space:nowrap" class="ft91"><b>4.2&#160;Xen3D&#160;Architectural&#160;Overview</b></p>
<p style="position:absolute;top:722px;left:85px;white-space:nowrap" class="ft94">API&#160;remoting&#160;techniques,&#160;as&#160;employed&#160;by&#160;most&#160;of the&#160;previous&#160;work&#160;described&#160;in<br/>Section&#160;2,&#160;suffer&#160;from&#160;generally featuring&#160;a large&#160;proportion&#160;of&#160;code running&#160;on&#160;the<br/>host,&#160;and&#160;thus&#160;being&#160;trusted.&#160;This is because,&#160;in the&#160;simplest&#160;case,&#160;they&#160;simply&#160;forward<br/>each&#160;user call&#160;to&#160;a graphics&#160;API&#160;in the&#160;manner&#160;of a&#160;remote&#160;procedure&#160;call;&#160;all<br/>processing&#160;logic&#160;is executed in the trusted domain.&#160;This&#160;approach&#160;is also inflexible:&#160;if it<br/>is desired&#160;to support&#160;more&#160;than&#160;one&#160;graphics API&#160;(for instance,&#160;OpenGL&#160;and Direct3D),<br/>either&#160;a separate&#160;renderer&#160;must&#160;be run&#160;in&#160;the&#160;trusted&#160;domain&#160;for&#160;each, further<br/>increasing&#160;the&#160;volume&#160;of&#160;trusted&#160;code, or&#160;else&#160;a translation&#160;layer&#160;must&#160;convert<br/>commands&#160;into those&#160;of&#160;a&#160;different&#160;graphics&#160;API,&#160;introducing&#160;less&#160;trusted&#160;code but<br/>incurring&#160;a performance&#160;penalty.</p>
<p style="position:absolute;top:933px;left:85px;white-space:nowrap" class="ft94">Xen3D&#160;differs&#160;from&#160;previous&#160;API-remoting&#160;software&#160;in&#160;that&#160;it&#160;performs&#160;remoting&#160;at&#160;the<br/>interface&#160;between&#160;the state&#160;tracker&#160;and&#160;pipe&#160;driver&#160;components&#160;of&#160;a Gallium&#160;driver,&#160;a<br/>situation&#160;illustrated&#160;in&#160;Figure&#160;2. While&#160;the pipe driver&#160;remains&#160;in&#160;the&#160;trusted&#160;domain,<br/>its code&#160;size&#160;is significantly&#160;reduced&#160;compared&#160;to&#160;a monolithic&#160;graphics&#160;driver,&#160;making<br/>it&#160;easier to&#160;verify.&#160;Further,&#160;because&#160;this&#160;element&#160;of&#160;the&#160;graphics&#160;driver&#160;is&#160;common&#160;to<br/>all&#160;graphics&#160;APIs&#160;it is likely to&#160;attract&#160;more&#160;testing&#160;and review than&#160;a similar&#160;API-<br/>specific&#160;driver simply&#160;due&#160;to higher usage.</p>
<p style="position:absolute;top:1087px;left:85px;white-space:nowrap" class="ft94">Xen3D&#160;also&#160;maintains&#160;desirable&#160;properties&#160;of previous&#160;solutions,&#160;including&#160;high<br/>performance,&#160;and&#160;the&#160;ability&#160;to run unmodified&#160;guest&#160;applications.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft96">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:774px;white-space:nowrap" class="ft96">9/17</p>
<p style="position:absolute;top:685px;left:85px;white-space:nowrap" class="ft911"><i>Illustration&#160;2:&#160;Simplified&#160;overview&#160;of Xen3D</i></p>
</div>
<!-- Page 10 -->
<a name="10"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page10-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content010.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft106">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft106">FINAL|1.0</p>
<p style="position:absolute;top:170px;left:85px;white-space:nowrap" class="ft104">The system&#160;as&#160;implemented&#160;comprises&#160;two&#160;parts.&#160;Firstly,&#160;a&#160;Gallium-specific&#160;libGL,<br/>which&#160;is&#160;linked to&#160;unmodified&#160;3D applications&#160;running&#160;on the guest&#160;and which includes<br/>the OpenGL&#160;state tracker&#160;coupled&#160;with&#160;remoting&#160;code.&#160;Secondly,&#160;a&#160;compositor<br/>application&#160;run&#160;on&#160;the&#160;host, which&#160;executes&#160;remoted commands&#160;as&#160;though on behalf<br/>of a&#160;local&#160;process.</p>
<p style="position:absolute;top:285px;left:85px;white-space:nowrap" class="ft104">Drawing&#160;commands&#160;received&#160;by the&#160;Pipe and&#160;Window&#160;System&#160;layers&#160;of the guest&#160;GL<br/>drivers are relayed&#160;to the&#160;compositor&#160;for drawing&#160;using a&#160;pair&#160;of simple&#160;shared<br/>memory&#160;ring-buffers.&#160;These buffers&#160;are&#160;directly accessible&#160;to&#160;both&#160;client&#160;application<br/>and&#160;compositor,&#160;and&#160;so,&#160;similarly&#160;to the&#160;VMWare&#160;Virtual&#160;GPU's&#160;command&#160;FIFOs,&#160;permit<br/>zero-copy command&#160;forwarding&#160;and batching.</p>
<p style="position:absolute;top:401px;left:85px;white-space:nowrap" class="ft104">Unlike the Virtual&#160;GPU, shared&#160;memory&#160;is&#160;not currently&#160;used for textures and&#160;vertex<br/>buffers;&#160;however&#160;this&#160;feature&#160;is&#160;planned&#160;for&#160;the future.</p>
<p style="position:absolute;top:476px;left:85px;white-space:nowrap" class="ft101"><b>4.3&#160;Marshalling&#160;Pipe&#160;Commands</b></p>
<p style="position:absolute;top:504px;left:85px;white-space:nowrap" class="ft104">The arguments&#160;to&#160;pipe&#160;commands&#160;are&#160;marshalled&#160;and&#160;forwarded&#160;over&#160;the&#160;shared<br/>memory&#160;transport&#160;unaltered,&#160;with&#160;a number&#160;of exceptions:</p>
<p style="position:absolute;top:568px;left:85px;white-space:nowrap" class="ft1010">•</p>
<p style="position:absolute;top:567px;left:90px;white-space:nowrap" class="ft102">&#160;Textures,&#160;surfaces&#160;and&#160;vertex&#160;buffers&#160;are&#160;persistent&#160;in-memory&#160;objects&#160;which&#160;the</p>
<p style="position:absolute;top:586px;left:85px;white-space:nowrap" class="ft104">pipe&#160;driver&#160;interface&#160;expects&#160;to&#160;refer to&#160;by pointers.&#160;These&#160;are&#160;marshalled&#160;into&#160;safe<br/>handles&#160;by&#160;the&#160;guest&#160;and&#160;unmarshalled&#160;into&#160;local&#160;pointers&#160;by the&#160;compositor.&#160;The<br/>tables&#160;of&#160;safe&#160;handles are rendering-context specific;&#160;contexts&#160;are themselves&#160;referred<br/>to&#160;by safe&#160;handles,&#160;which are&#160;held&#160;in&#160;a process-specific&#160;table.&#160;Therefore&#160;a malicious<br/>process&#160;cannot&#160;impersonate&#160;any other&#160;and&#160;gain&#160;access to&#160;is&#160;resources.</p>
<p style="position:absolute;top:687px;left:85px;white-space:nowrap" class="ft1010">•</p>
<p style="position:absolute;top:686px;left:90px;white-space:nowrap" class="ft102">&#160;Certain&#160;arguments,&#160;such&#160;as&#160;strides&#160;describing&#160;the row-length&#160;of a&#160;texture,&#160;act&#160;as</p>
<p style="position:absolute;top:705px;left:85px;white-space:nowrap" class="ft104">implied&#160;pointers into a surface.&#160;These&#160;are&#160;checked by the&#160;compositor&#160;to&#160;ensure&#160;that<br/>they&#160;do not&#160;point&#160;outside the&#160;referenced&#160;surface.</p>
<p style="position:absolute;top:749px;left:85px;white-space:nowrap" class="ft1010">•</p>
<p style="position:absolute;top:748px;left:90px;white-space:nowrap" class="ft102">&#160;Vertex and&#160;pixel&#160;shader&#160;programs&#160;are&#160;expressed&#160;as&#160;TGSI,&#160;Gallium3D's&#160;assembly-like</p>
<p style="position:absolute;top:768px;left:85px;white-space:nowrap" class="ft104">shader&#160;language.&#160;This&#160;language&#160;is&#160;Turing&#160;powerful;&#160;naturally&#160;the guest&#160;cannot&#160;check<br/>supplied&#160;programs&#160;to determine&#160;whether they&#160;halt. The Gallium pipe driver&#160;interface<br/>provides&#160;no&#160;means&#160;to interrupt&#160;processing,&#160;so&#160;the responsibility&#160;must&#160;fall to&#160;the<br/>graphics&#160;driver&#160;running&#160;in the&#160;trusted&#160;domain&#160;to&#160;determine&#160;when&#160;a&#160;shader&#160;program<br/>has&#160;run&#160;for&#160;an&#160;intolerably&#160;long&#160;time and&#160;abort&#160;processing.</p>
<p style="position:absolute;top:901px;left:85px;white-space:nowrap" class="ft101"><b>4.4&#160;Detailed&#160;Implementation</b></p>
<p style="position:absolute;top:929px;left:85px;white-space:nowrap" class="ft104">Interposition&#160;of&#160;the guest's remoting&#160;code&#160;on&#160;pipe&#160;driver&#160;calls is kept to&#160;a&#160;minimum;<br/>however&#160;it&#160;does&#160;intervene&#160;to ensure&#160;safety&#160;as&#160;described&#160;above.&#160;It also caches&#160;local<br/>copies&#160;of&#160;textures,&#160;render&#160;targets and&#160;vertex&#160;buffers&#160;to prevent&#160;unnecessary&#160;copying.</p>
<p style="position:absolute;top:1006px;left:85px;white-space:nowrap" class="ft104">This&#160;takes care&#160;of&#160;the task&#160;of&#160;relaying&#160;the 3D&#160;content&#160;drawn&#160;by&#160;applications&#160;running<br/>on&#160;this&#160;guest;&#160;however,&#160;typically&#160;the&#160;guest&#160;will&#160;be&#160;drawing&#160;3D&#160;content which is<br/>associated&#160;with a&#160;window, and&#160;which is layered on&#160;screen with&#160;respect to&#160;other<br/>windows&#160;containing both&#160;2D&#160;and 3D content. To&#160;this ends,&#160;the&#160;guests&#160;must&#160;also&#160;run an<br/>extension&#160;to&#160;their X&#160;servers.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft106">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft106">10/17</p>
</div>
<!-- Page 11 -->
<a name="11"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page11-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content011.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft116">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft116">FINAL|1.0</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft114">2D&#160;content&#160;drawn&#160;by&#160;this&#160;guest&#160;must&#160;then&#160;be&#160;integrated&#160;with&#160;the&#160;output of&#160;3D clients<br/>to&#160;produce&#160;a&#160;complete&#160;display;&#160;this is achieved&#160;using Xen's&#160;existing paravirtualised<br/>framebuffer&#160;device and&#160;a&#160;minor&#160;modification&#160;to the&#160;Qemu&#160;device&#160;model&#160;process&#160;which<br/>runs&#160;in Domain&#160;0 and&#160;manages&#160;the framebuffer.</p>
<p style="position:absolute;top:247px;left:85px;white-space:nowrap" class="ft114">The&#160;compositor,&#160;which runs on&#160;the&#160;host, is&#160;then&#160;responsible&#160;for accepting&#160;connections<br/>from&#160;guests'&#160;3D&#160;clients,&#160;Xorg&#160;extensions,&#160;and&#160;instances of&#160;the Qemu&#160;device model&#160;and<br/>synthesising&#160;these&#160;different&#160;inputs&#160;to&#160;create a coherent&#160;display&#160;corresponding&#160;to each<br/>guest,&#160;as well&#160;as&#160;allowing&#160;the&#160;user&#160;to navigate&#160;amongst&#160;the&#160;displays&#160;of different&#160;VMs.</p>
<p style="position:absolute;top:343px;left:85px;white-space:nowrap" class="ft114">In&#160;response&#160;to&#160;3D&#160;client&#160;commands,&#160;the&#160;compositor&#160;acts as&#160;though&#160;each&#160;is a&#160;3D<br/>application&#160;running&#160;on&#160;the local system. It&#160;harnesses&#160;the&#160;Pipe&#160;Driver and&#160;Window<br/>System&#160;Driver components&#160;of a Gallium&#160;driver&#160;for&#160;the local graphics&#160;card, and&#160;creates<br/>a rendering&#160;context corresponding&#160;to&#160;each&#160;remote&#160;rendering&#160;context.&#160;It then&#160;executes<br/>drawing&#160;commands&#160;in&#160;the appropriate&#160;context as&#160;it&#160;services&#160;each&#160;remote&#160;client&#160;in&#160;a<br/>round&#160;robin&#160;fashion.&#160;By&#160;retaining&#160;control&#160;of&#160;these&#160;context switches, the compositor&#160;is<br/>able&#160;to&#160;prevent&#160;guest&#160;applications&#160;from&#160;modifying&#160;the state&#160;of&#160;other&#160;contexts&#160;and<br/>therefore&#160;breaking isolation.</p>
<p style="position:absolute;top:516px;left:85px;white-space:nowrap" class="ft114">All&#160;rendering&#160;by clients&#160;is&#160;redirected&#160;to&#160;offscreen surfaces&#160;pending composition.&#160;This<br/>means&#160;that&#160;guests' rendering&#160;does&#160;not need&#160;to&#160;be&#160;bounds-checked&#160;by the compositor<br/>in&#160;order&#160;to&#160;prevent&#160;the possibility&#160;of&#160;a&#160;guest&#160;drawing&#160;on&#160;areas of&#160;screen&#160;belonging&#160;to<br/>another&#160;and&#160;thus&#160;impersonating&#160;that&#160;guest&#160;to the&#160;user.&#160;By comparison&#160;if&#160;it&#160;were<br/>permitted&#160;to&#160;draw&#160;direct&#160;to&#160;the screen (or&#160;the&#160;compositor's&#160;window,&#160;if it&#160;is running&#160;in&#160;a<br/>windowed&#160;environment,)&#160;every&#160;draw&#160;would&#160;need&#160;to&#160;be checked to&#160;ensure&#160;that&#160;it&#160;did<br/>not write&#160;outside&#160;its ‘owned’&#160;area. Of course,&#160;the&#160;graphics&#160;driver&#160;must&#160;ensure&#160;its own<br/>memory&#160;integrity&#160;somehow,&#160;either&#160;by explicit&#160;bounds checking or otherwise;&#160;this<br/>simply&#160;avoids&#160;having&#160;to ‘double&#160;check’ both&#160;at&#160;the&#160;application&#160;layer&#160;and&#160;in&#160;the driver.</p>
<p style="position:absolute;top:708px;left:85px;white-space:nowrap" class="ft114">Clipping&#160;information&#160;and&#160;2D content&#160;from&#160;the&#160;guests'&#160;Xorg&#160;extensions&#160;and&#160;Qemu<br/>instances&#160;is then used&#160;to&#160;reconstruct&#160;the guest's&#160;desktop&#160;from&#160;these offscreen<br/>surfaces&#160;as&#160;it would&#160;have&#160;been&#160;drawn&#160;locally.</p>
<p style="position:absolute;top:785px;left:85px;white-space:nowrap" class="ft114">The compositor&#160;uses&#160;the&#160;EGL API&#160;for management&#160;of local&#160;rendering&#160;contexts,&#160;rather<br/>than&#160;the X-specific&#160;GLX API&#160;ordinarily&#160;used&#160;for&#160;this purpose.&#160;As&#160;EGL can&#160;be<br/>implemented&#160;by a&#160;graphics&#160;driver&#160;which&#160;draws&#160;directly&#160;to the&#160;local framebuffer&#160;rather<br/>than&#160;into&#160;an&#160;X window,&#160;in&#160;the&#160;presence of&#160;such&#160;a&#160;driver&#160;the compositor&#160;can&#160;run<br/>without&#160;a&#160;windowing&#160;system,&#160;and therefore&#160;there is no&#160;need&#160;to run&#160;Xorg or any&#160;other&#160;X<br/>server&#160;in the&#160;trusted&#160;domain.&#160;This again&#160;reduces&#160;the&#160;quantity of code&#160;which must&#160;be<br/>trusted&#160;to permit&#160;guests&#160;access&#160;to hardware&#160;3D&#160;rendering.</p>
<p style="position:absolute;top:938px;left:85px;white-space:nowrap" class="ft114">The&#160;compositor also&#160;performs&#160;all forwarding of&#160;input&#160;events to&#160;VMs;&#160;only&#160;a single VM&#160;is<br/>active&#160;for&#160;input&#160;or&#160;output&#160;at&#160;any given&#160;time,&#160;in&#160;order&#160;to&#160;guard&#160;against&#160;VMs&#160;attempting<br/>to&#160;eavesdrop&#160;on&#160;one&#160;another,&#160;and&#160;the&#160;compositor&#160;recognises&#160;a&#160;secure&#160;attention<br/>sequence&#160;which&#160;is not&#160;passed&#160;on&#160;to any&#160;guest.&#160;In&#160;response&#160;to&#160;this&#160;sequence&#160;the<br/>compositor&#160;will switch&#160;to&#160;a&#160;nominated,&#160;trusted VM,&#160;which is then able to&#160;provide&#160;an<br/>interface&#160;for selecting&#160;which VM&#160;the&#160;user wishes to&#160;interact&#160;with. Because&#160;under&#160;Xen<br/>no&#160;VM&#160;can&#160;usurp&#160;the domain-ID&#160;of another, and&#160;no&#160;VM&#160;can&#160;intercept&#160;the&#160;secure<br/>attention&#160;sequence, there&#160;is&#160;no way&#160;for&#160;a VM&#160;to convincingly&#160;masquerade&#160;as another.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft116">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft116">11/17</p>
</div>
<!-- Page 12 -->
<a name="12"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page12-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content012.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft126">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft126">FINAL|1.0</p>
<p style="position:absolute;top:154px;left:85px;white-space:nowrap" class="ft128"><b>5&#160;</b></p>
<p style="position:absolute;top:151px;left:117px;white-space:nowrap" class="ft129"><b>Discussion and&#160;Lessons Learned</b></p>
<p style="position:absolute;top:181px;left:85px;white-space:nowrap" class="ft122">This&#160;system as currently&#160;implemented has achieved its&#160;main&#160;goals:</p>
<p style="position:absolute;top:225px;left:85px;white-space:nowrap" class="ft1210">•</p>
<p style="position:absolute;top:224px;left:90px;white-space:nowrap" class="ft122">&#160;VM&#160;isolation&#160;is threatened&#160;less than&#160;when&#160;using&#160;previous&#160;systems,&#160;because less&#160;of</p>
<p style="position:absolute;top:243px;left:85px;white-space:nowrap" class="ft122">the graphics&#160;driver&#160;code runs&#160;trusted&#160;and&#160;so&#160;presents&#160;a&#160;target&#160;for&#160;exploits.</p>
<p style="position:absolute;top:268px;left:85px;white-space:nowrap" class="ft1210">•</p>
<p style="position:absolute;top:267px;left:90px;white-space:nowrap" class="ft122">&#160;By remoting&#160;Gallium's&#160;pipe driver&#160;interface, Xen3D&#160;maintains&#160;independence&#160;from</p>
<p style="position:absolute;top:286px;left:85px;white-space:nowrap" class="ft122">OpenGL&#160;or any other&#160;graphics&#160;API.</p>
<p style="position:absolute;top:311px;left:85px;white-space:nowrap" class="ft1210">•</p>
<p style="position:absolute;top:310px;left:90px;white-space:nowrap" class="ft122">&#160;By&#160;controlling&#160;the&#160;host&#160;graphics&#160;driver&#160;using&#160;EGL,&#160;independence&#160;from&#160;a&#160;host</p>
<p style="position:absolute;top:329px;left:85px;white-space:nowrap" class="ft122">windowing&#160;system&#160;(or indeed the need to&#160;use&#160;one&#160;at all)&#160;is&#160;also&#160;maintained.</p>
<p style="position:absolute;top:354px;left:85px;white-space:nowrap" class="ft1210">•</p>
<p style="position:absolute;top:353px;left:90px;white-space:nowrap" class="ft122">&#160;The system&#160;performs&#160;well&#160;as far&#160;as it&#160;can be&#160;measured&#160;at&#160;present.&#160;Only software</p>
<p style="position:absolute;top:372px;left:85px;white-space:nowrap" class="ft124">drivers&#160;are&#160;currently compatible with&#160;Xen,&#160;but&#160;these&#160;drivers&#160;achieve framerates&#160;for<br/>tests&#160;such&#160;as&#160;glxgears&#160;and&#160;Open&#160;Arena&#160;almost&#160;equal&#160;to&#160;their&#160;performance&#160;without<br/>remoting</p>
<p style="position:absolute;top:449px;left:85px;white-space:nowrap" class="ft124">It is,&#160;however,&#160;certainly&#160;possible&#160;to&#160;improve&#160;further.&#160;This section&#160;will discuss&#160;in more<br/>detail&#160;the&#160;goals achieved,&#160;and&#160;how&#160;they could&#160;be&#160;bettered.</p>
<p style="position:absolute;top:524px;left:85px;white-space:nowrap" class="ft121"><b>5.1&#160;Security&#160;and&#160;Trusted&#160;Code</b></p>
<p style="position:absolute;top:572px;left:85px;white-space:nowrap" class="ft124">As mentioned&#160;above,&#160;one key aim of&#160;this&#160;work&#160;was to achieve&#160;highly general&#160;3D<br/>graphics&#160;remoting&#160;with&#160;a&#160;minimum&#160;of code&#160;being&#160;trusted.&#160;This&#160;goal&#160;is&#160;partially<br/>achieved:&#160;Gallium's&#160;only&#160;current&#160;state&#160;tracker&#160;implements&#160;OpenGL, and is<br/>implemented&#160;by over&#160;150,000&#160;lines of code&#160;(The&#160;code&#160;referenced&#160;actually&#160;includes<br/>over&#160;1,000,000&#160;lines,&#160;but&#160;we&#160;assume&#160;conservatively&#160;that none of the code<br/>implementing&#160;software&#160;execution of&#160;shader&#160;programs&#160;or fixed-function&#160;lighting&#160;is<br/>used,&#160;being entirely&#160;replaced&#160;by&#160;Gallium).&#160;By comparison,&#160;a&#160;sample&#160;hardware&#160;driver<br/>for&#160;Intel's 915&#160;graphics&#160;chipset&#160;features&#160;80,000&#160;lines of code,&#160;and&#160;of&#160;these,&#160;60,000&#160;are<br/>Gallium support&#160;libraries&#160;common&#160;to&#160;all&#160;drivers.&#160;Thus,&#160;running&#160;the&#160;state tracker<br/>element in&#160;the guest&#160;domain&#160;and&#160;remoting&#160;at&#160;the interface between tracker and&#160;pipe<br/>driver&#160;moves&#160;a large&#160;majority&#160;of&#160;the driver&#160;code&#160;out&#160;of the&#160;trusted&#160;domain.&#160;What's<br/>more, as Gallium3D&#160;approaches&#160;maturity&#160;it&#160;will acquire&#160;state-tracker&#160;modules&#160;for<br/>graphics&#160;APIs&#160;such&#160;as&#160;Direct3D&#160;9 and&#160;10,&#160;as&#160;well as&#160;window-system&#160;driver&#160;adaptations<br/>to&#160;suit&#160;their respective&#160;means&#160;of controlling drawing&#160;context.&#160;Since&#160;the&#160;state tracker,<br/>which&#160;runs untrusted,&#160;is likely&#160;to be&#160;large,&#160;whilst&#160;the windowing-system&#160;dependent<br/>elements of the sample&#160;Intel 915&#160;driver,&#160;running trusted,&#160;constitute just&#160;8,000&#160;lines&#160;of<br/>code, a very&#160;large proportion&#160;of&#160;new code&#160;is&#160;likely to&#160;run in the untrusted domain.</p>
<p style="position:absolute;top:917px;left:85px;white-space:nowrap" class="ft124">Division&#160;of the graphics&#160;driver&#160;using&#160;Gallium&#160;is also&#160;likely to increase&#160;the reliability of<br/>that&#160;code&#160;which&#160;is&#160;trusted.&#160;Because&#160;a&#160;significant&#160;majority&#160;of the&#160;trusted&#160;code is shared<br/>by&#160;all graphics&#160;drivers,&#160;it&#160;will&#160;be used and&#160;tested&#160;by a&#160;very large&#160;user&#160;base.&#160;Even&#160;of<br/>that&#160;code&#160;which&#160;is&#160;Intel-specific,&#160;the majority&#160;(all&#160;but&#160;those&#160;8000&#160;lines)&#160;is shared&#160;by all<br/>operating&#160;systems&#160;and graphics&#160;APIs,&#160;and&#160;thus&#160;will&#160;be&#160;tested&#160;by&#160;Intel users running&#160;3D<br/>applications&#160;in practically&#160;any&#160;situation.</p>
<p style="position:absolute;top:1052px;left:85px;white-space:nowrap" class="ft124">Dividing&#160;at the&#160;state&#160;tracker&#160;/ pipe&#160;driver&#160;layer&#160;also&#160;provides&#160;a remoting&#160;interface<br/>which&#160;is&#160;both&#160;thin in terms&#160;of number&#160;of&#160;exposed&#160;methods,&#160;and&#160;whose&#160;calls&#160;are&#160;easy<br/>to verify&#160;for&#160;safety.&#160;This&#160;may&#160;reduce&#160;the chances&#160;of a&#160;bug&#160;in the&#160;remoting&#160;code&#160;itself<br/>undermining&#160;security.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft126">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft126">12/17</p>
</div>
<!-- Page 13 -->
<a name="13"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page13-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content013.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft136">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft136">FINAL|1.0</p>
<p style="position:absolute;top:170px;left:85px;white-space:nowrap" class="ft134">On&#160;the&#160;down&#160;side,&#160;while&#160;it is true&#160;that&#160;the&#160;entirety of&#160;Mesa3D and&#160;its OpenGL&#160;state<br/>tracker have&#160;been moved&#160;out&#160;into the guest&#160;domain,&#160;80,000&#160;lines of code remain<br/>trusted,&#160;a&#160;figure&#160;which&#160;is comparable&#160;in&#160;size&#160;to&#160;the&#160;Xen&#160;hypervisor&#160;(estimated&#160;for<br/>version&#160;3.3&#160;at&#160;150,000&#160;lines).&#160;Therefore&#160;it is probably&#160;reasonable&#160;to&#160;say&#160;that providing<br/>3D&#160;graphics&#160;for&#160;guest&#160;VMs&#160;still inflates&#160;the&#160;trusted&#160;codebase&#160;significantly,&#160;even&#160;if the<br/>problem&#160;is reduced&#160;compared&#160;to straightforward&#160;OpenGL&#160;remoting.</p>
<p style="position:absolute;top:305px;left:85px;white-space:nowrap" class="ft134">A&#160;further&#160;problem is that&#160;the removed&#160;code&#160;consists&#160;of the&#160;implementation&#160;of&#160;the high-<br/>level semantics&#160;of&#160;OpenGL's&#160;state&#160;model,&#160;making&#160;heavy&#160;use of&#160;safe&#160;integer&#160;handles,<br/>whereas&#160;the&#160;code&#160;which remains&#160;trusted&#160;is involved&#160;with&#160;direct&#160;hardware&#160;access and<br/>command&#160;synthesis&#160;using&#160;raw pointers,&#160;as&#160;well&#160;as interacting&#160;directly&#160;with&#160;the<br/>operating&#160;system&#160;kernel.&#160;Therefore&#160;the code&#160;which has&#160;been&#160;exported&#160;to&#160;the&#160;guest<br/>domain&#160;could&#160;in&#160;some&#160;sense&#160;be&#160;said&#160;to&#160;be&#160;more&#160;‘benign’&#160;than&#160;that&#160;which&#160;remains.<br/>Errors&#160;in&#160;the&#160;high-level&#160;OpenGL&#160;code&#160;are likely&#160;to crash&#160;the local&#160;process;&#160;errors&#160;in the<br/>low-level hardware&#160;access&#160;code&#160;are likely to&#160;crash&#160;the graphics&#160;card&#160;itself,&#160;or&#160;worse&#160;to<br/>cause the card&#160;to&#160;write arbitrary&#160;physical&#160;memory;&#160;either&#160;of&#160;these&#160;is liable&#160;to bring<br/>down&#160;the&#160;host&#160;system,&#160;VMs&#160;and&#160;all.</p>
<p style="position:absolute;top:516px;left:85px;white-space:nowrap" class="ft134">To a degree this&#160;issue&#160;could&#160;be ameliorated&#160;by&#160;moving&#160;yet more&#160;code&#160;from&#160;the&#160;trusted<br/>domain&#160;into&#160;the guest,&#160;with&#160;the&#160;two&#160;exchanging&#160;lower&#160;and&#160;lower level&#160;commands,&#160;and<br/>the operands&#160;to&#160;these commands&#160;being&#160;indirected&#160;by&#160;the host&#160;such&#160;that&#160;buggy&#160;guest<br/>software&#160;cannot&#160;address&#160;objects which&#160;do not&#160;exist,&#160;or&#160;have been freed.&#160;The&#160;primary<br/>problem&#160;with this&#160;approach&#160;is a&#160;practical&#160;one:&#160;the&#160;low-level commands&#160;used&#160;by<br/>graphics&#160;cards&#160;are difficult&#160;to&#160;check&#160;for&#160;safety,&#160;vary&#160;widely&#160;from&#160;manufacturer&#160;to<br/>manufacturer,&#160;and&#160;have&#160;evolved swiftly&#160;over&#160;time. One&#160;might&#160;well&#160;produce&#160;a&#160;remoting<br/>solution&#160;which&#160;permitted&#160;guests&#160;to&#160;deal&#160;with,&#160;for&#160;example,&#160;a specific&#160;Intel&#160;graphics<br/>chipset,&#160;and which&#160;removed&#160;all but&#160;a&#160;few thousands&#160;lines of&#160;code&#160;to&#160;the&#160;guests.<br/>However,&#160;another&#160;solution&#160;would&#160;be required&#160;for&#160;ATI&#160;graphics&#160;hardware,&#160;still&#160;another<br/>for&#160;Nvidia hardware,&#160;and in all&#160;probability&#160;the Intel solution&#160;would&#160;need adapting&#160;and<br/>rewriting not&#160;far&#160;into&#160;the&#160;future&#160;as&#160;another&#160;generation&#160;of hardware&#160;defined&#160;another<br/>new&#160;command-set. This is&#160;similar&#160;to the&#160;current&#160;situation&#160;with ordinary,&#160;local&#160;graphics<br/>drivers;&#160;asking&#160;that&#160;graphics&#160;hardware&#160;vendors&#160;should&#160;develop&#160;both&#160;a local driver&#160;and<br/>a remoting&#160;solution&#160;for&#160;each of&#160;their cards&#160;seems&#160;hopeful&#160;at&#160;best.</p>
<p style="position:absolute;top:823px;left:85px;white-space:nowrap" class="ft134">By&#160;comparison,&#160;remoting&#160;OpenGL&#160;has&#160;been&#160;attractive&#160;as&#160;the&#160;API&#160;is&#160;relatively&#160;stable;<br/>although&#160;it&#160;has certainly&#160;grown&#160;since&#160;it&#160;was&#160;originally&#160;defined,&#160;this&#160;change has&#160;been<br/>very&#160;slow&#160;compared&#160;to&#160;the evolution&#160;of&#160;hardware,&#160;and&#160;so&#160;a GL&#160;remoting&#160;solution&#160;is<br/>likely&#160;to remain&#160;useful&#160;for years&#160;to&#160;come.&#160;In&#160;this way&#160;the&#160;remoting&#160;of Gallium3D&#160;takes<br/>advantage&#160;of a change&#160;in what&#160;is&#160;practical:&#160;as&#160;the&#160;pipe driver&#160;interface&#160;is envisaged&#160;to<br/>remain&#160;stable&#160;in the&#160;manner&#160;of OpenGL, and&#160;Gallium&#160;drivers&#160;can be&#160;remoted&#160;to<br/>without&#160;modification,&#160;removing&#160;the&#160;burden&#160;from&#160;hardware&#160;vendors,&#160;Gallium&#160;remoting<br/>shares&#160;the advantages of&#160;OpenGL&#160;(or&#160;Direct3D) remoting&#160;whilst&#160;doing so&#160;at&#160;a level<br/>sufficiently&#160;closer&#160;to&#160;the&#160;hardware&#160;to&#160;permit&#160;significant&#160;simplification&#160;of the&#160;host-side<br/>driver.</p>
<p style="position:absolute;top:1034px;left:85px;white-space:nowrap" class="ft134">One&#160;possible&#160;long-term solution&#160;to&#160;this problem&#160;might&#160;be&#160;to define&#160;an&#160;interface&#160;still<br/>closer&#160;to the hardware&#160;than the&#160;Gallium pipe&#160;driver&#160;interface, and&#160;remote&#160;that. This<br/>interface&#160;would necessarily&#160;include&#160;a means&#160;to&#160;serialize&#160;and&#160;deliver&#160;manufacturer&#160;and<br/>model-specific commands;&#160;the host's&#160;element&#160;of&#160;the&#160;driver&#160;would&#160;then simply&#160;be<br/>responsible&#160;for&#160;checking&#160;the safety&#160;of&#160;commands&#160;where appropriate&#160;and&#160;translating</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft136">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft136">13/17</p>
</div>
<!-- Page 14 -->
<a name="14"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page14-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content014.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft146">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft146">FINAL|1.0</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft144">guest&#160;pointers or&#160;handles&#160;into&#160;machine&#160;pointers (a task&#160;which could&#160;also&#160;be<br/>accomplished&#160;using&#160;a memory&#160;management&#160;unit-like scheme&#160;in which&#160;guests&#160;deal<br/>with&#160;a&#160;virtual&#160;address&#160;space&#160;which&#160;is mapped&#160;in&#160;hardware&#160;onto&#160;physical&#160;video<br/>memory).&#160;If&#160;this interface&#160;were designed&#160;such&#160;that execution&#160;in a non-virtualised<br/>environment&#160;were&#160;equivalent&#160;or&#160;very&#160;similar&#160;to&#160;a&#160;single&#160;virtual&#160;machine running&#160;under<br/>a&#160;hypervisor,&#160;and&#160;the&#160;remoting&#160;layer&#160;were&#160;sufficiently&#160;general,&#160;then&#160;the&#160;extra&#160;burden<br/>on&#160;graphics&#160;hardware&#160;developers&#160;could&#160;be&#160;minimised.&#160;This would&#160;almost&#160;completely<br/>eliminate&#160;trusted&#160;code,&#160;leaving&#160;only&#160;graphics&#160;memory&#160;management&#160;and&#160;the<br/>marshalling&#160;and&#160;remoting&#160;layer&#160;running&#160;in the trusted&#160;domain.</p>
<p style="position:absolute;top:343px;left:85px;white-space:nowrap" class="ft144">This scheme&#160;could be&#160;taken to&#160;its logical&#160;limit&#160;by permitting&#160;each&#160;guest&#160;VM&#160;to&#160;access<br/>the hardware&#160;directly in&#160;‘user mode,’&#160;analogous&#160;to&#160;running&#160;a program&#160;on&#160;a CPU&#160;in<br/>user-mode&#160;in&#160;which&#160;certain&#160;registers&#160;and&#160;processor&#160;features&#160;are&#160;inviolate.&#160;The<br/>hypervisor&#160;or&#160;trusted&#160;domain's&#160;role&#160;would&#160;then&#160;be&#160;limited&#160;to&#160;configuring&#160;the&#160;graphics<br/>card's&#160;memory&#160;management&#160;hardware&#160;appropriately&#160;before&#160;yielding&#160;control&#160;to&#160;a<br/>guest,&#160;similar&#160;to&#160;most&#160;operating&#160;system&#160;kernels'&#160;role&#160;in memory&#160;management&#160;and<br/>secure&#160;multiplexing&#160;of the&#160;CPU for&#160;user processes.&#160;This&#160;would also&#160;mean a large<br/>performance&#160;gain,&#160;as&#160;no&#160;remoting&#160;at&#160;all&#160;would&#160;be&#160;required&#160;apart&#160;from&#160;a&#160;domain-switch<br/>to&#160;configure&#160;the&#160;card's&#160;MMU.&#160;The PCI-SIG's&#160;Single&#160;Root&#160;I/O Virtualisation&#160;standard&#160;may<br/>provide&#160;hardware&#160;suited&#160;to such&#160;designs;&#160;network&#160;devices&#160;which&#160;similarly&#160;expose<br/>multiple&#160;interfaces&#160;for&#160;direct&#160;use by&#160;virtual&#160;machines&#160;already&#160;exist.</p>
<p style="position:absolute;top:591px;left:85px;white-space:nowrap" class="ft141"><b>5.2&#160;Generality&#160;and&#160;Portability</b></p>
<p style="position:absolute;top:639px;left:85px;white-space:nowrap" class="ft144">Another&#160;goal&#160;of&#160;this&#160;project was&#160;to&#160;produce&#160;a system&#160;easily&#160;adaptable&#160;to&#160;different<br/>graphics&#160;APIs,&#160;guest&#160;and&#160;host&#160;operating&#160;systems,&#160;and&#160;hypervisors.</p>
<p style="position:absolute;top:696px;left:85px;white-space:nowrap" class="ft144">Remoting&#160;a&#160;different&#160;graphics&#160;API&#160;would&#160;be&#160;trivial,&#160;given the existence of&#160;a&#160;state<br/>tracker.&#160;Linking the&#160;GL&#160;state&#160;tracker with&#160;our&#160;client&#160;graphics&#160;drivers&#160;required&#160;no<br/>modification&#160;to the&#160;state&#160;tracker&#160;at&#160;all,&#160;so we&#160;have&#160;no&#160;reason&#160;to believe that&#160;any would<br/>be&#160;required&#160;to&#160;link&#160;with&#160;a&#160;different&#160;state&#160;tracker&#160;and&#160;therefore&#160;permit&#160;guests'<br/>applications&#160;to&#160;use&#160;and&#160;accelerate,&#160;for&#160;example,&#160;Direct3D&#160;9.&#160;The&#160;current&#160;Window<br/>System&#160;Driver running&#160;on&#160;clients is based on&#160;Tungsten&#160;Graphics'&#160;stock Xlib/GLX&#160;driver,<br/>and&#160;required&#160;only 21&#160;additional&#160;lines of&#160;code&#160;which were&#160;GLX-specific,&#160;all&#160;relating&#160;to<br/>reporting&#160;window&#160;creation&#160;and&#160;destruction&#160;to the&#160;Xorg&#160;extension.&#160;Therefore&#160;similar<br/>modifications&#160;to&#160;another&#160;template&#160;window&#160;system&#160;should&#160;be simple.</p>
<p style="position:absolute;top:888px;left:85px;white-space:nowrap" class="ft144">Remoting&#160;the 3D drawing&#160;of a&#160;guest&#160;running&#160;a different&#160;operating&#160;system&#160;would<br/>require&#160;some&#160;work,&#160;but not&#160;a&#160;prohibitively&#160;large&#160;amount.&#160;The current&#160;OpenGL&#160;guest<br/>driver&#160;could&#160;be ported&#160;to&#160;run&#160;on Windows,&#160;for&#160;example,&#160;by&#160;reimplementing&#160;the ring<br/>buffer&#160;mechanisms&#160;to&#160;use&#160;Xen's&#160;means&#160;of&#160;exposing&#160;its shared&#160;memory&#160;capabilities&#160;to<br/>Windows&#160;guests,&#160;substituting&#160;the GLX&#160;integration&#160;of the current&#160;Window&#160;System&#160;driver<br/>for&#160;similar&#160;WGL&#160;integration,&#160;and replacing&#160;the Xorg&#160;extension&#160;with&#160;a similar<br/>mechanism&#160;for extracting&#160;window&#160;coordinates&#160;and clipping&#160;information&#160;from&#160;Windows'<br/>graphics&#160;subsystem.</p>
<p style="position:absolute;top:1061px;left:85px;white-space:nowrap" class="ft144">Running&#160;the compositor&#160;on&#160;a&#160;different&#160;operating&#160;system&#160;would&#160;be easy: the<br/>compositor&#160;as&#160;implemented&#160;interacts with&#160;its&#160;graphics&#160;driver&#160;using&#160;only&#160;the&#160;Pipe&#160;Driver<br/>interface,&#160;which&#160;is&#160;invariant&#160;across&#160;operating&#160;systems,&#160;and&#160;the&#160;EGL&#160;API&#160;for&#160;creating<br/>and&#160;managing&#160;rendering&#160;contexts,&#160;which&#160;is&#160;both&#160;cross-platform&#160;and&#160;graphics&#160;API</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft146">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft146">14/17</p>
</div>
<!-- Page 15 -->
<a name="15"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page15-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content015.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft156">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft156">FINAL|1.0</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft154">independent.&#160;It could&#160;therefore&#160;be easily&#160;integrated&#160;with&#160;a&#160;different&#160;graphics&#160;driver<br/>supporting&#160;EGL running&#160;on&#160;any&#160;operating&#160;system.</p>
<p style="position:absolute;top:209px;left:85px;white-space:nowrap" class="ft154">Running&#160;on a&#160;VMM&#160;other&#160;than&#160;Xen&#160;would&#160;naturally&#160;require&#160;replacement&#160;of&#160;the&#160;shared<br/>memory&#160;transport,&#160;which&#160;currently&#160;uses&#160;Xen's mechanisms&#160;for shared&#160;memory<br/>segment&#160;setup&#160;and&#160;teardown;&#160;however,&#160;conversion&#160;from&#160;the TCP-based&#160;transport&#160;used<br/>during&#160;early&#160;development&#160;to the&#160;current&#160;shared&#160;memory&#160;transport&#160;took&#160;only&#160;around<br/>two weeks for a&#160;single&#160;person&#160;with&#160;no&#160;prior&#160;knowledge of Xen's&#160;mechanisms&#160;for inter-<br/>domain&#160;communication,&#160;so&#160;again&#160;the&#160;prospects&#160;for&#160;an easy&#160;port&#160;look&#160;promising.</p>
<p style="position:absolute;top:361px;left:85px;white-space:nowrap" class="ft151"><b>5.3&#160;Suitability&#160;of&#160;Gallium&#160;for Remoting</b></p>
<p style="position:absolute;top:408px;left:85px;white-space:nowrap" class="ft154">To&#160;the best&#160;of&#160;our knowledge, Xen3D represents&#160;the&#160;first attempt to&#160;remote&#160;3D<br/>drawing&#160;operations&#160;at&#160;an&#160;API-neutral&#160;layer.&#160;VMWare's&#160;solution&#160;is&#160;the sole&#160;example&#160;that<br/>does not&#160;perform&#160;straight-forward&#160;API&#160;remoting,&#160;but what&#160;it&#160;remotes&#160;is closely related<br/>to Direct3D.</p>
<p style="position:absolute;top:504px;left:85px;white-space:nowrap" class="ft154">The&#160;use&#160;of a common&#160;remoting&#160;language&#160;offers many advantages.&#160;Firstly,&#160;as&#160;Gallium-<br/>based&#160;graphics&#160;drivers&#160;must&#160;always&#160;convert&#160;from&#160;the&#160;graphics&#160;API&#160;exposed&#160;to<br/>programmers&#160;to&#160;that&#160;exposed&#160;by the&#160;pipe&#160;driver,&#160;performing&#160;that&#160;conversion&#160;in&#160;a<br/>separate&#160;VM to&#160;the&#160;actual&#160;rendering&#160;does&#160;not&#160;introduce&#160;any&#160;additional&#160;work&#160;above&#160;the<br/>remoting&#160;overhead.&#160;This improves&#160;over any&#160;use&#160;of a conversion&#160;layer&#160;(such&#160;as&#160;GL to<br/>Direct3D),&#160;which&#160;would&#160;introduce&#160;a&#160;redundant&#160;API&#160;conversion,&#160;as&#160;may be&#160;taking&#160;place<br/>in Parallels'&#160;system.</p>
<p style="position:absolute;top:658px;left:85px;white-space:nowrap" class="ft154">Unfortunately&#160;however,&#160;whilst&#160;the OpenGL&#160;API was designed&#160;from the outset for<br/>remoting&#160;of&#160;drawing&#160;operations,&#160;being&#160;aimed&#160;at thin&#160;client&#160;setups,&#160;the&#160;Gallium Pipe<br/>Driver&#160;interface&#160;was not.&#160;The&#160;underlying&#160;assumption&#160;that&#160;dispatches&#160;to&#160;pipe&#160;driver<br/>functions would occur&#160;by&#160;simple&#160;local&#160;function&#160;calls are made&#160;evident&#160;in&#160;places:&#160;for<br/>one,&#160;pipe&#160;drivers&#160;do&#160;not&#160;support&#160;the&#160;OpenGL&#160;concept&#160;of display&#160;lists.&#160;These lists<br/>comprise&#160;sets of&#160;drawing&#160;commands&#160;which&#160;can&#160;be saved&#160;and&#160;replayed&#160;at a later&#160;date;<br/>this&#160;is&#160;particularly&#160;useful&#160;when&#160;the&#160;originator&#160;of the&#160;commands&#160;and&#160;the renderer&#160;are<br/>not collocated, as&#160;the&#160;list&#160;can&#160;be&#160;stored&#160;local to the&#160;renderer, and&#160;the&#160;command&#160;to<br/>invoke that&#160;list&#160;is&#160;very&#160;brief indeed.&#160;This helps to&#160;avoid&#160;the network&#160;becoming&#160;a<br/>bottleneck.&#160;Because&#160;Pipe Drivers&#160;do not&#160;have&#160;this&#160;capability,&#160;the OpenGL&#160;state&#160;tracker<br/>itself saves&#160;and&#160;‘plays&#160;back’&#160;these&#160;lists;&#160;to the pipe&#160;driver&#160;the&#160;situation&#160;looks&#160;just&#160;as&#160;if<br/>the complete&#160;command&#160;stream&#160;were&#160;reissued.&#160;When&#160;remoting&#160;at the state&#160;tracker /<br/>pipe&#160;driver&#160;interface,&#160;then,&#160;a&#160;complete&#160;copy&#160;of&#160;the list's&#160;representation&#160;as&#160;Gallium<br/>drawing&#160;commands&#160;will&#160;be transmitted&#160;on&#160;each list&#160;invocation.&#160;This&#160;may&#160;introduce&#160;the<br/>transport&#160;as a&#160;bottleneck.</p>
<p style="position:absolute;top:965px;left:85px;white-space:nowrap" class="ft154">Further,&#160;the pipe driver&#160;interface&#160;includes&#160;several&#160;functions&#160;with&#160;return&#160;values which<br/>may&#160;affect&#160;control&#160;flow&#160;in&#160;the&#160;state tracker,&#160;from&#160;which&#160;it is now remote;&#160;most<br/>critically&#160;the&#160;core&#160;“draw&#160;arrays”&#160;function,&#160;which&#160;instructs the pipe driver&#160;to&#160;draw&#160;a&#160;set<br/>of vertices,&#160;has&#160;a boolean&#160;return&#160;which&#160;indicates whether drawing&#160;was successful.&#160;The<br/>only&#160;current&#160;state&#160;tracker&#160;mercifully&#160;ignores&#160;these return&#160;values, and&#160;so we&#160;are&#160;able to<br/>avoid the&#160;need to&#160;wait for the&#160;renderer to&#160;return&#160;on&#160;every&#160;draw&#160;command;&#160;however<br/>future&#160;state&#160;trackers&#160;are&#160;liable&#160;to use this&#160;return,&#160;which&#160;might&#160;render&#160;Gallium&#160;unviable<br/>as&#160;a tool&#160;for&#160;remoting.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft156">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft156">15/17</p>
</div>
<!-- Page 16 -->
<a name="16"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page16-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content016.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft166">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft166">FINAL|1.0</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft161"><b>5.4&#160;Future&#160;Directions</b></p>
<p style="position:absolute;top:198px;left:85px;white-space:nowrap" class="ft164">One&#160;key&#160;difference&#160;between&#160;graphics&#160;remoting&#160;between VMs&#160;and&#160;between&#160;physically<br/>separate&#160;machines&#160;is the ability to make&#160;use&#160;of&#160;shared&#160;memory.&#160;The&#160;Gallium<br/>architecture&#160;provides&#160;functions&#160;allowing&#160;both&#160;textures&#160;and&#160;vertex buffers&#160;to&#160;be&#160;loaded<br/>or&#160;referenced&#160;from&#160;user&#160;memory,&#160;which&#160;could&#160;be used&#160;to&#160;avoid&#160;copying&#160;when&#160;a guest<br/>wishes to load&#160;textures&#160;and vertex&#160;data&#160;which&#160;it&#160;has&#160;generated&#160;or&#160;loaded&#160;from&#160;disk.<br/>This&#160;would&#160;also&#160;permit&#160;the&#160;guest&#160;to modify&#160;these&#160;textures&#160;and&#160;vertex&#160;buffers&#160;in-place,<br/>again&#160;avoiding&#160;copying.&#160;This would also&#160;remove&#160;a&#160;cause of&#160;synchronisation:&#160;whereas<br/>presently&#160;upon&#160;mapping&#160;a texture&#160;for&#160;local&#160;reading one must&#160;wait&#160;for&#160;the renderer&#160;VM<br/>to&#160;deliver&#160;a copy,&#160;a&#160;shared&#160;memory&#160;version&#160;would&#160;be&#160;available&#160;immediately,&#160;perhaps<br/>avoiding&#160;the&#160;need to&#160;flush drawing&#160;commands&#160;if&#160;it is known not&#160;to&#160;have&#160;changed.<br/>Synchronisation&#160;may&#160;be&#160;required&#160;regardless,&#160;however,&#160;if preceding&#160;drawing<br/>commands may modify that&#160;texture.</p>
<p style="position:absolute;top:448px;left:85px;white-space:nowrap" class="ft164">The compositor's&#160;system&#160;of rendering&#160;guest&#160;3D&#160;content to&#160;off-screen&#160;textures&#160;which<br/>are&#160;then drawn&#160;to&#160;screen&#160;could&#160;also&#160;be applied&#160;to&#160;accelerating&#160;2D&#160;windowing&#160;for<br/>guests.&#160;User&#160;experience could&#160;be&#160;improved&#160;by performing&#160;window&#160;composition&#160;using<br/>host hardware.&#160;This&#160;could&#160;be&#160;directly&#160;implemented by&#160;modifying the&#160;X&#160;servers&#160;of&#160;the<br/>guest,&#160;or&#160;an&#160;OpenGL-based&#160;X&#160;Server&#160;such&#160;as&#160;Xgl&#160;could&#160;be used.</p>
<p style="position:absolute;top:563px;left:85px;white-space:nowrap" class="ft164">In&#160;order&#160;to&#160;provide&#160;better&#160;isolation&#160;of&#160;guests,&#160;a&#160;quota&#160;system&#160;preventing&#160;excessive&#160;use<br/>of,&#160;for example,&#160;texture&#160;memory&#160;will be implemented.&#160;This&#160;will&#160;involve&#160;interposing&#160;on<br/>texture&#160;and buffer&#160;allocation methods&#160;in order&#160;to store&#160;these&#160;in&#160;main&#160;memory&#160;and&#160;load<br/>when appropriate.&#160;Quotas&#160;may&#160;also&#160;be&#160;applied in&#160;time; whereas&#160;currently&#160;the system<br/>divides&#160;time&#160;by issuing&#160;constant&#160;numbers&#160;of commands&#160;from&#160;each client&#160;in&#160;round-<br/>robin&#160;fashion,&#160;it&#160;may&#160;be useful&#160;to&#160;take into account&#160;the&#160;relative&#160;‘weights’&#160;of&#160;commands<br/>in&#160;terms of their&#160;execution&#160;times in&#160;hardware.&#160;As this&#160;will naturally&#160;vary&#160;from&#160;device&#160;to<br/>device, this will&#160;probably&#160;be&#160;best&#160;accomplished&#160;by&#160;direct&#160;measurement&#160;of the&#160;time<br/>consumed&#160;by each&#160;guest,&#160;varying&#160;the&#160;numbers&#160;of&#160;commands&#160;each is permitted&#160;to<br/>attempt to achieve&#160;fair distribution&#160;of time&#160;when&#160;averaged&#160;over&#160;the short term.&#160;This<br/>scheme would be in&#160;spirit&#160;similar&#160;to&#160;weighted&#160;round&#160;robin&#160;as used&#160;for&#160;scheduling&#160;of<br/>variable-length&#160;network&#160;packets,&#160;with&#160;the&#160;idiosyncrasy&#160;that&#160;the&#160;‘length’&#160;is&#160;not&#160;known<br/>until&#160;the ‘packet’&#160;has been&#160;dispatched.</p>
<p style="position:absolute;top:850px;left:85px;white-space:nowrap" class="ft161"><b>5.5&#160;Improving Gallium</b></p>
<p style="position:absolute;top:878px;left:85px;white-space:nowrap" class="ft164">In more&#160;general&#160;terms,&#160;it would&#160;be&#160;valuable&#160;to produce an&#160;interface&#160;which is&#160;similar&#160;to<br/>Gallium's&#160;pipe&#160;drivers,&#160;but which&#160;is&#160;designed&#160;with remoting&#160;in mind. This&#160;would&#160;mean<br/>in-built&#160;support&#160;for command&#160;playback,&#160;and the&#160;ability&#160;to avoid&#160;waiting for&#160;the<br/>renderer&#160;except&#160;when&#160;strictly necessary,&#160;permitting&#160;maximal&#160;command&#160;batching&#160;and<br/>minimal&#160;context&#160;switching.&#160;If&#160;such&#160;an&#160;interface&#160;were able&#160;to&#160;use state&#160;trackers&#160;similar<br/>to those&#160;required&#160;by Gallium&#160;then this&#160;new&#160;system&#160;would&#160;retain&#160;the adaptability&#160;which<br/>recommends&#160;the&#160;use of Gallium to&#160;begin with. If&#160;it were further suitable&#160;for&#160;local&#160;use<br/>the original&#160;Gallium could&#160;be&#160;discarded&#160;entirely, and&#160;the&#160;pursuits&#160;of&#160;local and&#160;virtually<br/>local&#160;rendering&#160;merged.</p>
<p style="position:absolute;top:1070px;left:85px;white-space:nowrap" class="ft164">In&#160;the&#160;still longer term, hardware&#160;management&#160;provides&#160;the&#160;most&#160;promising&#160;vision for<br/>high-performance&#160;virtualisation&#160;of&#160;the&#160;graphics&#160;subsystem.&#160;Given&#160;hardware&#160;which&#160;is<br/>able&#160;to&#160;expose&#160;an&#160;interface&#160;for&#160;direct passthrough&#160;to a&#160;guest,&#160;as&#160;the&#160;PCI&#160;SR-IOV</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft166">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft166">16/17</p>
</div>
<!-- Page 17 -->
<a name="17"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page17-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="OpenTC_D04.8_Secure_Multiplexing_of_Accelerated_3D_content017.png" alt="background image"/>
<p style="position:absolute;top:92px;left:249px;white-space:nowrap" class="ft176">Secure&#160;Multiplexing&#160;of Accelerated&#160;3D&#160;Content</p>
<p style="position:absolute;top:92px;left:694px;white-space:nowrap" class="ft176">FINAL|1.0</p>
<p style="position:absolute;top:151px;left:85px;white-space:nowrap" class="ft174">specification&#160;aims&#160;to&#160;do,&#160;performance&#160;could&#160;approach&#160;100%&#160;that of&#160;non-virtualised<br/>hardware.&#160;However,&#160;this&#160;will&#160;specifically&#160;require&#160;a&#160;very well&#160;designed&#160;driver&#160;model&#160;so<br/>as&#160;to&#160;merge&#160;the tasks of driver&#160;development&#160;for&#160;virtualised&#160;and non-virtualised<br/>environments&#160;as&#160;much as&#160;is&#160;possible;&#160;this&#160;is&#160;to ensure&#160;both&#160;high&#160;exposure&#160;of&#160;the<br/>virtualised&#160;platform&#160;code,&#160;and&#160;to&#160;minimise&#160;the extra&#160;effort&#160;required&#160;of hardware<br/>vendors&#160;such&#160;that&#160;they&#160;are not&#160;discouraged&#160;from&#160;implementing&#160;support.&#160;An&#160;example<br/>approach&#160;might&#160;be&#160;to&#160;have&#160;the&#160;non-virtualised&#160;environment&#160;use a virtual&#160;device itself,<br/>whilst retaining&#160;administrative&#160;control&#160;(unlike&#160;a VM,&#160;which would&#160;request<br/>administrative&#160;operations of a&#160;trusted VM);&#160;this&#160;could&#160;be coupled with&#160;a&#160;generic<br/>administrative&#160;interface,&#160;such&#160;that&#160;the&#160;process&#160;of&#160;VMs&#160;requesting&#160;the right&#160;to&#160;draw,<br/>negotiating&#160;for&#160;graphics&#160;memory&#160;and&#160;so&#160;forth&#160;is&#160;device-independent.</p>
<p style="position:absolute;top:402px;left:85px;white-space:nowrap" class="ft178"><b>6&#160;</b></p>
<p style="position:absolute;top:399px;left:117px;white-space:nowrap" class="ft179"><b>Conclusion</b></p>
<p style="position:absolute;top:429px;left:85px;white-space:nowrap" class="ft174">The Gallium&#160;pipe&#160;driver&#160;interface&#160;itself is&#160;not&#160;perfect&#160;for use&#160;in&#160;remoting&#160;3D&#160;rendering<br/>commands&#160;between&#160;VMs.&#160;However,&#160;we&#160;believe&#160;that&#160;its ability to&#160;make&#160;use&#160;of&#160;a single<br/>piece&#160;of&#160;remoting&#160;code&#160;and&#160;general&#160;purpose&#160;state&#160;trackers will&#160;mean that&#160;Xen3D&#160;is<br/>likely&#160;to&#160;see&#160;real&#160;use&#160;with&#160;new&#160;graphics&#160;APIs&#160;sooner&#160;than&#160;other open-source&#160;projects<br/>bound&#160;to&#160;specific&#160;APIs.&#160;We&#160;further&#160;believe&#160;that the&#160;code&#160;which is removed&#160;into<br/>untrusted&#160;domains&#160;by&#160;adoption&#160;of&#160;Gallium&#160;for&#160;remoting&#160;will&#160;decrease&#160;the chances&#160;of<br/>exploiting&#160;bugs&#160;in&#160;graphics&#160;driver&#160;code to&#160;subvert&#160;the host&#160;machine;&#160;this&#160;will&#160;reduce<br/>the loss&#160;of&#160;security&#160;and&#160;isolation&#160;incurred&#160;in&#160;providing&#160;multimedia&#160;facilities&#160;to guests.</p>
<p style="position:absolute;top:1160px;left:85px;white-space:nowrap" class="ft176">Open_TC&#160;Deliverable&#160;D04.8</p>
<p style="position:absolute;top:1160px;left:765px;white-space:nowrap" class="ft176">17/17</p>
</div>
</body>
</html>
